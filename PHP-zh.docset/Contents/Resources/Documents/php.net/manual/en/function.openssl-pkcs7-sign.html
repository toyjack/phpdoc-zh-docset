<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>Sign an S/MIME message</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.openssl-pkcs7-encrypt.html">? openssl_pkcs7_encrypt</a></li>
      <li style="float: right;"><a href="function.openssl-pkcs7-verify.html">openssl_pkcs7_verify ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.openssl.html">OpenSSL 函数</a></li>
    <li>Sign an S/MIME message</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.openssl-pkcs7-sign" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">openssl_pkcs7_sign</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.0.6, PHP 5, PHP 7)</p><p class="refpurpose"><span class="refname">openssl_pkcs7_sign</span> &mdash; <span class="dc-title">Sign an S/MIME message</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.openssl-pkcs7-sign-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><strong>openssl_pkcs7_sign</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$infilename</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$outfilename</code></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span> <code class="parameter">$signcert</code></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span> <code class="parameter">$privkey</code></span>
   , <span class="methodparam"><span class="type">array</span> <code class="parameter">$headers</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$flags</code><span class="initializer"> = PKCS7_DETACHED</span></span>
   [, <span class="methodparam"><span class="type">string</span> <code class="parameter">$extracerts</code></span>
  ]] )</div>

  <p class="para rdfs-comment">
   <span class="function"><strong>openssl_pkcs7_sign()</strong></span> takes the contents of the file
   named <code class="parameter">infilename</code> and signs them using the
   certificate and its matching private key specified by
   <code class="parameter">signcert</code> and <code class="parameter">privkey</code>
   parameters.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.openssl-pkcs7-sign-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">infilename</code></dt>

     <dd>

      <p class="para">
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">outfilename</code></dt>

     <dd>

      <p class="para">
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">signcert</code></dt>

     <dd>

      <p class="para">
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">privkey</code></dt>

     <dd>

      <p class="para">
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">headers</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">headers</code> is an array of headers that
       will be prepended to the data after it has been signed (see
       <span class="function"><a href="function.openssl-pkcs7-encrypt.html" class="function">openssl_pkcs7_encrypt()</a></span> for more information about
       the format of this parameter).
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">flags</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">flags</code> can be used to alter the output - see <a href="openssl.pkcs7.flags.html" class="link">PKCS7 constants</a>.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">extracerts</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">extracerts</code> specifies the name of a file containing
       a bunch of extra certificates to include in the signature which can for
       example be used to help the recipient to verify the certificate that you used.
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.openssl-pkcs7-sign-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   成功时返回 <strong><code>TRUE</code></strong>， 或者在失败时返回 <strong><code>FALSE</code></strong>。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.openssl-pkcs7-sign-examples">
  <h3 class="title">范例</h3>
  <p class="para">
   <div class="example" id="example-925">
    <p><strong>Example #1 <span class="function"><strong>openssl_pkcs7_sign()</strong></span> example</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">//&nbsp;the&nbsp;message&nbsp;you&nbsp;want&nbsp;to&nbsp;sign&nbsp;so&nbsp;that&nbsp;recipient&nbsp;can&nbsp;be&nbsp;sure&nbsp;it&nbsp;was&nbsp;you&nbsp;that<br />//&nbsp;sent&nbsp;it<br /></span><span style="color: #0000BB">$data&nbsp;</span><span style="color: #007700">=&nbsp;&lt;&lt;&lt;EOD<br /></span><span style="color: #DD0000"><br />You&nbsp;have&nbsp;my&nbsp;authorization&nbsp;to&nbsp;spend&nbsp;$10,000&nbsp;on&nbsp;dinner&nbsp;expenses.<br /><br />The&nbsp;CEO<br /></span><span style="color: #007700">EOD;<br /></span><span style="color: #FF8000">//&nbsp;save&nbsp;message&nbsp;to&nbsp;file<br /></span><span style="color: #0000BB">$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"msg.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"w"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//&nbsp;encrypt&nbsp;it<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">openssl_pkcs7_sign</span><span style="color: #007700">(</span><span style="color: #DD0000">"msg.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"signed.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"mycert.pem"</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;array(</span><span style="color: #DD0000">"file://mycert.pem"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"mypassphrase"</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;array(</span><span style="color: #DD0000">"To"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"joes@example.com"</span><span style="color: #007700">,&nbsp;</span><span style="color: #FF8000">//&nbsp;keyed&nbsp;syntax<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"From:&nbsp;HQ&nbsp;&lt;ceo@example.com&gt;"</span><span style="color: #007700">,&nbsp;</span><span style="color: #FF8000">//&nbsp;indexed&nbsp;syntax<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"Subject"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"Eyes&nbsp;only"</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;message&nbsp;signed&nbsp;-&nbsp;send&nbsp;it!<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">exec</span><span style="color: #007700">(</span><span style="color: #0000BB">ini_get</span><span style="color: #007700">(</span><span style="color: #DD0000">"sendmail_path"</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"&nbsp;&lt;&nbsp;signed.txt"</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="111336""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#111336" class="date">09-Feb-2013 01:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A note about the $flags parameter: PKCS7_BINARY has 2 effects:<br />
* converts LF to CR+LF, as described in <a href="http://www.php.net/manual/en/openssl.pkcs7.flags.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/openssl.pkcs7.flags.php</a><br />
* it creates an opaque pkcs7 signature (p7m)<br />
<br />
If you want to prevent the LF-&gt;CR+LF conversion *and* still have a detached signature (p7s), use PKCS7_BINARY | PKCS7_DETACHED (both flags are set).<br />
<br />
If the signed message is already MIME multi-part, using both flags as described above seems to be the right solution to assemble the message properly. Without any flags, apparently only some of the LF characters are converted. In a specific scenario (the local MTA is Postfix and then the message goes through sendmail on another machine), the MIME boundaries get scrambled in sendmail. However, this doesn't seem to happen if the local MTA is sendmail.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96155""></a>
  <div class="note">
   <strong class="user">ungdi at hotmail dot com</strong>
   <a href="#96155" class="date">11-Feb-2010 02:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Amongst the many discussions about signing or encrypting email by itself, none really discuss the pain of having an email BOTH signed AND encrypted.<br />
<br />
According to RFC 2311, you can encrypt then sign or sign then encrypt. However, it depends on the client in which you are programming for. In my experience, in Outlook 2000, it prefers it Encrypt then Sign. While in Outlook 2003, it is Sign then Encrypt. Generally, you want Sign then Encrypt, as it seems most logical from a snail-mail piece point of view. You first sign a letter than put it in an envelope. Certain clients complain if you do it in an order it does not like, so you may want to experiement with it.<br />
<br />
When you perform the first function, do NOT put in any headers in the headers array parameters, you want to put it in the SECOND function you want to perform. If you put the headers in the first function, the second function will hide it from the mail servers. You do not want that. Here I will sign then encrypt.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Setup mail headers.<br />
</span><span class="default">$headers </span><span class="keyword">= array(</span><span class="string">"To" </span><span class="keyword">=&gt; </span><span class="string">"someone@nowhere.net"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; </span><span class="string">"From" </span><span class="keyword">=&gt; </span><span class="string">"noone@somewhere.net"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; </span><span class="string">"Subject" </span><span class="keyword">=&gt; </span><span class="string">"A signed and encrypted message."</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Sign the message first<br />
</span><span class="default">openssl_pkcs7_sign</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">,</span><span class="string">"signed.txt"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; </span><span class="string">"signing_cert.pem"</span><span class="keyword">,array(</span><span class="string">"private_key.pem"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; </span><span class="string">"password"</span><span class="keyword">),array());<br />
<br />
</span><span class="comment">// Get the public key certificate.<br />
</span><span class="default">$pubkey </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"cert.pem"</span><span class="keyword">);<br />
<br />
</span><span class="comment">//encrypt the message, now put in the headers.<br />
</span><span class="default">openssl_pkcs7_encrypt</span><span class="keyword">(</span><span class="string">"signed.txt"</span><span class="keyword">, </span><span class="string">"enc.txt"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$pubkey</span><span class="keyword">,</span><span class="default">$headers</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">);<br />
<br />
</span><span class="default">$data </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"enc.txt"</span><span class="keyword">);<br />
<br />
</span><span class="comment">// separate header and body, to use with mail function<br />
//&nbsp; unfortunate but required, else we have two sets of headers<br />
//&nbsp; and the email client doesn't decode the attachment<br />
</span><span class="default">$parts </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">"\n\n"</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);<br />
<br />
</span><span class="comment">// send mail (headers in the Headers parameter will override those<br />
//&nbsp; generated for the To &amp; Subject parameters)<br />
</span><span class="default">mail</span><span class="keyword">(</span><span class="default">$mail</span><span class="keyword">, </span><span class="default">$subject</span><span class="keyword">, </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
</span><span class="default">?&gt;<br />
</span><br />
Note that if you use a function that picks up the data from the disk to be used in another function in your program, remember that you may have used the explode("\n\n",$data,2) function which may have removed the spacing between the header and the message content.<br />
<br />
When you take the signed message and feed it in to the encryption part, you have to remember that the line spacing must also be fed AS PART OF THE MESSAGE BODY! If you plan to sign then encrypt, do not feed the header output from the signing into the encrypting as part of the headers array parameter! The output of the signing should stay as part of the message body being encrypted. (And the same is true if you are doing the reverse of encrypting then signing.) An example of both the signing and encryption function made in to a routine for reusability, and then called to sign and encrypt a message.<br />
<br />
THIS IS WRONG!:<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// [0] of Array contains headers of message. [1] of Array contains signed body of message.<br />
</span><span class="default">$signedOutputArray </span><span class="keyword">= </span><span class="default">signMessage</span><span class="keyword">(</span><span class="default">$inputMessage</span><span class="keyword">,</span><span class="default">$headers</span><span class="keyword">);<br />
<br />
</span><span class="comment">// [0] of Array contains headers of message and the signing.<br />
// [1] of Array contains encrypted body of message without the signing header.<br />
</span><span class="default">$signedAndEncryptedArray </span><span class="keyword">= </span><span class="default">encryptMessage</span><span class="keyword">(</span><span class="default">$signedOutputArray</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$signedOutputArray</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
<br />
</span><span class="default">mail</span><span class="keyword">(</span><span class="default">$emailAddr</span><span class="keyword">,</span><span class="default">$subject</span><span class="keyword">,</span><span class="default">$signedAndEncryptedArray</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$signedAndEncryptedArray</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
</span><span class="default">?&gt;<br />
</span><br />
THIS IS CORRECT!<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// [0] of Array contains headers of signing.<br />
// [1] of Array contains signed body of message.<br />
</span><span class="default">$signedOutputArray </span><span class="keyword">= </span><span class="default">signMessage</span><span class="keyword">(</span><span class="default">$inputMessage</span><span class="keyword">,array());<br />
<br />
</span><span class="comment">// [0] of Array contains headers of message.<br />
// [1] of Array contains encrypted contents of both the signed message and its headers of the signing.<br />
</span><span class="default">$signedAndEncryptedArray </span><span class="keyword">=<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">encryptMessage</span><span class="keyword">(</span><span class="default">$signedOutputArray</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] . </span><span class="string">"\n\n" </span><span class="keyword">. </span><span class="default">$signedOutputArray</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">$headers</span><span class="keyword">);<br />
<br />
</span><span class="default">mail</span><span class="keyword">(</span><span class="default">$emailAddr</span><span class="keyword">,</span><span class="default">$subject</span><span class="keyword">,</span><span class="default">$signedAndEncryptedArray</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$signedAndEncryptedArray</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="88645""></a>
  <div class="note">
   <strong class="user">yurchenko dot anton at gmail dot com</strong>
   <a href="#88645" class="date">02-Feb-2009 07:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I also spent hours when trying to find the reason of error:
<br />
"error getting private key". 
<br />

<br />
Sometimes this error appeared, sometimes not. 
<br />

<br />
My solution is using the realpath() for every parameter of openssl_pkcs7_sign. In my case the code looks like:
<br />

<br />
<span class="default">&lt;?php
<br />
$Certif_path </span><span class="keyword">= </span><span class="string">'certificate/mycertificate.pem'</span><span class="keyword">;
<br />

<br />
</span><span class="default">$clearfile </span><span class="keyword">= </span><span class="string">"certificate/random_name"</span><span class="keyword">;
<br />
</span><span class="default">$encfile </span><span class="keyword">= </span><span class="default">$clearfile </span><span class="keyword">. </span><span class="string">".enc"</span><span class="keyword">;
<br />
</span><span class="default">$clearfile </span><span class="keyword">= </span><span class="default">$clearfile </span><span class="keyword">. </span><span class="string">".txt"</span><span class="keyword">;
<br />

<br />
</span><span class="comment">// ---- 
<br />
// -- fill $clearfile with the mail to be signed ...
<br />
// ----
<br />

<br />
</span><span class="default">openssl_pkcs7_sign</span><span class="keyword">(</span><span class="default">realpath</span><span class="keyword">(</span><span class="default">$clearfile</span><span class="keyword">), 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">realpath</span><span class="keyword">(</span><span class="string">'.'</span><span class="keyword">).</span><span class="string">'/'</span><span class="keyword">.</span><span class="default">$encfile</span><span class="keyword">, </span><span class="comment">// because $encfile does not exist yet we cannot use realpath($encfile);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">'file://'</span><span class="keyword">.</span><span class="default">realpath</span><span class="keyword">(</span><span class="default">$Certif_path</span><span class="keyword">),
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(</span><span class="string">'file://'</span><span class="keyword">.</span><span class="default">realpath</span><span class="keyword">(</span><span class="default">$Certif_path</span><span class="keyword">), </span><span class="default">PUBLIC_KEY</span><span class="keyword">), 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(</span><span class="string">"To" </span><span class="keyword">=&gt; </span><span class="default">TO_EMAIL</span><span class="keyword">,
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">"From" </span><span class="keyword">=&gt; </span><span class="default">FROM_EMAIL</span><span class="keyword">,
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">"Subject" </span><span class="keyword">=&gt; </span><span class="string">""</span><span class="keyword">), 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">PKCS7_DETACHED</span><span class="keyword">));
<br />

<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73139""></a>
  <div class="note">
   <strong class="user">ungdi at hotmail dot com</strong>
   <a href="#73139" class="date">10-Feb-2007 10:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I would like to make a modification from my previous note. Some clients prefer a certain order in which messages should be signed and encrypted (if both is desired). Newer email clients, such as Thunderbird and Outlook 2003 will accept the most secure method of "sign -&gt; encrypt -&gt; sign again".<br />
<br />
Why?<br />
<br />
The first signing authenticates the message saying that you did indeed write it. Then the email is encrypted so that only the recipient can open and read it. Then the second signing ensure confidentiality by identifying that the person encrypting is the one whom encrypted it, a message intended for the decrypting person. This is the most secure method. This ensures: Non-Repudiation of message (first sign), Confidentiality (encrypt), and Context Integrity [you were intended to be addressed] (second sign).<br />
<br />
If you only sign then encrypt, there is no way you can guarantee that (aside from the contents of the letter, headers are placed in plain text outside the message) that the message was intended for you by the original sender. For example:<br />
<br />
Bob signs a love letter and encrypts it to Amy saying only "I love you. -- Bob". Amy decrypts it, sees the message (and plays a joke) and forwards the message to John using John's public key, re-encrypting, but not tampering with the message contents keeping the signature valid. This allows Amy to make it look like Bob sent John a love letter and that Bob loves John, as you cannot verify whom sent it during encryption. That is not what you want!<br />
<br />
This is also analogous to someone taking a government document, put it in an envelope themselves and write the government address in the return address and send it to you. You know the letter is written by the government, but you don't know for sure whether the government sent it to you directly or was opened and relayed.<br />
<br />
While encrypting then signing has a problem, this is affectively signing on the envelope of a snail mail piece. I know you sent it, but is the message really from you? Or are you forwarding it?<br />
<br />
Sign - Encrypt - Sign Again method will make the first sign show that you know the writer of the message is the person, encrypt it to keep others from reading it, sign again to indicate the message was not relayed and that the sender intended to sent the mail to address you.<br />
<br />
Just make sure the headers of the mail is applied in the last step and not the second or third step.<br />
<br />
For more information about the security and integrity risks of this situation, please read this web page: <a href="http://world.std.com/~dtd/sign_encrypt/sign_encrypt7.html" rel="nofollow" target="_blank">http://world.std.com/~dtd/sign_encrypt/sign_encrypt7.html</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="63971""></a>
  <div class="note">
   <strong class="user">dmitri at gmx dot net</strong>
   <a href="#63971" class="date">04-Apr-2006 10:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Working example:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$data </span><span class="keyword">= &lt;&lt;&lt; EOF<br />
</span><span class="string">Content-Type: text/plain;<br />
&nbsp;&nbsp;&nbsp; charset="us-ascii"<br />
Content-Transfer-Encoding: 7bit<br />
<br />
You have my authorization to spend 10,000 on dinner expenses.<br />
The CEO<br />
</span><span class="keyword">EOF;<br />
<br />
</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);<br />
</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
<br />
</span><span class="default">$headers </span><span class="keyword">= array(</span><span class="string">"From" </span><span class="keyword">=&gt; </span><span class="string">"me@email.com"</span><span class="keyword">);<br />
<br />
</span><span class="default">openssl_pkcs7_sign</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">, </span><span class="string">"signed.txt"</span><span class="keyword">, </span><span class="string">"file://email.pem"</span><span class="keyword">, array(</span><span class="string">"file://email.pem"</span><span class="keyword">, </span><span class="string">"123456"</span><span class="keyword">), </span><span class="default">$headers</span><span class="keyword">);<br />
<br />
</span><span class="default">$data </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"signed.txt"</span><span class="keyword">);<br />
<br />
</span><span class="default">$parts </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">"\n\n"</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);<br />
<br />
</span><span class="default">mail</span><span class="keyword">(</span><span class="string">"you@email.com"</span><span class="keyword">, </span><span class="string">"Signed message."</span><span class="keyword">, </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
<br />
echo </span><span class="string">"Email sent"</span><span class="keyword">;<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="49892""></a>
  <div class="note">
   <strong class="user">maarten at xolphin dot nl</strong>
   <a href="#49892" class="date">11-Feb-2005 11:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It is also possible to sign message including attachments. An easy way to do this:
<br />

<br />
<span class="default">&lt;?php
<br />
&nbsp; $boundary </span><span class="keyword">= </span><span class="default">md5</span><span class="keyword">(</span><span class="default">uniqid</span><span class="keyword">(</span><span class="default">time</span><span class="keyword">()));
<br />
&nbsp; </span><span class="default">$boddy </span><span class="keyword">= </span><span class="string">"MIME-Version: 1.0\n"</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Type: multipart/mixed; boundary=\"" </span><span class="keyword">. </span><span class="default">$boundary</span><span class="keyword">. </span><span class="string">"\"\n"</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Transfer-Encoding: quoted-printable\n\n"</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"This is a multi-part message in MIME format.\n\n"</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"--</span><span class="default">$boundary</span><span class="string">\n"</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Type: text/plain; charset=\"iso-8859-1\"\n"</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Transfer-Encoding: quoted-printable\n\n"</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="default">$EmailText </span><span class="keyword">. </span><span class="string">"\n\n"</span><span class="keyword">;
<br />
&nbsp; </span><span class="comment">// Add the attachment to the message
<br />
&nbsp; </span><span class="keyword">do&nbsp; {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"--</span><span class="default">$boundary</span><span class="string">\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Type: application/pdf; name=\"FileName\"\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Transfer-Encoding: base64\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Disposition: attachment;\n\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="default">chunk_split</span><span class="keyword">(</span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">)) . </span><span class="string">"\n\n"</span><span class="keyword">;
<br />
&nbsp; } while ( {</span><span class="default">files left to be attached</span><span class="keyword">} );
<br />
&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"--</span><span class="default">$boundary</span><span class="string">--\n"</span><span class="keyword">;
<br />

<br />
&nbsp; </span><span class="comment">// Save message to a file
<br />
&nbsp; </span><span class="default">$msg </span><span class="keyword">= </span><span class="string">'msg.txt'</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$signed </span><span class="keyword">= </span><span class="string">'signed.txt'</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$msg</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);
<br />
&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$boddy</span><span class="keyword">);
<br />
&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);
<br />

<br />
&nbsp; </span><span class="comment">// Sign it
<br />
&nbsp; </span><span class="keyword">if (</span><span class="default">openssl_pkcs7_sign</span><span class="keyword">(</span><span class="default">$msg</span><span class="keyword">, </span><span class="default">$signed</span><span class="keyword">, </span><span class="string">'file://cert.pem'</span><span class="keyword">,
<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">'file://key.pem'</span><span class="keyword">, </span><span class="string">'test'</span><span class="keyword">),
<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"To" </span><span class="keyword">=&gt; </span><span class="string">"joes@example.com"</span><span class="keyword">, </span><span class="comment">// keyed syntax
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">"From: HQ &lt;ceo@example.com&gt;"</span><span class="keyword">, </span><span class="comment">// indexed syntax
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">"Subject" </span><span class="keyword">=&gt; </span><span class="string">"Eyes only"</span><span class="keyword">), </span><span class="default">PKCS7_DETACHED</span><span class="keyword">, </span><span class="string">'intermediate_cert.pem' </span><span class="keyword">)) {&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">exec</span><span class="keyword">(</span><span class="default">ini_get</span><span class="keyword">(</span><span class="string">'sendmail_path'</span><span class="keyword">) . </span><span class="string">' &lt; ' </span><span class="keyword">. </span><span class="default">$signed</span><span class="keyword">);
<br />
&nbsp; }
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
The same can be established by using the PEAR package Mail_Mime in combination with openssl_pkcs7_sign.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="36653""></a>
  <div class="note">
   <strong class="user">Maciej_Niemir at ilim dot poznan dot pl</strong>
   <a href="#36653" class="date">17-Oct-2003 04:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This command doesn't work correctly on WIN32 with IIS. Mails aren?t interpreted correctly by IIS SMTP Server (and by Outlook too). The reason is that UNIX and WINDOWS interpret the ?enter to the next line? ascii code in a different way.
<br />

<br />
Below I present an improved code:
<br />

<br />
<span class="default">&lt;?php
<br />

<br />
$data </span><span class="keyword">= &lt;&lt;&lt;EOD
<br />
</span><span class="string">
<br />
Testing 123
<br />

<br />
This is a test
<br />

<br />
Test
<br />

<br />
</span><span class="keyword">EOD;
<br />

<br />
</span><span class="comment">//save the message to a file
<br />
</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">,</span><span class="string">"w"</span><span class="keyword">);
<br />
</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">$data</span><span class="keyword">);
<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);
<br />

<br />
</span><span class="comment">//sign the message using the sender's keys
<br />
</span><span class="default">openssl_pkcs7_sign</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">, </span><span class="string">"signed.eml"</span><span class="keyword">, </span><span class="string">"file://c:/max/cert.pem"</span><span class="keyword">,
<br />
array(</span><span class="string">"file://c:/max/priv.pem"</span><span class="keyword">,</span><span class="string">"your_password"</span><span class="keyword">),
<br />
array(</span><span class="string">"To" </span><span class="keyword">=&gt; </span><span class="string">"recipient &lt;recipients@mail.com&gt;"</span><span class="keyword">,
<br />
</span><span class="string">"From" </span><span class="keyword">=&gt; </span><span class="string">"sender &lt;sender@mail.com&gt;"</span><span class="keyword">,
<br />
</span><span class="string">"Subject" </span><span class="keyword">=&gt; </span><span class="string">"Order Notification - Test"</span><span class="keyword">),</span><span class="default">PKCS7_DETACHED</span><span class="keyword">,</span><span class="string">"c:\max\extra_cert.pem"</span><span class="keyword">);
<br />

<br />
</span><span class="default">$file_arry </span><span class="keyword">= </span><span class="default">file</span><span class="keyword">(</span><span class="string">"signed.eml"</span><span class="keyword">);
<br />
</span><span class="default">$file </span><span class="keyword">= </span><span class="default">join </span><span class="keyword">(</span><span class="string">""</span><span class="keyword">, </span><span class="default">$file_arry</span><span class="keyword">);
<br />
</span><span class="default">$message </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/\r\n|\r|\n/"</span><span class="keyword">, </span><span class="string">"\r\n"</span><span class="keyword">, </span><span class="default">$file</span><span class="keyword">);
<br />

<br />
</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"c:\Inetpub\mailroot\Pickup\signed.eml"</span><span class="keyword">, </span><span class="string">"wb"</span><span class="keyword">);
<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);
<br />
</span><span class="default">fputs</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$message</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);
<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);
<br />

<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Besides, if you want to use the keys created with Windows, you should export them (from IE) to the form of PKCS#12 file (*.pfx).
<br />

<br />
Install OpenSSLWin32 from
<br />
<a href="http://www.shininglightpro.com/search.php?searchname=Win32+OpenSSL" rel="nofollow" target="_blank">http://www.shininglightpro.com/search.php?searchname=Win32+OpenSSL</a>
<br />

<br />
execute: openssl.exe
<br />

<br />
enter the commands:
<br />

<br />
pkcs12 -in &lt;pfx-file&gt; -nokeys -out &lt;pem-certs-file&gt;
<br />

<br />
pkcs12 -in &lt;pfx-file&gt; -nocerts -nodes -out &lt;pem-key-file&gt;
<br />

<br />
Next export from IE Root CA certificate as Base-64 *.cer and rename the file to *.pem
<br />

<br />
And that's all!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="36038""></a>
  <div class="note">
   <strong class="user">php at toyingwithfate dot com</strong>
   <a href="#36038" class="date">23-Sep-2003 11:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It's probably worth noting that I had a great deal of difficulty getting either Mozilla 1.4 or Outlook Express 6 to verify signatures generated by openssl_pkcs7_sign() until I added a newline (\n) to the beginning of the message I was signing.&nbsp; Not sure why that is, but as soon as I made that change all problems disappeared.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="21212""></a>
  <div class="note">
   <strong class="user">del at babel dot com dot au</strong>
   <a href="#21212" class="date">03-May-2002 12:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The "mycert.pem" parameters as shown in the example above are not correct.&nbsp; You either have to pass a string containing the PEM encoded certificate or key, or the location of a file in file://path/to/file.pem notation.&nbsp; See the comments on the OpenSSL functions page (the page above this one).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="15290""></a>
  <div class="note">
   <strong class="user">meint dot post at bigfoot dot com</strong>
   <a href="#15290" class="date">05-Sep-2001 01:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want to integrate PKCS7 signing/verifying with a browser and it's not a problem that it's only Internet Explorer (or Netscape + ActiveX plugin) you can look at Capicom. It's a free component and available at the MSDN website.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
