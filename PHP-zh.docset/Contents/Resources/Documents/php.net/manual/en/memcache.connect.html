<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>打开一个memcached服务端连接</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="memcache.close.html">? Memcache::close</a></li>
      <li style="float: right;"><a href="memcache.decrement.html">Memcache::decrement ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="class.memcache.html">Memcache</a></li>
    <li>打开一个memcached服务端连接</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="memcache.connect" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">Memcache::connect</h1>
  <p class="verinfo">(PECL memcache &gt;= 0.2.0)</p><p class="refpurpose"><span class="refname">Memcache::connect</span> &mdash; <span class="dc-title">打开一个memcached服务端连接</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-memcache.connect-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><strong>Memcache::connect</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$host</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$port</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$timeout</code></span>
  ]] )</div>


  <p class="para rdfs-comment">
   <span class="function"><strong>Memcache::connect()</strong></span>建立一个到memcached服务端的连接。 使用方法
   <span class="function"><strong>Memcache::connect()</strong></span>打开的连接在脚本执行结束后会自动关闭。当然，你也可以使用方法
   <span class="function"><a href="memcache.close.html" class="function">Memcache::close()</a></span>来主动关闭。
   同时你也可以使用<span class="function"><strong>memcache_connect()</strong></span>函数来获取一个连接。
  </p>
 
 </div>

 
 <div class="refsect1 parameters" id="refsect1-memcache.connect-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">host</code></dt>

     <dd>

      <p class="para">
      memcached服务端监听主机地址。这个参数也可以指定为其他传输方式比如<em>unix:///path/to/memcached.sock</em>
      来使用Unix域socket，在这种方式下，<code class="parameter">port</code>参数必须设置为<em>0</em>。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">port</code></dt>

     <dd>

      <p class="para">
      memcached服务端监听端口。当使用Unix域socket的时候要设置此参数为<em>0</em>。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">timeout</code></dt>

     <dd>

      <p class="para">
      连接持续（超时）时间，单位秒。默认值1秒，修改此值之前请三思，过长的连接持续时间可能会导致失去所有的缓存优势。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-memcache.connect-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   成功时返回 <strong><code>TRUE</code></strong>， 或者在失败时返回 <strong><code>FALSE</code></strong>。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-memcache.connect-examples">
  <h3 class="title">范例</h3>
  <p class="para">
   <div class="example" id="example-4417">
    <p><strong>Example #1 <span class="function"><strong>Memcache::connect()</strong></span> example</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #FF8000">/*&nbsp;procedural&nbsp;API&nbsp;*/<br /><br /></span><span style="color: #0000BB">$memcache_obj&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">memcache_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">'memcache_host'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">11211</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;OO&nbsp;API&nbsp;*/<br /><br /></span><span style="color: #0000BB">$memcache&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Memcache</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$memcache</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connect</span><span style="color: #007700">(</span><span style="color: #DD0000">'memcache_host'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">11211</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-memcache.connect-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="memcache.pconnect.html" class="function" rel="rdfs-seeAlso">Memcache::pconnect()</a> - 打开一个到服务器的持久化连接</span></li>
    <li class="member"><span class="function"><a href="memcache.close.html" class="function" rel="rdfs-seeAlso">Memcache::close()</a> - 关闭memcache连接</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="114989""></a>
  <div class="note">
   <strong class="user">webysther at gmail dot com</strong>
   <a href="#114989" class="date">10-May-2014 01:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In describing the timeout there is a statement that is not completely correct, increase the timeout does not necessarily preclude or unfeasible memcache, only allows the system to wait for more concurrent connections, which is a large minority of the number of connections, this causes several problems and could simply be corrected if the timeout was increased and perform some tests. <br />
To prove the concept and show that the connection does not wait if the server goes down:<br />
<br />
<span class="default">&lt;?PHP<br />
<br />
</span><span class="keyword">while ( ++</span><span class="default">$loop </span><span class="keyword">&lt; </span><span class="default">10000 </span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; try {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$memcache </span><span class="keyword">= new </span><span class="default">Memcache</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; @</span><span class="default">$memcache</span><span class="keyword">-&gt;</span><span class="default">pconnect</span><span class="keyword">( </span><span class="string">"127.0.0.1" </span><span class="keyword">, </span><span class="default">11211 </span><span class="keyword">, </span><span class="default">30 </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$loopset </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$loopget </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while ( ++</span><span class="default">$loopset </span><span class="keyword">&lt; </span><span class="default">50 </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if ( @</span><span class="default">$memcache</span><span class="keyword">-&gt;</span><span class="default">set</span><span class="keyword">( </span><span class="string">"foo" </span><span class="keyword">, </span><span class="string">"bar" </span><span class="keyword">) === </span><span class="default">false </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Fail!" </span><span class="keyword">. </span><span class="default">PHP_EOL</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while ( ++</span><span class="default">$loopget </span><span class="keyword">&lt; </span><span class="default">500 </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if ( @</span><span class="default">$memcache</span><span class="keyword">-&gt;</span><span class="default">get</span><span class="keyword">( </span><span class="string">"foo" </span><span class="keyword">) === </span><span class="default">false </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Fail!" </span><span class="keyword">. </span><span class="default">PHP_EOL</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ( </span><span class="default">$loop </span><span class="keyword">% </span><span class="default">100 </span><span class="keyword">== </span><span class="default">0 </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Try: " </span><span class="keyword">. </span><span class="default">$loop </span><span class="keyword">. </span><span class="default">PHP_EOL</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; } catch ( </span><span class="default">Exception $e </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Fail: " </span><span class="keyword">. </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="default">PHP_EOL</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Replace with an invalid host and test the timeout will not make a difference! It serves only for connections to the socket that are occupied.<br />
<br />
More detail about troubleshooting timeouts in memcached google code.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="106786""></a>
  <div class="note">
   <strong class="user">tom at all dash community dot de</strong>
   <a href="#106786" class="date">06-Dec-2011 04:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There is a not-so-obvious way to check whether or not a MemCache-Server is available.<br />
<br />
Using ($memCache-&gt;connect() == false) will wait for a timeout if it can't connect. If you got a high-traffic site this may not be an option. So when the server is down, you may want to avoid waiting for this timeout on every request and instead try to reconnect only once every X seconds.<br />
<br />
If so, this code may help:<br />
<br />
<span class="default">&lt;?php<br />
$memCache </span><span class="keyword">= new \</span><span class="default">Memcache</span><span class="keyword">();<br />
</span><span class="default">$memCache</span><span class="keyword">-&gt;</span><span class="default">addServer</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
</span><span class="default">$stats </span><span class="keyword">= @</span><span class="default">$memCache</span><span class="keyword">-&gt;</span><span class="default">getExtendedStats</span><span class="keyword">();<br />
</span><span class="default">$available </span><span class="keyword">= (bool) </span><span class="default">$stats</span><span class="keyword">[</span><span class="string">"</span><span class="default">$host</span><span class="string">:</span><span class="default">$port</span><span class="string">"</span><span class="keyword">];<br />
if (</span><span class="default">$available </span><span class="keyword">&amp;&amp; @</span><span class="default">$memCache</span><span class="keyword">-&gt;</span><span class="default">connect</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">))<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// MemCache is there<br />
</span><span class="keyword">else<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// go on without MemCache<br />
</span><span class="default">?&gt;<br />
</span><br />
The result of getExtendedStats() is an array. The information is cached and maintained by MemCache itself. If the server is not available, the result will be FALSE.<br />
<br />
Even if the result is not false, the server may still not be available. Thus you need to check for connect() != false too, but only if the first check returns TRUE, thus avoiding the 1 second timeout in most cases.<br />
Both getExtendedStats() and connect() issue notices/warnings if the server is not there. Thus you have to mute both calls.<br />
<br />
Do NOT use getServerStatus() for this purpose: the result is cached on server-start and will not recognize when the connection to the server is lost (or reestablished) in between.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="103928""></a>
  <div class="note">
   <strong class="user">djbrd</strong>
   <a href="#103928" class="date">11-May-2011 08:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To suppress (or handle) the warning and notice thrown by a failed attempt to connect, you can use a custom error handler function, like this:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">myErrorHandler</span><span class="keyword">(</span><span class="default">$errno</span><span class="keyword">, </span><span class="default">$errstr</span><span class="keyword">, </span><span class="default">$errfile</span><span class="keyword">, </span><span class="default">$errline</span><span class="keyword">)
<br />
{
<br />

<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">E_WARNING </span><span class="keyword">=== </span><span class="default">$errno</span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">Log</span><span class="keyword">(</span><span class="string">"PHP Warning: </span><span class="default">$errstr</span><span class="string">, </span><span class="default">$errfile</span><span class="string">, </span><span class="default">$errline</span><span class="string">"</span><span class="keyword">, </span><span class="default">Logging</span><span class="keyword">::</span><span class="default">WARN</span><span class="keyword">); 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">E_NOTICE </span><span class="keyword">=== </span><span class="default">$errno</span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">Log</span><span class="keyword">(</span><span class="string">"PHP Notic: </span><span class="default">$errstr</span><span class="string">, </span><span class="default">$errfile</span><span class="string">, </span><span class="default">$errline</span><span class="string">"</span><span class="keyword">, </span><span class="default">Logging</span><span class="keyword">::</span><span class="default">NOTICE</span><span class="keyword">); 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }&nbsp; &nbsp; 
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;
<br />
}
<br />

<br />
</span><span class="default">set_error_handler</span><span class="keyword">(</span><span class="string">'myErrorHandler'</span><span class="keyword">);
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99461""></a>
  <div class="note">
   <strong class="user">geoffrey dot hoffman at gmail dot com</strong>
   <a href="#99461" class="date">18-Aug-2010 09:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If memcached is working, calling memcache_connect( ) returns an Object instance, not a boolean. If memcached is not working, calling memcache_connect( ) throws a notice AND a warning (and returns false as expected). <br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/* memcache is running */<br />
</span><span class="default">$test1 </span><span class="keyword">= </span><span class="default">memcache_connect</span><span class="keyword">(</span><span class="string">'127.0.0.1'</span><span class="keyword">,</span><span class="default">11211</span><span class="keyword">);<br />
echo </span><span class="default">gettype</span><span class="keyword">(</span><span class="default">$test1</span><span class="keyword">);<br />
</span><span class="comment">// object<br />
</span><span class="keyword">echo </span><span class="default">get_class</span><span class="keyword">(</span><span class="default">$test1</span><span class="keyword">);<br />
</span><span class="comment">// Memcache<br />
<br />
/* memcached is stopped */<br />
</span><span class="default">$test2 </span><span class="keyword">= </span><span class="default">memcache_connect</span><span class="keyword">(</span><span class="string">'127.0.0.1'</span><span class="keyword">,</span><span class="default">11211</span><span class="keyword">);<br />
<br />
</span><span class="comment">/*<br />
Notice: memcache_connect(): Server 127.0.0.1 (tcp 11211) failed with: A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond.<br />
&nbsp;(10060) in C:\Program Files\Support Tools\- on line 1<br />
<br />
Warning: memcache_connect(): Can't connect to 127.0.0.1:11211, A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond.<br />
&nbsp;(10060) in C:\Program Files\Support Tools\- on line 1<br />
*/<br />
<br />
</span><span class="keyword">echo </span><span class="default">gettype</span><span class="keyword">(</span><span class="default">$test2</span><span class="keyword">);<br />
</span><span class="comment">// boolean<br />
</span><span class="keyword">echo </span><span class="default">$test2</span><span class="keyword">===</span><span class="default">false</span><span class="keyword">;<br />
</span><span class="comment">// 1<br />
</span><span class="default">?&gt;<br />
</span><br />
There appears to be no way to check whether memcached is actually running without resorting to error suppression:<br />
<br />
<span class="default">&lt;?php<br />
$test3 </span><span class="keyword">= @</span><span class="default">memcache_connect</span><span class="keyword">(</span><span class="string">'127.0.0.1'</span><span class="keyword">,</span><span class="default">11211</span><span class="keyword">);<br />
if( </span><span class="default">$test3</span><span class="keyword">===</span><span class="default">false </span><span class="keyword">){<br />
&nbsp;&nbsp; </span><span class="comment">// memcached is _probably_ not running<br />
</span><span class="keyword">}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="69405""></a>
  <div class="note">
   <strong class="user">chrisn at allipo dot com</strong>
   <a href="#69405" class="date">05-Sep-2006 10:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The behavior of Memcache::connect() is to always reinitialize the pool from scratch regardless of any previous calls to addServer().
<br />

<br />
E.g.
<br />

<br />
<span class="default">&lt;?php
<br />
$mmc </span><span class="keyword">= new </span><span class="default">Memcache</span><span class="keyword">()
<br />
</span><span class="default">$mmc</span><span class="keyword">-&gt;</span><span class="default">addServer</span><span class="keyword">(</span><span class="string">'node1'</span><span class="keyword">, </span><span class="default">11211</span><span class="keyword">);
<br />
</span><span class="default">$mmc</span><span class="keyword">-&gt;</span><span class="default">addServer</span><span class="keyword">(</span><span class="string">'node2'</span><span class="keyword">, </span><span class="default">11211</span><span class="keyword">);
<br />
</span><span class="default">$mmc</span><span class="keyword">-&gt;</span><span class="default">addServer</span><span class="keyword">(</span><span class="string">'node3'</span><span class="keyword">, </span><span class="default">11211</span><span class="keyword">);
<br />

<br />
</span><span class="default">$mmc</span><span class="keyword">-&gt;</span><span class="default">connect</span><span class="keyword">(</span><span class="string">'node1'</span><span class="keyword">, </span><span class="default">11211</span><span class="keyword">);
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
The last connect() call clears out the pool and then add and connect node1:11211 making it the only server.
<br />

<br />
If you want a pool of memcache servers, do not use the connect() function.
<br />

<br />
If you only want a single memcache server then there is no need to use the addServer() function.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
