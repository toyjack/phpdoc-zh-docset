<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>取得使用 TrueType 字体的文本的范围</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.imagetruecolortopalette.html">? imagetruecolortopalette</a></li>
      <li style="float: right;"><a href="function.imagettftext.html">imagettftext ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.image.html">GD 和图像处理 函数</a></li>
    <li>取得使用 TrueType 字体的文本的范围</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.imagettfbbox" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">imagettfbbox</h1>
  <p class="verinfo">(PHP 4, PHP 5, PHP 7)</p><p class="refpurpose"><span class="refname">imagettfbbox</span> &mdash; <span class="dc-title">取得使用 TrueType 字体的文本的范围</span></p>

 </div>
 <div class="refsect1 unknown-notet" id="refsect1-function.imagettfbbox-unknown-notet">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">array</span> <span class="methodname"><strong>imagettfbbox</strong></span>
    ( <span class="methodparam"><span class="type">float</span> <code class="parameter">$size</code></span>
   , <span class="methodparam"><span class="type">float</span> <code class="parameter">$angle</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$fontfile</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$text</code></span>
   )</div>

  <p class="para rdfs-comment">
   本函数计算并返回一个包围着 TrueType 文本范围的虚拟方框的像素大小。
   <dl>

    
     <dt>

      <code class="parameter">size</code>
     </dt>

     <dd>

      <span class="simpara">像素单位的字体大小。</span>
     </dd>

    
    
     <dt>

      <code class="parameter">angle</code>
     </dt>

     <dd>

      <span class="simpara"><code class="parameter">text</code> 将被度量的角度大小。</span>
     </dd>

    
    
     <dt>

      <code class="parameter">fontfile</code>
     </dt>

     <dd>

      <span class="simpara">
       TrueType 字体文件的文件名（可以是 URL）。根据 PHP
       所使用的 GD 库版本，可能尝试搜索那些不是以 &#039;/&#039;
       开头的文件名并加上 &#039;.ttf&#039; 的后缀并搜索库定义的字体路径。
      </span>
     </dd>

    
    
     <dt>

      <code class="parameter">text</code>
     </dt>

     <dd>

      <span class="simpara">要度量的字符串。</span>
     </dd>

    
   </dl>

   <span class="function"><strong>imagettfbbox()</strong></span> 返回一个含有 8
   个单元的数组表示了文本外框的四个角：
   <table class="doctable informaltable">
    
     <tbody class="tbody">
      <tr>
       <td>0</td>
       <td>左下角 X 位置</td>
      </tr>

      <tr>
       <td>1</td>
       <td>左下角 Y 位置</td>
      </tr>

      <tr>
       <td>2</td>
       <td>右下角 X 位置</td>
      </tr>

      <tr>
       <td>3</td>
       <td>右下角 Y 位置</td>
      </tr>

      <tr>
       <td>4</td>
       <td>右上角 X 位置</td>
      </tr>

      <tr>
       <td>5</td>
       <td>右上角 Y 位置</td>
      </tr>

      <tr>
       <td>6</td>
       <td>左上角 X 位置</td>
      </tr>

      <tr>
       <td>7</td>
       <td>左上角 Y 位置</td>
      </tr>

     </tbody>
    
   </table>

   这些点是相对于<em class="emphasis">文本</em>的而和角度无关，因此"左上角"指的是以水平方向看文字时其左上角。
  </p>
  <p class="para">
   本函数同时需要 GD 库和 FreeType 库。
  </p>
  <p class="para">
   参见 <span class="function"><a href="function.imagettftext.html" class="function">imagettftext()</a></span>。
  </p>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="118677""></a>
  <div class="note">
   <strong class="user">gw at example dot com</strong>
   <a href="#118677" class="date">19-Jan-2016 02:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
a little something to replace in blackbart tip :<br />
<br />
// start scanning (0=&gt; black =&gt; empty) <br />
&nbsp; $rleft&nbsp; = $w4 = $width&lt;&lt;2; <br />
&nbsp; $rright = 0; <br />
&nbsp; $rbottom&nbsp;&nbsp; = 0; <br />
&nbsp; $rtop = $h4 = $height&lt;&lt;2; <br />
&nbsp; for( $x = 0; $x &lt; $w4; $x++ ) <br />
&nbsp;&nbsp;&nbsp; for( $y = 0; $y &lt; $h4; $y++ ) <br />
&nbsp;&nbsp; &nbsp;&nbsp; if( imagecolorat( $img, $x, $y ) ){ <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $rleft&nbsp;&nbsp; = min( $rleft, $x ); <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $rright&nbsp; = max( $rright, $x ); <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $rtop&nbsp; &nbsp; = min( $rtop, $y ); <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $rbottom = max( $rbottom, $y ); <br />
&nbsp;&nbsp; &nbsp;&nbsp; } <br />
<br />
with<br />
<br />
// start scanning (0=&gt; black =&gt; empty) <br />
&nbsp; $break = false;<br />
&nbsp; $rleft&nbsp; = $w4 = $width&lt;&lt;2; <br />
&nbsp; $rright = 0; <br />
&nbsp; $rbottom&nbsp;&nbsp; = 0; <br />
&nbsp; $rtop = $h4 = $height&lt;&lt;2; <br />
&nbsp; // scanning from left to right, breaking when a pixel is found, to scan from the other side : avoid scanning all pixels !<br />
&nbsp; for($x=0; $x&lt;$w4; $x++){<br />
&nbsp;&nbsp;&nbsp; for($y=0; $y&lt;$h4; $y++)<br />
&nbsp;&nbsp; &nbsp;&nbsp; if(imagecolorat($img,$x,$y)){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $rtop = min($rtop, $y); $rleft = min($rleft, $x);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $break = true; break;<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; if($break) break;<br />
&nbsp; }<br />
&nbsp; // scanning from right to left, breaking when a pixel is found<br />
&nbsp; for($x=($w4-1); $x&gt;$rleft; $x--){<br />
&nbsp;&nbsp;&nbsp; for($y=0; $y&lt;$h4; $y++)<br />
&nbsp;&nbsp; &nbsp;&nbsp; if(imagecolorat($img,$x,$y)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $rright = max($rright, $x); $rbottom = max($rbottom, $y);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $break = true; break;<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; if($break) break;<br />
&nbsp; }<br />
//... //<br />
<br />
it may be even better to check if the picture is portrait or landscape, to start the loops from left-right(landscape) or top-bottom (portrait)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117234""></a>
  <div class="note">
   <strong class="user">indraaaa34 at gmail dot com</strong>
   <a href="#117234" class="date">07-May-2015 09:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The returned array order is like this:<br />
-----------------------------<br />
| X:4&nbsp; Y:5&nbsp; &nbsp; &nbsp; | X:&nbsp;&nbsp; Y:7&nbsp; &nbsp; &nbsp; &nbsp; |<br />
-----------------------------<br />
| X:0&nbsp; Y:1&nbsp; &nbsp; &nbsp; | X:2&nbsp; Y:3&nbsp; &nbsp; &nbsp;&nbsp; |<br />
-----------------------------<br />
<br />
eg:<br />
4 for the upper left X <br />
5 for the upper left Y and so on.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116999""></a>
  <div class="note">
   <strong class="user">user107</strong>
   <a href="#116999" class="date">01-Apr-2015 12:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I found a simple solution that was working for me:<br />
<br />
&nbsp;<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(!isset(</span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'size'</span><span class="keyword">])) </span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'size'</span><span class="keyword">] = </span><span class="default">44</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; if(!isset(</span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'text'</span><span class="keyword">])) </span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'text'</span><span class="keyword">] = </span><span class="string">"Hello, world!"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$size </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'size'</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">, </span><span class="string">"ARIAL"</span><span class="keyword">, </span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'text'</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$xsize </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]) + </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ysize </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">]) + </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$image </span><span class="keyword">= </span><span class="default">imagecreate</span><span class="keyword">(</span><span class="default">$xsize</span><span class="keyword">, </span><span class="default">$ysize</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$blue </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$white </span><span class="keyword">= </span><span class="default">ImageColorAllocate</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">,</span><span class="default">255</span><span class="keyword">,</span><span class="default">255</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'size'</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">, </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]), </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">]), </span><span class="default">$white</span><span class="keyword">, </span><span class="string">"ARIAL"</span><span class="keyword">, </span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'text'</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">"content-type: image/png"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span> <br />
<br />
Here is the link with a examples:<br />
<a href="http://www.tuxradar.com/practicalphp/11/2/6#null" rel="nofollow" target="_blank">http://www.tuxradar.com/practicalphp/11/2/6#null</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111922""></a>
  <div class="note">
   <strong class="user">rasmus at mindplay dot dk</strong>
   <a href="#111922" class="date">11-Apr-2013 10:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It should be noted that the bounding box coordinates returned by this function are inaccurate - bug reports about this have been open for 5 years, so expect this will likely never be fixed. <br />
<br />
More information here:<br />
<br />
https://gist.github.com/mindplay-dk/4429153</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="109589""></a>
  <div class="note">
   <strong class="user">go4christian at gmail dot com</strong>
   <a href="#109589" class="date">01-Aug-2012 12:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Automatic line breaks: This simple function is able automatically create line breaks if you want to write a text on an image. All you have to specify is a maximum length.
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">write_multiline_text</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$font_size</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">, </span><span class="default">$start_x</span><span class="keyword">, </span><span class="default">$start_y</span><span class="keyword">, </span><span class="default">$max_width</span><span class="keyword">) 
<br />
{
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//split the string
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; //build new string word for word
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; //check everytime you add a word if string still fits
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; //otherwise, remove last word, post current string and start fresh on a new line
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$words </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">" "</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$string </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmp_string </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">count</span><span class="keyword">(</span><span class="default">$words</span><span class="keyword">); </span><span class="default">$i</span><span class="keyword">++)
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmp_string </span><span class="keyword">.= </span><span class="default">$words</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">" "</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//check size of string
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dim </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$font_size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$tmp_string</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$dim</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">] &lt; </span><span class="default">$max_width</span><span class="keyword">)
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$string </span><span class="keyword">= </span><span class="default">$tmp_string</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">--;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmp_string </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">11</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$start_x</span><span class="keyword">, </span><span class="default">$start_y</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$string </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$start_y </span><span class="keyword">+= </span><span class="default">22</span><span class="keyword">; </span><span class="comment">//change this to adjust line-height. Additionally you could use the information from the "dim" array to automatically figure out how much you have to "move down"
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">11</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$start_x</span><span class="keyword">, </span><span class="default">$start_y</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">); </span><span class="comment">//"draws" the rest of the string
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="108955""></a>
  <div class="note">
   <strong class="user">magnum dot tc dot mr at gmail dot com</strong>
   <a href="#108955" class="date">08-Jun-2012 07:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please note that the 3rd argument is really a "path". 
<br />
<span class="default">&lt;?php
<br />
imagettfbbox</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="string">'arial.ttf'</span><span class="keyword">, </span><span class="string">'Hello, World!'</span><span class="keyword">);&nbsp; </span><span class="comment">// will result in "Warning: imagettfbbox(): Could not find/open font in ...php on line ..."
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
use instead something like this:
<br />
<span class="default">&lt;?php imagettfbbox</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="string">'./arial.ttf'</span><span class="keyword">, </span><span class="string">'Hello, World!'</span><span class="keyword">); </span><span class="default">?&gt;
<br />
</span>or
<br />
<span class="default">&lt;?php imagettfbbox</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">getcwd</span><span class="keyword">().</span><span class="string">'/arial.ttf'</span><span class="keyword">, </span><span class="string">'Hello, World!'</span><span class="keyword">); </span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="108536""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#108536" class="date">04-May-2012 10:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It seems to be worth pointing out that the "points" unit GD2 is using corresponds to 96 dpi, as defined in gd.h:<br />
#define GD_RESOLUTION&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 96&nbsp; &nbsp; &nbsp; /* pixels per inch */<br />
<br />
So if you want to translate the bbox back to font points, you need to multiply all coordinates by 72/96 = 3/4.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105593""></a>
  <div class="note">
   <strong class="user">jodybrabec at gmail dot com</strong>
   <a href="#105593" class="date">31-Aug-2011 12:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Very CLEAR version of func., with example....
<br />

<br />
<span class="default">&lt;?php
<br />

<br />
</span><span class="keyword">function </span><span class="default">calculateTextBox</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">,</span><span class="default">$fontFile</span><span class="keyword">,</span><span class="default">$fontSize</span><span class="keyword">,</span><span class="default">$fontAngle</span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/************
<br />
&nbsp;&nbsp;&nbsp; simple function that calculates the *exact* bounding box (single pixel precision). 
<br />
&nbsp;&nbsp;&nbsp; The function returns an associative array with these keys: 
<br />
&nbsp;&nbsp;&nbsp; left, top:&nbsp; coordinates you will pass to imagettftext 
<br />
&nbsp;&nbsp;&nbsp; width, height: dimension of the image you have to create 
<br />
&nbsp;&nbsp;&nbsp; *************/
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$rect </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$fontSize</span><span class="keyword">,</span><span class="default">$fontAngle</span><span class="keyword">,</span><span class="default">$fontFile</span><span class="keyword">,</span><span class="default">$text</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$minX </span><span class="keyword">= </span><span class="default">min</span><span class="keyword">(array(</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">]));
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$maxX </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">(array(</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">]));
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$minY </span><span class="keyword">= </span><span class="default">min</span><span class="keyword">(array(</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]));
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$maxY </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">(array(</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]));
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; return array(
<br />
&nbsp;&nbsp; &nbsp; </span><span class="string">"left"&nbsp;&nbsp; </span><span class="keyword">=&gt; </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$minX</span><span class="keyword">) - </span><span class="default">1</span><span class="keyword">,
<br />
&nbsp;&nbsp; &nbsp; </span><span class="string">"top"&nbsp; &nbsp; </span><span class="keyword">=&gt; </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$minY</span><span class="keyword">) - </span><span class="default">1</span><span class="keyword">,
<br />
&nbsp;&nbsp; &nbsp; </span><span class="string">"width"&nbsp; </span><span class="keyword">=&gt; </span><span class="default">$maxX </span><span class="keyword">- </span><span class="default">$minX</span><span class="keyword">,
<br />
&nbsp;&nbsp; &nbsp; </span><span class="string">"height" </span><span class="keyword">=&gt; </span><span class="default">$maxY </span><span class="keyword">- </span><span class="default">$minY</span><span class="keyword">,
<br />
&nbsp;&nbsp; &nbsp; </span><span class="string">"box"&nbsp; &nbsp; </span><span class="keyword">=&gt; </span><span class="default">$rect
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">);
<br />
}
<br />

<br />
</span><span class="comment">// Example usage - gif image output
<br />

<br />
</span><span class="default">$text_string&nbsp; &nbsp; </span><span class="keyword">= </span><span class="string">"Hullo World"</span><span class="keyword">;
<br />
</span><span class="default">$font_ttf&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="string">"./fonts/arial.ttf"</span><span class="keyword">;
<br />
</span><span class="default">$font_size&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">22</span><span class="keyword">;
<br />
</span><span class="default">$text_angle&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
</span><span class="default">$text_padding&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">; </span><span class="comment">// Img padding - around text
<br />

<br />
</span><span class="default">$the_box&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">calculateTextBox</span><span class="keyword">(</span><span class="default">$text_string</span><span class="keyword">, </span><span class="default">$font_ttf</span><span class="keyword">, </span><span class="default">$font_size</span><span class="keyword">, </span><span class="default">$text_angle</span><span class="keyword">);
<br />

<br />
</span><span class="default">$imgWidth&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">$the_box</span><span class="keyword">[</span><span class="string">"width"</span><span class="keyword">] + </span><span class="default">$text_padding</span><span class="keyword">;
<br />
</span><span class="default">$imgHeight&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">$the_box</span><span class="keyword">[</span><span class="string">"height"</span><span class="keyword">] + </span><span class="default">$text_padding</span><span class="keyword">; 
<br />

<br />
</span><span class="default">$image </span><span class="keyword">= </span><span class="default">imagecreate</span><span class="keyword">(</span><span class="default">$imgWidth</span><span class="keyword">,</span><span class="default">$imgHeight</span><span class="keyword">);
<br />
</span><span class="default">imagefill</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">,</span><span class="default">200</span><span class="keyword">,</span><span class="default">200</span><span class="keyword">,</span><span class="default">200</span><span class="keyword">));
<br />

<br />
</span><span class="default">$color </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">);
<br />
</span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">,
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$font_size</span><span class="keyword">,
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$text_angle</span><span class="keyword">,
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$the_box</span><span class="keyword">[</span><span class="string">"left"</span><span class="keyword">] + (</span><span class="default">$imgWidth </span><span class="keyword">/ </span><span class="default">2</span><span class="keyword">) - (</span><span class="default">$the_box</span><span class="keyword">[</span><span class="string">"width"</span><span class="keyword">] / </span><span class="default">2</span><span class="keyword">),
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$the_box</span><span class="keyword">[</span><span class="string">"top"</span><span class="keyword">] + (</span><span class="default">$imgHeight </span><span class="keyword">/ </span><span class="default">2</span><span class="keyword">) - (</span><span class="default">$the_box</span><span class="keyword">[</span><span class="string">"height"</span><span class="keyword">] / </span><span class="default">2</span><span class="keyword">),
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$color</span><span class="keyword">,
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$font_ttf</span><span class="keyword">,
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$text_string</span><span class="keyword">);
<br />

<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-Type: image/gif"</span><span class="keyword">);
<br />
</span><span class="default">imagegif</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);
<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);
<br />

<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
[ remember: No spaces before or after the <span class="default">&lt;?php </span><span class="keyword">... </span><span class="default">?&gt;</span> tag, because of header() call, you Roast! ]</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104030""></a>
  <div class="note">
   <strong class="user">phpcity at phpcountry dot net</strong>
   <a href="#104030" class="date">18-May-2011 03:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I could in no way reproduce this function's example if I was to use any accented letter.<br />
<br />
Replacing imagecreatetruecolor by imagecreate worked correctly with accents.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101684""></a>
  <div class="note">
   <strong class="user">Andrey Zakharov</strong>
   <a href="#101684" class="date">05-Jan-2011 12:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For mixed text drawing on image, height given by this function is useless and leads to text's hip-hops over the baseline .<br />
<br />
I will use just this:<br />
<span class="default">&lt;?php<br />
$size </span><span class="keyword">= </span><span class="default">12</span><span class="keyword">;</span><span class="comment">//font height<br />
</span><span class="default">$font </span><span class="keyword">= </span><span class="string">'Arial'</span><span class="keyword">;</span><span class="comment">// your font<br />
</span><span class="default">$char </span><span class="keyword">= </span><span class="string">'Test'</span><span class="keyword">;<br />
</span><span class="default">$char </span><span class="keyword">= </span><span class="string">'With W'</span><span class="keyword">;<br />
</span><span class="default">$char </span><span class="keyword">= </span><span class="string">'without w but with p and y and q'</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$rect </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$char</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$image_height </span><span class="keyword">=</span><span class="default">abs</span><span class="keyword">( </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">] );</span><span class="comment">//do no respect bottom margin<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$imw </span><span class="keyword">= </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">//as usual<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bx </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">( </span><span class="default">$rect</span><span class="keyword">[ </span><span class="default">0 </span><span class="keyword">] ); </span><span class="comment">// X offset <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$by </span><span class="keyword">= </span><span class="default">$size </span><span class="keyword">* </span><span class="default">1.25</span><span class="keyword">; </span><span class="comment">// Y offset - we will use const LINEHEIGHT<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101537""></a>
  <div class="note">
   <strong class="user">a2hansolo at gmail dot com</strong>
   <a href="#101537" class="date">23-Dec-2010 08:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
measure bg image size, wrap text to fit image width
<br />

<br />
<span class="default">&lt;?php
<br />
$mx </span><span class="keyword">= </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$main_img</span><span class="keyword">);
<br />
</span><span class="default">$my </span><span class="keyword">= </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$main_img</span><span class="keyword">);
<br />

<br />
</span><span class="comment">//TEXT VARS/////////
<br />
</span><span class="default">$main_text </span><span class="keyword">= ;
<br />
</span><span class="default">$main_text_size </span><span class="keyword">= ;
<br />
</span><span class="default">$main_text_x </span><span class="keyword">= (</span><span class="default">$mx</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">);
<br />

<br />
</span><span class="default">$main_text_color </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$main_img</span><span class="keyword">, </span><span class="default">$main_text_red</span><span class="keyword">, </span><span class="default">$main_text_green</span><span class="keyword">, </span><span class="default">$main_text_blue</span><span class="keyword">);
<br />
</span><span class="default">$words </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">' '</span><span class="keyword">, </span><span class="default">$main_text</span><span class="keyword">);
<br />
</span><span class="default">$lines </span><span class="keyword">= array(</span><span class="default">$words</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]); 
<br />
</span><span class="default">$currentLine </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; for(</span><span class="default">$i </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">count</span><span class="keyword">(</span><span class="default">$words</span><span class="keyword">); </span><span class="default">$i</span><span class="keyword">++)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lineSize </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$main_text_size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$mt_f</span><span class="keyword">, </span><span class="default">$lines</span><span class="keyword">[</span><span class="default">$currentLine</span><span class="keyword">] . </span><span class="string">' ' </span><span class="keyword">. </span><span class="default">$words</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$lineSize</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$lineSize</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] &lt; </span><span class="default">$mx</span><span class="keyword">)
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lines</span><span class="keyword">[</span><span class="default">$currentLine</span><span class="keyword">] .= </span><span class="string">' ' </span><span class="keyword">. </span><span class="default">$words</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$currentLine</span><span class="keyword">++;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lines</span><span class="keyword">[</span><span class="default">$currentLine</span><span class="keyword">] = </span><span class="default">$words</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } 
<br />
&nbsp;&nbsp;&nbsp; }
<br />
</span><span class="default">$line_count </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;
<br />
</span><span class="comment">// Loop through the lines and place them on the image
<br />
</span><span class="keyword">foreach (</span><span class="default">$lines </span><span class="keyword">as </span><span class="default">$line</span><span class="keyword">)
<br />
{
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$line_box </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$main_text_size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$mt_f</span><span class="keyword">, </span><span class="string">"</span><span class="default">$line</span><span class="string">"</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$line_width </span><span class="keyword">= </span><span class="default">$line_box</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]+</span><span class="default">$line_box</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">];
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$line_height </span><span class="keyword">= </span><span class="default">$line_box</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]-</span><span class="default">$line_box</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">];
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$line_margin </span><span class="keyword">= (</span><span class="default">$mx</span><span class="keyword">-</span><span class="default">$line_width</span><span class="keyword">)/</span><span class="default">2</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$line_y </span><span class="keyword">= ((</span><span class="default">$line_height</span><span class="keyword">+</span><span class="default">12</span><span class="keyword">) * </span><span class="default">$line_count</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$main_img</span><span class="keyword">, </span><span class="default">$main_t_s</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$line_margin</span><span class="keyword">, </span><span class="default">$line_y</span><span class="keyword">, </span><span class="default">$main_text_color</span><span class="keyword">, </span><span class="default">$mt_f</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);
<br />

<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Increment Y so the next line is below the previous line
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$line_count </span><span class="keyword">++;
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97357""></a>
  <div class="note">
   <strong class="user">blackbart at simail dot it</strong>
   <a href="#97357" class="date">15-Apr-2010 08:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I wrote a simple function that calculates the *exact* bounding box (single pixel precision).
<br />
The function returns an associative array with these keys:
<br />
left, top:&nbsp; coordinates you will pass to imagettftext 
<br />
width, height: dimension of the image you have to create
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">calculateTextBox</span><span class="keyword">(</span><span class="default">$font_size</span><span class="keyword">, </span><span class="default">$font_angle</span><span class="keyword">, </span><span class="default">$font_file</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">) {
<br />
&nbsp; </span><span class="default">$box&nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$font_size</span><span class="keyword">, </span><span class="default">$font_angle</span><span class="keyword">, </span><span class="default">$font_file</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);
<br />
&nbsp; if( !</span><span class="default">$box </span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$min_x </span><span class="keyword">= </span><span class="default">min</span><span class="keyword">( array(</span><span class="default">$box</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">$box</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">$box</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">], </span><span class="default">$box</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">]) );
<br />
&nbsp; </span><span class="default">$max_x </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">( array(</span><span class="default">$box</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">$box</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">$box</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">], </span><span class="default">$box</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">]) );
<br />
&nbsp; </span><span class="default">$min_y </span><span class="keyword">= </span><span class="default">min</span><span class="keyword">( array(</span><span class="default">$box</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">$box</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">], </span><span class="default">$box</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">], </span><span class="default">$box</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]) );
<br />
&nbsp; </span><span class="default">$max_y </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">( array(</span><span class="default">$box</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">$box</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">], </span><span class="default">$box</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">], </span><span class="default">$box</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]) );
<br />
&nbsp; </span><span class="default">$width&nbsp; </span><span class="keyword">= ( </span><span class="default">$max_x </span><span class="keyword">- </span><span class="default">$min_x </span><span class="keyword">);
<br />
&nbsp; </span><span class="default">$height </span><span class="keyword">= ( </span><span class="default">$max_y </span><span class="keyword">- </span><span class="default">$min_y </span><span class="keyword">);
<br />
&nbsp; </span><span class="default">$left&nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">( </span><span class="default">$min_x </span><span class="keyword">) + </span><span class="default">$width</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$top&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">( </span><span class="default">$min_y </span><span class="keyword">) + </span><span class="default">$height</span><span class="keyword">;
<br />
&nbsp; </span><span class="comment">// to calculate the exact bounding box i write the text in a large image
<br />
&nbsp; </span><span class="default">$img&nbsp; &nbsp;&nbsp; </span><span class="keyword">= @</span><span class="default">imagecreatetruecolor</span><span class="keyword">( </span><span class="default">$width </span><span class="keyword">&lt;&lt; </span><span class="default">2</span><span class="keyword">, </span><span class="default">$height </span><span class="keyword">&lt;&lt; </span><span class="default">2 </span><span class="keyword">);
<br />
&nbsp; </span><span class="default">$white&nbsp;&nbsp; </span><span class="keyword">=&nbsp; </span><span class="default">imagecolorallocate</span><span class="keyword">( </span><span class="default">$img</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255 </span><span class="keyword">);
<br />
&nbsp; </span><span class="default">$black&nbsp;&nbsp; </span><span class="keyword">=&nbsp; </span><span class="default">imagecolorallocate</span><span class="keyword">( </span><span class="default">$img</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0 </span><span class="keyword">);
<br />
&nbsp; </span><span class="default">imagefilledrectangle</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">), </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">), </span><span class="default">$black</span><span class="keyword">);
<br />
&nbsp; </span><span class="comment">// for sure the text is completely in the image!
<br />
&nbsp; </span><span class="default">imagettftext</span><span class="keyword">( </span><span class="default">$img</span><span class="keyword">, </span><span class="default">$font_size</span><span class="keyword">,
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$font_angle</span><span class="keyword">, </span><span class="default">$left</span><span class="keyword">, </span><span class="default">$top</span><span class="keyword">,
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$white</span><span class="keyword">, </span><span class="default">$font_file</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);
<br />
&nbsp; </span><span class="comment">// start scanning (0=&gt; black =&gt; empty)
<br />
&nbsp; </span><span class="default">$rleft&nbsp; </span><span class="keyword">= </span><span class="default">$w4 </span><span class="keyword">= </span><span class="default">$width</span><span class="keyword">&lt;&lt;</span><span class="default">2</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$rright </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$rbottom&nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp; </span><span class="default">$rtop </span><span class="keyword">= </span><span class="default">$h4 </span><span class="keyword">= </span><span class="default">$height</span><span class="keyword">&lt;&lt;</span><span class="default">2</span><span class="keyword">;
<br />
&nbsp; for( </span><span class="default">$x </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$x </span><span class="keyword">&lt; </span><span class="default">$w4</span><span class="keyword">; </span><span class="default">$x</span><span class="keyword">++ )
<br />
&nbsp;&nbsp;&nbsp; for( </span><span class="default">$y </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$y </span><span class="keyword">&lt; </span><span class="default">$h4</span><span class="keyword">; </span><span class="default">$y</span><span class="keyword">++ )
<br />
&nbsp;&nbsp; &nbsp;&nbsp; if( </span><span class="default">imagecolorat</span><span class="keyword">( </span><span class="default">$img</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y </span><span class="keyword">) ){
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$rleft&nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">min</span><span class="keyword">( </span><span class="default">$rleft</span><span class="keyword">, </span><span class="default">$x </span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$rright&nbsp; </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">( </span><span class="default">$rright</span><span class="keyword">, </span><span class="default">$x </span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$rtop&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">min</span><span class="keyword">( </span><span class="default">$rtop</span><span class="keyword">, </span><span class="default">$y </span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$rbottom </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">( </span><span class="default">$rbottom</span><span class="keyword">, </span><span class="default">$y </span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp;&nbsp; }
<br />
&nbsp; </span><span class="comment">// destroy img and serve the result
<br />
&nbsp; </span><span class="default">imagedestroy</span><span class="keyword">( </span><span class="default">$img </span><span class="keyword">);
<br />
&nbsp; return array( </span><span class="string">"left"&nbsp;&nbsp; </span><span class="keyword">=&gt; </span><span class="default">$left </span><span class="keyword">- </span><span class="default">$rleft</span><span class="keyword">,
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"top"&nbsp; &nbsp; </span><span class="keyword">=&gt; </span><span class="default">$top&nbsp; </span><span class="keyword">- </span><span class="default">$rtop</span><span class="keyword">,
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"width"&nbsp; </span><span class="keyword">=&gt; </span><span class="default">$rright </span><span class="keyword">- </span><span class="default">$rleft </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">,
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"height" </span><span class="keyword">=&gt; </span><span class="default">$rbottom </span><span class="keyword">- </span><span class="default">$rtop </span><span class="keyword">+ </span><span class="default">1 </span><span class="keyword">);
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97211""></a>
  <div class="note">
   <strong class="user">peterjwest3 at gmail dot com</strong>
   <a href="#97211" class="date">08-Apr-2010 03:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As many of you know, this function is bugged in several versions of PHP. It should return the coordinates relative to the baseline of the font. So if your text includes characters like g and p then the bounding box should extend below zero on the Y axis, however it doesn't. This is a problem because imagettftext() positions text using the baseline, so all your text will be misaligned.<br />
<br />
My solution is to create an image of the desired font and font-size using all ascii characters with imagettfbbox() and imagettftext(). The height of this image is used as the height for the real image.<br />
<br />
I then analyse the image to get the vertical offset of the text (the background color should be $baseColor)<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">getYOffset</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$baseColor</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; for(</span><span class="default">$y </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$y </span><span class="keyword">&lt; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">height</span><span class="keyword">(); </span><span class="default">$y</span><span class="keyword">++)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$x </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$x </span><span class="keyword">&lt; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">width</span><span class="keyword">(); </span><span class="default">$x</span><span class="keyword">++)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">imagecolorat</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y</span><span class="keyword">) !== </span><span class="default">$baseColor</span><span class="keyword">) <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$y</span><span class="keyword">; }<br />
</span><span class="default">?&gt;<br />
</span><br />
This offset can be used as the baseline for the font (for this font-size). You can use a similar trick for the horizontal offset, but that changes depending on the first character.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93088""></a>
  <div class="note">
   <strong class="user">hkc@taiwan</strong>
   <a href="#93088" class="date">22-Aug-2009 09:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I want to output a bounding box of a text as an image straightly. I did like this:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$text </span><span class="keyword">= </span><span class="string">"&lt;?php echo \"hello, world\"; ?&gt;"</span><span class="keyword">;<br />
</span><span class="default">$font </span><span class="keyword">= </span><span class="string">"./arial.ttf"</span><span class="keyword">;<br />
</span><span class="default">$size </span><span class="keyword">= </span><span class="string">"60"</span><span class="keyword">;<br />
<br />
</span><span class="default">$bbox </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
<br />
</span><span class="default">$width </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
</span><span class="default">$height </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">] - </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
<br />
</span><span class="default">$image </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$width</span><span class="keyword">, </span><span class="default">$height</span><span class="keyword">);<br />
<br />
</span><span class="default">$bgcolor </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">);<br />
</span><span class="default">$color </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
<br />
</span><span class="default">$x </span><span class="keyword">= </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] + (</span><span class="default">$width </span><span class="keyword">/ </span><span class="default">2</span><span class="keyword">) - (</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">] / </span><span class="default">2</span><span class="keyword">);<br />
</span><span class="default">$y </span><span class="keyword">= </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] + (</span><span class="default">$height </span><span class="keyword">/ </span><span class="default">2</span><span class="keyword">) - (</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">] / </span><span class="default">2</span><span class="keyword">);<br />
<br />
</span><span class="default">imagefilledrectangle</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$width </span><span class="keyword">- </span><span class="default">1</span><span class="keyword">, </span><span class="default">$height </span><span class="keyword">- </span><span class="default">1</span><span class="keyword">, </span><span class="default">$bgcolor</span><span class="keyword">);<br />
</span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
<br />
</span><span class="default">$last_pixel</span><span class="keyword">= </span><span class="default">imagecolorat</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
<br />
for (</span><span class="default">$j </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$j </span><span class="keyword">&lt; </span><span class="default">$height</span><span class="keyword">; </span><span class="default">$j</span><span class="keyword">++)<br />
{<br />
&nbsp;&nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$width</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (isset(</span><span class="default">$blank_left</span><span class="keyword">) &amp;&amp; </span><span class="default">$i </span><span class="keyword">&gt;= </span><span class="default">$blank_left</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">imagecolorat</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$i</span><span class="keyword">, </span><span class="default">$j</span><span class="keyword">) !== </span><span class="default">$last_pixel</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (!isset(</span><span class="default">$blank_top</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$blank_top </span><span class="keyword">= </span><span class="default">$j</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$blank_left </span><span class="keyword">= </span><span class="default">$i</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$last_pixel </span><span class="keyword">= </span><span class="default">imagecolorat</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$i</span><span class="keyword">, </span><span class="default">$j</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">$x </span><span class="keyword">-= </span><span class="default">$blank_left</span><span class="keyword">;<br />
</span><span class="default">$y </span><span class="keyword">-= </span><span class="default">$blank_top</span><span class="keyword">;<br />
<br />
</span><span class="default">imagefilledrectangle</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$width </span><span class="keyword">- </span><span class="default">1</span><span class="keyword">, </span><span class="default">$height </span><span class="keyword">- </span><span class="default">1</span><span class="keyword">, </span><span class="default">$bgcolor</span><span class="keyword">);<br />
</span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">'Content-type: image/png'</span><span class="keyword">);<br />
</span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="91050""></a>
  <div class="note">
   <strong class="user">alvaro at demogracia dot com</strong>
   <a href="#91050" class="date">22-May-2009 12:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If $fontfile is a Windows UNC path, it *must* start with //SERVER rather than \\SERVER:<br />
<br />
<span class="default">&lt;?php<br />
imagettfbbox</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="string">'\\\\server\\path\\file.ttf'</span><span class="keyword">, </span><span class="string">'Hello, World!'</span><span class="keyword">); </span><span class="comment">// Warning: imagettfbbox() [<a href="http://es.php.net/function.imagettfbbox]: Could not find/open font " rel="nofollow" target="_blank">http://es.php.net/function.imagettfbbox]: Could not find/open font </a><br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90720""></a>
  <div class="note">
   <strong class="user">Dario</strong>
   <a href="#90720" class="date">06-May-2009 04:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
My solution to below-baseline characters is to simply apply a smaller angle and some padding when calculating your boundaries, so the function thinks your text goes below baseline. For example: 
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="comment">// GET BOUNDS OF TEXT
<br />
</span><span class="default">$bounds </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">*</span><span class="default">1.05</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">-</span><span class="default">3</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="86854""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#86854" class="date">06-Nov-2008 08:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
SIMPLE OVERLOADED FUNCTION: Adds TTF Center and Right Alignment to co ordintate points.
<br />
Correctly demonstrates the use of the bouning box TTF function and the array of coordinates that it returns.
<br />

<br />
After obtaining values and adjusting based on a set of values [L, C, R], it uses simple math based of the length of the text to move it from the origin (x = 0 )
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">imagettftextalign</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">, </span><span class="default">$alignment</span><span class="keyword">=</span><span class="string">'L'</span><span class="keyword">)
<br />
{
<br />

<br />
&nbsp;&nbsp; </span><span class="comment">//check width of the text
<br />
&nbsp;&nbsp; </span><span class="default">$bbox </span><span class="keyword">= </span><span class="default">imagettfbbox </span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);
<br />
&nbsp;&nbsp; </span><span class="default">$textWidth </span><span class="keyword">= </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];
<br />
&nbsp;&nbsp; switch (</span><span class="default">$alignment</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; case </span><span class="string">"R"</span><span class="keyword">:
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$x </span><span class="keyword">-= </span><span class="default">$textWidth</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; case </span><span class="string">"C"</span><span class="keyword">:
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$x </span><span class="keyword">-= </span><span class="default">$textWidth </span><span class="keyword">/ </span><span class="default">2</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;
<br />
&nbsp;&nbsp; }
<br />

<br />
&nbsp;&nbsp; </span><span class="comment">//write text
<br />
&nbsp;&nbsp; </span><span class="default">imagettftext </span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);
<br />

<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="86134""></a>
  <div class="note">
   <strong class="user">decimealgo at gmail dot com</strong>
   <a href="#86134" class="date">04-Oct-2008 07:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This is a function which reformats a text string into a text block of a given width.
<br />
Usefull when you have a long single line string and want to fit it into a fixed width but don't care about it's height
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">makeTextBlock</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">, </span><span class="default">$fontfile</span><span class="keyword">, </span><span class="default">$fontsize</span><span class="keyword">, </span><span class="default">$width</span><span class="keyword">)
<br />
{&nbsp; &nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$words </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">' '</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$lines </span><span class="keyword">= array(</span><span class="default">$words</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$currentLine </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; for(</span><span class="default">$i </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">count</span><span class="keyword">(</span><span class="default">$words</span><span class="keyword">); </span><span class="default">$i</span><span class="keyword">++)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lineSize </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$fontsize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$fontfile</span><span class="keyword">, </span><span class="default">$lines</span><span class="keyword">[</span><span class="default">$currentLine</span><span class="keyword">] . </span><span class="string">' ' </span><span class="keyword">. </span><span class="default">$words</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$lineSize</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$lineSize</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] &lt; </span><span class="default">$width</span><span class="keyword">)
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lines</span><span class="keyword">[</span><span class="default">$currentLine</span><span class="keyword">] .= </span><span class="string">' ' </span><span class="keyword">. </span><span class="default">$words</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$currentLine</span><span class="keyword">++;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lines</span><span class="keyword">[</span><span class="default">$currentLine</span><span class="keyword">] = </span><span class="default">$words</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">implode</span><span class="keyword">(</span><span class="string">"\n"</span><span class="keyword">, </span><span class="default">$lines</span><span class="keyword">);
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85266""></a>
  <div class="note">
   <strong class="user">beosman at gmail dot com</strong>
   <a href="#85266" class="date">22-Aug-2008 06:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was viewing the code for calculate the box of a text for a given font but I do not found one that works fine with different angles from zero, so I have made a function simpler than above:<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">calculateTextBox</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">,</span><span class="default">$fontFile</span><span class="keyword">,</span><span class="default">$fontSize</span><span class="keyword">,</span><span class="default">$fontAngle</span><span class="keyword">) {<br />
&nbsp; </span><span class="default">$rect </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$fontSize</span><span class="keyword">,</span><span class="default">$fontAngle</span><span class="keyword">,</span><span class="default">$fontFile</span><span class="keyword">,</span><span class="default">$text</span><span class="keyword">);<br />
&nbsp; <br />
&nbsp; </span><span class="default">$minX </span><span class="keyword">= </span><span class="default">min</span><span class="keyword">(array(</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">]));<br />
&nbsp; </span><span class="default">$maxX </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">(array(</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">]));<br />
&nbsp; </span><span class="default">$minY </span><span class="keyword">= </span><span class="default">min</span><span class="keyword">(array(</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]));<br />
&nbsp; </span><span class="default">$maxY </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">(array(</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">],</span><span class="default">$rect</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]));<br />
<br />
&nbsp; return array(<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"left"&nbsp;&nbsp; </span><span class="keyword">=&gt; </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$minX</span><span class="keyword">),<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"top"&nbsp; &nbsp; </span><span class="keyword">=&gt; </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$minY</span><span class="keyword">),<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"width"&nbsp; </span><span class="keyword">=&gt; </span><span class="default">$maxX </span><span class="keyword">- </span><span class="default">$minX</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"height" </span><span class="keyword">=&gt; </span><span class="default">$maxY </span><span class="keyword">- </span><span class="default">$minY</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"box"&nbsp; &nbsp; </span><span class="keyword">=&gt; </span><span class="default">$rect<br />
&nbsp; </span><span class="keyword">);<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
With this function you can center an angled string in any image:<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp; $mystring </span><span class="keyword">= </span><span class="string">"Hello world!"</span><span class="keyword">;<br />
<br />
&nbsp; </span><span class="default">$imgWidth </span><span class="keyword">= </span><span class="default">300</span><span class="keyword">;<br />
&nbsp; </span><span class="default">$imgHeight </span><span class="keyword">= </span><span class="default">150</span><span class="keyword">;&nbsp; <br />
<br />
&nbsp; </span><span class="default">$image </span><span class="keyword">= </span><span class="default">imagecreate</span><span class="keyword">(</span><span class="default">$imgWidth</span><span class="keyword">,</span><span class="default">$imgHeight</span><span class="keyword">);<br />
&nbsp; </span><span class="default">imagefill</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">,</span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">,</span><span class="default">200</span><span class="keyword">,</span><span class="default">200</span><span class="keyword">,</span><span class="default">200</span><span class="keyword">));<br />
<br />
&nbsp; </span><span class="default">$box </span><span class="keyword">= </span><span class="default">calculateTextBox</span><span class="keyword">(</span><span class="default">$mystring</span><span class="keyword">,</span><span class="string">"./Verdana.ttf"</span><span class="keyword">,</span><span class="default">15</span><span class="keyword">,</span><span class="default">45</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$color </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">);<br />
&nbsp; </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">15</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">45</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$box</span><span class="keyword">[</span><span class="string">"left"</span><span class="keyword">] + (</span><span class="default">$imgWidth </span><span class="keyword">/ </span><span class="default">2</span><span class="keyword">) - (</span><span class="default">$box</span><span class="keyword">[</span><span class="string">"width"</span><span class="keyword">] / </span><span class="default">2</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$box</span><span class="keyword">[</span><span class="string">"top"</span><span class="keyword">] + (</span><span class="default">$imgHeight </span><span class="keyword">/ </span><span class="default">2</span><span class="keyword">) - (</span><span class="default">$box</span><span class="keyword">[</span><span class="string">"height"</span><span class="keyword">] / </span><span class="default">2</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$color</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">"./Verdana.ttf"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$mystring</span><span class="keyword">);<br />
<br />
&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-Type: image/x-png"</span><span class="keyword">);<br />
&nbsp; </span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">);<br />
&nbsp; </span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83536""></a>
  <div class="note">
   <strong class="user">Stefan at colulus dot com</strong>
   <a href="#83536" class="date">30-May-2008 08:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I worked out a script that allows the transfer of alphanumeric data to be placed on an image. The HTML feature is img src and the php feature is imagettftext. This simple code will increment from 1 to 3 on images.<br />
<br />
code:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//ImageCall.php -- This script will call a script to produce the image.<br />
</span><span class="keyword">for(</span><span class="default">$next </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;</span><span class="default">$next </span><span class="keyword">&lt; </span><span class="default">4</span><span class="keyword">; </span><span class="default">$next</span><span class="keyword">++){<br />
print </span><span class="string">"Image </span><span class="default">$next</span><span class="string">:&lt;br&gt;"</span><span class="keyword">;<br />
print </span><span class="string">"&lt;img src = 'Image.php?\$text=</span><span class="default">$next</span><span class="string">'&gt;"</span><span class="keyword">;<br />
print </span><span class="string">"&lt;br&gt;&lt;br&gt;"</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
<span class="default">&lt;?php<br />
</span><span class="comment">//Image.php -- This script creates a square image and places the text on it.<br />
<br />
// image size and color<br />
</span><span class="default">$im </span><span class="keyword">= </span><span class="default">ImageCreate</span><span class="keyword">(</span><span class="default">77</span><span class="keyword">,</span><span class="default">77</span><span class="keyword">);<br />
</span><span class="default">$color1 </span><span class="keyword">= </span><span class="default">ImageColorAllocate</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">,</span><span class="default">0x66</span><span class="keyword">,</span><span class="default">0xCC</span><span class="keyword">,</span><span class="default">0x00</span><span class="keyword">);<br />
</span><span class="default">$color2 </span><span class="keyword">= </span><span class="default">ImageColorAllocate</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">,</span><span class="default">0x33</span><span class="keyword">,</span><span class="default">0x66</span><span class="keyword">,</span><span class="default">0x00</span><span class="keyword">);<br />
</span><span class="default">$color3 </span><span class="keyword">= </span><span class="default">ImageColorAllocate</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">,</span><span class="default">0x00</span><span class="keyword">,</span><span class="default">0x99</span><span class="keyword">,</span><span class="default">0x00</span><span class="keyword">);<br />
</span><span class="default">$color4 </span><span class="keyword">= </span><span class="default">ImageColorAllocate</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">,</span><span class="default">0x3D</span><span class="keyword">,</span><span class="default">0x3D</span><span class="keyword">,</span><span class="default">0x3D</span><span class="keyword">);<br />
<br />
</span><span class="comment">// image creation<br />
</span><span class="default">ImageFilledRectangle</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">76</span><span class="keyword">,</span><span class="default">76</span><span class="keyword">,</span><span class="default">$color1</span><span class="keyword">);<br />
</span><span class="default">ImageFilledpolygon</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, array (</span><span class="default">76</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">76</span><span class="keyword">,</span><span class="default">76</span><span class="keyword">,</span><span class="default">76</span><span class="keyword">),</span><span class="default">3</span><span class="keyword">,</span><span class="default">$color2</span><span class="keyword">);<br />
</span><span class="default">ImageFilledRectangle</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">,</span><span class="default">5</span><span class="keyword">,</span><span class="default">5</span><span class="keyword">,</span><span class="default">72</span><span class="keyword">,</span><span class="default">72</span><span class="keyword">,</span><span class="default">$color3</span><span class="keyword">);<br />
<br />
</span><span class="comment">// determine numeric center of image<br />
</span><span class="default">$size </span><span class="keyword">= </span><span class="default">ImageTTFBBox</span><span class="keyword">(</span><span class="default">45</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="string">'impact'</span><span class="keyword">,</span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'$text'</span><span class="keyword">]);<br />
</span><span class="default">$X </span><span class="keyword">= (</span><span class="default">77 </span><span class="keyword">- (</span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]- </span><span class="default">$size</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">])))/</span><span class="default">2</span><span class="keyword">;<br />
</span><span class="default">$Y </span><span class="keyword">= ((</span><span class="default">77 </span><span class="keyword">- (</span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">] - </span><span class="default">$size</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">])))/</span><span class="default">2 </span><span class="keyword">+ (</span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">] - </span><span class="default">$size</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">])));<br />
<br />
</span><span class="comment">//places numeric information on image<br />
</span><span class="default">ImageTTFText</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">,</span><span class="default">45</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,(</span><span class="default">$X</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">),</span><span class="default">$Y</span><span class="keyword">,</span><span class="default">$color4</span><span class="keyword">,</span><span class="string">'impact'</span><span class="keyword">,</span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'$text'</span><span class="keyword">]);<br />
<br />
</span><span class="comment">//returns completed image to calling script<br />
</span><span class="default">Header</span><span class="keyword">(</span><span class="string">'Content-Type: image/png'</span><span class="keyword">);<br />
</span><span class="default">Imagepng</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83249""></a>
  <div class="note">
   <strong class="user">Valentijn de Pagter</strong>
   <a href="#83249" class="date">16-May-2008 07:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you're looking for easy text alignment, you need to use the imagettfbbox() command. When given the correct parameters, it will return the boundaries of your to-be-made text field in an array, which will allow you to calculate the x and y coordinate that you need to use for centering or aligning your text.<br />
<br />
A horizontal centering example:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$tb </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">17</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="string">'airlock.ttf'</span><span class="keyword">, </span><span class="string">'Hello world!'</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
$tb would contain:<br />
<br />
Array<br />
(<br />
&nbsp;&nbsp;&nbsp; [0] =&gt; 0 // lower left X coordinate<br />
&nbsp;&nbsp;&nbsp; [1] =&gt; -1 // lower left Y coordinate<br />
&nbsp;&nbsp;&nbsp; [2] =&gt; 198 // lower right X coordinate<br />
&nbsp;&nbsp;&nbsp; [3] =&gt; -1 // lower right Y coordinate<br />
&nbsp;&nbsp;&nbsp; [4] =&gt; 198 // upper right X coordinate<br />
&nbsp;&nbsp;&nbsp; [5] =&gt; -20 // upper right Y coordinate<br />
&nbsp;&nbsp;&nbsp; [6] =&gt; 0 // upper left X coordinate<br />
&nbsp;&nbsp;&nbsp; [7] =&gt; -20 // upper left Y coordinate<br />
)<br />
<br />
For horizontal alignment, we need to substract the "text box's" width { $tb[2] or $tb[4] } from the image's width and then substract by two.<br />
<br />
Saying you have a 200px wide image, you could do something like this:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$x </span><span class="keyword">= </span><span class="default">ceil</span><span class="keyword">((</span><span class="default">200 </span><span class="keyword">- </span><span class="default">$tb</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]) / </span><span class="default">2</span><span class="keyword">); </span><span class="comment">// lower left X coordinate for text<br />
</span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, </span><span class="default">17</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y</span><span class="keyword">, </span><span class="default">$tc</span><span class="keyword">, </span><span class="string">'airlock.ttf'</span><span class="keyword">, </span><span class="string">'Hello world!'</span><span class="keyword">); </span><span class="comment">// write text to image<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
This'll give you perfect horizontal center alignment for your text, give or take 1 pixel. Have fun!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82518""></a>
  <div class="note">
   <strong class="user">mihai.draghicioiu at gmailcom</strong>
   <a href="#82518" class="date">15-Apr-2008 12:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To get the height for a line of text, I've found it useful to do:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$bbox </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$ttf</span><span class="keyword">, </span><span class="string">" \n "</span><span class="keyword">); </span><span class="comment">// space, newline, space<br />
<br />
</span><span class="default">$height </span><span class="keyword">= </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">] - </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">];<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
I hope this helps. Before, I used the string "Tj", but that sometimes fell short, especially for crazy fonts.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80265""></a>
  <div class="note">
   <strong class="user">heshan at sjtu dot edu dot cn</strong>
   <a href="#80265" class="date">07-Jan-2008 01:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
the imagettfbbox and imagettftext quirks are:<br />
<br />
1. imagettfbbox and imagettftext have the same return value and both of them are wrong for angle not equal to zero.<br />
2. imagettfbbox returns the correct bounding box when angle is zero.<br />
3. the bounding box has a coordinate system that the x gets bigger from left to right and y gets bigger from top to bottom.<br />
4. the "base point" used in imagettftext is the origin in the bounding box coordinate system.<br />
5. when the angle is other than 0, it is actually rotated in the coordinate system with respect to the base point. so if we know the bounding box coordinate when angle is zero, we can get the new bounding box coordinate by doing the rotation by math equations manually.<br />
6. to have pixel level accuracy, we should also be aware of another thing. suppose the axis is like this: |_|_|_|, the bounding box coordinate uses point on the vertical line while image function uses point on the horizontal line, so there is a 1 pixel difference you should take care of.<br />
<br />
The following snippet creates minimal images containing a letter of different font and rotation angle. This is especially useful in captcha scripts.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">create_font_image</span><span class="keyword">( </span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$char </span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$rect </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">( </span><span class="default">$size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$char </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if( </span><span class="default">0 </span><span class="keyword">== </span><span class="default">$angle </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$imh </span><span class="keyword">= </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] - </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$imw </span><span class="keyword">= </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bx </span><span class="keyword">= -</span><span class="default">1 </span><span class="keyword">- </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$by </span><span class="keyword">= -</span><span class="default">1 </span><span class="keyword">- </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$rad </span><span class="keyword">= </span><span class="default">deg2rad</span><span class="keyword">( </span><span class="default">$angle </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sin </span><span class="keyword">= </span><span class="default">sin</span><span class="keyword">( </span><span class="default">$rad </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$cos </span><span class="keyword">= </span><span class="default">cos</span><span class="keyword">( </span><span class="default">$rad </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if( </span><span class="default">$angle </span><span class="keyword">&gt; </span><span class="default">0 </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmp </span><span class="keyword">= </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">] * </span><span class="default">$cos </span><span class="keyword">+ </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">] * </span><span class="default">$sin</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bx </span><span class="keyword">= -</span><span class="default">1 </span><span class="keyword">- </span><span class="default">round</span><span class="keyword">( </span><span class="default">$tmp </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$imw </span><span class="keyword">= </span><span class="default">round</span><span class="keyword">( </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] * </span><span class="default">$cos </span><span class="keyword">+ </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">] * </span><span class="default">$sin </span><span class="keyword">- </span><span class="default">$tmp </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmp </span><span class="keyword">= </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">] * </span><span class="default">$cos </span><span class="keyword">- </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">] * </span><span class="default">$sin</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$by </span><span class="keyword">= -</span><span class="default">1 </span><span class="keyword">- </span><span class="default">round</span><span class="keyword">( </span><span class="default">$tmp </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$imh </span><span class="keyword">= </span><span class="default">round</span><span class="keyword">( </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] * </span><span class="default">$cos </span><span class="keyword">- </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] * </span><span class="default">$sin </span><span class="keyword">- </span><span class="default">$tmp </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmp </span><span class="keyword">= </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] * </span><span class="default">$cos </span><span class="keyword">+ </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] * </span><span class="default">$sin</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bx </span><span class="keyword">= -</span><span class="default">1 </span><span class="keyword">- </span><span class="default">round</span><span class="keyword">( </span><span class="default">$tmp </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$imw </span><span class="keyword">= </span><span class="default">round</span><span class="keyword">( </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">] * </span><span class="default">$cos </span><span class="keyword">+ </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">] * </span><span class="default">$sin </span><span class="keyword">- </span><span class="default">$tmp </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmp </span><span class="keyword">= </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">] * </span><span class="default">$cos </span><span class="keyword">- </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">] * </span><span class="default">$sin</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$by </span><span class="keyword">= -</span><span class="default">1 </span><span class="keyword">- </span><span class="default">round</span><span class="keyword">( </span><span class="default">$tmp </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$imh </span><span class="keyword">= </span><span class="default">round</span><span class="keyword">( </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">] * </span><span class="default">$cos </span><span class="keyword">- </span><span class="default">$rect</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] * </span><span class="default">$sin </span><span class="keyword">- </span><span class="default">$tmp </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$im </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">( </span><span class="default">$imw</span><span class="keyword">, </span><span class="default">$imh </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagefill</span><span class="keyword">( </span><span class="default">$im</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagecolorallocate</span><span class="keyword">( </span><span class="default">$im</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">255 </span><span class="keyword">) );<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagettftext</span><span class="keyword">( </span><span class="default">$im</span><span class="keyword">, </span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$bx</span><span class="keyword">, </span><span class="default">$by</span><span class="keyword">, </span><span class="default">imagecolorallocate</span><span class="keyword">( </span><span class="default">$im</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0 </span><span class="keyword">), </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$char </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagegif</span><span class="keyword">( </span><span class="default">$im</span><span class="keyword">, </span><span class="default">trim</span><span class="keyword">( </span><span class="default">$font</span><span class="keyword">, </span><span class="string">'./' </span><span class="keyword">) . </span><span class="default">ord</span><span class="keyword">( </span><span class="default">$char </span><span class="keyword">) . </span><span class="default">$angle </span><span class="keyword">. </span><span class="string">'.gif' </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagedestroy</span><span class="keyword">( </span><span class="default">$im </span><span class="keyword">);<br />
}<br />
<br />
</span><span class="default">$chars </span><span class="keyword">= </span><span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890'</span><span class="keyword">;<br />
</span><span class="default">$angles </span><span class="keyword">= array( -</span><span class="default">30</span><span class="keyword">, -</span><span class="default">20</span><span class="keyword">, -</span><span class="default">10</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">10</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">, </span><span class="default">30 </span><span class="keyword">);<br />
</span><span class="default">$fonts </span><span class="keyword">= array( </span><span class="string">'./latinwide.ttf'</span><span class="keyword">, </span><span class="string">'./verdana.ttf'</span><span class="keyword">, </span><span class="string">'./times.ttf'</span><span class="keyword">, </span><span class="string">'./broadway.ttf' </span><span class="keyword">);<br />
foreach( </span><span class="default">$angles </span><span class="keyword">as </span><span class="default">$angle </span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; foreach( </span><span class="default">$fonts </span><span class="keyword">as </span><span class="default">$font </span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for( </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">strlen</span><span class="keyword">( </span><span class="default">$chars </span><span class="keyword">); ++</span><span class="default">$i </span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">create_font_image</span><span class="keyword">( </span><span class="default">100</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$chars</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] );<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="77453""></a>
  <div class="note">
   <strong class="user">intuz et gmx dt de</strong>
   <a href="#77453" class="date">30-Aug-2007 08:45</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I still got problems trying to rotate imagettftext using imagettfbbox.<br />
<br />
It's position calculation is mostly wrong. So i tried to rotate ttftext with IMAGEROTATE. <br />
<br />
As a special the result is in black fontcolor and transparent background.<br />
<br />
Hope it helps sombody (thanks for function convertBoundingBox, reading below)<br />
<br />
&lt;?<br />
function ImgText($text,$fontsize,$font,$angle){<br />
$im = '';<br />
&nbsp;&nbsp;&nbsp; if($text){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!$fontsize || $fontsize &lt; 1) $fontsize = 12;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!$font) $font = "fonts/arial.ttf";<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $bbox = imagettfbbox($fontsize, 0, $font, $text);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $size=convertBoundingBox($bbox);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $im = ImageCreatetruecolor($size['width'],$size['height']);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $white = ImageColorAllocate($im, 255, 255, 255);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $black = ImageColorAllocate($im, 0,0,0);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; imagefill ($im, 0, 0, $white );<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; imagettftext($im, $fontsize, 0, $size['xOffset'], $size['yOffset'], $black, $font, $text);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $im = imagerotate( $im,$angle, $white);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; imagecolortransparent ($im,$white);<br />
&nbsp;&nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // No text<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
?&gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="76333""></a>
  <div class="note">
   <strong class="user">bushj at rpi dot edu</strong>
   <a href="#76333" class="date">11-Jul-2007 06:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Apparently the bounding box returned by imagettftext and imagettfbbox is not the same, and it appears as though imagettftext does a better job at calculating the actual bounding box (maybe because it has to render every character and it then finds out really everywhere it rendered).<br />
<br />
So, you can create a dummy image render the text to it and get a better box. Here is an example function:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">better_imagettfbbox</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">) {<br />
&nbsp; </span><span class="default">$dummy </span><span class="keyword">= </span><span class="default">imagecreate</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$black </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$dummy</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$bbox </span><span class="keyword">= </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$dummy</span><span class="keyword">, </span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$black</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
&nbsp; </span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$dummy</span><span class="keyword">);<br />
&nbsp; return </span><span class="default">$bbox</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span>If you use this a lot, it would be better to keep one dummy image instead of continually creating and destroying images.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75530""></a>
  <div class="note">
   <strong class="user">Ruquay</strong>
   <a href="#75530" class="date">04-Jun-2007 01:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Several comments show that the output of this function is often not what is expected, especially when the text is rotated.<br />
<br />
For those of you who'd like a visual representation of what is happening to the bounding box as the text is rotated, take a look here:<br />
<br />
<a href="http://ruquay.com/sandbox/imagettf/" rel="nofollow" target="_blank">http://ruquay.com/sandbox/imagettf/</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75491""></a>
  <div class="note">
   <strong class="user">Nate Sweet</strong>
   <a href="#75491" class="date">01-Jun-2007 09:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
An improvement to the convertBoundingBox function. The previous function was completely wrong. My confusion came from characters like "1" and "_" that are rendered to the right or below the basepoint (in the font I'm using). I ended up using mike at mikeleigh dot com's function with a fix for these characters, and a "belowBasepoint" value.<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">convertBoundingBox </span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] &gt;= -</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$xOffset </span><span class="keyword">= -</span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] + </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$xOffset </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] + </span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$width </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] &lt; -</span><span class="default">1</span><span class="keyword">) </span><span class="default">$width </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]) + </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]) - </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$yOffset </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">] + </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">] &gt;= -</span><span class="default">1</span><span class="keyword">) </span><span class="default">$yOffset </span><span class="keyword">= -</span><span class="default">$yOffset</span><span class="keyword">; </span><span class="comment">// Fixed characters below the baseline.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$height </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]) - </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">] &gt; </span><span class="default">0</span><span class="keyword">) </span><span class="default">$height </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">] - </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]) - </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; return array(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'width' </span><span class="keyword">=&gt; </span><span class="default">$width</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'height' </span><span class="keyword">=&gt; </span><span class="default">$height</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'xOffset' </span><span class="keyword">=&gt; </span><span class="default">$xOffset</span><span class="keyword">, </span><span class="comment">// Using xCoord + xOffset with imagettftext puts the left most pixel of the text at xCoord.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'yOffset' </span><span class="keyword">=&gt; </span><span class="default">$yOffset</span><span class="keyword">, </span><span class="comment">// Using yCoord + yOffset with imagettftext puts the top most pixel of the text at yCoord.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'belowBasepoint' </span><span class="keyword">=&gt; </span><span class="default">max</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])<br />
&nbsp;&nbsp;&nbsp; );<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75479""></a>
  <div class="note">
   <strong class="user">Nate Sweet</strong>
   <a href="#75479" class="date">01-Jun-2007 09:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It took me some time to make full use of imagettfbbox. Hopefully the following function makes it much easier to use for others.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">convertBoundingBox </span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] &gt;= -</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$leftOfBasepoint </span><span class="keyword">= -</span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] + </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$leftOfBasepoint </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] + </span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$rightOfBasepoint </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] &lt; -</span><span class="default">1</span><span class="keyword">) </span><span class="default">$rightOfBasepoint </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]) + </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]) - </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$aboveBasepoint </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">] + </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$height </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]) - </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">] &gt; </span><span class="default">0</span><span class="keyword">) </span><span class="default">$height </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">] - </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]) - </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$width </span><span class="keyword">= </span><span class="default">$leftOfBasepoint </span><span class="keyword">+ </span><span class="default">$rightOfBasepoint</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$belowBasepoint </span><span class="keyword">= </span><span class="default">$height </span><span class="keyword">- </span><span class="default">$aboveBasepoint</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; return array(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'width' </span><span class="keyword">=&gt; </span><span class="default">$width</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'height' </span><span class="keyword">=&gt; </span><span class="default">$height</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'leftOfBasepoint' </span><span class="keyword">=&gt; </span><span class="default">$leftOfBasepoint</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'rightOfBasepoint' </span><span class="keyword">=&gt; </span><span class="default">$rightOfBasepoint</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'aboveBasepoint' </span><span class="keyword">=&gt; </span><span class="default">$aboveBasepoint</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'belowBasepoint' </span><span class="keyword">=&gt; </span><span class="default">$belowBasepoint<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Thanks goes to mike at mikeleigh dot com for providing the core of this function.<br />
<br />
Remember, the basepoint is the x, y coords you use to draw text with imagettftext. A useful thing to do is take a string like...<br />
ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234567890<br />
...and use the "aboveBasepoint" value for the height of your font. Now you can draw lines and use "the height of your font * leading" as the distance between lines of text, where leading is a number like 1.45 (for 45% leading).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75439""></a>
  <div class="note">
   <strong class="user">Nate Sweet</strong>
   <a href="#75439" class="date">30-May-2007 10:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This script shows you side by side the difference between a font rendered at a certain size and the same font rendered at some multiple of that size and then scaled down by the same multiple. It seems to help small sizes and affects large ones less. This script lets you see if it is worth implementing for your situation. Included is the great "imagettfbboxextended" function by mike at mikeleigh dot com below.<br />
<br />
$size = 30;<br />
$factor = 16;<br />
<br />
$smallSize = imagettfbboxextended($size, 0, "fonts/MPlantin.ttf", "The quick brown fox jumps over the lazy dog.");<br />
$smallWidth = $smallSize['width'];<br />
$smallHeight = $smallSize['height'];<br />
$canvas = imagecreatetruecolor($smallWidth + 20, $smallHeight * 2 + 20);<br />
imagefill($canvas, 0, 0, imagecolorallocate($canvas, 255, 255, 255));<br />
imagettftext($canvas, $size, 0, 10 + $smallSize['x'], 10 + $smallSize['y'], imagecolorallocate($canvas, 0, 0, 0), "fonts/MPlantin.ttf", "The quick brown fox jumps over the lazy dog.");<br />
<br />
$largeSize = imagettfbboxextended($size * $factor, 0, "fonts/MPlantin.ttf", "The quick brown fox jumps over the lazy dog.");<br />
$largeWidth = $largeSize['width'];<br />
$largeHeight = $largeSize['height'];<br />
$temp = imagecreatetruecolor($largeWidth, $largeHeight);<br />
imagefill($temp, 0, 0, imagecolorallocate($canvas, 255, 255, 255));<br />
imagettftext($temp, $size * $factor, 0, $largeSize['x'], $largeSize['y'], imagecolorallocate($temp, 0, 0, 0), "fonts/MPlantin.ttf", "The quick brown fox jumps over the lazy dog.");<br />
imagecopyresampled($canvas, $temp, 10 + $smallSize['x'], 10 + $smallSize['y'] + 10, 0, 0, $smallWidth, $smallHeight, $largeWidth, $largeHeight);<br />
imagepng($temp, "temp.png");<br />
<br />
imagepng($canvas, "test.png");<br />
<br />
function imagettfbboxextended($size, $angle, $fontfile, $text) {<br />
&nbsp;&nbsp;&nbsp; /*this function extends imagettfbbox and includes within the returned array<br />
&nbsp;&nbsp;&nbsp; the actual text width and height as well as the x and y coordinates the<br />
&nbsp;&nbsp;&nbsp; text should be drawn from to render correctly.&nbsp; This currently only works<br />
&nbsp;&nbsp;&nbsp; for an angle of zero and corrects the issue of hanging letters e.g. jpqg*/<br />
&nbsp;&nbsp;&nbsp; $bbox = imagettfbbox($size, $angle, $fontfile, $text);<br />
<br />
&nbsp;&nbsp;&nbsp; //calculate x baseline<br />
&nbsp;&nbsp;&nbsp; if($bbox[0] &gt;= -1) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $bbox['x'] = abs($bbox[0] + 1) * -1;<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; //$bbox['x'] = 0;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $bbox['x'] = abs($bbox[0] + 2);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; //calculate actual text width<br />
&nbsp;&nbsp;&nbsp; $bbox['width'] = abs($bbox[2] - $bbox[0]);<br />
&nbsp;&nbsp;&nbsp; if($bbox[0] &lt; -1) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $bbox['width'] = abs($bbox[2]) + abs($bbox[0]) - 1;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; //calculate y baseline<br />
&nbsp;&nbsp;&nbsp; $bbox['y'] = abs($bbox[5] + 1);<br />
<br />
&nbsp;&nbsp;&nbsp; //calculate actual text height<br />
&nbsp;&nbsp;&nbsp; $bbox['height'] = abs($bbox[7]) - abs($bbox[1]);<br />
&nbsp;&nbsp;&nbsp; if($bbox[3] &gt; 0) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $bbox['height'] = abs($bbox[7] - $bbox[1]) - 1;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return $bbox;<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75407""></a>
  <div class="note">
   <strong class="user">mike at mikeleigh dot com</strong>
   <a href="#75407" class="date">28-May-2007 04:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have been testing this function for a while now and have come up with many of the same issues that other people have touched upon.&nbsp; Not being able to calculate the width of the text correctly.&nbsp; Or if a solution is found then it won't work with a hanging letter or a negative start letter like 'j'.<br />
<br />
Like Ralph I also wanted to draw a box around some text and this would require me being pixel perfect with the font.&nbsp; The trouble is I did not know which font would be used or which size.&nbsp; This led me to come up with a solution which I am sharing below.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">imagettfbboxextended</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$fontfile</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/*this function extends imagettfbbox and includes within the returned array<br />
&nbsp;&nbsp;&nbsp; the actual text width and height as well as the x and y coordinates the <br />
&nbsp;&nbsp;&nbsp; text should be drawn from to render correctly.&nbsp; This currently only works<br />
&nbsp;&nbsp;&nbsp; for an angle of zero and corrects the issue of hanging letters e.g. jpqg*/<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bbox </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$fontfile</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//calculate x baseline<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] &gt;= -</span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="string">'x'</span><span class="keyword">] = </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] + </span><span class="default">1</span><span class="keyword">) * -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//$bbox['x'] = 0;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="string">'x'</span><span class="keyword">] = </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] + </span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//calculate actual text width<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="string">'width'</span><span class="keyword">] = </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] &lt; -</span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="string">'width'</span><span class="keyword">] = </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]) + </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]) - </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//calculate y baseline<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="string">'y'</span><span class="keyword">] = </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">] + </span><span class="default">1</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//calculate actual text height<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="string">'height'</span><span class="keyword">] = </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]) - </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">] &gt; </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="string">'height'</span><span class="keyword">] = </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">] - </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]) - </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$bbox</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
The function above gives the correct x and y coordinates that the text should be drawn from and also gives the actual image width and height.&nbsp; This has been tested with various fonts and sizes ranging from 6 up to 144 points.&nbsp; Some of the output will appear to be incorrect and have an extra pixel on the right, using verdana at size 144 and outputting the character 'Q' for example.&nbsp; This is not an error as this is part of the anti-aliasing of the font output.<br />
<br />
Example Usage:<br />
<span class="default">&lt;?php<br />
$font </span><span class="keyword">= </span><span class="string">'c:\windows\fonts\verdana.ttf'</span><span class="keyword">;<br />
</span><span class="default">$font_size </span><span class="keyword">= </span><span class="default">144</span><span class="keyword">;<br />
</span><span class="default">$text </span><span class="keyword">= </span><span class="string">'jüyZgQ'</span><span class="keyword">;<br />
</span><span class="default">$bbox </span><span class="keyword">= </span><span class="default">imagettfbboxextended</span><span class="keyword">(</span><span class="default">$font_size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Return Values:<br />
Array<br />
(<br />
&nbsp;&nbsp;&nbsp; [0] =&gt; -8<br />
&nbsp;&nbsp;&nbsp; [1] =&gt; 40<br />
&nbsp;&nbsp;&nbsp; [2] =&gt; 715<br />
&nbsp;&nbsp;&nbsp; [3] =&gt; 40<br />
&nbsp;&nbsp;&nbsp; [4] =&gt; 715<br />
&nbsp;&nbsp;&nbsp; [5] =&gt; -177<br />
&nbsp;&nbsp;&nbsp; [6] =&gt; -8<br />
&nbsp;&nbsp;&nbsp; [7] =&gt; -177<br />
&nbsp;&nbsp;&nbsp; [x] =&gt; 6<br />
&nbsp;&nbsp;&nbsp; [width] =&gt; 722<br />
&nbsp;&nbsp;&nbsp; [y] =&gt; 176<br />
&nbsp;&nbsp;&nbsp; [height] =&gt; 216<br />
)<br />
<br />
Further notes can be found here along with images of the output of the function <a href="http://mikeleigh.com/links/imagettfbbox" rel="nofollow" target="_blank">http://mikeleigh.com/links/imagettfbbox</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75333""></a>
  <div class="note">
   <strong class="user">lassial dot gmail dot com</strong>
   <a href="#75333" class="date">24-May-2007 01:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Ralph Bolton commented about the difference in calculating the bounding box size vs. aligning text base line. <br />
<br />
The workaround for this issue is to calculate the difference in height between a character going below baseline and one above the baseline. This is likely going to vary from font to font, so I'd suggest something like this:<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">fontBaselineOffset</span><span class="keyword">(</span><span class="default">$font</span><span class="keyword">, </span><span class="default">$fontSize</span><span class="keyword">)<br />
{<br />
</span><span class="comment">//this should be above baseline<br />
</span><span class="default">$test2</span><span class="keyword">=</span><span class="string">"H"</span><span class="keyword">;<br />
</span><span class="comment">//some of these additional letters should go below it<br />
</span><span class="default">$test3</span><span class="keyword">=</span><span class="string">"Hjgqp"</span><span class="keyword">;<br />
<br />
</span><span class="comment">//get the dimension for these two:<br />
<br />
</span><span class="default">$box2 </span><span class="keyword">= </span><span class="default">imageTTFBbox</span><span class="keyword">(</span><span class="default">$fontSize</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$font</span><span class="keyword">,</span><span class="default">$test2</span><span class="keyword">);<br />
</span><span class="default">$box3 </span><span class="keyword">= </span><span class="default">imageTTFBbox</span><span class="keyword">(</span><span class="default">$fontSize</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$font</span><span class="keyword">,</span><span class="default">$test3</span><span class="keyword">);<br />
<br />
</span><span class="comment">//return the offset value<br />
<br />
</span><span class="keyword">return&nbsp; </span><span class="default">abs</span><span class="keyword">((</span><span class="default">abs</span><span class="keyword">(</span><span class="default">$box2</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">]) + </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$box2</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])) - (</span><span class="default">abs</span><span class="keyword">(</span><span class="default">$box3</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">]) + </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$box3</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])));<br />
<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
This is not perfect yet. You should define a range of allowed characters that can go below baseline, compare them to the ones actually found in your string and use them instead of the string $test3 used in the example function above. This should avoid problems with letters that go further below baseline than the others (e.g. there could be a difference between 'g' and 'p')</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="74686""></a>
  <div class="note">
   <strong class="user">ralphbolton at mail2sexy dot com</strong>
   <a href="#74686" class="date">23-Apr-2007 06:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There's a bit of an annoyance with measuring font sizes and drawing boxes around text. When fonts are measured using ImageTTFbbox, the correct vertical height is returned. That is, the measurement of the phrase "Hanging" will be from the top of the "H" to the bottom of the "g".<br />
<br />
The problem is that functions like imageTTFtext align with the "line" of the text - that is, in the phrase "Hanging", the alignment is below the "H", not the bottom of the "g". That means that if you draw a rectangle behind your text, it'll be incorrectly aligned because the hanging "g" will be outside the box.<br />
<br />
For example, this doesn't work as you might expect (because the "g" hangs below the box):<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Get the size of the font box<br />
</span><span class="default">$textbox </span><span class="keyword">= </span><span class="default">imageTTFBbox</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="string">'Hanging'</span><span class="keyword">);<br />
</span><span class="default">$textwidth </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$textbox</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">] - </span><span class="default">$textbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
</span><span class="default">$textheight </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$textbox</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">] - </span><span class="default">$textbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
<br />
</span><span class="comment">// Now draw a rectangle on the image<br />
</span><span class="default">$colour </span><span class="keyword">= </span><span class="default">ImageColorAllocate</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">);<br />
</span><span class="default">imagefilledrectangle</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y </span><span class="keyword">- </span><span class="default">$textheight</span><span class="keyword">, </span><span class="default">$x </span><span class="keyword">+ </span><span class="default">$textwidth</span><span class="keyword">, </span><span class="default">$y</span><span class="keyword">, </span><span class="default">$colour </span><span class="keyword">);<br />
<br />
</span><span class="comment">// Now draw the text<br />
</span><span class="default">$black </span><span class="keyword">= </span><span class="default">ImageColorAllocate</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
</span><span class="default">ImageTTFText</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">[</span><span class="string">'resource'</span><span class="keyword">], </span><span class="default">$size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y</span><span class="keyword">, </span><span class="default">$black</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="string">'Hanging'</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span>It also seems that the rectangle in the above example is located 1 pixel to the left of the text.<br />
<br />
I haven't found a way to resolve this problem correctly. Instead, I have enlarged the rectangle and then put the text into it. I don't think this will work absolutely correctly for all fonts, so it's not exactly a perfect solution. However, it's better than nothing! Here is a snippet of it:<br />
<span class="default">&lt;?php<br />
$enlargex </span><span class="keyword">= </span><span class="default">$textwidth </span><span class="keyword">* </span><span class="default">0.08</span><span class="keyword">;<br />
</span><span class="default">$enlargey </span><span class="keyword">= </span><span class="default">$textheight </span><span class="keyword">* </span><span class="default">0.1</span><span class="keyword">;<br />
</span><span class="default">$enlargey2 </span><span class="keyword">= </span><span class="default">$textheight </span><span class="keyword">* </span><span class="default">0.5</span><span class="keyword">;<br />
<br />
</span><span class="comment">// Now draw a rectangle on the image<br />
</span><span class="default">$colour </span><span class="keyword">= </span><span class="default">ImageColorAllocate</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">);<br />
</span><span class="default">imagefilledrectangle</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, </span><span class="default">$x </span><span class="keyword">- </span><span class="default">$enlargex</span><span class="keyword">, </span><span class="default">$y </span><span class="keyword">- </span><span class="default">$textheight </span><span class="keyword">- </span><span class="default">$enlargey</span><span class="keyword">, </span><span class="default">$x </span><span class="keyword">+ </span><span class="default">$textwidth </span><span class="keyword">+ </span><span class="default">$enlargex</span><span class="keyword">, </span><span class="default">$y </span><span class="keyword">+ </span><span class="default">$enlarge2</span><span class="keyword">, </span><span class="default">$colour </span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68518""></a>
  <div class="note">
   <strong class="user">marclaz</strong>
   <a href="#68518" class="date">31-Jul-2006 03:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please note that as imageTTFBbox and imageTTFText functions return an array of coordinates which could be negative numbers care must be taken with height and width calculations.<br />
<br />
The rigth way to do that is to use the abs() function:<br />
<br />
for an horizontal text:<br />
<br />
$box = @imageTTFBbox($size,0,$font,$text);<br />
$width = abs($box[4] - $box[0]);<br />
$height = abs($box[5] - $box[1]);<br />
<br />
Then to center your text at ($x,$y) position the code should be like that:<br />
<br />
$x -= $width/2;<br />
$y += $heigth/2;<br />
<br />
imageTTFText($img,$size,0,$x,$y,$color,$font,$text);<br />
<br />
this because (0,0) page origin is topleft page corner and (0,0) text origin is lower-left readable text corner.<br />
<br />
Hope this help.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="65806""></a>
  <div class="note">
   <strong class="user">Nimja</strong>
   <a href="#65806" class="date">08-May-2006 10:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Warning: <br />
james.logsdon's function has a few flaws in copying my own function. Though he did a great job in making an overall nicer looking function it does have a few flaws.<br />
<br />
His function does not allow for long words (longer then the width) linebreaks (harder then it looks) and has a non-pixel perfect location.<br />
<br />
The problem with the imagettfbbox function is that different letters give a different x/y top-left coordinate. At least it looks that way for the eye. I 'solved' this by putting a space in front of every line and then offset the text by the width of that space.<br />
<br />
So, although some things of my function seem useless they do serve an important purpose.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="65691""></a>
  <div class="note">
   <strong class="user">james.logsdon at firesidemedia dot net</strong>
   <a href="#65691" class="date">05-May-2006 10:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I've modified Nimja's function a little. It doesn't support line-breaks (didn't need it in my script), but it's easy enough to add in.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">imageWordWrapBBox </span><span class="keyword">( </span><span class="default">$Text</span><span class="keyword">, </span><span class="default">$Width </span><span class="keyword">= </span><span class="default">650</span><span class="keyword">, </span><span class="default">$FontSize </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">, </span><span class="default">$Font </span><span class="keyword">= </span><span class="string">'./fonts/arial.ttf' </span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$Words </span><span class="keyword">= </span><span class="default">split </span><span class="keyword">( </span><span class="string">' '</span><span class="keyword">, </span><span class="default">$Text </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$Lines </span><span class="keyword">= array ( );<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$Line&nbsp; </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; foreach ( </span><span class="default">$Words </span><span class="keyword">as </span><span class="default">$Word </span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$Box&nbsp; </span><span class="keyword">= </span><span class="default">imagettfbbox </span><span class="keyword">( </span><span class="default">$FontSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$Font</span><span class="keyword">, </span><span class="default">$Line </span><span class="keyword">. </span><span class="default">$Word </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$Size </span><span class="keyword">= </span><span class="default">$Box</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">] - </span><span class="default">$Box</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ( </span><span class="default">$Size </span><span class="keyword">&gt; </span><span class="default">$Width </span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$Lines</span><span class="keyword">[] = </span><span class="default">trim </span><span class="keyword">( </span><span class="default">$Line </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$Line&nbsp; &nbsp; </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$Line </span><span class="keyword">.= </span><span class="default">$Word </span><span class="keyword">. </span><span class="string">' '</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$Lines</span><span class="keyword">[] = </span><span class="default">trim </span><span class="keyword">( </span><span class="default">$Line </span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$Dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox </span><span class="keyword">( </span><span class="default">$FontSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$Font</span><span class="keyword">, </span><span class="string">'AJLMYabdfghjklpqry019`@$^&amp;*(,' </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$lineHeight </span><span class="keyword">= </span><span class="default">$Dimensions</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] - </span><span class="default">$Dimensions</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">];<br />
<br />
&nbsp;&nbsp;&nbsp; return array ( </span><span class="default">$lineHeight</span><span class="keyword">, </span><span class="default">$Lines</span><span class="keyword">, </span><span class="default">$lineHeight </span><span class="keyword">* </span><span class="default">count </span><span class="keyword">( </span><span class="default">$Lines </span><span class="keyword">) );<br />
}<br />
<br />
function </span><span class="default">imageWordWrap </span><span class="keyword">( </span><span class="default">$Text</span><span class="keyword">, </span><span class="default">$Width</span><span class="keyword">, </span><span class="default">$Color</span><span class="keyword">, </span><span class="default">$X </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">, </span><span class="default">$Y </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">, </span><span class="default">$FontSize </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">, </span><span class="default">$Font </span><span class="keyword">= </span><span class="string">'./fonts/arial.ttf' </span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$Data </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">imageWordWrapBBox </span><span class="keyword">( </span><span class="default">$Text</span><span class="keyword">, </span><span class="default">$Width</span><span class="keyword">, </span><span class="default">$FontSize</span><span class="keyword">, </span><span class="default">$Font </span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; foreach ( </span><span class="default">$Data</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] as </span><span class="default">$Key </span><span class="keyword">=&gt; </span><span class="default">$Line </span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$locX </span><span class="keyword">= </span><span class="default">$X</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$locY </span><span class="keyword">= </span><span class="default">$Y </span><span class="keyword">+ ( </span><span class="default">$Key </span><span class="keyword">* </span><span class="default">$Data</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] );<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagettftext </span><span class="keyword">( </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">Image</span><span class="keyword">, </span><span class="default">$FontSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$locX</span><span class="keyword">, </span><span class="default">$locY</span><span class="keyword">, </span><span class="default">$Color</span><span class="keyword">, </span><span class="default">$Font</span><span class="keyword">, </span><span class="default">$Line </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$Data</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62428""></a>
  <div class="note">
   <strong class="user">toe dot cutter at telia dot com</strong>
   <a href="#62428" class="date">28-Feb-2006 04:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Neither Greg's or Henrik N's code worked for me.<br />
<br />
I figured out that imagettfbbox gives the size (coordinates) of the whole letter (ie. with the hang on 'g' or 'j'). So it was only a matter of finding the correct index of coordinates in the array.<br />
<br />
Note: This doesn't work on Times New Roman Italic's 'f' for some reason.<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp;&nbsp; $size </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$fontsize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dx </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]-</span><span class="default">$size</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dy </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">]-</span><span class="default">$size</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ImageTTFText</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, </span><span class="default">$fontsize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">]), </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">]), </span><span class="default">$txtcolor</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62363""></a>
  <div class="note">
   <strong class="user">Henrik N</strong>
   <a href="#62363" class="date">26-Feb-2006 10:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Tried Greg's code below, but it didn't quite work for me. This did, however:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$size </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$fontSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
</span><span class="default">$width </span><span class="keyword">= </span><span class="default">$size</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] + </span><span class="default">$size</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
</span><span class="default">$height </span><span class="keyword">= </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]) + </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]);<br />
<br />
</span><span class="default">$image </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$width</span><span class="keyword">, </span><span class="default">$height</span><span class="keyword">); <br />
<br />
</span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$fontSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">abs</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">]), </span><span class="default">$black</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="61785""></a>
  <div class="note">
   <strong class="user">greg at gregoryfenton dot be</strong>
   <a href="#61785" class="date">11-Feb-2006 11:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Have a problem with imagettfbbox cutting off the hang of letters such as 'g' or 'j'??<br />
<br />
After days trying to figure this thing out, I finally cracked it:<br />
<br />
&nbsp; $size = imagettfbbox($s,0,$font,$text);<br />
&nbsp; $dx=abs($size[0])+abs($size[2]);<br />
&nbsp; $dy=abs($size[1])+abs($size[7]);<br />
<br />
&nbsp; ImageTTFText($im, $s, 0, $dx-abs($size[0]), $dy-abs($size[1]), $black, $font, $text);<br />
<br />
The key is the abs commands - you must account for the negative numbers in the original imagettfbbox, and if you have any, take them away from the location at the end when the text is displayed:<br />
<br />
you need to start the x and y at a (possibly) negative number, not 0,0 as I had thought.<br />
<br />
Hope that helps someone..</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60678""></a>
  <div class="note">
   <strong class="user">Nimja</strong>
   <a href="#60678" class="date">13-Jan-2006 05:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
My previous function had 2 bugs which are now fixed:<br />
* Align is now pixel perfect, no longer dependant on the first character. Solved by putting a space " " in front of every rendered line, making the basepoint at the exact same place every time.<br />
* X Y Coordinates are no longer the base-point, but the perfect top/left coordinates. This made my life designing a LOT easier.<br />
<br />
Features:<br />
* Newline support! (both Windows and Linux)<br />
* Paragraph support, no newlines are ignored, not even empty ones. So empty lines are properly supported.<br />
* True top/left x/y coordinates instead of TTF basepoint.(at least as close as possible).<br />
* Align function for Left, Center and Right<br />
* Support for words that are longer then the supported width.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//A function for pixel precise text Wrapping<br />
</span><span class="keyword">function </span><span class="default">imageTextWrapped</span><span class="keyword">(&amp;</span><span class="default">$img</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y</span><span class="keyword">, </span><span class="default">$width</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">, </span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">$align</span><span class="keyword">=</span><span class="string">"l"</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//Recalculate X and Y to have the proper top/left coordinates instead of TTF base-point<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$y </span><span class="keyword">+= </span><span class="default">$textSize</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="string">" "</span><span class="keyword">); </span><span class="comment">//use a custom string to get a fixed height.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$x </span><span class="keyword">-= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">]-</span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$text </span><span class="keyword">= </span><span class="default">str_replace </span><span class="keyword">(</span><span class="string">"\r"</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">); </span><span class="comment">//Remove windows line-breaks<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$srcLines </span><span class="keyword">= </span><span class="default">split </span><span class="keyword">(</span><span class="string">"\n"</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">); </span><span class="comment">//Split text into "lines"<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dstLines </span><span class="keyword">= Array(); </span><span class="comment">// The destination lines array.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$srcLines </span><span class="keyword">as </span><span class="default">$currentL</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$words </span><span class="keyword">= </span><span class="default">split </span><span class="keyword">(</span><span class="string">" "</span><span class="keyword">, </span><span class="default">$currentL</span><span class="keyword">); </span><span class="comment">//Split line into words.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$words </span><span class="keyword">as </span><span class="default">$word</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">.</span><span class="default">$word</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lineWidth </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// get the length of this line, if the word is to be included<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$lineWidth </span><span class="keyword">&gt; </span><span class="default">$width </span><span class="keyword">&amp;&amp; !empty(</span><span class="default">$line</span><span class="keyword">) ) { </span><span class="comment">// check if it is too big if the word was added, if so, then move on.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dstLines</span><span class="keyword">[] = </span><span class="string">' '</span><span class="keyword">.</span><span class="default">trim</span><span class="keyword">(</span><span class="default">$line</span><span class="keyword">); </span><span class="comment">//Add the line like it was without spaces.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">.= </span><span class="default">$word</span><span class="keyword">.</span><span class="string">' '</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dstLines</span><span class="keyword">[] =&nbsp; </span><span class="string">' '</span><span class="keyword">.</span><span class="default">trim</span><span class="keyword">(</span><span class="default">$line</span><span class="keyword">); </span><span class="comment">//Add the line when the line ends.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//Calculate lineheight by common characters.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="string">"MXQJPmxqjp123"</span><span class="keyword">); </span><span class="comment">//use a custom string to get a fixed height.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$lineHeight </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">]; </span><span class="comment">// get the heightof this line<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$align </span><span class="keyword">= </span><span class="default">strtolower</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$align</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">)); </span><span class="comment">//Takes the first letter and converts to lower string. Support for Left, left and l etc.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$dstLines </span><span class="keyword">as </span><span class="default">$nr </span><span class="keyword">=&gt; </span><span class="default">$line</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$align </span><span class="keyword">!= </span><span class="string">"l"</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lineWidth </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// get the length of this line<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$align </span><span class="keyword">== </span><span class="string">"r"</span><span class="keyword">) { </span><span class="comment">//If the align is Right<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$locX </span><span class="keyword">= </span><span class="default">$x </span><span class="keyword">+ </span><span class="default">$width </span><span class="keyword">- </span><span class="default">$lineWidth</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else { </span><span class="comment">//If the align is Center<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$locX </span><span class="keyword">= </span><span class="default">$x </span><span class="keyword">+ (</span><span class="default">$width</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">) - (</span><span class="default">$lineWidth</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else { </span><span class="comment">//if the align is Left<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$locX </span><span class="keyword">= </span><span class="default">$x</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$locY </span><span class="keyword">= </span><span class="default">$y </span><span class="keyword">+ (</span><span class="default">$nr </span><span class="keyword">* </span><span class="default">$lineHeight</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Print the line.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">, </span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$locX</span><span class="keyword">, </span><span class="default">$locY</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; <br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60673""></a>
  <div class="note">
   <strong class="user">Nimja</strong>
   <a href="#60673" class="date">13-Jan-2006 03:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This is a completely rewritten function of "printWordWrapped" because it lacked a few important features. First of all, it started too high with it's text, which was easily fixed. And it has the annoying 'feature' of adding a space in front of every line. Not ideal.<br />
<br />
But secondly, and more importantly, it didn't support long words or linebreaks. This is all fixed. And I rewrote it for cleaner code.<br />
<br />
Please note that with the current code you could easily make a vertical align as well if you wanted to. I have not done this myself since it did not fit my own needs (and I'm slightly lazy)<br />
<br />
Enjoy:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">imageTextWrapped</span><span class="keyword">(&amp;</span><span class="default">$img</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y</span><span class="keyword">, </span><span class="default">$width</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">, </span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">$align</span><span class="keyword">=</span><span class="string">"l"</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$y </span><span class="keyword">+= </span><span class="default">$fontSize</span><span class="keyword">; </span><span class="comment">//Correct place for the fonts.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$text </span><span class="keyword">= </span><span class="default">str_replace </span><span class="keyword">(</span><span class="string">"\\r"</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">); </span><span class="comment">//Remove windows line-breaks<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$srcLines </span><span class="keyword">= </span><span class="default">split </span><span class="keyword">(</span><span class="string">"\\n"</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">); </span><span class="comment">//Split text into "lines"<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dstLines </span><span class="keyword">= Array(); </span><span class="comment">// The destination lines array.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$srcLines </span><span class="keyword">as </span><span class="default">$currentL</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$words </span><span class="keyword">= </span><span class="default">split </span><span class="keyword">(</span><span class="string">" "</span><span class="keyword">, </span><span class="default">$currentL</span><span class="keyword">); </span><span class="comment">//Split line into words.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$words </span><span class="keyword">as </span><span class="default">$word</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">.</span><span class="string">' '</span><span class="keyword">.</span><span class="default">$word</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lineWidth </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// get the length of this line, if the word is to be included<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$lineWidth </span><span class="keyword">&gt; </span><span class="default">$width </span><span class="keyword">&amp;&amp; !empty(</span><span class="default">$line</span><span class="keyword">) ) { </span><span class="comment">// check if it is too big if the word was added, if so, then move on.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dstLines</span><span class="keyword">[] = </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$line</span><span class="keyword">); </span><span class="comment">//Add the line like it was without spaces.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">.= </span><span class="default">$word</span><span class="keyword">.</span><span class="string">' '</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dstLines</span><span class="keyword">[] =&nbsp; </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$line</span><span class="keyword">); </span><span class="comment">//Add the line when the line ends.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//Calculate lineheight by common characters.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="string">"MXQJPmxqjp123"</span><span class="keyword">); </span><span class="comment">//use a custom string to get a fixed height.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$lineHeight </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">]; </span><span class="comment">// get the heightof this line<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$align </span><span class="keyword">= </span><span class="default">strtolower</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$align</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">)); </span><span class="comment">//Takes the first letter and converts to lower string. Support for Left, left and l etc.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$dstLines </span><span class="keyword">as </span><span class="default">$nr </span><span class="keyword">=&gt; </span><span class="default">$line</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$align </span><span class="keyword">!= </span><span class="string">"l"</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lineWidth </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// get the length of this line<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$align </span><span class="keyword">== </span><span class="string">"r"</span><span class="keyword">) { </span><span class="comment">//If the align is Right<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$locX </span><span class="keyword">= </span><span class="default">$x </span><span class="keyword">+ </span><span class="default">$width </span><span class="keyword">- </span><span class="default">$lineWidth</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else { </span><span class="comment">//If the align is Center<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$locX </span><span class="keyword">= </span><span class="default">$x </span><span class="keyword">+ (</span><span class="default">$width</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">) - (</span><span class="default">$lineWidth</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else { </span><span class="comment">//if the align is Left<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$locX </span><span class="keyword">= </span><span class="default">$x</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$locY </span><span class="keyword">= </span><span class="default">$y </span><span class="keyword">+ (</span><span class="default">$nr </span><span class="keyword">* </span><span class="default">$lineHeight</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Print the line.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">, </span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$locX</span><span class="keyword">, </span><span class="default">$locY</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; <br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60183""></a>
  <div class="note">
   <strong class="user">peisenmann at gmail dot com</strong>
   <a href="#60183" class="date">29-Dec-2005 03:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Another function for centered text string.<br />
What it does: Generate a truecolor .png image of a text string. The image will be just large enough encompass the text and a 2 px border and the text will be centered in it.<br />
<br />
It is called from any other page like so...<br />
&lt;img src="linkImg.php?text=php.net is great&amp;border=out" /&gt; // Text with #&amp;+"'\&lt;&gt; will need to be escaped, but I've found spaces don't cause errors. I haven't tested this with any other languages.<br />
<br />
The following code is the file named linkImg.php<br />
The file was not designed to have anything else here with it, and the open and close php tags should the the very first and very last characters of the page respectively, as outside whitespace can be a little evil sometimes.<br />
<span class="default">&lt;?php <br />
</span><span class="comment">//Obtain text and border via GET<br />
//Border can be out, in, or flat<br />
</span><span class="default">$text </span><span class="keyword">= </span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'text'</span><span class="keyword">];<br />
</span><span class="default">$border </span><span class="keyword">= </span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'border'</span><span class="keyword">];<br />
&nbsp;<br />
&nbsp; </span><span class="default">$font </span><span class="keyword">= </span><span class="string">"fontpath"</span><span class="keyword">; </span><span class="comment">//(str) "fonts/sasquatchlives.ttf"<br />
&nbsp; </span><span class="default">$fontsize </span><span class="keyword">= </span><span class="default">font size</span><span class="keyword">; </span><span class="comment">//(int) pixels in GD 1, or points in GD 2<br />
<br />
//Register box<br />
</span><span class="default">$box </span><span class="keyword">= </span><span class="default">imagettfbbox </span><span class="keyword">(</span><span class="default">$fontsize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
</span><span class="comment">//Find out the width and height of the text box<br />
</span><span class="default">$textW </span><span class="keyword">= </span><span class="default">$box</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$box</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
</span><span class="default">$textH</span><span class="keyword">= </span><span class="default">$box</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">]-</span><span class="default">$box</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">];<br />
</span><span class="comment">//Add padding<br />
</span><span class="default">$paddingx </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">;<br />
</span><span class="default">$paddingy </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">;<br />
</span><span class="comment">//Set image dimentions<br />
</span><span class="default">$width </span><span class="keyword">= </span><span class="default">$textW</span><span class="keyword">+</span><span class="default">$paddingx</span><span class="keyword">;<br />
</span><span class="default">$height</span><span class="keyword">= </span><span class="default">$textH</span><span class="keyword">+</span><span class="default">$paddingy</span><span class="keyword">;<br />
<br />
</span><span class="comment">//Bottom left corner of text<br />
</span><span class="default">$textx </span><span class="keyword">= </span><span class="default">$paddingx</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">;<br />
</span><span class="default">$texty </span><span class="keyword">= </span><span class="default">$height </span><span class="keyword">- </span><span class="default">$paddingy</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">;<br />
<br />
</span><span class="comment">//Shadow offset (pixels)<br />
</span><span class="default">$shadoffx </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br />
</span><span class="default">$shadoffy </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br />
<br />
</span><span class="comment">//Create the image<br />
&nbsp;</span><span class="default">$img </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$width</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">);<br />
</span><span class="comment">//Define some colors<br />
&nbsp;</span><span class="default">$white </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">255</span><span class="keyword">,</span><span class="default">255</span><span class="keyword">,</span><span class="default">255</span><span class="keyword">);<br />
&nbsp;</span><span class="default">$black </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">);<br />
&nbsp;</span><span class="default">$lightgrey </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">200</span><span class="keyword">,</span><span class="default">200</span><span class="keyword">,</span><span class="default">200</span><span class="keyword">);<br />
&nbsp;</span><span class="default">$grey </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">100</span><span class="keyword">,</span><span class="default">100</span><span class="keyword">,</span><span class="default">100</span><span class="keyword">);<br />
</span><span class="comment">//Define Text (fg) and background (bg) colors<br />
&nbsp;</span><span class="default">$bgcol </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">192</span><span class="keyword">,</span><span class="default">213</span><span class="keyword">,</span><span class="default">196</span><span class="keyword">); </span><span class="comment">//Celadon (light pastel green)<br />
&nbsp;</span><span class="default">$fgcol </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">243</span><span class="keyword">,</span><span class="default">104</span><span class="keyword">,</span><span class="default">88</span><span class="keyword">); </span><span class="comment">//Peach<br />
// Fill image with background color<br />
&nbsp;</span><span class="default">imagefill</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$bgcol</span><span class="keyword">); <br />
<br />
</span><span class="comment">//Write Shadow<br />
</span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">, </span><span class="default">$fontsize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$textx</span><span class="keyword">+</span><span class="default">$shadoffx</span><span class="keyword">, </span><span class="default">$texty</span><span class="keyword">+</span><span class="default">$shadoffy</span><span class="keyword">, </span><span class="default">$grey</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
<br />
</span><span class="comment">//Write Text<br />
</span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">, </span><span class="default">$fontsize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$textx</span><span class="keyword">, </span><span class="default">$texty</span><span class="keyword">, </span><span class="default">$fgcol</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
<br />
</span><span class="comment">//Bordering<br />
<br />
&nbsp;&nbsp; //Embossed border (button-looking)<br />
&nbsp;</span><span class="keyword">if (</span><span class="default">$border </span><span class="keyword">== </span><span class="string">"out"</span><span class="keyword">) <br />
&nbsp; {<br />
&nbsp;&nbsp; </span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$white</span><span class="keyword">);</span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">,</span><span class="default">$white</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">$lightgrey</span><span class="keyword">);</span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$lightgrey</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$black</span><span class="keyword">);</span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$black</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$grey</span><span class="keyword">);</span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">,</span><span class="default">$grey</span><span class="keyword">);<br />
<br />
&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//Flat border<br />
&nbsp;</span><span class="keyword">if (</span><span class="default">$border </span><span class="keyword">== </span><span class="string">"flat"</span><span class="keyword">) <br />
&nbsp; {<br />
&nbsp;&nbsp; </span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$white</span><span class="keyword">);</span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">,</span><span class="default">$white</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">$grey</span><span class="keyword">);</span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$grey</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$white</span><span class="keyword">);</span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$white</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$grey</span><span class="keyword">);</span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">,</span><span class="default">$grey</span><span class="keyword">);<br />
&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//Engraved border (pushed button)<br />
&nbsp;</span><span class="keyword">if (</span><span class="default">$border </span><span class="keyword">== </span><span class="string">"in"</span><span class="keyword">) <br />
&nbsp; {<br />
&nbsp;&nbsp; </span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$black</span><span class="keyword">);</span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">,</span><span class="default">$black</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">$grey</span><span class="keyword">);</span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$grey</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$white</span><span class="keyword">);</span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$white</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$lightgrey</span><span class="keyword">);</span><span class="default">imageline </span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">2</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">,</span><span class="default">$lightgrey</span><span class="keyword">);<br />
&nbsp; }<br />
<br />
</span><span class="comment">// Header info<br />
&nbsp;</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-type: image/png"</span><span class="keyword">);<br />
</span><span class="comment">//Sends the image<br />
&nbsp;</span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">);<br />
&nbsp;</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Hope this helps someone!<br />
-Patrick-</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="59623""></a>
  <div class="note">
   <strong class="user">Mickey9801 at ComicParty dot com</strong>
   <a href="#59623" class="date">11-Dec-2005 06:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have revised my mb_wordwrap function to fix 2 major bugs: cannot handle line break and infinite loop while handling very very long long long single byte word.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">mb_wordwrap</span><span class="keyword">(</span><span class="default">$txt</span><span class="keyword">,</span><span class="default">$font</span><span class="keyword">,</span><span class="default">$size</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pointer </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="comment">// Current character position pointer<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this_line_start </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="comment">// Starting character position of current line<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this_line_strlen </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">; </span><span class="comment">// How long is the current line<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$single_byte_stack </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">; </span><span class="comment">// Variable for storing single byte word<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sbs_line_width </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="comment">// Pixel width of the Single byte word<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this_is_cr </span><span class="keyword">= </span><span class="default">FALSE</span><span class="keyword">; </span><span class="comment">// Check if the character is new line code (ASCII=10)<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result_lines </span><span class="keyword">= array(); </span><span class="comment">// Array for storing the return result<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">while (</span><span class="default">$pointer </span><span class="keyword">&lt; </span><span class="default">mb_strlen</span><span class="keyword">(</span><span class="default">$txt</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this_char </span><span class="keyword">= </span><span class="default">mb_substr</span><span class="keyword">(</span><span class="default">$txt</span><span class="keyword">,</span><span class="default">$pointer</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$this_char</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">])==</span><span class="default">10</span><span class="keyword">) </span><span class="default">$this_is_cr </span><span class="keyword">= </span><span class="default">TRUE</span><span class="keyword">; </span><span class="comment">// Check if it is a new line<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // Check current line width<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmp_line </span><span class="keyword">= </span><span class="default">mb_substr</span><span class="keyword">(</span><span class="default">$txt</span><span class="keyword">, </span><span class="default">$this_line_start</span><span class="keyword">, </span><span class="default">$this_line_strlen</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmp_line_bbox </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$font</span><span class="keyword">,</span><span class="default">$tmp_line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this_line_width </span><span class="keyword">= </span><span class="default">$tmp_line_bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]-</span><span class="default">$tmp_line_bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Prevent to cut off english word at the end of line<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // if this character is a alphanumeric character or open bracket, put it into stack<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">is_alphanumeric</span><span class="keyword">(</span><span class="default">$this_char</span><span class="keyword">, </span><span class="default">$single_byte_stack</span><span class="keyword">)) </span><span class="default">$single_byte_stack </span><span class="keyword">.= </span><span class="default">$this_char</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Check the width of single byte words<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$single_byte_stack </span><span class="keyword">!= </span><span class="string">""</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmp_line_bbox </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$font</span><span class="keyword">,</span><span class="default">$single_byte_stack</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sbs_line_width </span><span class="keyword">= </span><span class="default">$tmp_line_bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]-</span><span class="default">$tmp_line_bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$this_is_cr </span><span class="keyword">|| </span><span class="default">$this_line_width </span><span class="keyword">&gt; </span><span class="default">$width </span><span class="keyword">|| </span><span class="default">$sbs_line_width </span><span class="keyword">&gt;= </span><span class="default">$width</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// If last word is alphanumeric, put it to next line rather then cut it off<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$single_byte_stack </span><span class="keyword">!= </span><span class="string">"" </span><span class="keyword">&amp;&amp; </span><span class="default">is_alphanumeric</span><span class="keyword">(</span><span class="default">$this_char</span><span class="keyword">, </span><span class="default">$single_byte_stack</span><span class="keyword">) &amp;&amp; </span><span class="default">$sbs_line_width </span><span class="keyword">&lt; </span><span class="default">$width</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$stack_len </span><span class="keyword">= </span><span class="default">mb_strlen</span><span class="keyword">(</span><span class="default">$single_byte_stack</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this_line_strlen </span><span class="keyword">= </span><span class="default">$this_line_strlen </span><span class="keyword">- </span><span class="default">$stack_len </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pointer </span><span class="keyword">= </span><span class="default">$pointer </span><span class="keyword">- </span><span class="default">$stack_len </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Move the current line to result array and reset all counter<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result_lines</span><span class="keyword">[] = </span><span class="default">mb_substr</span><span class="keyword">(</span><span class="default">$txt</span><span class="keyword">, </span><span class="default">$this_line_start</span><span class="keyword">, </span><span class="default">$this_line_strlen</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$this_is_cr</span><span class="keyword">) { </span><span class="default">$pointer</span><span class="keyword">++; </span><span class="default">$this_is_cr</span><span class="keyword">=</span><span class="default">FALSE</span><span class="keyword">; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$sbs_line_width </span><span class="keyword">&gt;= </span><span class="default">$width</span><span class="keyword">) </span><span class="default">$sbs_line_width </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this_line_start </span><span class="keyword">= </span><span class="default">$pointer</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this_line_strlen </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$single_byte_stack </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">is_alphanumeric</span><span class="keyword">(</span><span class="default">$this_char</span><span class="keyword">, </span><span class="default">$single_byte_stack</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$single_byte_stack </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">; </span><span class="comment">// Clear stack if met multibyte character and not line end<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this_line_strlen</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pointer</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Move remained word to result<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result_lines</span><span class="keyword">[] = </span><span class="default">mb_substr</span><span class="keyword">(</span><span class="default">$txt</span><span class="keyword">, </span><span class="default">$this_line_start</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$result_lines</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">is_alphanumeric</span><span class="keyword">(</span><span class="default">$character</span><span class="keyword">, </span><span class="default">$stack</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; if (<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$character</span><span class="keyword">)&gt;=</span><span class="default">48 </span><span class="keyword">&amp;&amp; </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$character</span><span class="keyword">)&lt;=</span><span class="default">57</span><span class="keyword">) || <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$character</span><span class="keyword">)&gt;=</span><span class="default">65 </span><span class="keyword">&amp;&amp; </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$character</span><span class="keyword">)&lt;=</span><span class="default">91</span><span class="keyword">) || <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$character</span><span class="keyword">)&gt;=</span><span class="default">97 </span><span class="keyword">&amp;&amp; </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$character</span><span class="keyword">)&lt;=</span><span class="default">123</span><span class="keyword">) || <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$character</span><span class="keyword">)==</span><span class="default">40 </span><span class="keyword">|| <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$character</span><span class="keyword">)==</span><span class="default">60 </span><span class="keyword">|| <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="default">$stack</span><span class="keyword">==</span><span class="string">"" </span><span class="keyword">&amp;&amp; (</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$character</span><span class="keyword">)==</span><span class="default">34 </span><span class="keyword">|| </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$character</span><span class="keyword">)==</span><span class="default">39</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ) return </span><span class="default">TRUE</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else return </span><span class="default">FALSE</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="59620""></a>
  <div class="note">
   <strong class="user">Nashev</strong>
   <a href="#59620" class="date">11-Dec-2005 02:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
see <a href="http://php.rinet.ru/manual/ru/function.imagettftext.php#57416 " rel="nofollow" target="_blank">http://php.rinet.ru/manual/ru/function.imagettftext.php#57416 </a><br />
<br />
function ByteCount($s) {<br />
&nbsp;&nbsp;&nbsp; $has_mbstring = extension_loaded('mbstring') ||@dl(PHP_SHLIB_PREFIX.'mbstring.'.PHP_SHLIB_SUFFIX);<br />
&nbsp;&nbsp;&nbsp; $has_mb_shadow = (int) ini_get('mbstring.func_overload');<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if ($has_mbstring &amp;&amp; ($has_mb_shadow &amp; 2) ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; $size = mb_strlen($s,'latin1');<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; $size = strlen($s);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return $size;<br />
}<br />
<br />
function foxy_utf8_to_nce($s) {<br />
&nbsp; $utf = "$s";<br />
&nbsp; <br />
&nbsp; $max_count = 5; // flag-bits in $max_mark ( 1111 1000 == 5 times 1)<br />
&nbsp; $max_mark = 248; // marker for a (theoretical ;-)) 5-byte-char and mask for a 4-byte-char;<br />
<br />
&nbsp; $html = '';<br />
&nbsp; $ByteCount = ByteCount($utf);<br />
&nbsp; for($str_pos = 0; $str_pos &lt; $ByteCount; $str_pos++) {<br />
&nbsp;&nbsp;&nbsp; $old_chr = $utf{$str_pos};<br />
&nbsp;&nbsp;&nbsp; $old_val = ord($old_chr);<br />
&nbsp;&nbsp;&nbsp; $new_val = 0;<br />
<br />
&nbsp;&nbsp;&nbsp; $utf8_marker = 0;<br />
<br />
&nbsp;&nbsp;&nbsp; // skip non-utf-8-chars<br />
&nbsp;&nbsp;&nbsp; if ($old_val &gt; 127) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; $mark = $max_mark;<br />
&nbsp;&nbsp; &nbsp;&nbsp; for ($byte_ctr = $max_count; $byte_ctr &gt; 2; $byte_ctr--) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // actual byte is utf-8-marker?<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (($old_val &amp; $mark) == (($mark &lt;&lt; 1) &amp; 255)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $utf8_marker = $byte_ctr - 1;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $mark = ($mark &lt;&lt; 1) &amp; 255;<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; // marker found: collect following bytes<br />
&nbsp;&nbsp;&nbsp; if ($utf8_marker &gt; 1 and isset($utf{$str_pos + 1})) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; $str_off = 0;<br />
&nbsp;&nbsp; &nbsp;&nbsp; $new_val = $old_val &amp; (127 &gt;&gt; $utf8_marker);<br />
&nbsp;&nbsp; &nbsp;&nbsp; for($byte_ctr = $utf8_marker; $byte_ctr &gt; 1; $byte_ctr--) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // check if following chars are UTF8 additional data blocks<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // UTF8 and ord() &gt; 127<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if( (ord($utf{$str_pos + 1}) &amp; 192) == 128 ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $new_val = $new_val &lt;&lt; 6;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $str_off++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // no need for Addition, bitwise OR is sufficient<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // 63: more UTF8-bytes; 0011 1111<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $new_val = $new_val | ( ord( $utf{$str_pos + $str_off} ) &amp; 63 );<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // no UTF8, but ord() &gt; 127<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // nevertheless convert first char to NCE<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $new_val = $old_val;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; // build NCE-Code<br />
&nbsp;&nbsp; &nbsp;&nbsp; $html .= '&amp;#'.$new_val.';';<br />
&nbsp;&nbsp; &nbsp;&nbsp; // Skip additional UTF-8-Bytes<br />
&nbsp;&nbsp; &nbsp;&nbsp; $str_pos = $str_pos + $str_off;<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp;&nbsp; $html .= chr($old_val);<br />
&nbsp;&nbsp; &nbsp;&nbsp; //$new_val = $old_val;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; }<br />
&nbsp; return $html;<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58972""></a>
  <div class="note">
   <strong class="user">Mickey9801 at ComicParty dot com</strong>
   <a href="#58972" class="date">22-Nov-2005 09:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Most of functions shared here seems only work with western language and is not suitable for multibyte characters (like Chinese). I have written a function using mb_string functions to match the need of multibyte character word wrapping.<br />
<br />
I also added some machanism so that English word won't be cut off at the end of line. Of couse you must use unicode string on GD.<br />
<br />
function mb_wordwrap($txt,$font,$size,$width) {<br />
&nbsp;&nbsp;&nbsp; $pointer = 0;<br />
&nbsp;&nbsp;&nbsp; $this_line_start = 0;<br />
&nbsp;&nbsp;&nbsp; $this_line_strlen = 1;<br />
&nbsp;&nbsp;&nbsp; $single_byte_stack = "";<br />
&nbsp;&nbsp;&nbsp; $result_lines = array();<br />
&nbsp;&nbsp;&nbsp; while ($pointer &lt;= mb_strlen($txt)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $this_char = mb_substr($txt,$pointer,1);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $tmp_line = mb_substr($txt, $this_line_start, $this_line_strlen);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $tmp_line_bbox = imagettfbbox($size,0,$font,$tmp_line);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $this_line_width = $tmp_line_bbox[2]-$tmp_line_bbox[0];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ($this_line_width &gt; $width) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // If last word is alphanumeric, put it to next line rather then cut it off<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if ($single_byte_stack != "") {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $stack_len = mb_strlen($single_byte_stack);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $this_line_strlen -= $stack_len;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $pointer -= $stack_len;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $result_lines[] = mb_substr($txt, $this_line_start, $this_line_strlen-1);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $this_line_start = $pointer;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $this_line_strlen = 1;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $single_byte_stack = "";<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // Prevent to cut off english word at the end of line<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // if this character is a alphanumeric character or open bracket, put it into stack<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (ord($this_char)&gt;=48 &amp;&amp; ord($this_char)&lt;=57) || <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (ord($this_char)&gt;=65 &amp;&amp; ord($this_char)&lt;=91) || <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (ord($this_char)&gt;=97 &amp;&amp; ord($this_char)&lt;=123) || <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ord($this_char)==40 || <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ord($this_char)==60 || <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ($single_byte_stack=="" &amp;&amp; (ord($this_char)==34 || ord($this_char)==39))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ) $single_byte_stack .= $this_char;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else $single_byte_stack = ""; // Clear stack if met multibyte character and not line end<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $this_line_strlen++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $pointer++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; // Move remained word to result<br />
&nbsp;&nbsp;&nbsp; $result_lines[] = mb_substr($txt, $this_line_start);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; return $result_lines;<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58451""></a>
  <div class="note">
   <strong class="user">Info at GravoMaster dot com</strong>
   <a href="#58451" class="date">04-Nov-2005 05:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
TTF character charmap page<br />
Could use some help in reading ttf file<br />
so that unused rectangle chars are filtered out of the charmap<br />
see<br />
<a href="http://www.phpenabled.com/ttf_fontlist/" rel="nofollow" target="_blank">http://www.phpenabled.com/ttf_fontlist/</a><br />
fontlist.php?font=Phones_NormalA.ttf</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="55827""></a>
  <div class="note">
   <strong class="user">c.scheffers [gmail]</strong>
   <a href="#55827" class="date">14-Aug-2005 10:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I would like to post a small modification to the imageprintWordWrapped() posted below also.<br />
<br />
The following code causes each line to start with a space, which results in the incorrect alignment of text:<br />
<br />
$line .= ' '.$words[0]; // add the word to the current sentence<br />
<br />
A (quick) fix for this problem:<br />
<br />
$line .= ($line != '' ? ' ' : '').$words[0]; // add the word to the current sentence</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="55437""></a>
  <div class="note">
   <strong class="user">fernandez_marce at yahoo dot com</strong>
   <a href="#55437" class="date">03-Aug-2005 07:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I would modify the last function imageprintWordWrapped() posted below. When it says:<br />
<br />
// do the actual printing<br />
$i = 0;<br />
<br />
$i should be equal to 1, because if $top is greater than 0, the imagettftext() call will not work for the first element in the $lines array ($top + lineHeight*$i) == $top when $i=0!<br />
<br />
imagettftext($image, $textSize, 0, $leftStart, $top + $lineHeight * $i, $color, $font, $line);<br />
$i++;<br />
<br />
To sum up, replace<br />
<br />
// do the actual printing<br />
$i = 0;<br />
<br />
with:<br />
// do the actual printing<br />
$i = 1;<br />
<br />
Cheers,<br />
Marcelo</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="55257""></a>
  <div class="note">
   <strong class="user">thetorpedodog [gmail]</strong>
   <a href="#55257" class="date">28-Jul-2005 06:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just for the sake of consistency, I turned Miles' function into one that takes a $right value rather than a $maxWidth value. This makes it like all the other image* functions.<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">imageprintWordWrapped</span><span class="keyword">(&amp;</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$top</span><span class="keyword">, </span><span class="default">$left</span><span class="keyword">, </span><span class="default">$right</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">, </span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">$halign</span><span class="keyword">=</span><span class="string">"left"</span><span class="keyword">) {<br />
&nbsp;&nbsp; </span><span class="default">$maxWidth </span><span class="keyword">= </span><span class="default">$right </span><span class="keyword">- </span><span class="default">$left </span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment">//the trivial change<br />
&nbsp;&nbsp; </span><span class="default">$words </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">' '</span><span class="keyword">, </span><span class="default">strip_tags</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">)); </span><span class="comment">// split the text into an array of single words<br />
&nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; while (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$words</span><span class="keyword">) &gt; </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">.</span><span class="string">' '</span><span class="keyword">.</span><span class="default">$words</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$lineWidth </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// get the length of this line, if the word is to be included<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="keyword">if (</span><span class="default">$lineWidth </span><span class="keyword">&gt; </span><span class="default">$maxWidth</span><span class="keyword">) { </span><span class="comment">// if this makes the text wider that anticipated<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$lines</span><span class="keyword">[] = </span><span class="default">$line</span><span class="keyword">; </span><span class="comment">// add the line to the others<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">; </span><span class="comment">// empty it (the word will be added outside the loop)<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$line </span><span class="keyword">.= </span><span class="string">' '</span><span class="keyword">.</span><span class="default">$words</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// add the word to the current sentence<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$words </span><span class="keyword">= </span><span class="default">array_slice</span><span class="keyword">(</span><span class="default">$words</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">); </span><span class="comment">// remove the word from the array<br />
&nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp; if (</span><span class="default">$line </span><span class="keyword">!= </span><span class="string">''</span><span class="keyword">) { </span><span class="default">$lines</span><span class="keyword">[] = </span><span class="default">$line</span><span class="keyword">; } </span><span class="comment">// add the last line to the others, if it isn't empty<br />
&nbsp;&nbsp; </span><span class="default">$lineHeight </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]; </span><span class="comment">// the height of a single line<br />
&nbsp;&nbsp; </span><span class="default">$height </span><span class="keyword">= </span><span class="default">count</span><span class="keyword">(</span><span class="default">$lines</span><span class="keyword">) * </span><span class="default">$lineHeight</span><span class="keyword">; </span><span class="comment">// the height of all the lines total<br />
&nbsp;&nbsp; // do the actual printing<br />
&nbsp;&nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; </span><span class="comment">//print_R($widths);<br />
&nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$lines </span><span class="keyword">as </span><span class="default">$line</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; if(</span><span class="default">$halign</span><span class="keyword">==</span><span class="string">"center"</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//figure out width of line<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$lineWidth </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//figure out where the center is.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$center</span><span class="keyword">=</span><span class="default">floor</span><span class="keyword">(</span><span class="default">$maxWidth</span><span class="keyword">/</span><span class="default">2 </span><span class="keyword">+ </span><span class="default">$left</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$leftStart</span><span class="keyword">=</span><span class="default">$center</span><span class="keyword">-</span><span class="default">$lineWidth</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; } else if (</span><span class="default">$halign</span><span class="keyword">==</span><span class="string">"right"</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//figure out width of line<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$lineWidth </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$leftStart</span><span class="keyword">=</span><span class="default">$left</span><span class="keyword">+</span><span class="default">$maxWidth</span><span class="keyword">-</span><span class="default">$lineWidth</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$leftStart</span><span class="keyword">=</span><span class="default">$left</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; }&nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$leftStart</span><span class="keyword">, </span><span class="default">$top </span><span class="keyword">+ </span><span class="default">$lineHeight </span><span class="keyword">* </span><span class="default">$i</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$i</span><span class="keyword">++;<br />
&nbsp;&nbsp; }<br />
&nbsp;&nbsp; return </span><span class="default">$height</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="54694""></a>
  <div class="note">
   <strong class="user">miles at dinewilmingtononline dot com</strong>
   <a href="#54694" class="date">13-Jul-2005 03:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is a slight modification to the function posted below that vegard posted that allows for left, right or center alignment within the text boxes.&nbsp; <br />
<br />
$halign has a default of left.&nbsp; center, and right can also be put in.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">printWordWrapped</span><span class="keyword">(&amp;</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$top</span><span class="keyword">, </span><span class="default">$left</span><span class="keyword">, </span><span class="default">$maxWidth</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">, </span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">$halign</span><span class="keyword">=</span><span class="string">"left"</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$words </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">' '</span><span class="keyword">, </span><span class="default">strip_tags</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">)); </span><span class="comment">// split the text into an array of single words<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; while (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$words</span><span class="keyword">) &gt; </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">.</span><span class="string">' '</span><span class="keyword">.</span><span class="default">$words</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lineWidth </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// get the length of this line, if the word is to be included<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$lineWidth </span><span class="keyword">&gt; </span><span class="default">$maxWidth</span><span class="keyword">) { </span><span class="comment">// if this makes the text wider that anticipated<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lines</span><span class="keyword">[] = </span><span class="default">$line</span><span class="keyword">; </span><span class="comment">// add the line to the others<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">; </span><span class="comment">// empty it (the word will be added outside the loop)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">.= </span><span class="string">' '</span><span class="keyword">.</span><span class="default">$words</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// add the word to the current sentence<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$words </span><span class="keyword">= </span><span class="default">array_slice</span><span class="keyword">(</span><span class="default">$words</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">); </span><span class="comment">// remove the word from the array<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$line </span><span class="keyword">!= </span><span class="string">''</span><span class="keyword">) { </span><span class="default">$lines</span><span class="keyword">[] = </span><span class="default">$line</span><span class="keyword">; } </span><span class="comment">// add the last line to the others, if it isn't empty<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$lineHeight </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]; </span><span class="comment">// the height of a single line<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$height </span><span class="keyword">= </span><span class="default">count</span><span class="keyword">(</span><span class="default">$lines</span><span class="keyword">) * </span><span class="default">$lineHeight</span><span class="keyword">; </span><span class="comment">// the height of all the lines total<br />
&nbsp;&nbsp;&nbsp; // do the actual printing<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//print_R($widths);<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$lines </span><span class="keyword">as </span><span class="default">$line</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$halign</span><span class="keyword">==</span><span class="string">"center"</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//figure out width of line<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lineWidth </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//figure out where the center is.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$center</span><span class="keyword">=</span><span class="default">floor</span><span class="keyword">(</span><span class="default">$maxWidth</span><span class="keyword">/</span><span class="default">2 </span><span class="keyword">+ </span><span class="default">$left</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$leftStart</span><span class="keyword">=</span><span class="default">$center</span><span class="keyword">-</span><span class="default">$lineWidth</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else if (</span><span class="default">$halign</span><span class="keyword">==</span><span class="string">"right"</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//figure out width of line<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lineWidth </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$leftStart</span><span class="keyword">=</span><span class="default">$left</span><span class="keyword">+</span><span class="default">$maxWidth</span><span class="keyword">-</span><span class="default">$lineWidth</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$leftStart</span><span class="keyword">=</span><span class="default">$left</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }&nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$leftStart</span><span class="keyword">, </span><span class="default">$top </span><span class="keyword">+ </span><span class="default">$lineHeight </span><span class="keyword">* </span><span class="default">$i</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">++;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$height</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="53736""></a>
  <div class="note">
   <strong class="user">info at rainer-schuetze dot de</strong>
   <a href="#53736" class="date">11-Jun-2005 06:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
according function by jtopland at hive dot no<br />
08-Feb-2004 03:26<br />
<br />
soukhinov at mail dot ru was right, the function doesn't work with 180?. By the way it was a intresting way to trasform the angle to radian. Change the calculation of the angle to the following:&nbsp; $angle = $angle/ 180 * pi();<br />
The function to calc. the points is correct. Sorry to say this, but the cal. of the height and width is incorrect. I used the version from LB (11-Feb-2004 08:55)<br />
<br />
&nbsp;&nbsp;&nbsp; /**<br />
&nbsp;&nbsp; &nbsp; * return width and height, offset [left, top] of a ttf character<br />
&nbsp;&nbsp; &nbsp; * @param string $font : the font file<br />
&nbsp;&nbsp; &nbsp; * @param string $text : the character<br />
&nbsp;&nbsp; &nbsp; * @param int $size : the font size<br />
&nbsp;&nbsp; &nbsp; * @param int $angle : the angle<br />
&nbsp;&nbsp; &nbsp; * @access private<br />
&nbsp;&nbsp; &nbsp; * @return array&nbsp; of the width and height, left and top.<br />
&nbsp;&nbsp; &nbsp; **/<br />
&nbsp;&nbsp;&nbsp; function _getCharacterSize($font, $text, $size, $angle)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; // Get the boundingbox from imagettfbbox(), which is correct when angle is 0<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; $bbox = imagettfbbox($size, 0, $font, $text);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; // Rotate the boundingbox<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; $angle = $angle/ 180 * pi();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; for ($i=0; $i&lt;4; $i++)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $x = $bbox[$i * 2];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $y = $bbox[$i * 2 + 1];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $bbox[$i * 2] = cos($angle) * $x - sin($angle) * $y;&nbsp; // X<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $bbox[$i * 2 + 1] = sin($angle) * $x + cos($angle) * $y; // Y<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; // Variables which tells the correct width and height<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $bbox["left"] = 0- min($bbox[0],$bbox[2],$bbox[4],$bbox[6]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $bbox["top"] = 0- min($bbox[1],$bbox[3],$bbox[5],$bbox[7]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $bbox["width"] = max($bbox[0],$bbox[2],$bbox[4],$bbox[6]) -&nbsp; min($bbox[0],$bbox[2],$bbox[4],$bbox[6]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $bbox["height"] = max($bbox[1],$bbox[3],$bbox[5],$bbox[7]) - min($bbox[1],$bbox[3],$bbox[5],$bbox[7]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return $bbox;<br />
&nbsp;&nbsp;&nbsp; }</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52434""></a>
  <div class="note">
   <strong class="user">php@da dot mcbf dot net</strong>
   <a href="#52434" class="date">01-May-2005 04:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Pretty trivial, but still might save someone some trouble: on my system (Debian Linux), the absolute path to the font file had to be specified. I tried it relative to the current webpage and that did not work.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="51563""></a>
  <div class="note">
   <strong class="user">vegard at I dot DONT dot WANT dot SPAM dot programmer dot no</strong>
   <a href="#51563" class="date">04-Apr-2005 03:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is a function that wordwraps text you want to print, allows to specify where the text should be printed, what the maximum width should be, and returns the height used.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">printWordWrapped</span><span class="keyword">(&amp;</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$top</span><span class="keyword">, </span><span class="default">$left</span><span class="keyword">, </span><span class="default">$maxWidth</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">, </span><span class="default">$textSize</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$words </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">' '</span><span class="keyword">, </span><span class="default">strip_tags</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">)); </span><span class="comment">// split the text into an array of single words<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$words</span><span class="keyword">) &gt; </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dimensions </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">.</span><span class="string">' '</span><span class="keyword">.</span><span class="default">$words</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lineWidth </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// get the length of this line, if the word is to be included<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$lineWidth </span><span class="keyword">&gt; </span><span class="default">$maxWidth</span><span class="keyword">) { </span><span class="comment">// if this makes the text wider that anticipated<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lines</span><span class="keyword">[] = </span><span class="default">$line</span><span class="keyword">; </span><span class="comment">// add the line to the others<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">; </span><span class="comment">// empty it (the word will be added outside the loop)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">.= </span><span class="string">' '</span><span class="keyword">.</span><span class="default">$words</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// add the word to the current sentence<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$words </span><span class="keyword">= </span><span class="default">array_slice</span><span class="keyword">(</span><span class="default">$words</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">); </span><span class="comment">// remove the word from the array<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$line </span><span class="keyword">!= </span><span class="string">''</span><span class="keyword">) { </span><span class="default">$lines</span><span class="keyword">[] = </span><span class="default">$line</span><span class="keyword">; } </span><span class="comment">// add the last line to the others, if it isn't empty<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lineHeight </span><span class="keyword">= </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] - </span><span class="default">$dimensions</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]; </span><span class="comment">// the height of a single line<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$height </span><span class="keyword">= </span><span class="default">count</span><span class="keyword">(</span><span class="default">$lines</span><span class="keyword">) * </span><span class="default">$lineHeight</span><span class="keyword">; </span><span class="comment">// the height of all the lines total<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // do the actual printing<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; foreach (</span><span class="default">$lines </span><span class="keyword">as </span><span class="default">$line</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$textSize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$left</span><span class="keyword">, </span><span class="default">$top </span><span class="keyword">+ </span><span class="default">$lineHeight </span><span class="keyword">* </span><span class="default">$i</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$height</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="51373""></a>
  <div class="note">
   <strong class="user">ryan at retronetworks dot com</strong>
   <a href="#51373" class="date">29-Mar-2005 04:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is a function that lets you write a string with your own "font tracking" level (the amount of pixels separating each character).&nbsp; It uses imagettfbbox to determine the width of each character, so it doesn't discriminate against the skinnier of characters.&nbsp; For this example, let $t = the amount of distance in pixels you want to separate each character from its neighbors.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">ImageTTFTextWithTracking</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, </span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$t</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$numchar </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; for(</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$numchar</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment"># Assign character<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$char</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">, </span><span class="default">$i</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment"># Write character<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, </span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, (</span><span class="default">$x </span><span class="keyword">+ </span><span class="default">$w </span><span class="keyword">+ (</span><span class="default">$i </span><span class="keyword">* </span><span class="default">$t</span><span class="keyword">)), </span><span class="default">$y</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$char</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment"># Get width of character<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$width </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$char</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$w </span><span class="keyword">= </span><span class="default">$w </span><span class="keyword">+ </span><span class="default">$width</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Be aware that it currently does not work for angles other than the 0 default (I have no need for that).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="50987""></a>
  <div class="note">
   <strong class="user">soukhinov at mail dot ru</strong>
   <a href="#50987" class="date">16-Mar-2005 01:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have tryed all of fixes<br />
The David Eder's fix is the only working fix.<br />
The "jtopland at hive dot no"s fix is good enough, but it not working with angle = 180 degrees.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="43523""></a>
  <div class="note">
   <strong class="user">helloktk at naver dot com</strong>
   <a href="#43523" class="date">24-Jun-2004 03:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is a function which moves the center of text's bounding <br />
box to a given pivot point (px,py) and rotates text about<br />
that point.<br />
<span class="default">&lt;?php<br />
$width</span><span class="keyword">=</span><span class="default">500</span><span class="keyword">;<br />
</span><span class="default">$height</span><span class="keyword">=</span><span class="default">400</span><span class="keyword">;<br />
</span><span class="default">$fontpath </span><span class="keyword">= </span><span class="string">'c:/windows/fonts/arial.ttf'</span><span class="keyword">;<br />
</span><span class="default">$text </span><span class="keyword">= </span><span class="string">'Finally, I have a roated text box'</span><span class="keyword">;<br />
</span><span class="default">$fontsize </span><span class="keyword">= </span><span class="default">20</span><span class="keyword">;<br />
</span><span class="default">$angle </span><span class="keyword">= </span><span class="default">30.0</span><span class="keyword">;<br />
</span><span class="comment">// create an image and fill the background with lightgray<br />
</span><span class="default">$image </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$width</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">);<br />
</span><span class="default">imagefill</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0xDDDDDD</span><span class="keyword">);<br />
</span><span class="comment">// bounding box<br />
</span><span class="default">$bbox </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$fontsize</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$fontpath</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
</span><span class="comment">// baseline point for drawing non-rotated text.<br />
</span><span class="default">$x0</span><span class="keyword">=&nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">];<br />
</span><span class="default">$y0</span><span class="keyword">=-</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">];<br />
</span><span class="comment">// fixes bounding box w.r.t. image coordinate.<br />
</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">]=-</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">]+</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">];<br />
</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]=-</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]+</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">];<br />
</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]=</span><span class="default">0</span><span class="keyword">;<br />
</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">]=</span><span class="default">0</span><span class="keyword">;<br />
</span><span class="comment">// get the size of image.<br />
</span><span class="default">$sx</span><span class="keyword">=</span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
</span><span class="default">$sy</span><span class="keyword">=</span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
</span><span class="comment">// center of bounding box (xc,yc);<br />
</span><span class="default">$xc</span><span class="keyword">=(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]+</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">])/</span><span class="default">2.0</span><span class="keyword">;<br />
</span><span class="default">$yc</span><span class="keyword">=(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]+</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">])/</span><span class="default">2.0</span><span class="keyword">;<br />
</span><span class="comment">// rotation angle in radian<br />
</span><span class="default">$rad</span><span class="keyword">=</span><span class="default">$angle</span><span class="keyword">*</span><span class="default">pi</span><span class="keyword">()/</span><span class="default">180.0</span><span class="keyword">;<br />
</span><span class="default">$sa</span><span class="keyword">=</span><span class="default">sin</span><span class="keyword">(</span><span class="default">$rad</span><span class="keyword">);<br />
</span><span class="default">$ca</span><span class="keyword">=</span><span class="default">cos</span><span class="keyword">(</span><span class="default">$rad</span><span class="keyword">);<br />
</span><span class="default">$x1</span><span class="keyword">=</span><span class="default">$x0</span><span class="keyword">-</span><span class="default">$xc</span><span class="keyword">;<br />
</span><span class="default">$y1</span><span class="keyword">=</span><span class="default">$y0</span><span class="keyword">-</span><span class="default">$yc</span><span class="keyword">;<br />
</span><span class="comment">//pivot point(here, we take the center of image)<br />
</span><span class="default">$px</span><span class="keyword">=</span><span class="default">$sx</span><span class="keyword">/</span><span class="default">2.0</span><span class="keyword">;<br />
</span><span class="default">$py</span><span class="keyword">=</span><span class="default">$sy</span><span class="keyword">/</span><span class="default">2.0</span><span class="keyword">;<br />
</span><span class="comment">// new baseline point for rotated text.<br />
</span><span class="default">$x2</span><span class="keyword">= </span><span class="default">intval</span><span class="keyword">( </span><span class="default">$x1</span><span class="keyword">*</span><span class="default">$ca</span><span class="keyword">+</span><span class="default">$y1</span><span class="keyword">*</span><span class="default">$sa</span><span class="keyword">+</span><span class="default">$px</span><span class="keyword">+</span><span class="default">0.5</span><span class="keyword">);<br />
</span><span class="default">$y2</span><span class="keyword">= </span><span class="default">intval</span><span class="keyword">(-</span><span class="default">$x1</span><span class="keyword">*</span><span class="default">$sa</span><span class="keyword">+</span><span class="default">$y1</span><span class="keyword">*</span><span class="default">$ca</span><span class="keyword">+</span><span class="default">$py</span><span class="keyword">+</span><span class="default">0.5</span><span class="keyword">);<br />
<br />
</span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">,</span><span class="default">$fontsize</span><span class="keyword">,</span><span class="default">$angle</span><span class="keyword">,</span><span class="default">$x2</span><span class="keyword">,</span><span class="default">$y2</span><span class="keyword">,</span><span class="default">0xFF</span><span class="keyword">,</span><span class="default">$fontpath</span><span class="keyword">,</span><span class="default">$text</span><span class="keyword">);<br />
</span><span class="comment">// draw rotated bounding box;<br />
</span><span class="default">rotbbox</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">,</span><span class="default">$angle</span><span class="keyword">,</span><span class="default">$px</span><span class="keyword">,</span><span class="default">$py</span><span class="keyword">);&nbsp;&nbsp; <br />
for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">4</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++){<br />
&nbsp;&nbsp; </span><span class="default">$x0</span><span class="keyword">=</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">*</span><span class="default">$i</span><span class="keyword">+</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp; </span><span class="default">$y0</span><span class="keyword">=</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">*</span><span class="default">$i</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">];<br />
&nbsp;&nbsp; </span><span class="default">$j</span><span class="keyword">=</span><span class="default">$i</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">; <br />
&nbsp;&nbsp; if(</span><span class="default">$j</span><span class="keyword">==</span><span class="default">4</span><span class="keyword">) </span><span class="default">$j</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; </span><span class="default">$x1</span><span class="keyword">=</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">*</span><span class="default">$j</span><span class="keyword">+</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp; </span><span class="default">$y1</span><span class="keyword">=</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">*</span><span class="default">$j</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">];<br />
&nbsp;&nbsp; </span><span class="default">imageline</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">,</span><span class="default">$x0</span><span class="keyword">,</span><span class="default">$y0</span><span class="keyword">,</span><span class="default">$x1</span><span class="keyword">,</span><span class="default">$y1</span><span class="keyword">,</span><span class="default">0xFF0000</span><span class="keyword">);<br />
}<br />
</span><span class="comment">// Show the image<br />
</span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
<br />
function </span><span class="default">rotbbox</span><span class="keyword">(&amp;</span><span class="default">$bbox</span><span class="keyword">,</span><span class="default">$angle</span><span class="keyword">,</span><span class="default">$px</span><span class="keyword">,</span><span class="default">$py</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$xc</span><span class="keyword">=(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]+</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">])/</span><span class="default">2.0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$yc</span><span class="keyword">=(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]+</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">])/</span><span class="default">2.0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$rad</span><span class="keyword">=</span><span class="default">$angle</span><span class="keyword">*</span><span class="default">pi</span><span class="keyword">()/</span><span class="default">180.0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$sa</span><span class="keyword">=</span><span class="default">sin</span><span class="keyword">(</span><span class="default">$rad</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$ca</span><span class="keyword">=</span><span class="default">cos</span><span class="keyword">(</span><span class="default">$rad</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">4</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$x</span><span class="keyword">=</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">*</span><span class="default">2</span><span class="keyword">+</span><span class="default">0</span><span class="keyword">]-</span><span class="default">$xc</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$y</span><span class="keyword">=</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">*</span><span class="default">2</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">]-</span><span class="default">$yc</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">*</span><span class="default">2</span><span class="keyword">+</span><span class="default">0</span><span class="keyword">]= </span><span class="default">intval</span><span class="keyword">( </span><span class="default">$ca</span><span class="keyword">*</span><span class="default">$x</span><span class="keyword">+</span><span class="default">$sa</span><span class="keyword">*</span><span class="default">$y</span><span class="keyword">+</span><span class="default">$px</span><span class="keyword">+</span><span class="default">0.5</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">*</span><span class="default">2</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">]= </span><span class="default">intval</span><span class="keyword">(-</span><span class="default">$sa</span><span class="keyword">*</span><span class="default">$x</span><span class="keyword">+</span><span class="default">$ca</span><span class="keyword">*</span><span class="default">$y</span><span class="keyword">+</span><span class="default">$py</span><span class="keyword">+</span><span class="default">0.5</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; }<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="40616""></a>
  <div class="note">
   <strong class="user">jrisken at mn dot rr dot com</strong>
   <a href="#40616" class="date">09-Mar-2004 11:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I took Magicaltux's word wrap procedure and modified it in two ways.&nbsp; I changed the order of processing so that the string plotting function is called only once for each word instead of for every character.&nbsp; And I wrote the results to a string scalar instead of a string array, with embedded breaks &lt;br&gt; at line ends.&nbsp; It should run pretty fast.&nbsp; Mine breaks only on spaces, but hyphens could easily be added.<br />
<br />
I'm new to PHP so I apologize for my idiosyncratic formatting conventions.<br />
&lt;?<br />
function myWordWrap($txt,$font,$size,$width) <br />
{<br />
&nbsp;&nbsp;&nbsp; /*<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; word-wrapper.&nbsp; gets bounding box sizes for each word in a string, then<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; strings words together up to desired width. calls strpos and<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; imagettfbbox only once per word - so very fast.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; this version reconcatenates the words with a &lt;br&gt; character where<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; the line break should be.<br />
&nbsp;&nbsp;&nbsp; */<br />
&nbsp;&nbsp;&nbsp; $txt.=" "; // guaranteed to find end of line<br />
&nbsp;&nbsp;&nbsp; $spaces=array();<br />
&nbsp;&nbsp;&nbsp; $wids=array();<br />
&nbsp;&nbsp;&nbsp; $i=0;<br />
&nbsp;&nbsp;&nbsp; while(true)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $j=strpos(substr($txt,$i)," ");<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!($j===false))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $spaces[]=$j+$i;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $bbox=imagettfbbox($size,0,$font,substr($txt,$i,$j+1));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $left=($bbox[0]&gt;$bbox[6])?$bbox[6]:$bbox[0]; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $right=($bbox[2]&gt;$bbox[4])?$bbox[2]:$bbox[4]; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $wids[]=$right-$left; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $i=$j+$i+1;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else&nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; $lastspace=-1;<br />
&nbsp;&nbsp;&nbsp; $cum=0;<br />
&nbsp;&nbsp;&nbsp; $t2="";<br />
&nbsp;&nbsp;&nbsp; for($i=0;$i&lt;count($spaces);$i++)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if((($cum&gt;0)&amp;&amp;($cum+$wids[$i])&gt;$width)) // time for a line break<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $t2.="&lt;br&gt;";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $cum=0;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $i--;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // we'll always get at least one word (even if too wide) thanks to <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // ($cum&gt;0) test above<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $t2.=substr($txt,$lastspace+1,$spaces[$i]-$lastspace);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $cum+=$wids[$i];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $lastspace=$spaces[$i];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return $t2;<br />
}<br />
?&gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="39808""></a>
  <div class="note">
   <strong class="user">LB</strong>
   <a href="#39808" class="date">11-Feb-2004 04:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
the oliver dot martin at onemail dot fixbbox function is just lacking a small thing:<br />
the coordonates for top and left have to be the opposite, because the imagettftext x and y coordonates are calculated from the top left of the image and set the bottom left of the first character.<br />
<br />
The correct function is:<br />
function fixbbox($bbox)<br />
{<br />
&nbsp; $tmp_bbox["left"] = min($bbox[0],$bbox[2],$bbox[4],$bbox[6]);<br />
&nbsp; $tmp_bbox["top"] = min($bbox[1],$bbox[3],$bbox[5],$bbox[7]);<br />
&nbsp; $tmp_bbox["width"] = max($bbox[0],$bbox[2],$bbox[4],$bbox[6]) -<br />
&nbsp;&nbsp;&nbsp; min($bbox[0],$bbox[2],$bbox[4],$bbox[6]) + 1;<br />
&nbsp; $tmp_bbox["height"] = max($bbox[1],$bbox[3],$bbox[5],$bbox[7]) - min($bbox[1],$bbox[3],$bbox[5],$bbox[7]);<br />
<br />
&nbsp; $tmp_bbox["left"] = 0 - $tmp_bbox["left"];<br />
&nbsp; $tmp_bbox["top"] = 0 - $tmp_bbox["top"];<br />
&nbsp; return $tmp_bbox;<br />
}<br />
<br />
And it works for any rotated text.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="39781""></a>
  <div class="note">
   <strong class="user">David  Eder</strong>
   <a href="#39781" class="date">10-Feb-2004 06:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As "oliver dot martin at onemail dot at" noted above, imagettfbbox() does not work correctly in php 4.3.4.&nbsp; To remedy this, I've written a short function that uses trig to calculate the bounding box from rotating a non-rotated piece of text.<br />
<br />
Hopefully, this comment will be obsolete soon, but for now, ...<br />
<br />
function imagettfbbox_t($size, $angle, $fontfile, $text)<br />
{<br />
&nbsp; // compute size with a zero angle<br />
&nbsp; $coords = imagettfbbox($size, 0, $fontfile, $text);<br />
<br />
&nbsp; // convert angle to radians<br />
&nbsp; $a = $angle * M_PI / 180;<br />
<br />
&nbsp; // compute some usefull values<br />
&nbsp; $ca = cos($a);<br />
&nbsp; $sa = sin($a);<br />
&nbsp; $ret = array();<br />
<br />
&nbsp; // perform transformations<br />
&nbsp; for($i = 0; $i &lt; 7; $i += 2)<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; $ret[$i] = round($coords[$i] * $ca + $coords[$i+1] * $sa);<br />
&nbsp;&nbsp;&nbsp; $ret[$i+1] = round($coords[$i+1] * $ca - $coords[$i] * $sa);<br />
&nbsp; }<br />
&nbsp; return $ret;<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="39720""></a>
  <div class="note">
   <strong class="user">jtopland at hive dot no</strong>
   <a href="#39720" class="date">08-Feb-2004 11:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Finally managed to make a fixed version of imagettfbbox().<br />
All angles returns correct values.<br />
Except that imagettftext() returns different trackings (space between each character) when rotating.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Set some test variables<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$font </span><span class="keyword">= </span><span class="string">"d://www//tahoma.ttf"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$text </span><span class="keyword">= </span><span class="string">"Finally, I can center rotated text!"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$size </span><span class="keyword">= </span><span class="default">20</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$angle </span><span class="keyword">= </span><span class="default">20</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Create an image and fill the background with lightgray<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$image </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">500</span><span class="keyword">, </span><span class="default">400</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagefill</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">hexdec</span><span class="keyword">(</span><span class="string">"dddddd"</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Make a cross to make it easier to analyze<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imageline</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">), </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">), </span><span class="default">hexdec</span><span class="keyword">(</span><span class="string">"000000"</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imageline</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">), </span><span class="default">hexdec</span><span class="keyword">(</span><span class="string">"000000"</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Run a fixed version of imagettfbbox()<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bbox </span><span class="keyword">= </span><span class="default">imagettfbbox_fixed</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Make some text and center the text on the image.<br />
&nbsp;&nbsp;&nbsp; // imagettftext() pivot is on lower left<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagettftext</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">) / </span><span class="default">2 </span><span class="keyword">- </span><span class="default">$bbox</span><span class="keyword">[</span><span class="string">'width'</span><span class="keyword">] / </span><span class="default">2</span><span class="keyword">, </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">) / </span><span class="default">2 </span><span class="keyword">+ </span><span class="default">$bbox</span><span class="keyword">[</span><span class="string">'height'</span><span class="keyword">] / </span><span class="default">2</span><span class="keyword">, </span><span class="default">hexdec</span><span class="keyword">(</span><span class="string">"0000ff"</span><span class="keyword">), </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Show the image<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">imagettfbbox_fixed</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">, </span><span class="default">$angle</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Get the boundingbox from imagettfbbox(), which is correct when angle is 0<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bbox </span><span class="keyword">= </span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Rotate the boundingbox<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$angle </span><span class="keyword">= </span><span class="default">pi</span><span class="keyword">() * </span><span class="default">2 </span><span class="keyword">- </span><span class="default">$angle </span><span class="keyword">* </span><span class="default">pi</span><span class="keyword">() * </span><span class="default">2 </span><span class="keyword">/ </span><span class="default">360</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">4</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$x </span><span class="keyword">= </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">$i </span><span class="keyword">* </span><span class="default">2</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$y </span><span class="keyword">= </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">$i </span><span class="keyword">* </span><span class="default">2 </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">$i </span><span class="keyword">* </span><span class="default">2</span><span class="keyword">] = </span><span class="default">cos</span><span class="keyword">(</span><span class="default">$angle</span><span class="keyword">) * </span><span class="default">$x </span><span class="keyword">- </span><span class="default">sin</span><span class="keyword">(</span><span class="default">$angle</span><span class="keyword">) * </span><span class="default">$y</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">$i </span><span class="keyword">* </span><span class="default">2 </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">] = </span><span class="default">sin</span><span class="keyword">(</span><span class="default">$angle</span><span class="keyword">) * </span><span class="default">$x </span><span class="keyword">+ </span><span class="default">cos</span><span class="keyword">(</span><span class="default">$angle</span><span class="keyword">) * </span><span class="default">$y</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Variables which tells the correct width and height<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="string">'width'</span><span class="keyword">] = </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] + </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bbox</span><span class="keyword">[</span><span class="string">'height'</span><span class="keyword">] = </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] - </span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">];<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$bbox</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="38880""></a>
  <div class="note">
   <strong class="user">oliver dot martin at onemail dot at</strong>
   <a href="#38880" class="date">09-Jan-2004 10:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The original fixbox function by &lt;php at deathz0rz dot homeunix dot net&gt; doesn't work when the text is rotated, as it assumes that the upper left corner of the text is also the upper left corner of the bounding box. Same goes for the lower right corner. Here is my corrected version of it:<br />
<br />
&lt;?<br />
function fixbbox($bbox)<br />
{<br />
&nbsp;&nbsp;&nbsp; $tmp_bbox["left"] = min($bbox[0],$bbox[2],$bbox[4],$bbox[6]);<br />
&nbsp;&nbsp;&nbsp; $tmp_bbox["top"] = min($bbox[1],$bbox[3],$bbox[5],$bbox[7]);<br />
&nbsp;&nbsp;&nbsp; $tmp_bbox["width"] = max($bbox[0],$bbox[2],$bbox[4],$bbox[6]) - min($bbox[0],$bbox[2],$bbox[4],$bbox[6]);<br />
&nbsp;&nbsp;&nbsp; $tmp_bbox["height"] = max($bbox[1],$bbox[3],$bbox[5],$bbox[7]) - min($bbox[1],$bbox[3],$bbox[5],$bbox[7]);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; return $tmp_bbox;<br />
}<br />
?&gt;<br />
<br />
However, be aware that this might not be very useful, as gd-2.0.8 introduces a bug which renders the results of imagettfbbox() useless when the text is rotated. This is still not fixed in the the php-4.3.4 bundled version (2.0.15 compatible).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="38458""></a>
  <div class="note">
   <strong class="user">MagicalTux at FF.ST</strong>
   <a href="#38458" class="date">22-Dec-2003 09:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
One use of this function is to do some WordWrap =p<br />
<br />
I wrote a little function to make a basic wordwrap : it returns an array with each line in a row.<br />
<br />
You just have to display each row on a different line (calling many times imagettftext) to get a good result.<br />
The character ^ is assumed as a linebreak.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">im_wordwrap</span><span class="keyword">(</span><span class="default">$txt</span><span class="keyword">,</span><span class="default">$font</span><span class="keyword">,</span><span class="default">$size</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sep</span><span class="keyword">=array(</span><span class="string">' '</span><span class="keyword">,</span><span class="string">'-'</span><span class="keyword">); </span><span class="comment">// separators<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$res</span><span class="keyword">=array();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$buf</span><span class="keyword">=</span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// main function loop<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$txt</span><span class="keyword">);</span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$l</span><span class="keyword">=</span><span class="default">$txt</span><span class="keyword">{</span><span class="default">$i</span><span class="keyword">};<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$l</span><span class="keyword">==</span><span class="string">'^'</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$res</span><span class="keyword">[]=</span><span class="default">$buf</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$buf</span><span class="keyword">=</span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; continue;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$t</span><span class="keyword">=</span><span class="default">$buf</span><span class="keyword">.</span><span class="default">$l</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bbox</span><span class="keyword">=</span><span class="default">imagettfbbox</span><span class="keyword">(</span><span class="default">$size</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$font</span><span class="keyword">,</span><span class="default">$t</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$left</span><span class="keyword">=(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]&gt;</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">])?</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">]:</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// determine most far points<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$right</span><span class="keyword">=(</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]&gt;</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">])?</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]:</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">]; </span><span class="comment">// idem<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$w</span><span class="keyword">=</span><span class="default">$right</span><span class="keyword">-</span><span class="default">$left</span><span class="keyword">; </span><span class="comment">// get total width<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$w</span><span class="keyword">&gt;</span><span class="default">$width</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$buf</span><span class="keyword">==</span><span class="string">''</span><span class="keyword">) return </span><span class="default">false</span><span class="keyword">; </span><span class="comment">// FATAL: 1 letter is smallest than the pixel width - avoid infinite loop<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // we can assume that everything present in $buf currently is inside our limits<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // find a separator in string<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fp</span><span class="keyword">=</span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; foreach(</span><span class="default">$sep </span><span class="keyword">as </span><span class="default">$s</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$p</span><span class="keyword">=</span><span class="default">strrpos</span><span class="keyword">(</span><span class="default">$buf</span><span class="keyword">,</span><span class="default">$s</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if ((</span><span class="default">$p</span><span class="keyword">!==</span><span class="default">false</span><span class="keyword">) and (</span><span class="default">$p</span><span class="keyword">&gt;</span><span class="default">$fp</span><span class="keyword">)) </span><span class="default">$fp</span><span class="keyword">=</span><span class="default">$p</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$fp</span><span class="keyword">===</span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// let's break here !<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$res</span><span class="keyword">[]=</span><span class="default">$buf</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$buf</span><span class="keyword">=</span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">--; </span><span class="comment">// dececrase $i to retry this letter<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">continue;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// $fp+1 -&gt; we put the separator char at the end of the prev. line =p<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$res</span><span class="keyword">[]=</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$buf</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$fp</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$buf</span><span class="keyword">=</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$buf</span><span class="keyword">,</span><span class="default">$fp</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">--;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; continue;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$buf</span><span class="keyword">.=</span><span class="default">$l</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$buf</span><span class="keyword">!=</span><span class="string">''</span><span class="keyword">) </span><span class="default">$res</span><span class="keyword">[]=</span><span class="default">$buf</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$res</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="38261""></a>
  <div class="note">
   <strong class="user">php at deathz0rz dot homeunix dot net</strong>
   <a href="#38261" class="date">14-Dec-2003 03:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The array this function returns is very strange, at least, i think so... So i created this function that 'fixes' the bounding box array into some human-understandable format<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">fixbbox</span><span class="keyword">(</span><span class="default">$bbox</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$xcorr</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">-</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">]; </span><span class="comment">//northwest X<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ycorr</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">-</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]; </span><span class="comment">//northwest Y<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tmp_bbox</span><span class="keyword">[</span><span class="string">'left'</span><span class="keyword">]=</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">]+</span><span class="default">$xcorr</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tmp_bbox</span><span class="keyword">[</span><span class="string">'top'</span><span class="keyword">]=</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">]+</span><span class="default">$ycorr</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tmp_bbox</span><span class="keyword">[</span><span class="string">'width'</span><span class="keyword">]=</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]+</span><span class="default">$xcorr</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tmp_bbox</span><span class="keyword">[</span><span class="string">'height'</span><span class="keyword">]=</span><span class="default">$bbox</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">]+</span><span class="default">$ycorr</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$tmp_bbox</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="24910""></a>
  <div class="note">
   <strong class="user">Brian at NOSPAM at PrintsMadeEasy dot com</strong>
   <a href="#24910" class="date">04-Sep-2002 10:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There seems to be a little confusion regarding the font coordinate system.&nbsp; PHP's TTF functions will make more sense after you understand the principals of font creation.&nbsp; This guy wrote a really good overview...<br />
<a href="http://pfaedit.sourceforge.net/overview.html" rel="nofollow" target="_blank">http://pfaedit.sourceforge.net/overview.html</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
