<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>Mcrypt 函数</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mcrypt.examples.html">? 范例</a></li>
      <li style="float: right;"><a href="function.mcrypt-cbc.html">mcrypt_cbc ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="book.mcrypt.html">Mcrypt</a></li>
    <li>Mcrypt 函数</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="ref.mcrypt" class="reference">
 <h1 class="title">Mcrypt 函数</h1>

 














































































































































































































































































































































<h2>Table of Contents</h2><ul class="chunklist chunklist_reference"><li><a href="function.mcrypt-cbc.html">mcrypt_cbc</a> &mdash; 以 CBC 模式加解密数据</li><li><a href="function.mcrypt-cfb.html">mcrypt_cfb</a> &mdash; 以 CFB 模式加解密数据</li><li><a href="function.mcrypt-create-iv.html">mcrypt_create_iv</a> &mdash; 从随机源创建初始向量</li><li><a href="function.mcrypt-decrypt.html">mcrypt_decrypt</a> &mdash; 使用给定参数解密密文</li><li><a href="function.mcrypt-ecb.html">mcrypt_ecb</a> &mdash; 已废弃：使用 ECB 模式加解密数据</li><li><a href="function.mcrypt-enc-get-algorithms-name.html">mcrypt_enc_get_algorithms_name</a> &mdash; 返回打开的算法名称</li><li><a href="function.mcrypt-enc-get-block-size.html">mcrypt_enc_get_block_size</a> &mdash; 返回打开的算法的分组大小</li><li><a href="function.mcrypt-enc-get-iv-size.html">mcrypt_enc_get_iv_size</a> &mdash; 返回打开的算法的初始向量大小</li><li><a href="function.mcrypt-enc-get-key-size.html">mcrypt_enc_get_key_size</a> &mdash; 返回打开的模式所能支持的最长密钥</li><li><a href="function.mcrypt-enc-get-modes-name.html">mcrypt_enc_get_modes_name</a> &mdash; 返回打开的模式的名称</li><li><a href="function.mcrypt-enc-get-supported-key-sizes.html">mcrypt_enc_get_supported_key_sizes</a> &mdash; 以数组方式返回打开的算法所支持的密钥长度</li><li><a href="function.mcrypt-enc-is-block-algorithm-mode.html">mcrypt_enc_is_block_algorithm_mode</a> &mdash; 检测打开的模式是否支持分组加密</li><li><a href="function.mcrypt-enc-is-block-algorithm.html">mcrypt_enc_is_block_algorithm</a> &mdash; 检测打开模式的算法是否为分组算法</li><li><a href="function.mcrypt-enc-is-block-mode.html">mcrypt_enc_is_block_mode</a> &mdash; 检测打开的模式是否以分组方式输出</li><li><a href="function.mcrypt-enc-self-test.html">mcrypt_enc_self_test</a> &mdash; 在打开的模块上进行自检</li><li><a href="function.mcrypt-encrypt.html">mcrypt_encrypt</a> &mdash; 使用给定参数加密明文</li><li><a href="function.mcrypt-generic-deinit.html">mcrypt_generic_deinit</a> &mdash; 对加密模块进行清理工作</li><li><a href="function.mcrypt-generic-end.html">mcrypt_generic_end</a> &mdash; 终止加密</li><li><a href="function.mcrypt-generic-init.html">mcrypt_generic_init</a> &mdash; 初始化加密所需的缓冲区</li><li><a href="function.mcrypt-generic.html">mcrypt_generic</a> &mdash; 加密数据</li><li><a href="function.mcrypt-get-block-size.html">mcrypt_get_block_size</a> &mdash; 获得加密算法的分组大小</li><li><a href="function.mcrypt-get-cipher-name.html">mcrypt_get_cipher_name</a> &mdash; 获取加密算法名称</li><li><a href="function.mcrypt-get-iv-size.html">mcrypt_get_iv_size</a> &mdash; 返回指定算法/模式组合的初始向量大小</li><li><a href="function.mcrypt-get-key-size.html">mcrypt_get_key_size</a> &mdash; 获取指定加密算法的密钥大小</li><li><a href="function.mcrypt-list-algorithms.html">mcrypt_list_algorithms</a> &mdash; 获取支持的加密算法</li><li><a href="function.mcrypt-list-modes.html">mcrypt_list_modes</a> &mdash; 获取所支持的模式</li><li><a href="function.mcrypt-module-close.html">mcrypt_module_close</a> &mdash; 关闭加密模块</li><li><a href="function.mcrypt-module-get-algo-block-size.html">mcrypt_module_get_algo_block_size</a> &mdash; 返回指定算法的分组大小</li><li><a href="function.mcrypt-module-get-algo-key-size.html">mcrypt_module_get_algo_key_size</a> &mdash; 获取打开模式所支持的最大密钥大小</li><li><a href="function.mcrypt-module-get-supported-key-sizes.html">mcrypt_module_get_supported_key_sizes</a> &mdash; 以数组形式返回打开的算法所支持的密钥大小</li><li><a href="function.mcrypt-module-is-block-algorithm-mode.html">mcrypt_module_is_block_algorithm_mode</a> &mdash; 返回指定模块是否是分组加密模式</li><li><a href="function.mcrypt-module-is-block-algorithm.html">mcrypt_module_is_block_algorithm</a> &mdash; 检测指定算法是否为分组加密算法</li><li><a href="function.mcrypt-module-is-block-mode.html">mcrypt_module_is_block_mode</a> &mdash; 检测指定模式是否以分组方式输出</li><li><a href="function.mcrypt-module-open.html">mcrypt_module_open</a> &mdash; 打开算法和模式对应的模块</li><li><a href="function.mcrypt-module-self-test.html">mcrypt_module_self_test</a> &mdash; 在指定模块上执行自检</li><li><a href="function.mcrypt-ofb.html">mcrypt_ofb</a> &mdash; 使用 OFB 模式加密/解密数据</li><li><a href="function.mdecrypt-generic.html">mdecrypt_generic</a> &mdash; 解密数据</li></ul>
</div>
<div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="99263""></a>
  <div class="note">
   <strong class="user">patrickdk at patrickdk dot com</strong>
   <a href="#99263" class="date">06-Aug-2010 07:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This works completely with mysql aes, even long keys.
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">mysql_aes_decrypt</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">,</span><span class="default">$ky</span><span class="keyword">)
<br />
{
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key</span><span class="keyword">=</span><span class="string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; for(</span><span class="default">$a</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$a</span><span class="keyword">&lt;</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$ky</span><span class="keyword">);</span><span class="default">$a</span><span class="keyword">++)
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$key</span><span class="keyword">[</span><span class="default">$a</span><span class="keyword">%</span><span class="default">16</span><span class="keyword">]=</span><span class="default">chr</span><span class="keyword">(</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">[</span><span class="default">$a</span><span class="keyword">%</span><span class="default">16</span><span class="keyword">]) ^ </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$ky</span><span class="keyword">[</span><span class="default">$a</span><span class="keyword">]));
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mode </span><span class="keyword">= </span><span class="default">MCRYPT_MODE_ECB</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$enc </span><span class="keyword">= </span><span class="default">MCRYPT_RIJNDAEL_128</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dec </span><span class="keyword">= @</span><span class="default">mcrypt_decrypt</span><span class="keyword">(</span><span class="default">$enc</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$val</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">, @</span><span class="default">mcrypt_create_iv</span><span class="keyword">( @</span><span class="default">mcrypt_get_iv_size</span><span class="keyword">(</span><span class="default">$enc</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">), </span><span class="default">MCRYPT_DEV_URANDOM </span><span class="keyword">) );
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">rtrim</span><span class="keyword">(</span><span class="default">$dec</span><span class="keyword">,(( </span><span class="default">ord</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$dec</span><span class="keyword">,</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$dec</span><span class="keyword">)-</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">))&gt;=</span><span class="default">0 </span><span class="keyword">and </span><span class="default">ord</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$dec</span><span class="keyword">, </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$dec</span><span class="keyword">)-</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">))&lt;=</span><span class="default">16</span><span class="keyword">)? </span><span class="default">chr</span><span class="keyword">(</span><span class="default">ord</span><span class="keyword">( </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$dec</span><span class="keyword">,</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$dec</span><span class="keyword">)-</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">))):</span><span class="default">null</span><span class="keyword">));
<br />
}
<br />

<br />
function </span><span class="default">mysql_aes_encrypt</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">,</span><span class="default">$ky</span><span class="keyword">)
<br />
{
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key</span><span class="keyword">=</span><span class="string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; for(</span><span class="default">$a</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$a</span><span class="keyword">&lt;</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$ky</span><span class="keyword">);</span><span class="default">$a</span><span class="keyword">++)
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$key</span><span class="keyword">[</span><span class="default">$a</span><span class="keyword">%</span><span class="default">16</span><span class="keyword">]=</span><span class="default">chr</span><span class="keyword">(</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">[</span><span class="default">$a</span><span class="keyword">%</span><span class="default">16</span><span class="keyword">]) ^ </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$ky</span><span class="keyword">[</span><span class="default">$a</span><span class="keyword">]));
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mode</span><span class="keyword">=</span><span class="default">MCRYPT_MODE_ECB</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$enc</span><span class="keyword">=</span><span class="default">MCRYPT_RIJNDAEL_128</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$val</span><span class="keyword">=</span><span class="default">str_pad</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">, (</span><span class="default">16</span><span class="keyword">*(</span><span class="default">floor</span><span class="keyword">(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">) / </span><span class="default">16</span><span class="keyword">)+(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">) % </span><span class="default">16</span><span class="keyword">==</span><span class="default">0</span><span class="keyword">?</span><span class="default">2</span><span class="keyword">:</span><span class="default">1</span><span class="keyword">))), </span><span class="default">chr</span><span class="keyword">(</span><span class="default">16</span><span class="keyword">-(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">) % </span><span class="default">16</span><span class="keyword">)));
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">mcrypt_encrypt</span><span class="keyword">(</span><span class="default">$enc</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$val</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">, </span><span class="default">mcrypt_create_iv</span><span class="keyword">( </span><span class="default">mcrypt_get_iv_size</span><span class="keyword">(</span><span class="default">$enc</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">), </span><span class="default">MCRYPT_DEV_URANDOM</span><span class="keyword">));
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="94373""></a>
  <div class="note">
   <strong class="user">p ete postma - googlemail.com</strong>
   <a href="#94373" class="date">31-Oct-2009 06:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
mcrypt module initialization failed
<br />

<br />
I found this circumstance:
<br />

<br />
usemcrypt.php:
<br />
<span class="default">&lt;?php
<br />
&nbsp;</span><span class="keyword">function </span><span class="default">protect</span><span class="keyword">() {
<br />
&nbsp;</span><span class="comment">//some mcrypt/decrypt command
<br />
&nbsp;</span><span class="keyword">}
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
filea.php:
<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">include_once(</span><span class="string">'usemcrypt.php'</span><span class="keyword">);
<br />

<br />
function </span><span class="default">a</span><span class="keyword">() {
<br />
&nbsp;</span><span class="default">protect</span><span class="keyword">();
<br />
} </span><span class="default">?&gt;
<br />
</span>
<br />
fileb.php
<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">b</span><span class="keyword">() {
<br />
&nbsp; include_once(</span><span class="string">'usemcrypt.php'</span><span class="keyword">);
<br />
&nbsp; </span><span class="default">protect</span><span class="keyword">();
<br />
}
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
filea.php and a() work fine
<br />
fileb.php and b() will report a mcrypt module initialization failed
<br />

<br />
I am assuming you can't pull that module in on the fly. If you use a file that calls mcrypt, it has to be included at the head, not in a function.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="92013""></a>
  <div class="note">
   <strong class="user">manyagain</strong>
   <a href="#92013" class="date">05-Jul-2009 05:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if you don't have mcrypt installed, try phpseclib - <a href="http://phpseclib.sourceforge.net" rel="nofollow" target="_blank">http://phpseclib.sourceforge.net</a><br />
<br />
includes pure-php implementations of des, 3des, rc4, aes, and rijndael.&nbsp; uses mcrypt if it's available and a pure-php implementation otherwise.&nbsp; it also has the distinction of having the fastest existent pure-php aes implementation as per section 3.5.5. "Speed Comparisons" of the documentation.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="87274""></a>
  <div class="note">
   <strong class="user">Rafael M. Salvioni</strong>
   <a href="#87274" class="date">27-Nov-2008 01:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The follow function is a implementation of the RC4 cypher algorithm in pure PHP code.<br />
<br />
The function is used to encrypt and decrypt data.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/**<br />
&nbsp;* Crypt/decrypt strings with RC4 stream cypher algorithm.<br />
&nbsp;*<br />
&nbsp;* @param string $key Key<br />
&nbsp;* @param string $data Encripted/pure data<br />
&nbsp;* @see&nbsp;&nbsp; <a href="http://pt.wikipedia.org/wiki/RC4" rel="nofollow" target="_blank">http://pt.wikipedia.org/wiki/RC4</a><br />
&nbsp;* @return string<br />
&nbsp;*/<br />
</span><span class="keyword">function </span><span class="default">rc4</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Store the vectors "S" has calculated<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">static </span><span class="default">$SC</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Function to swaps values of the vector "S"<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$swap </span><span class="keyword">= </span><span class="default">create_function</span><span class="keyword">(</span><span class="string">'&amp;$v1, &amp;$v2'</span><span class="keyword">, </span><span class="string">'<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $v1 = $v1 ^ $v2;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $v2 = $v1 ^ $v2;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $v1 = $v1 ^ $v2;<br />
&nbsp;&nbsp;&nbsp; '</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ikey </span><span class="keyword">= </span><span class="default">crc32</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (!isset(</span><span class="default">$SC</span><span class="keyword">[</span><span class="default">$ikey</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Make the vector "S", basead in the key<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$S&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">range</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$j&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$n&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">255</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$char&nbsp; </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">{</span><span class="default">$i </span><span class="keyword">% </span><span class="default">$n</span><span class="keyword">});<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$j&nbsp; &nbsp;&nbsp; </span><span class="keyword">= (</span><span class="default">$j </span><span class="keyword">+ </span><span class="default">$S</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] + </span><span class="default">$char</span><span class="keyword">) % </span><span class="default">256</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$swap</span><span class="keyword">(</span><span class="default">$S</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="default">$S</span><span class="keyword">[</span><span class="default">$j</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$SC</span><span class="keyword">[</span><span class="default">$ikey</span><span class="keyword">] = </span><span class="default">$S</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$S </span><span class="keyword">= </span><span class="default">$SC</span><span class="keyword">[</span><span class="default">$ikey</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Crypt/decrypt the data<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$n&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">str_split</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$i&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">$j </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; for (</span><span class="default">$m </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$m </span><span class="keyword">&lt; </span><span class="default">$n</span><span class="keyword">; </span><span class="default">$m</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= (</span><span class="default">$i </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">) % </span><span class="default">256</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$j&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= (</span><span class="default">$j </span><span class="keyword">+ </span><span class="default">$S</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]) % </span><span class="default">256</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$swap</span><span class="keyword">(</span><span class="default">$S</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="default">$S</span><span class="keyword">[</span><span class="default">$j</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$char&nbsp; &nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">[</span><span class="default">$m</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$char&nbsp; &nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">$S</span><span class="keyword">[(</span><span class="default">$S</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] + </span><span class="default">$S</span><span class="keyword">[</span><span class="default">$j</span><span class="keyword">]) % </span><span class="default">256</span><span class="keyword">] ^ </span><span class="default">$char</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data</span><span class="keyword">[</span><span class="default">$m</span><span class="keyword">] = </span><span class="default">chr</span><span class="keyword">(</span><span class="default">$char</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">implode</span><span class="keyword">(</span><span class="string">''</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83519""></a>
  <div class="note">
   <strong class="user">artem at it-nt dot ru</strong>
   <a href="#83519" class="date">29-May-2008 09:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
And some code for LM hash:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">LMhash</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$string </span><span class="keyword">= </span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">14</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$p1 </span><span class="keyword">= </span><span class="default">LMhash_DESencrypt</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">7</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$p2 </span><span class="keyword">= </span><span class="default">LMhash_DESencrypt</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">7</span><span class="keyword">, </span><span class="default">7</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$p1</span><span class="keyword">.</span><span class="default">$p2</span><span class="keyword">);<br />
}<br />
<br />
function </span><span class="default">LMhash_DESencrypt</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tmp </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$len </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">7</span><span class="keyword">; ++</span><span class="default">$i</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmp</span><span class="keyword">[] = </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$len </span><span class="keyword">? </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]) : </span><span class="default">0</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key</span><span class="keyword">[] = </span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] &amp; </span><span class="default">254</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key</span><span class="keyword">[] = (</span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] &lt;&lt; </span><span class="default">7</span><span class="keyword">) | (</span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] &gt;&gt; </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key</span><span class="keyword">[] = (</span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] &lt;&lt; </span><span class="default">6</span><span class="keyword">) | (</span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] &gt;&gt; </span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key</span><span class="keyword">[] = (</span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] &lt;&lt; </span><span class="default">5</span><span class="keyword">) | (</span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">] &gt;&gt; </span><span class="default">3</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key</span><span class="keyword">[] = (</span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">] &lt;&lt; </span><span class="default">4</span><span class="keyword">) | (</span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">] &gt;&gt; </span><span class="default">4</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key</span><span class="keyword">[] = (</span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">] &lt;&lt; </span><span class="default">3</span><span class="keyword">) | (</span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">] &gt;&gt; </span><span class="default">5</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key</span><span class="keyword">[] = (</span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">5</span><span class="keyword">] &lt;&lt; </span><span class="default">2</span><span class="keyword">) | (</span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">] &gt;&gt; </span><span class="default">6</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key</span><span class="keyword">[] = </span><span class="default">$tmp</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">] &lt;&lt; </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$is </span><span class="keyword">= </span><span class="default">mcrypt_get_iv_size</span><span class="keyword">(</span><span class="default">MCRYPT_DES</span><span class="keyword">, </span><span class="default">MCRYPT_MODE_ECB</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">mcrypt_create_iv</span><span class="keyword">(</span><span class="default">$is</span><span class="keyword">, </span><span class="default">MCRYPT_RAND</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key0 </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">$key </span><span class="keyword">as </span><span class="default">$k</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$key0 </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">$k</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$crypt </span><span class="keyword">= </span><span class="default">mcrypt_encrypt</span><span class="keyword">(</span><span class="default">MCRYPT_DES</span><span class="keyword">, </span><span class="default">$key0</span><span class="keyword">, </span><span class="string">"KGS!@#$%"</span><span class="keyword">, </span><span class="default">MCRYPT_MODE_ECB</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">bin2hex</span><span class="keyword">(</span><span class="default">$crypt</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Some optimization?</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80808""></a>
  <div class="note">
   <strong class="user">phpknights at pookmail dot com</strong>
   <a href="#80808" class="date">01-Feb-2008 10:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The Pear class Crypt/Blowfish.php will use the mcrypt module if available but the mcrypt module is not required.<br />
<br />
Some very easy Pear and example pseudocode to protect your data by encrypting your databases with a one-way hash and blowfish symmetric encryption.<br />
<a href="http://en.wikibooks.org/wiki/Cryptography/Database_protection" rel="nofollow" target="_blank">http://en.wikibooks.org/wiki/Cryptography/Database_protection</a><br />
<br />
Using a one-way hash and blowfish symmetric encryption.<br />
1. Insert a record of John Doe in an encrypted database.<br />
2. Get the encrypted record of user John Doe and decrypt the data.<br />
<br />
1. Insert a record of John Doe in an encrypted database.<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">require_once(</span><span class="string">"Crypt/Blowfish.php"</span><span class="keyword">); </span><span class="comment">// a Pear class<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'email'</span><span class="keyword">]&nbsp; &nbsp; &nbsp;&nbsp; =&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"johndoe@anisp.localhost"</span><span class="keyword">; </span><span class="comment">// The Primary key<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'name'</span><span class="keyword">]&nbsp; &nbsp; &nbsp; &nbsp; =&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"John Doe"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'creditnr'</span><span class="keyword">]&nbsp; &nbsp; =&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"0192733652342" </span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// crypt - one-way encryption<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$cipher_key </span><span class="keyword">= </span><span class="default">crypt</span><span class="keyword">( </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'email'</span><span class="keyword">] , </span><span class="string">"AN_SECRET_COMPANY_SALT"</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bf </span><span class="keyword">= new </span><span class="default">Crypt_Blowfish</span><span class="keyword">(</span><span class="string">'ecb'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bf</span><span class="keyword">-&gt;</span><span class="default">setKey</span><span class="keyword">( </span><span class="default">$cipher_key </span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// crypt_blowfish symmetric encryption to encrypt the data<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'email'</span><span class="keyword">]&nbsp; &nbsp; &nbsp;&nbsp; = </span><span class="default">$bf</span><span class="keyword">-&gt;</span><span class="default">encrypt</span><span class="keyword">( </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'email'</span><span class="keyword">] );<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'name'</span><span class="keyword">]&nbsp; &nbsp; &nbsp; &nbsp; = </span><span class="default">$bf</span><span class="keyword">-&gt;</span><span class="default">encrypt</span><span class="keyword">( </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'name'</span><span class="keyword">] );<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'creditnr'</span><span class="keyword">]&nbsp; &nbsp; = </span><span class="default">$bf</span><span class="keyword">-&gt;</span><span class="default">encrypt</span><span class="keyword">( </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'creditnr'</span><span class="keyword">] );<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">sqlInsert</span><span class="keyword">( </span><span class="default">$aRecord </span><span class="keyword">) ;<br />
</span><span class="default">?&gt;<br />
</span><br />
2. Get the encrypted record of user John Doe and decrypt the data.<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">require_once(</span><span class="string">"Crypt/Blowfish.php"</span><span class="keyword">);&nbsp; </span><span class="comment">// a Pear class<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$primary_key </span><span class="keyword">= </span><span class="string">"johndoe@anisp.localhost"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// crypt - one-way encryption<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$cipher_key </span><span class="keyword">= </span><span class="default">crypt</span><span class="keyword">(&nbsp; </span><span class="default">$primary_key </span><span class="keyword">, </span><span class="string">"AN_SECRET_COMPANY_SALT"</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bf </span><span class="keyword">= new </span><span class="default">Crypt_Blowfish</span><span class="keyword">(</span><span class="string">'ecb'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bf</span><span class="keyword">-&gt;</span><span class="default">setKey</span><span class="keyword">( </span><span class="default">$cipher_key </span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// crypt_blowfish symmetric encryption to ecrypt the primary key for a sql select<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$select_key </span><span class="keyword">= </span><span class="default">$bf</span><span class="keyword">-&gt;</span><span class="default">encrypt</span><span class="keyword">(&nbsp; </span><span class="default">$primary_key </span><span class="keyword">) ;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$aRecord </span><span class="keyword">= </span><span class="default">sqlSelectWithPKEY</span><span class="keyword">( </span><span class="default">$select_key </span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// crypt_blowfish symmetric encryption to decrypt the data<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'email'</span><span class="keyword">]&nbsp; &nbsp; &nbsp;&nbsp; = </span><span class="default">$bf</span><span class="keyword">-&gt;</span><span class="default">decrypt</span><span class="keyword">( </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'email'</span><span class="keyword">] );<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'name'</span><span class="keyword">]&nbsp; &nbsp; &nbsp; &nbsp; = </span><span class="default">$bf</span><span class="keyword">-&gt;</span><span class="default">decrypt</span><span class="keyword">( </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'name'</span><span class="keyword">] );<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'creditnr'</span><span class="keyword">]&nbsp; &nbsp; = </span><span class="default">$bf</span><span class="keyword">-&gt;</span><span class="default">decrypt</span><span class="keyword">( </span><span class="default">$aRecord</span><span class="keyword">[</span><span class="string">'creditnr'</span><span class="keyword">] );<br />
</span><span class="default">?&gt;<br />
</span><br />
Thanks for reading this.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80587""></a>
  <div class="note">
   <strong class="user">Kevin</strong>
   <a href="#80587" class="date">23-Jan-2008 06:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Solved Problem:<br />
<br />
when compiling php --with-mcrypt, phpinfo() says, that mcrypt ist enabled, but<br />
"Supported ciphers none" and<br />
"Supported modes none"<br />
<br />
In order to get mcrypt to work in php, you have to configure and compile the libmcrypt source package with the following options:<br />
./configure --disable-posix-threads --enable-dynamic-loading</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="74817""></a>
  <div class="note">
   <strong class="user">Ivan Frederiks</strong>
   <a href="#74817" class="date">28-Apr-2007 04:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To enable mcrypt extension under Windows you need to:<br />
1) uncomment line "extension=php_mcrypt.dll" in php.ini<br />
2) download libmcrypt.dll from <a href="http://files.edin.dk/php/win32/mcrypt/ and put it to System32 directory (for example C:" rel="nofollow" target="_blank">http://files.edin.dk/php/win32/mcrypt/ and put it to System32 directory (for example C:</a>\Windows\System32).<br />
Tested on Windows XP+Apache 1.3.37+PHP 4.4.6 (as SAPI module!!!)<br />
<br />
P.S.<br />
I wrote this because I got "Cannot load mcrypt extension. Please check your PHP configuration." from phpMyAdmin when I simply uncommented "extension=php_mcrypt.dll" line.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="69782""></a>
  <div class="note">
   <strong class="user">duerra_NOT_THIS_ at pushitlive dot net</strong>
   <a href="#69782" class="date">20-Sep-2006 09:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For those of you that need to use PKCS#5 padding, the mcrypt API's for PHP do not support it.&nbsp; However, you can DIY using the following:
<br />

<br />
<span class="default">&lt;?php
<br />

<br />
</span><span class="keyword">function </span><span class="default">encrypt_something</span><span class="keyword">(</span><span class="default">$input</span><span class="keyword">)
<br />
{
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$size </span><span class="keyword">= </span><span class="default">mcrypt_get_block_size</span><span class="keyword">(</span><span class="string">'des'</span><span class="keyword">, </span><span class="string">'ecb'</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$input </span><span class="keyword">= </span><span class="default">pkcs5_pad</span><span class="keyword">(</span><span class="default">$input</span><span class="keyword">, </span><span class="default">$size</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="string">'YOUR SECRET KEY HERE'</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$td </span><span class="keyword">= </span><span class="default">mcrypt_module_open</span><span class="keyword">(</span><span class="string">'des'</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">, </span><span class="string">'ecb'</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">mcrypt_create_iv </span><span class="keyword">(</span><span class="default">mcrypt_enc_get_iv_size</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">), </span><span class="default">MCRYPT_RAND</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_generic_init</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">mcrypt_generic</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">, </span><span class="default">$input</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_generic_deinit</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_module_close</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$data</span><span class="keyword">;
<br />
}
<br />

<br />
function </span><span class="default">pkcs5_pad </span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">, </span><span class="default">$blocksize</span><span class="keyword">)
<br />
{
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pad </span><span class="keyword">= </span><span class="default">$blocksize </span><span class="keyword">- (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">) % </span><span class="default">$blocksize</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$text </span><span class="keyword">. </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="default">chr</span><span class="keyword">(</span><span class="default">$pad</span><span class="keyword">), </span><span class="default">$pad</span><span class="keyword">);
<br />
}
<br />

<br />
function </span><span class="default">pkcs5_unpad</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">)
<br />
{
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pad </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">{</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">)-</span><span class="default">1</span><span class="keyword">});
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$pad </span><span class="keyword">&gt; </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">)) return </span><span class="default">false</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">strspn</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">, </span><span class="default">chr</span><span class="keyword">(</span><span class="default">$pad</span><span class="keyword">), </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">) - </span><span class="default">$pad</span><span class="keyword">) != </span><span class="default">$pad</span><span class="keyword">) return </span><span class="default">false</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, -</span><span class="default">1 </span><span class="keyword">* </span><span class="default">$pad</span><span class="keyword">);
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62850""></a>
  <div class="note">
   <strong class="user">rolf at winmutt dot com</strong>
   <a href="#62850" class="date">10-Mar-2006 09:19</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
mysql AES_ENCRYPT() compatibly function for PHP :
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">mysql_aes_encrypt</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">,</span><span class="default">$ky</span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mode</span><span class="keyword">=</span><span class="default">MCRYPT_MODE_ECB</span><span class="keyword">;&nbsp; &nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$enc</span><span class="keyword">=</span><span class="default">MCRYPT_RIJNDAEL_128</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$val</span><span class="keyword">=</span><span class="default">str_pad</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">, (</span><span class="default">16</span><span class="keyword">*(</span><span class="default">floor</span><span class="keyword">(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">) / </span><span class="default">16</span><span class="keyword">)+(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">) % </span><span class="default">16</span><span class="keyword">==</span><span class="default">0</span><span class="keyword">?</span><span class="default">2</span><span class="keyword">:</span><span class="default">1</span><span class="keyword">))), </span><span class="default">chr</span><span class="keyword">(</span><span class="default">16</span><span class="keyword">-(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">) % </span><span class="default">16</span><span class="keyword">)));
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">mcrypt_encrypt</span><span class="keyword">(</span><span class="default">$enc</span><span class="keyword">, </span><span class="default">$ky</span><span class="keyword">, </span><span class="default">$val</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">, </span><span class="default">mcrypt_create_iv</span><span class="keyword">( </span><span class="default">mcrypt_get_iv_size</span><span class="keyword">(</span><span class="default">$enc</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">), </span><span class="default">MCRYPT_DEV_URANDOM</span><span class="keyword">));
<br />
}
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Please note that if the strlen($ky)&gt;16 then this function will not be compatible.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62494""></a>
  <div class="note">
   <strong class="user">vincent at verbrugh dot nl</strong>
   <a href="#62494" class="date">01-Mar-2006 10:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you plan to use Mcrypt Encryption to store encrypted data (e.g. passwords) in a (MySQL) database make sure to set the column to BLOB rather than VARCHAR. Otherwise the data may change which can give unexpected results if you decrypt the value.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62006""></a>
  <div class="note">
   <strong class="user">Jerry Hathaway</strong>
   <a href="#62006" class="date">17-Feb-2006 07:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
After benchmarking AES in 256-bit operation, I've concluded that CBC is far faster than OFB.&nbsp; Using a 14.9 MiB file, on average...<br />
<br />
Encrypt in CBC:&nbsp;&nbsp; 1.9 seconds<br />
Encrypt in OFB:&nbsp;&nbsp; 45.7 seconds (same as CFB)<br />
Just reading the file:&nbsp; ~.53 seconds<br />
<br />
After some research, I've concluded that OFB and CFB are slightly more secure than CBC, however I believe the performance difference to be due to an implementation issue.<br />
<br />
As a side note on ECB:&nbsp; As stated in the wiki linked to below, ECB is wholly inadequate.&nbsp; It not use an IV (whether it was supplied ot MCrypt or not), meaning the same key and plaintext always produce the same ciphertext and it doesn't hide patterns.&nbsp; The site shows an excellent example of this.<br />
<br />
Very useful info:<br />
<a href="http://en.wikipedia.org/wiki/Block_cipher_mode_of_operation" rel="nofollow" target="_blank">http://en.wikipedia.org/wiki/Block_cipher_mode_of_operation</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="61490""></a>
  <div class="note">
   <strong class="user">triptripon at gmail dot com</strong>
   <a href="#61490" class="date">05-Feb-2006 12:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Regarding storing the result on a postgres DB that uses Unicode (follow up to a post below). <br />
You don't need to change the DB's encoding to ASCII. <br />
Simply use BASE64 to encode the result, it's perfectly safe.<br />
use base64_decode before you decrypt.<br />
-- Tomer Levinboim</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58446""></a>
  <div class="note">
   <strong class="user">coz AT metamule D0T com</strong>
   <a href="#58446" class="date">04-Nov-2005 02:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you're going to encrypt data with something like this and store it in postgres.
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">encrypt</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">){
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt;=</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">); </span><span class="default">$i</span><span class="keyword">++){
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$char </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$i</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$keychar </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, (</span><span class="default">$i </span><span class="keyword">% </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">))-</span><span class="default">1</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$char </span><span class="keyword">= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$char</span><span class="keyword">)+</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$keychar</span><span class="keyword">));
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result</span><span class="keyword">.=</span><span class="default">$char</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$result</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Make sure when you create your database to set the encoding to SQL_ASCII because you won't be able to store this data in a database that uses UNICODE</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58300""></a>
  <div class="note">
   <strong class="user">joseph-at-digiweb-dot-net-dot-nz</strong>
   <a href="#58300" class="date">31-Oct-2005 02:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A further note for those doing interop between PHP and Java:<br />
<br />
If you're using the BouncyCastle library on the Java side, then you can use the ZeroBytePadding mode now available in it. Mcrypt pads the data with Nulls rather than spaces....<br />
<br />
I've sucessfully done interop using Blowfish/CBC/ZeroBytePadding between PHP and Java this way.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="54717""></a>
  <div class="note">
   <strong class="user">paul dot lewis at absolutegenius dot co dot uk</strong>
   <a href="#54717" class="date">13-Jul-2005 05:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I've spent the majority of the day attempting to get mcrypt to work under IIS6 with Windows Server 2003 (Web Edition) and PHP 5.0.4<br />
<br />
There seems to be some incompatability with enabling certain extensions (mcrypt being one) when you are running PHP as ISAPI in this environment.<br />
<br />
The way to solve the problem (the error will be that it cannot load php_mcrypt.dll - access is denied) is to run in CGI. While this isn't supposed to be as good performance wise, if you need the mcrypt support (or Oracle support, too, I believe) then this is the only way I've found to do it.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="47626""></a>
  <div class="note">
   <strong class="user">Jurgen Schwietering</strong>
   <a href="#47626" class="date">23-Nov-2004 10:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Attention when using keys longer than the actual key size (i.e. 160 bit instead of 128 bit). <br />
<br />
It will work inbetween PHP scripts, but might cause problems when using openssl or other packages with this integration of mcrypt. Cut them always to the supported size (mcrypt_enc_get_key_size) to avoid sleepless hours.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="38860""></a>
  <div class="note">
   <strong class="user">groundzero at zuavra dot net</strong>
   <a href="#38860" class="date">09-Jan-2004 02:08</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you've ever compiled PHP from source (any version) you may be familiar with the [in]famous MCRYPT_BLOWFISH_128 compilation error that appears when you attempt to compile --with-mcrypt. It occurs often on Debian but not only there. The problem: during compilation, the PHP configure script always assumes that libmcrypt has been built in conjunction with libltdl. Whenever that is not the case, PHP compilation will fail later saying certain headers (such as the above blowfish example) are missing from mcrypt.h (which is misleading, they're not supposed to be there nor looked after if libltdl was properly involved). Solution: make sure your libmcrypt was linked against libltdl before you even start configuring PHP. You can check by running 'ldd lybmcrypt.so' and verifying that libltdl appears in the output. libltdl can be found in libltld[3][-dev] on Debian or in libtool-libs on Red Hat.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="36291""></a>
  <div class="note">
   <strong class="user">simms</strong>
   <a href="#36291" class="date">03-Oct-2003 11:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
DEBIAN users: avoid mcrypt installation headaches. 
<br />
to add mcrypt support to an existing php installation, get root and run 
<br />

<br />
apt-get install php4-mcrypt
<br />

<br />
restart your webserver, and voila.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="36161""></a>
  <div class="note">
   <strong class="user">steve@itemfront dot ltd dot uk</strong>
   <a href="#36161" class="date">29-Sep-2003 02:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just spent a while getting mcrypt support working with php. Used libmcrypt version 2.5.7 with php 4.3.3. Out of the box it just won't work. Configure as follows:<br />
<br />
libmcrypt:<br />
<br />
&nbsp; ./configure --disable-posix-threads --enable-dynamic-loading<br />
<br />
php: ( as you can see, it's built for a SunONE server, but that's the easy bit to configure! )<br />
<br />
./configure&nbsp; --with-nsapi=/usr/iplanet/servers --enable-sigchld --with-ldap --with-zlib-dir=/usr/lib --with-mcrypt=&lt;srcdir&gt;/libmcrypt-2.5.7<br />
<br />
hth, steve</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="34579""></a>
  <div class="note">
   <strong class="user">herowekker at hotmail dot com</strong>
   <a href="#34579" class="date">31-Jul-2003 02:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
mcrypt_ecb with base64_decode gave some problems, i found out that it had to be chopped to work:
<br />

<br />
<span class="default">&lt;?php
<br />
chop</span><span class="keyword">(</span><span class="default">mcrypt_ecb</span><span class="keyword">(</span><span class="default">MCRYPT_BLOWFISH</span><span class="keyword">,</span><span class="default">$key</span><span class="keyword">,</span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$input</span><span class="keyword">),</span><span class="default">MCRYPT_DECRYPT</span><span class="keyword">));
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="20267""></a>
  <div class="note">
   <strong class="user">scott at boothcreek dot com</strong>
   <a href="#20267" class="date">28-Mar-2002 10:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you are using ECB mode to encrypt it does not seem to use the iv (initialization vector) for much of anything, given the same key it will always decrypt it no matter what the iv is.&nbsp; If you use CBC mode you must decrypt with the same iv that you encrypted with. <br />
<br />
&nbsp;If you use a different iv before decrypting, your decrypt will not work.&nbsp; IMHO it seems better to use CBC mode than ECB as ECB will always encrypt to the same cipher text given the same plain text&nbsp; (leaving you open to know plaintext attacks).&nbsp; CBC uses the random iv which means text encrypts to different things.&nbsp; You probably could get the same effect from using random keys in ECB mode.<br />
<br />
Read that in the Schneier book - Applied Cryptography (ISBN 0-471-11709-9)&nbsp; This book is a must for anyone seriously using any type of encryption.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="14536""></a>
  <div class="note">
   <strong class="user">pawelNOSPAM at rsc dot pl</strong>
   <a href="#14536" class="date">03-Aug-2001 03:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you compiled mcrypt and php without problem, but phpinfo() shows there are no supported ciphers and modes, try to change mode to 755 on libdirs (/usr/local/libmcrypt, /usr/local/libcrypt).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="3671""></a>
  <div class="note">
   <strong class="user">mountie at paygate dot net</strong>
   <a href="#3671" class="date">10-Feb-2000 02:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
the encrypted result data maybe binary data and It make errors in sql query.
<br />
so use the base64_encode/base64_decode function with mcrypt()
<br />
try below
<br />

<br />
<span class="default">&lt;?php
<br />
base64_encode</span><span class="keyword">(</span><span class="default">mcrypt_ecb</span><span class="keyword">(</span><span class="default">MCRYPT_BLOWFISH</span><span class="keyword">,</span><span class="default">$key</span><span class="keyword">,</span><span class="default">$input</span><span class="keyword">,</span><span class="default">MCRYPT_ENCRYPT</span><span class="keyword">));
<br />

<br />
</span><span class="default">mcrypt_ecb</span><span class="keyword">(</span><span class="default">MCRYPT_BLOWFISH</span><span class="keyword">,</span><span class="default">$key</span><span class="keyword">,</span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$input</span><span class="keyword">),</span><span class="default">MCRYPT_DECRYPT</span><span class="keyword">);
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
