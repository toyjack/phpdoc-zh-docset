<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>Set the UID of the current process</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.posix-setsid.html">? posix_setsid</a></li>
      <li style="float: right;"><a href="function.posix-strerror.html">posix_strerror ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.posix.html">POSIX 函数</a></li>
    <li>Set the UID of the current process</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.posix-setuid" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">posix_setuid</h1>
  <p class="verinfo">(PHP 4, PHP 5, PHP 7)</p><p class="refpurpose"><span class="refname">posix_setuid</span> &mdash; <span class="dc-title">Set the UID of the current process</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.posix-setuid-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><strong>posix_setuid</strong></span>
    ( <span class="methodparam"><span class="type">int</span> <code class="parameter">$uid</code></span>
   )</div>

  <p class="para rdfs-comment">
   Set the real user ID of the current process. This is a privileged
   function that needs appropriate privileges (usually root) on
   the system to be able to perform this function.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.posix-setuid-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">uid</code></dt>

     <dd>

      <p class="para">
       The user id.
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.posix-setuid-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   成功时返回 <strong><code>TRUE</code></strong>， 或者在失败时返回 <strong><code>FALSE</code></strong>。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.posix-setuid-examples">
  <h3 class="title">范例</h3>
  <p class="para">
   <div class="example" id="example-4078">
    <p><strong>Example #1 <span class="function"><strong>posix_setuid()</strong></span> example</strong></p>
    <div class="example-contents"><p>This example will show the current user id and then set
     it to a different value.</p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">echo&nbsp;</span><span style="color: #0000BB">posix_getuid</span><span style="color: #007700">().</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//10001<br /></span><span style="color: #007700">echo&nbsp;</span><span style="color: #0000BB">posix_geteuid</span><span style="color: #007700">().</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//10001<br /></span><span style="color: #0000BB">posix_setuid</span><span style="color: #007700">(</span><span style="color: #0000BB">10000</span><span style="color: #007700">);<br />echo&nbsp;</span><span style="color: #0000BB">posix_getuid</span><span style="color: #007700">().</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//10000<br /></span><span style="color: #007700">echo&nbsp;</span><span style="color: #0000BB">posix_geteuid</span><span style="color: #007700">().</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//10000<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.posix-setuid-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.posix-setgid.html" class="function" rel="rdfs-seeAlso">posix_setgid()</a> - Set the GID of the current process</span></li>
    <li class="member"><span class="function"><a href="function.posix-seteuid.html" class="function" rel="rdfs-seeAlso">posix_seteuid()</a> - Set the effective UID of the current process</span></li>
    <li class="member"><span class="function"><a href="function.posix-getuid.html" class="function" rel="rdfs-seeAlso">posix_getuid()</a> - Return the real user ID of the current process</span></li>
    <li class="member"><span class="function"><a href="function.posix-geteuid.html" class="function" rel="rdfs-seeAlso">posix_geteuid()</a> - Return the effective user ID of the current process</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="115069""></a>
  <div class="note">
   <strong class="user">Leigh</strong>
   <a href="#115069" class="date">22-May-2014 11:08</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that on unix, if your target user does not have a valid shell, some php functions (eg: tempnam) will not work correctly:<br />
<br />
$ grep www-data /etc/passwd<br />
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin<br />
<br />
$ cat test.php <br />
#!/usr/bin/php -q<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; $info</span><span class="keyword">=</span><span class="default">posix_getpwnam</span><span class="keyword">(</span><span class="string">"www-data"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$id</span><span class="keyword">=</span><span class="default">$info</span><span class="keyword">[</span><span class="string">"uid"</span><span class="keyword">];<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$file</span><span class="keyword">=</span><span class="default">tempnam</span><span class="keyword">(</span><span class="string">"/tmp"</span><span class="keyword">,</span><span class="string">"something"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; print </span><span class="string">"PRE SetUID: </span><span class="default">$file</span><span class="string">\n"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$SETUID</span><span class="keyword">=</span><span class="default">posix_setuid</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$file</span><span class="keyword">=</span><span class="default">tempnam</span><span class="keyword">(</span><span class="string">"/tmp"</span><span class="keyword">,</span><span class="string">"something"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; print </span><span class="string">"POST SetUID: </span><span class="default">$file</span><span class="string">\n"</span><span class="keyword">;<br />
</span><span class="default">?&gt;<br />
</span><br />
$ sudo ./test.php <br />
PRE SetUID: /tmp/somethingrsb1qZ<br />
POST SetUID:</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="78554""></a>
  <div class="note">
   <strong class="user">fm at farhad.ca</strong>
   <a href="#78554" class="date">17-Oct-2007 12:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When you do a posix_setuid from root to some other users you will not have access to files owned by root according to their permissions. For instance if you change owner of the process and still need to open a file for read or write with 600 permission owned by root you will receive a permission denied.<br />
There are some ways to do this (i.e. a unix socket or tcp daemon etc), but probably the most easiest way is:<br />
<br />
Open the file before changing ownership of process, save the file pointer in a global variable and use it after changing ownership. <br />
<br />
For example assume /root/test_file is a file owned by root:root and have a permission of 600 and you are running this script under root. This code will not work:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Change ownership of process to nobody<br />
</span><span class="default">posix_setgid</span><span class="keyword">(</span><span class="default">99</span><span class="keyword">);<br />
</span><span class="default">posix_setuid</span><span class="keyword">(</span><span class="default">99</span><span class="keyword">);<br />
<br />
</span><span class="default">$fd </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'/root/test_file'</span><span class="keyword">,</span><span class="string">'a'</span><span class="keyword">);<br />
</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">,</span><span class="string">"some test strings"</span><span class="keyword">);<br />
</span><span class="default">fclose</span><span class="keyword">();<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
But this one will work:<br />
<br />
<span class="default">&lt;?php<br />
$fd </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'/root/test_file'</span><span class="keyword">,</span><span class="string">'a'</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Change ownership of process to nobody<br />
</span><span class="default">posix_setgid</span><span class="keyword">(</span><span class="default">99</span><span class="keyword">);<br />
</span><span class="default">posix_setuid</span><span class="keyword">(</span><span class="default">99</span><span class="keyword">);<br />
<br />
</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">,</span><span class="string">"some test strings"</span><span class="keyword">);<br />
</span><span class="default">fclose</span><span class="keyword">();<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Hope this helps some one.<br />
<br />
[Tested on CentOS 5 - Linux 2.6.x - PHP 5.2.x]</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="74747""></a>
  <div class="note">
   <strong class="user">reuben @ nospam me</strong>
   <a href="#74747" class="date">26-Apr-2007 03:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In response to a note above that advocated the user of system() in a setuid program written in C, this is generally a bad idea for security.&nbsp; <br />
<br />
You should use the standard library calls like execl() instead because system() can be manipulated to execute the wrong thing using the SHELL, IFS and possibly other variables.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73113""></a>
  <div class="note">
   <strong class="user">TheWanderer</strong>
   <a href="#73113" class="date">09-Feb-2007 01:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
On many UNIX systems (tested on Debian GNU/Linux), SUID is disabled for scripts and works only for binaries. If you need to setuid, you must use a wrapper binary that runs setuid() php script. Here's an example:<br />
<br />
$ nano suexec.cpp<br />
#include &lt;stdlib&gt;<br />
using namespace std;<br />
int main()<br />
{<br />
system("php /home/php/php_user.php");<br />
return 0;<br />
}<br />
<br />
$ g++ -o suexec suexec.cpp<br />
$ sudo chown root:root suexec<br />
$ sudo chmod 4755 root<br />
<br />
Then we create short PHP script to set process uid (you should already know how to do this). Don't even try to experiment with auto_prepend_file in php.ini, it doesn't work as expected.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68493""></a>
  <div class="note">
   <strong class="user">hpaul/at/abo/dot/fi</strong>
   <a href="#68493" class="date">29-Jul-2006 08:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It seems like this function returns true if you try to change uid to the already active user - even if you aren't root.<br />
<br />
Should save you one if-statement in some cases.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="37289""></a>
  <div class="note">
   <strong class="user">rjmooney at syr dot edu</strong>
   <a href="#37289" class="date">09-Nov-2003 12:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For simple operations, you can easily create a privilege-separation mechanism to perform commands that require elevated privileges.<br />
<br />
For example, in creating a document repository, I had the need to provide access to certain directory and file operations based on a user's login name.&nbsp; It's unrealistic and unsecure to provide the web server access to all of the directories that the user may need to access, so I created a setuid() script to perform the required operations for me.<br />
<br />
An exerpt from the code demonstrates this:<br />
<br />
&lt;?<br />
<br />
//<br />
// main.php<br />
//<br />
<br />
// Perform a privileged stat()<br />
function privsep_stat($path)<br />
{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // Call the privilege separation program, ask for a stat of the specified path<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $serialized_result = exec("/path/to/privsep.php stat " . $path, $oa, $return_code);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ($return_code != 0)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return false;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // Return the unserialized object<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return unserialize($serialized_result);<br />
}<br />
<br />
// Get file statistics on a file we don't have access to as the web server user<br />
$st = privsep_stat("/private_directory/private_file");<br />
print_r($st);<br />
<br />
?&gt;<br />
<br />
privsep.php looks like this:<br />
<br />
#!/usr/local/bin/php<br />
&lt;?<br />
<br />
//<br />
// privsep.php<br />
//<br />
<br />
// Don't allow this script to be run from the web<br />
if (isset($_SERVER['REQUEST_METHOD']))<br />
{<br />
&nbsp;&nbsp;&nbsp; print "&lt;br&gt;This program is not intended to be run directly from the WWW.\n";<br />
&nbsp;&nbsp;&nbsp; return 1;<br />
}<br />
<br />
// TODO: add your argument validation here<br />
<br />
// A stat was requested<br />
if ($argv[1] == "stat")<br />
{<br />
&nbsp;&nbsp;&nbsp; // Reset the stat() cache<br />
&nbsp;&nbsp;&nbsp; clearstatcache();<br />
<br />
&nbsp;&nbsp;&nbsp; // Original user ID<br />
&nbsp;&nbsp;&nbsp; $original_uid = posix_get_uid();<br />
<br />
&nbsp;&nbsp;&nbsp; // Set our real user ID to root<br />
&nbsp;&nbsp;&nbsp; $success = posix_setuid(0);<br />
&nbsp;&nbsp;&nbsp; if (!$success)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print "Error: Cannot setuid().\n";<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return 1;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; // Store the file statistics<br />
&nbsp;&nbsp;&nbsp; $st = stat($argv[2]);<br />
<br />
&nbsp;&nbsp;&nbsp; // Drop the real UID back to the calling user ID<br />
&nbsp;&nbsp;&nbsp; $success = posix_setuid($original_uid); <br />
&nbsp;&nbsp;&nbsp; if (!$success)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print "Error: Cannot setuid().\n";<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return 1;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; // Drop the effective UID as well<br />
&nbsp;&nbsp;&nbsp; $success = posix_seteuid($original_uid); <br />
&nbsp;&nbsp;&nbsp; if (!$success)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print "Error: Cannot seteuid().\n";<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return 1;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; // Serialize the result and print it<br />
&nbsp;&nbsp;&nbsp; $result = serialize($st);<br />
&nbsp;&nbsp;&nbsp; print $result;<br />
<br />
&nbsp;&nbsp;&nbsp; // Success!<br />
&nbsp;&nbsp;&nbsp; return 0;<br />
}<br />
?&gt;<br />
<br />
Finally, privsep.php's permissions are configured like this:<br />
<br />
# chown root:wheel privsep.php<br />
# chmod 4755 privsep.php<br />
<br />
And look like this:<br />
<br />
-rwsr-xr-x&nbsp; 1 root&nbsp; &nbsp; &nbsp; wheel&nbsp; &nbsp;&nbsp; 1000 Nov&nbsp; 1 00:00 privsep.php<br />
<br />
It's probably wise to keep privsep.php out of your document root to help mitigate any successful attack. <br />
<br />
This method can be extended for other functions.&nbsp; Use at your own risk.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="23983""></a>
  <div class="note">
   <strong class="user">simon at dont-spam-me-pleease dot simonster dot com</strong>
   <a href="#23983" class="date">03-Aug-2002 12:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here's some Perl code to run a PHP script setuid. Just put it into a CGI, make that CGI setuid and executable, then call the CGI where you would usually call the PHP script.<br />
<br />
#!/usr/local/bin/perl<br />
<br />
# Perl wrapper to execute a PHP script setuid<br />
# ?2002 Simon Kornblith<br />
# Requires PHP CGI<br />
<br />
# Make UID = EUID (so that PHP can run system()s and execs() setuid)<br />
$&lt; = $&gt;;<br />
# Set this to the path, so that we can't get poisoned<br />
$ENV{'PATH'} = "/home/httpd/cgi-bin/ssl/admin";&nbsp; &nbsp; &nbsp; <br />
# Open the PHP script (must start with !#/usr/local/bin/php or similar and<br />
# be executable<br />
open(STDOUT, "| /home/httpd/cgi-bin/ssl/admin/new.php");<br />
# Write STDIN to PHP script <br />
print while &lt;STDIN&gt;;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
