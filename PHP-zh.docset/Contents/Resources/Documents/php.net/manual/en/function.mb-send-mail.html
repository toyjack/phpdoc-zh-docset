<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>发送编码过的邮件</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.mb-regex-set-options.html">? mb_regex_set_options</a></li>
      <li style="float: right;"><a href="function.mb-split.html">mb_split ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.mbstring.html">多字节字符串 函数</a></li>
    <li>发送编码过的邮件</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.mb-send-mail" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">mb_send_mail</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.0.6, PHP 5)</p><p class="refpurpose"><span class="refname">mb_send_mail</span> &mdash; <span class="dc-title">发送编码过的邮件</span></p>

 </div>
   
 <div class="refsect1 description" id="refsect1-function.mb-send-mail-description">
  <h3 class="title">说明</h3>
   <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><strong>mb_send_mail</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$to</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$subject</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$message</code></span>
   [, <span class="methodparam"><span class="type">string</span> <code class="parameter">$additional_headers</code><span class="initializer"> = <strong><code>NULL</code></strong></span></span>
   [, <span class="methodparam"><span class="type">string</span> <code class="parameter">$additional_parameter</code><span class="initializer"> = <strong><code>NULL</code></strong></span></span>
  ]] )</div>

  <p class="para rdfs-comment"> 
   发送邮件。邮件头和内容根据 <span class="function"><a href="function.mb-language.html" class="function">mb_language()</a></span> 设置来转换编码。
   这是 <span class="function"><a href="function.mail.html" class="function">mail()</a></span> 的一个包装器函数，所以详情参见 <span class="function"><a href="function.mail.html" class="function">mail()</a></span>。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.mb-send-mail-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">to</code></dt>

     <dd>

      <p class="para">
       被发送到该邮件地址。可通过逗号分隔地址的 <code class="parameter">to</code> 来指定多个收件人。
       该参数不会被自动编码。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">subject</code></dt>

     <dd>

      <p class="para">
       邮件标题。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">message</code></dt>

     <dd>

      <p class="para">
       邮件消息。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">additional_headers</code>(可选)</dt>

     <dd>

      <p class="para">
       String to be inserted at the end of the email header.
      </p>
      <p class="para">
       This is typically used to add extra headers (From, Cc, and Bcc).
       Multiple extra headers should be separated with a CRLF (\r\n).
       Validate parameter not to be injected unwanted headers by attackers.
      </p>
      <blockquote class="note"><p><strong class="note">Note</strong>: 
       <p class="para">
        When sending mail, the mail <em class="emphasis">must</em> contain
        a <em>From</em> header. This can be set with the 
        <code class="parameter">additional_headers</code> parameter, or a default
        can be set in <var class="filename">php.ini</var>.
       </p>
       <p class="para">
        Failing to do this will result in an error
        message similar to <em>Warning: mail(): &quot;sendmail_from&quot; not
        set in php.ini or custom &quot;From:&quot; header missing</em>.
        The <em>From</em> header sets also
        <em>Return-Path</em> under Windows.
       </p>
      </p></blockquote>
      <blockquote class="note"><p><strong class="note">Note</strong>: 
       <p class="para">
        If messages are not received, try using a LF (\n) only.
        Some Unix mail transfer agents (most notably
        <a href="http://www.qmail.org/" class="link external" title="Link : http://www.qmail.org/">&raquo;&nbsp;qmail</a>) replace LF by CRLF
        automatically (which leads to doubling CR if CRLF is used).
        This should be a last resort, as it does not comply with
        <a href="http://www.faqs.org/rfcs/rfc2822" class="link external" title="Link : http://www.faqs.org/rfcs/rfc2822">&raquo;&nbsp;RFC 2822</a>.
       </p>
      </p></blockquote>
     </dd>

    
    
     <dt>
<code class="parameter">additional_parameter</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">additional_parameter</code> 是一个 MTA 命令行参数。
       在使用 sendmail 时对设置正确的返回路径头很有帮助。
      </p>
      <p class="para">
       This parameter is escaped by <span class="function"><a href="function.escapeshellcmd.html" class="function">escapeshellcmd()</a></span> internally
       to prevent command execution. <span class="function"><a href="function.escapeshellcmd.html" class="function">escapeshellcmd()</a></span> prevents
       command execution, but allows to add addtional parameters. For security reason,
       this parameter should be validated.
      </p>
      <p class="para">
       Since <span class="function"><a href="function.escapeshellcmd.html" class="function">escapeshellcmd()</a></span> is applied automatically, some characters
       that are allowed as email addresses by internet RFCs cannot be used. Programs
       that are required to use these characters <span class="function"><a href="function.mail.html" class="function">mail()</a></span> cannot be used.
      </p>
      <p class="para">
       The user that the webserver runs as should be added as a trusted user to the
       sendmail configuration to prevent a &#039;X-Warning&#039; header from being added
       to the message when the envelope sender (-f) is set using this method.
       For sendmail users, this file is <var class="filename">/etc/mail/trusted-users</var>.
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.mb-send-mail-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   成功时返回 <strong><code>TRUE</code></strong>， 或者在失败时返回 <strong><code>FALSE</code></strong>。
  </p>
 </div>

 

 <div class="refsect1 seealso" id="refsect1-function.mb-send-mail-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.mail.html" class="function" rel="rdfs-seeAlso">mail()</a> - 发送邮件</span></li>
    <li class="member"><span class="function"><a href="function.mb-encode-mimeheader.html" class="function" rel="rdfs-seeAlso">mb_encode_mimeheader()</a> - 为 MIME 头编码字符串</span></li>
    <li class="member"><span class="function"><a href="function.mb-language.html" class="function" rel="rdfs-seeAlso">mb_language()</a> - 设置/获取当前的语言</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="111002""></a>
  <div class="note">
   <strong class="user">contact-form at contactrobot dot com</strong>
   <a href="#111002" class="date">04-Jan-2013 08:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
While using the right tags mentioned in other comments (mb_internal_encoding, Content-Type, etc) ...<br />
<br />
mb_send_mail would properly encode special characters in plain text emails, for both subject and message<br />
<br />
mb_send_mail would not properly encode special characters in subject for multi-part messages (text+html)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95753""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#95753" class="date">20-Jan-2010 12:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you have problem using mb_send_mail to send utf-8 mails, you have to know the following things (I've spent hours on the net before finding the correct php code) :<br />
<br />
- You have to use the mb_encode_mimeheader function on the sender name and on the recipient name (on names, not on emails !).<br />
- Subject and message are automatically encoded.<br />
- Add - at least - the following header :<br />
<br />
$headers = "Mime-Version: 1.0\n";<br />
$headers .= "Content-Type: text/plain;CHARSET=gb2312\n";<br />
$headers .= "From: $sender";<br />
<br />
- Last but not least, beware of the internal encoding, which is needed by mb_encode_mimeheader function in order to encode properly. I had to set the internal encoding to UTF-8 in order to make it work properly :<br />
<br />
mb_internal_encoding("UTF-8");</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="77899""></a>
  <div class="note">
   <strong class="user">Sohel Taslim</strong>
   <a href="#77899" class="date">19-Sep-2007 08:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Easy and simple....<br />
Send an email with Japanese contain.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">/**<br />
&nbsp;&nbsp; &nbsp; * @name&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : sendMail<br />
&nbsp;&nbsp; &nbsp; * @author Taslim Mazumder Sohel<br />
&nbsp;&nbsp; &nbsp; * @mailsohel62@yahoo.com<br />
&nbsp;&nbsp; &nbsp; * Function for sending email <br />
&nbsp;&nbsp; &nbsp; *with Japanese Email Body, Subject, Sender Name.<br />
&nbsp;&nbsp; &nbsp; *<br />
&nbsp;&nbsp; &nbsp; * @param String $to&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : Receiver mail address.<br />
&nbsp;&nbsp; &nbsp; * @param String $subject&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : email subject.<br />
&nbsp;&nbsp; &nbsp; * @param int&nbsp; &nbsp; $body&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : mail body text.<br />
&nbsp;&nbsp; &nbsp; * @param array&nbsp; $from_email&nbsp; &nbsp; : Sender mail address.<br />
&nbsp;&nbsp; &nbsp; * @param array&nbsp; $from_name&nbsp; &nbsp; &nbsp; : Sender Name.<br />
&nbsp;&nbsp; &nbsp; *<br />
&nbsp;&nbsp; &nbsp; */<br />
</span><span class="keyword">function </span><span class="default">sendMail</span><span class="keyword">(</span><span class="default">$to</span><span class="keyword">, </span><span class="default">$subject</span><span class="keyword">, </span><span class="default">$body</span><span class="keyword">, </span><span class="default">$from_email</span><span class="keyword">,</span><span class="default">$from_name</span><span class="keyword">)<br />
&nbsp;{<br />
</span><span class="default">$headers&nbsp; </span><span class="keyword">= </span><span class="string">"MIME-Version: 1.0 \n" </span><span class="keyword">;<br />
</span><span class="default">$headers </span><span class="keyword">.= </span><span class="string">"From: " </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="string">""</span><span class="keyword">.</span><span class="default">mb_encode_mimeheader </span><span class="keyword">(</span><span class="default">mb_convert_encoding</span><span class="keyword">(</span><span class="default">$from_name</span><span class="keyword">,</span><span class="string">"ISO-2022-JP"</span><span class="keyword">,</span><span class="string">"AUTO"</span><span class="keyword">)) .</span><span class="string">"" </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="string">"&lt;"</span><span class="keyword">.</span><span class="default">$from_email</span><span class="keyword">.</span><span class="string">"&gt; \n"</span><span class="keyword">;<br />
</span><span class="default">$headers </span><span class="keyword">.= </span><span class="string">"Reply-To: " </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="string">""</span><span class="keyword">.</span><span class="default">mb_encode_mimeheader </span><span class="keyword">(</span><span class="default">mb_convert_encoding</span><span class="keyword">(</span><span class="default">$from_name</span><span class="keyword">,</span><span class="string">"ISO-2022-JP"</span><span class="keyword">,</span><span class="string">"AUTO"</span><span class="keyword">)) .</span><span class="string">"" </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="string">"&lt;"</span><span class="keyword">.</span><span class="default">$from_email</span><span class="keyword">.</span><span class="string">"&gt; \n"</span><span class="keyword">;<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; <br />
</span><span class="default">$headers </span><span class="keyword">.= </span><span class="string">"Content-Type: text/plain;charset=ISO-2022-JP \n"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; <br />
</span><span class="comment">/* Convert body to same encoding as stated <br />
in Content-Type header above */<br />
&nbsp;&nbsp;&nbsp; <br />
</span><span class="default">$body </span><span class="keyword">= </span><span class="default">mb_convert_encoding</span><span class="keyword">(</span><span class="default">$body</span><span class="keyword">, </span><span class="string">"ISO-2022-JP"</span><span class="keyword">,</span><span class="string">"AUTO"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
</span><span class="comment">/* Mail, optional paramiters. */<br />
</span><span class="default">$sendmail_params&nbsp; </span><span class="keyword">= </span><span class="string">"-f</span><span class="default">$from_email</span><span class="string">"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
</span><span class="default">mb_language</span><span class="keyword">(</span><span class="string">"ja"</span><span class="keyword">);<br />
</span><span class="default">$subject </span><span class="keyword">= </span><span class="default">mb_convert_encoding</span><span class="keyword">(</span><span class="default">$subject</span><span class="keyword">, </span><span class="string">"ISO-2022-JP"</span><span class="keyword">,</span><span class="string">"AUTO"</span><span class="keyword">);<br />
</span><span class="default">$subject </span><span class="keyword">= </span><span class="default">mb_encode_mimeheader</span><span class="keyword">(</span><span class="default">$subject</span><span class="keyword">);<br />
<br />
</span><span class="default">$result </span><span class="keyword">= </span><span class="default">mail</span><span class="keyword">(</span><span class="default">$to</span><span class="keyword">, </span><span class="default">$subject</span><span class="keyword">, </span><span class="default">$body</span><span class="keyword">, </span><span class="default">$headers</span><span class="keyword">, </span><span class="default">$sendmail_params</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; <br />
return </span><span class="default">$result</span><span class="keyword">;<br />
}<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="74598""></a>
  <div class="note">
   <strong class="user">noting@nowhere</strong>
   <a href="#74598" class="date">19-Apr-2007 02:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Yes, as far as I understood the function encodes the entrire message body with base64 and that's why it can be used to send messages with attachments.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="72702""></a>
  <div class="note">
   
   <a href="#72702" class="date">30-Jan-2007 01:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be careful, mb_send_mail chokes if you try and send a multipart e-mail.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="43480""></a>
  <div class="note">
   <strong class="user">bredfern at calarts dot edu</strong>
   <a href="#43480" class="date">23-Jun-2004 12:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Make sure that if you're using a form to type in the mail, that your form page has the right encoding, like if I want to send out a japanese email, by filling out a form, the form page needs this in the header:<br />
&lt;META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=SHIFT-JIS"&gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="35404""></a>
  <div class="note">
   <strong class="user">dynamis at skillup dot jp</strong>
   <a href="#35404" class="date">30-Aug-2003 03:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
# self-fix...<br />
I posted "encode_mimeheader" workaround on the day before. But I found that the code depends on platforms. :(<br />
<br />
In some platforms, hedders(after the header splited into two or more lines) will appear in the body content.<br />
The cause is that 'there are some platforms where the translation from \n to \r\n is apparently done for you'.<br />
# See the post by "leon at ietsmet dot nl" about mail function (23-Apr-2003).<br />
<br />
Now, all you have to do is just changing the glue string from "\r\n " to "\n ".<br />
<br />
function encode_mimeheader($str, $indent = 0, $encoding = 'utf-8', $mail_encoding = 'iso-2022-jp')<br />
{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; ..... lefted out (all same).....<br />
&nbsp; $str = join("\r\n ", $lines); // RFC 2047,822 say newline must be ^\r\n, not only\n<br />
&nbsp; return $str;<br />
}<br />
<br />
should be below in some platform...<br />
<br />
function encode_mimeheader($str, $indent = 0, $encoding = 'utf-8', $mail_encoding = 'iso-2022-jp')<br />
{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; ..... lefted out (all same).....<br />
&nbsp; $str = join("\n ", $lines);<br />
&nbsp; // Though RFC 2047,822 say newline must be \r\n, not only \n,<br />
&nbsp; // in my platform, auto replacement will be done (accepts \n and \n\r\n -&gt; \n\n)...<br />
&nbsp; return $str;<br />
}<br />
<br />
# notice: In both code, 1 space after newline is essential (gule str is *not* only "\r\n" nor "\n").<br />
# This space is ignored only between encoded-words.<br />
<br />
&nbsp;&nbsp;&nbsp; c.f. about efficiency<br />
<br />
Thinking about efficiency, my encode_mimeheader may have to determine where to split string into lines without mb_encode_mimeheader in the determining loop. But that loop will be repeated only one or a few times and this function&nbsp; will be usually used against not so long string. So, this loss is not critical in most case.<br />
If you use only one encoding, you can easily check ascii or multi-byte char one by one accoding to the definition of the encoding and determining splitting point (this is far faster), but when you have to handle all encoding that is not so easy. At least, I don't want to touch. :p<br />
To accept *any* encoding (encoding name will be passed as argument), you can use this code. This is because I post non-efficient code like this.<br />
# Though I'm not sure whether the code actually work well with all encoding...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="34254""></a>
  <div class="note">
   <strong class="user">dynamis at skillup dot jp</strong>
   <a href="#34254" class="date">20-Jul-2003 01:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As others say, mb_encode_mimeheader() seems to have a bug with JIS(ISO-2022-JP) encording. Token indicating start and end of multibyte char is inserted only before start of encoding and after the all.<br />
We need the tokens at start and end of *all* encoded-text.<br />
# PHP 4.3.2<br />
<br />
So, we needs some workaround.<br />
<br />
The post by "gordon at kanazawa-gu dot ac dot jp" seems to work well, but it doesn't. JIS nees some special tokens and base64_encode does'nt output them, so the code cannot used.<br />
<br />
The post "RE: N03L in Japan", which simply splitting words in eash 10 chars is good enough in most case, there are some problem left. When there are some splited parts starting with ascii chars, 1 additional space will be inserted.<br />
# RFC2047 only say within 76 words, shorter is not bad.<br />
<br />
Additionally, thought it is really rare case, when we use "=?charset?" as literal string, we have to escape them.<br />
# Some mailer can actually send this without escape and header will be broken. :(<br />
<br />
Now, a little non-smart but maybe more accurate code is below function. I tested only with ISO-2022-JP, only in costomized phpBB2.0.5, only some cases.<br />
As far as my test this code worked well, but I'm not sure.<br />
<br />
# $str: source text<br />
# $indent: ex. for "Subject: " header, give 9 and first line will be shorter than 76-1-9=66<br />
# $encoding: source text encoding<br />
# $mail_encoding: $str will be converted into this before base64 encode<br />
<br />
function encode_mimeheader($str, $indent = 0, $encoding = 'utf-8', $mail_encoding = 'iso-2022-jp')<br />
{<br />
&nbsp; $start_delimiter = strtoupper("=?$mail_encoding?B?");<br />
&nbsp; $start_pattern&nbsp;&nbsp; = strtoupper("=\\?$mail_encoding\\?B\\?");<br />
&nbsp; $end_delimiter&nbsp;&nbsp; = '?=';<br />
<br />
&nbsp; $str = mb_convert_encoding($str, $mail_encoding, $encoding);<br />
&nbsp; $length&nbsp; = mb_strlen($str, $mail_encoding);<br />
&nbsp; $max_part_length = 20; // enough short in most case (you can change this default value)<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp; for ($i=0, $index=0; $index&lt;$length; $i++) {<br />
&nbsp;&nbsp;&nbsp; $part_length = $max_part_length;<br />
&nbsp;&nbsp;&nbsp; $s = mb_substr($str, $index, $part_length, $mail_encoding);<br />
&nbsp;&nbsp;&nbsp; // workaround for literally used start delimiter (without below, subject may break)<br />
&nbsp;&nbsp;&nbsp; // note: mb_encode_mimeheader() don't encode ascii including start delimiter<br />
&nbsp;&nbsp;&nbsp; if (preg_match('/^' . $start_pattern . '/i', $s))<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; $lines[$i] = $start_delimiter . base64_encode($start_delimiter) . "?=";<br />
&nbsp;&nbsp; &nbsp;&nbsp; $index += strlen($start_delimiter);<br />
&nbsp;&nbsp; &nbsp;&nbsp; continue;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; $lines[$i] = mb_encode_mimeheader($s, $mail_encoding);<br />
&nbsp;&nbsp;&nbsp; while (strlen($lines[$i]) &gt; 76-1 - ($i?0:$indent)) { // max par line - first space - indent (first line only)<br />
&nbsp;&nbsp; &nbsp;&nbsp; $part_length = floor($part_length * (76-1 - ($i?0:$indent)) / strlen($lines[$i])); // at least 1 decrement<br />
&nbsp;&nbsp; &nbsp;&nbsp; $s = mb_substr($str, $index, $part_length, $mail_encoding);<br />
&nbsp;&nbsp; &nbsp;&nbsp; $lines[$i] = mb_encode_mimeheader($s, $mail_encoding);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; // workaround for starting new line with ascii (without below, 1 space may cut in)<br />
&nbsp;&nbsp;&nbsp; // note: mb_encode_mimeheader() starts encode after encounterring multibyte char<br />
&nbsp;&nbsp;&nbsp; if ($i &gt; 0 &amp;&amp; !preg_match('/^' . $start_pattern . '/i', $lines[$i]))<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; $p = strpos($lines[$i], $start_delimiter); //never 0 (false when not found)<br />
&nbsp;&nbsp; &nbsp;&nbsp; $p = $p ? $p : strlen($lines[$i]);<br />
&nbsp;&nbsp; &nbsp;&nbsp; $lines[$i] = $start_delimiter . base64_encode(substr($lines[$i], 0, $p)) . "?=";<br />
&nbsp;&nbsp; &nbsp;&nbsp; $part_length = $p;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; $index += $part_length;<br />
&nbsp; }<br />
&nbsp; $str = join("\r\n ", $lines); // RFC 2047,822 say newline must be ^\r\n, not only\n<br />
&nbsp; return $str;<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="32273""></a>
  <div class="note">
   <strong class="user">RE: N03L in Japan</strong>
   <a href="#32273" class="date">22-May-2003 11:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have to use Japanese hankaku (single byte kana in (S)JIS) in mail subject and message,<br />
so I tried the way that NO3L in Japan said, but I found there's a big problem.<br />
In that way, mb_encode_mimeheader drop escape sequence from the head of encoded string from second line.<br />
if you use long letter in subject, and if it includes multi byte string, It must crashed.<br />
Therefore, if you want to use Japanese hankaku in mail subject, you might try like this.<br />
Encoded subject letters in one line is not just 76 letters, so it is not based on RFC, but it work.<br />
<br />
$intSubjectLength&nbsp; = mb_strlen($strSubject);<br />
$intSeparateLength = 10;<br />
for ($i=0; $i&lt;ceil($intSubjectLength / $intSeparateLength); $i++) {<br />
&nbsp;&nbsp;&nbsp; $arrSeparatedSubject[$i] = mb_substr($strSubject, $intIndex, $intSeparateLength);<br />
&nbsp;&nbsp;&nbsp; $arrSeparatedSubject[$i] = mb_encode_mimeheader(mb_convert_encoding($arrSeparatedSubject[$i], "JIS", "EUC-JP"));<br />
&nbsp;&nbsp;&nbsp; $intIndex = $intIndex + $intSeparateLength;<br />
}<br />
$strSubject = join("\n ", $arrSeparatedSubject);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="31057""></a>
  <div class="note">
   <strong class="user">Ran Hamada ( rhamada at sdcj dot co dot jp )</strong>
   <a href="#31057" class="date">08-Apr-2003 06:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You may not use mb_encode_mimeheader() with mb_convert_encoding() to make subject as follows. It causes mojibake in several strings.<br />
mb_encode_mimeheader( mb_convert_encoding($strMailSubj, "JIS", "EUC-JP") )<br />
<br />
Set mb_internal_encoding() to *subject's* encoding and call mb_encode_mimeheader.<br />
<br />
Example)<br />
<br />
&nbsp;&nbsp;&nbsp; $__lang = mb_language();<br />
&nbsp;&nbsp;&nbsp; $__enc = mb_internal_encoding();<br />
&nbsp;&nbsp;&nbsp; mb_language("Japanese");<br />
&nbsp;&nbsp;&nbsp; mb_internal_encoding( mb_detect_encoding($subject) );<br />
&nbsp;&nbsp;&nbsp; #mb_internal_encoding( "EUC-JP" ); #just do when you know encoding of $subject<br />
&nbsp;&nbsp;&nbsp; mail($to,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; mb_encode_mimeheader($subject),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; mb_convert_encoding($msg,"JIS","AUTO"),$header);<br />
&nbsp;&nbsp;&nbsp; mb_internal_encoding( $__enc );<br />
&nbsp;&nbsp;&nbsp; mb_language($__lang);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="29843""></a>
  <div class="note">
   <strong class="user">phpguru at hotmail dot com</strong>
   <a href="#29843" class="date">26-Feb-2003 08:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There is another way of encoding Japanese language to send email without worrying about mb_functions:<br />
<br />
Download PHP Jcode from <a href="http://www.spencernetwork.org/" rel="nofollow" target="_blank">http://www.spencernetwork.org/</a><br />
and use JcodeConvert function with base64_encode function for the e-mail header and the subject.<br />
<br />
$email_to = "blah@blah.com";<br />
<br />
$_POST["name"] = strip_tags(trim($_POST["name"]));<br />
$name = "=?ISO-2022-JP?B?". base64_encode(JcodeConvert($_POST["name"], 2, 3)). "?=";<br />
$_POST["email"] = strip_tags(trim($_POST["email"]));<br />
$_POST["subject"] = strip_tags(trim($_POST["subject"]));<br />
$email_subject = "=?ISO-2022-JP?B?". base64_encode(JcodeConvert($_POST["subject"], 2, 3)). "?=";<br />
$_POST["body"] = strip_tags(trim($_POST["body"]));<br />
<br />
$email_header = "From: $name &lt;". $_POST["email"] ."&gt;\n";<br />
$email_header .= "Reply-To: ". $_POST["email"] ."\n";<br />
$email_header .= "Content-transfer-encoding: 7bit\n";<br />
$email_header .= "Content-type: text/plain; charset=\"iso-2022-jp\"\n\n";<br />
<br />
$email_body = "blah blah blah.\n"<br />
<br />
mail($email_to, $email_subject, $email_body, $email_header);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="29747""></a>
  <div class="note">
   <strong class="user">N03L in Japan</strong>
   <a href="#29747" class="date">24-Feb-2003 06:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
First of all, don't use nl2br in newer php versions unless you WANT to write xhtml...you'll get &lt;br /&gt; tags.<br />
<br />
Secondly, you should use JIS, not ISO-2022-JP as the convert TO encoding.&nbsp; If you use ISO... mb_encode_mimeheader seems to fail. They're the same charset anyway.<br />
<br />
Now here's why I am really writing.&nbsp; I just discovered that mb_send_mail and mb_encode_mimeheader cannot support hankaku (single byte kana in (S)JIS) at all.&nbsp; If you are making apps for the keitai (mobile) market, this won't do.&nbsp; Therefore, undo your overloading on the mail function and use regular mail and convert everything yourself like this.&nbsp; This is what we did.&nbsp; It seems to work for us.&nbsp; Your mileage may vary.<br />
<br />
$strMBS = mb_convert_encoding($strMailBodySend, "JIS", "EUC-JP");<br />
<br />
$strMS&nbsp; = mb_encode_mimeheader( mb_convert_encoding($strMailSubj, "JIS", "EUC-JP") );<br />
<br />
mail($strToMail, $strMS, $strMBS, $strFrom);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="29174""></a>
  <div class="note">
   <strong class="user">jc AT mega-bucks DOT co DOT jp</strong>
   <a href="#29174" class="date">05-Feb-2003 09:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was trying to send japanese email and had a hell of a time getting it to work. I finally stumbled across mb_send_mail() and it did everything I wanted *except* that it only send plain text emails ... sending HTML contents was impossible.<br />
<br />
I finally whipped this up. I'm posting in case someone finds it useful.<br />
<br />
function send_japanese_mail($to, $subject, $body, $from, $from_email, $is_html_content=false) {<br />
<br />
&nbsp;&nbsp; $headers&nbsp; = "MIME-Version: 1.0\\n" ;<br />
&nbsp;&nbsp; $headers .= "From: $from &lt;$from_email&gt;\\n";<br />
&nbsp;&nbsp; $headers .= "Reply-To: $from &lt;$from_email&gt;\\n";<br />
&nbsp;<br />
&nbsp; /* If the body&nbsp; is HTML or plain text set the Content-Type header accordingly */<br />
<br />
&nbsp;&nbsp; if ($is_html_content) {<br />
&nbsp;&nbsp; &nbsp; $headers .= "Content-Type: text/html;charset=ISO-2022-JP\\n";<br />
&nbsp;&nbsp; &nbsp; /* turn all line breaks into BR tags */<br />
&nbsp;&nbsp; &nbsp; $body = nl2br($body);<br />
&nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; else {<br />
&nbsp;&nbsp; &nbsp; $headers .= "Content-Type: text/plain;charset=ISO-2022-JP\\n";<br />
&nbsp;&nbsp; }<br />
<br />
&nbsp; /* need to convert body to same encoding as stated in Content-Type header above */<br />
<br />
&nbsp; $body = mb_convert_encoding($body, "ISO-2022-JP","AUTO");<br />
<br />
&nbsp; /* set any sendmail params, optional ... */<br />
&nbsp; $sendmail_params&nbsp; = "-f$from_email";<br />
<br />
&nbsp; /*<br />
&nbsp;&nbsp; The subject is actually a "header" and can/will get mangled<br />
&nbsp;&nbsp; if it contains non-ASCII characters. So we need to convert<br />
&nbsp;&nbsp; the subject to something containing only ASCII characters.<br />
<br />
&nbsp;&nbsp; First we convert the subject to the same encoding as the<br />
&nbsp;&nbsp; body, then we use mb_encode_mimeheader() to make the subject<br />
&nbsp;&nbsp; line all ASCII characters.<br />
&nbsp; */<br />
<br />
&nbsp;&nbsp; mb_language("ja");<br />
&nbsp;&nbsp; $subject = mb_convert_encoding($subject, "ISO-2022-JP","AUTO");<br />
&nbsp;&nbsp; $subject = mb_encode_mimeheader($subject);<br />
<br />
&nbsp;&nbsp; mail($to, $subject, $body, $headers, $sendmail_params);<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="27998""></a>
  <div class="note">
   <strong class="user">gordon at kanazawa-gu dot ac dot jp</strong>
   <a href="#27998" class="date">29-Dec-2002 03:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If your server doesn't have mb_send_mail() enabled but you want to use non-ascii (multi-byte) chars in an email's subject or name headers, you can use something like the following:<br />
<br />
$charset = "iso-2202-jp"; // japanese<br />
$to = encode("japanese name 01", $charset) . " &lt;to@email.com&gt;";<br />
$from = encode("japanese name 02", $charset) . " &lt;from@email.com&gt;";<br />
$subject = encode("japanese text", $charset);<br />
$message = "does not need to be encoded";<br />
mail($to, $subject, $message, $from);<br />
<br />
function encode($in_str, $charset) {<br />
&nbsp;&nbsp;&nbsp; $out_str = $in_str;<br />
&nbsp;&nbsp;&nbsp; if ($out_str &amp;&amp; $charset) {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // define start delimimter, end delimiter and spacer<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $end = "?=";<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $start = "=?" . $charset . "?B?";<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $spacer = $end . "\r\n " . $start;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // determine length of encoded text within chunks<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // and ensure length is even<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $length = 75 - strlen($start) - strlen($end);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $length = floor($length/2) * 2;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // encode the string and split it into chunks <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // with spacers after each chunk<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $out_str = base64_encode($out_str);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $out_str = chunk_split($out_str, $length, $spacer);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // remove trailing spacer and <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // add start and end delimiters<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $spacer = preg_quote($spacer);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $out_str = preg_replace("/" . $spacer . "$/", "", $out_str);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $out_str = $start . $out_str . $end;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return $out_str;<br />
}<br />
// for details on Message Header Extensions <br />
// for Non-ASCII Text see ...<br />
// <a href="http://www.faqs.org/rfcs/rfc2047.html" rel="nofollow" target="_blank">http://www.faqs.org/rfcs/rfc2047.html</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="25218""></a>
  <div class="note">
   <strong class="user">no dot email dot address at example dot com</strong>
   <a href="#25218" class="date">15-Sep-2002 12:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Tested with PHP 4.2.2 on Linux: Please note that if you're using Unicode (mb_language("uni")) and you attempt to send mail with mb_send_mail(), you will need to base64_encode() the message body - mb_send_mail() doesn't do that for you. It does, however, issue the correct message headers, so you don't need to worry about that.<br />
<br />
Also note that neither mb_language() nor mb_send_mail() is able to convert your message to UTF-8. *You* need to provide the UTF-8-encoded (and base64-encoded) message, and then mb_send_mail() will issue the correct message headers.<br />
<br />
Here's an example of sending an UTF-8-encoded message with mb_send_mail():<br />
<br />
mb_language("uni");<br />
$body = chunk_split(base64_encode("International characters"));<br />
mb_send_mail("someone@example.com", "Subject", $body);<br />
<br />
If the receiving mail client supports UTF-8 properly, you will be able to send messages that contain a mix of all kinds of characters (e.g., you could send Thai, Chinese, and Danish characters in the same message). Not all mail clients support UTF-8, though. At the time of writing, some of the more popular Windows email clients - Eudora and Pegasus Mail - don't. There are a number of email clients with working support for UTF-8. These include Outlook Express, KMail, Mozilla, Netscape 6/7, Sylpheed, Evolution and others.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
