<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>轻便的咨询文件锁定</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.filetype.html">? filetype</a></li>
      <li style="float: right;"><a href="function.fnmatch.html">fnmatch ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.filesystem.html">文件系统函数</a></li>
    <li>轻便的咨询文件锁定</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.flock" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">flock</h1>
  <p class="verinfo">(PHP 4, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">flock</span> &mdash; <span class="dc-title">轻便的咨询文件锁定</span></p>

 </div>
 <div class="refsect1 description" id="refsect1-function.flock-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>flock</strong></span>(<span class="methodparam"><span class="type">resource</span> <code class="parameter">$handle</code></span>, <span class="methodparam"><span class="type">int</span> <code class="parameter">$operation</code></span>, <span class="methodparam"><span class="type">int</span> <code class="parameter reference">&$wouldblock</code><span class="initializer"> = ?</span></span>): <span class="type">bool</span></div>

    <p class="para rdfs-comment">
     <span class="function"><strong>flock()</strong></span> 允许执行一个简单的可以在任何平台中使用的读取/写入模型（包括大部分的
   Unix 派生版和甚至是 Windows）。
  </p>
    <p class="para">
     在 PHP 5.3.2版本之前，锁也会被 <span class="function"><a href="function.fclose.html" class="function">fclose()</a></span> 释放（在脚本结束后会自动调用）。
  </p>
  <p class="para">
   PHP 支持以咨询方式（也就是说所有访问程序必须使用同一方式锁定, 否则它不会工作）锁定全部文件的一种轻便方法。
    默认情况下，这个函数会阻塞到获取锁；这可以通过下面文档中 <strong><code>LOCK_NB</code></strong> 选项来控制（在非 Windows 平台上）。
  </p>
 </div>

 
 <div class="refsect1 parameters" id="refsect1-function.flock-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">handle</code></dt>

     <dd>

      <p class="para">文件系统指针，是典型地由
<span class="function"><a href="function.fopen.html" class="function">fopen()</a></span> 创建的 <span class="type">resource</span>(资源)。</p>
     </dd>

    
    
     <dt>
<code class="parameter">operation</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">operation</code>
   可以是以下值之一：
       <ul class="itemizedlist">
        <li class="listitem">
         <span class="simpara">
         <strong><code>LOCK_SH</code></strong>取得共享锁定（读取的程序）。
         </span>
        </li>
        <li class="listitem">
         <span class="simpara">
         <strong><code>LOCK_EX</code></strong> 取得独占锁定（写入的程序。
         </span>
        </li>
        <li class="listitem">
         <span class="simpara">
          <strong><code>LOCK_UN</code></strong> 释放锁定（无论共享或独占）。
         </span>
        </li>
       </ul>
      </p>
      <p class="para">
       如果不希望 <span class="function"><strong>flock()</strong></span> 在锁定时堵塞，则是
       <strong><code>LOCK_NB</code></strong>（Windows 上还不支持）。

      </p>
     </dd>

    
    
     <dt>
<code class="parameter">wouldblock</code></dt>

     <dd>

      <p class="para">
       如果锁定会堵塞的话（EWOULDBLOCK
   错误码情况下），可选的第三个参数会被设置为 <strong><code>true</code></strong>。（Windows 上不支持）
      </p>
     </dd>

    
   </dl>

  </p>
 </div>

 
 <div class="refsect1 returnvalues" id="refsect1-function.flock-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   成功时返回 <strong><code>true</code></strong>， 或者在失败时返回 <strong><code>false</code></strong>。
  </p>
 </div>

 
 <div class="refsect1 changelog" id="refsect1-function.flock-changelog">
  <h3 class="title">更新日志</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>版本</th>
       <th>说明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>5.3.2</td>
       <td>
        在文件资源句柄关闭时不再自动解锁。现在要解锁必须手动进行。
       </td>
      </tr>

      <tr>
       <td>4.0.1</td>
       <td>
        增加了常量 <code class="literal">LOCK_XXX</code>。
        之前你必须使用 1 代表 <strong><code>LOCK_SH</code></strong>，2 代表
        <strong><code>LOCK_EX</code></strong>，3 代表<strong><code>LOCK_UN</code></strong>，4 代表
         <strong><code>LOCK_NB</code></strong>。
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>

 
 <div class="refsect1 examples" id="refsect1-function.flock-examples">
  <h3 class="title">范例</h3>
  <p class="para">
   <div class="example" id="example-2112">
    <p><strong>Example #1 <span class="function"><strong>flock()</strong></span> 例子</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"/tmp/lock.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"r+"</span><span style="color: #007700">);<br /><br />if&nbsp;(</span><span style="color: #0000BB">flock</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">LOCK_EX</span><span style="color: #007700">))&nbsp;{&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;进行排它型锁定<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">ftruncate</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;truncate&nbsp;file<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"Write&nbsp;something&nbsp;here\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fflush</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;flush&nbsp;output&nbsp;before&nbsp;releasing&nbsp;the&nbsp;lock<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">flock</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">LOCK_UN</span><span style="color: #007700">);&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;释放锁定<br /></span><span style="color: #007700">}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Couldn't&nbsp;get&nbsp;the&nbsp;lock!"</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   <div class="example" id="example-2113">
    <p><strong>Example #2 <span class="function"><strong>flock()</strong></span> 使用 <strong><code>LOCK_NB</code></strong> 选项</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">'/tmp/lock.txt'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'r+'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;Activate&nbsp;the&nbsp;LOCK_NB&nbsp;option&nbsp;on&nbsp;an&nbsp;LOCK_EX&nbsp;operation&nbsp;*/<br /></span><span style="color: #007700">if(!</span><span style="color: #0000BB">flock</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">LOCK_EX&nbsp;</span><span style="color: #007700">|&nbsp;</span><span style="color: #0000BB">LOCK_NB</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'Unable&nbsp;to&nbsp;obtain&nbsp;lock'</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;exit(-</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;...&nbsp;*/<br /><br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>

 
 <div class="refsect1 notes" id="refsect1-function.flock-notes">
  <h3 class="title">注释</h3>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    <span class="function"><strong>flock()</strong></span> uses mandatory locking instead of advisory
    locking on Windows. Mandatory locking is also supported on Linux and
    System V based operating systems via the usual mechanism supported by the
    fcntl() system call: that is, if the file in question has the setgid
    permission bit set and the group execution bit cleared. On Linux, the file
    system will also need to be mounted with the mand option for this to work.
   </p>
  </p></blockquote>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    由于 <span class="function"><strong>flock()</strong></span>
    需要一个文件指针， 因此可能不得不用一个特殊的锁定文件来保护打算通过写模式打开的文件的访问（在
    <span class="function"><a href="function.fopen.html" class="function">fopen()</a></span> 函数中加入 &quot;w&quot; 或 &quot;w+&quot;）。
   </p>
  </p></blockquote>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    May only be used on file pointers returned by <span class="function"><a href="function.fopen.html" class="function">fopen()</a></span>
    for local files, or file pointers pointing to userspace streams that
    implement the <span class="function"><a href="streamwrapper.stream-lock.html" class="function">streamWrapper::stream_lock()</a></span> method.
   </p>
  </p></blockquote>
  <div class="warning"><strong class="warning">Warning</strong>
   <p class="para">
    Assigning another value to <code class="parameter">handle</code> argument in
    subsequent code will release the lock.
   </p>
  </div>
  <div class="warning"><strong class="warning">Warning</strong>
   <p class="para">
    在部分操作系统中 <span class="function"><strong>flock()</strong></span> 以进程级实现。当用一个多线程服务器
    API（比如 ISAPI）时，可能不可以依靠
    <span class="function"><strong>flock()</strong></span> 来保护文件，因为运行于同一服务器实例中其它并行线程的
    PHP 脚本可以对该文件进行处理。
   </p>
   <p class="para">
    <span class="function"><strong>flock()</strong></span> 不支持旧的文件系统，如 <code class="literal">FAT</code>
    以及它的派生系统。因此，此环境下总是返回 <strong><code>false</code></strong>（尤其是对 Windows 98 用户来说）。
   </p>
  </div>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="121196""></a>
  <div class="note">
   <strong class="user">peripeltus at gmail dot com</strong>
   <a href="#121196" class="date">07-Jun-2017 01:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Relying on flock for synchronise things is risky, consider using extensions like SYNC or pthreads instead.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120874""></a>
  <div class="note">
   <strong class="user">jlh at gmx dot ch</strong>
   <a href="#120874" class="date">27-Mar-2017 06:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When a file is closed the lock will be released by the system anyway, even if PHP doesn't do it explicitly anymore since 5.3.2 (the documentation is very confusing about this).<br />
<br />
However, I had a situation on an apache/PHP server where an out-of-memory error in PHP caused file handles to not be closed and therefore the locks where kept even thought PHP execution had ended and the process had returned to apache to serve other requests. The lock was kept alive until apache recycled those processes.<br />
<br />
This lack of proper clean up basically makes flock() completely unreliable.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120274""></a>
  <div class="note">
   <strong class="user">markus at malkusch dot de</strong>
   <a href="#120274" class="date">04-Dec-2016 07:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
And here's the timeout template for UNIX:<br />
<br />
<span class="default">&lt;?php<br />
pcntl_signal</span><span class="keyword">(</span><span class="default">SIGALRM</span><span class="keyword">, function() {});<br />
</span><span class="default">pcntl_alarm</span><span class="keyword">(</span><span class="default">3</span><span class="keyword">);<br />
try {<br />
&nbsp;&nbsp;&nbsp; if (!</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; throw new \</span><span class="default">Exception</span><span class="keyword">(</span><span class="string">"Timeout"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
} finally {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">pcntl_alarm</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">pcntl_signal_dispatch</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGALRM</span><span class="keyword">, </span><span class="default">SIG_DFL</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118933""></a>
  <div class="note">
   <strong class="user">emilchemical at gmail dot com</strong>
   <a href="#118933" class="date">01-Mar-2016 02:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you are interested in using file locking as indicator that your console app is running and you don't want to start it again:<br />
<br />
&nbsp;if (!flock($fp, LOCK_EX | LOCK_NB, $wouldblock)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if ($wouldblock) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //Another process holds the lock!<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //Couldn't lock for another reason, e.g. no such file<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //Lock obtained<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; startJob();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
Please note that this is platform independent solution, but you have restrictions in PHP version (5.5.22 on Windows).<br />
Also, some old file systems are not supported.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117162""></a>
  <div class="note">
   <strong class="user">forzi at mail333 dot com</strong>
   <a href="#117162" class="date">24-Apr-2015 06:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Simple Helper for lock files creation<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">class </span><span class="default">FileLocker </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; protected static </span><span class="default">$loc_files </span><span class="keyword">= array();<br />
<br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">lockFile</span><span class="keyword">(</span><span class="default">$file_name</span><span class="keyword">, </span><span class="default">$wait </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$loc_file </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$file_name</span><span class="keyword">, </span><span class="string">'c'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ( !</span><span class="default">$loc_file </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new \</span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'Can\'t create lock file!'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ( </span><span class="default">$wait </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lock </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$loc_file</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lock </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$loc_file</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">| </span><span class="default">LOCK_NB</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ( </span><span class="default">$lock </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">self</span><span class="keyword">::</span><span class="default">$loc_files</span><span class="keyword">[</span><span class="default">$file_name</span><span class="keyword">] = </span><span class="default">$loc_file</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fprintf</span><span class="keyword">(</span><span class="default">$loc_file</span><span class="keyword">, </span><span class="string">"%s\n"</span><span class="keyword">, </span><span class="default">getmypid</span><span class="keyword">());<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$loc_file</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else if ( </span><span class="default">$wait </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new \</span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'Can\'t lock file!'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">unlockFile</span><span class="keyword">(</span><span class="default">$file_name</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">self</span><span class="keyword">::</span><span class="default">$loc_files</span><span class="keyword">[</span><span class="default">$file_name</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$file_name</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">self</span><span class="keyword">::</span><span class="default">$loc_files</span><span class="keyword">[</span><span class="default">$file_name</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
} <br />
<br />
if ( !</span><span class="default">FileLocker</span><span class="keyword">::</span><span class="default">lockFile</span><span class="keyword">(</span><span class="string">'/tmp/1.lock'</span><span class="keyword">) ) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Can't lock file\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; die();<br />
}<br />
</span><span class="default">sleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">);<br />
</span><span class="default">FileLocker</span><span class="keyword">::</span><span class="default">unlockFile</span><span class="keyword">(</span><span class="string">'/tmp/1.lock'</span><span class="keyword">);<br />
echo </span><span class="string">"All Ok\n"</span><span class="keyword">;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116782""></a>
  <div class="note">
   <strong class="user">ravenswd at gmail dot com</strong>
   <a href="#116782" class="date">27-Feb-2015 05:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that Example #1 contains a bug: ftruncate() does *not* re-set the file pointer to the beginning of the file. You need to execute a call to rewind() afterward. I realize that the ftruncate page does mention this, but if anybody copies the example above (as I did), their program will not work correctly unless they fix this.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="115558""></a>
  <div class="note">
   <strong class="user">sinus-php at sinpi dot net</strong>
   <a href="#115558" class="date">15-Aug-2014 02:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
"Assigning another value to handle argument in subsequent code will release the lock."<br />
Note: this is also true for losing the handle's context completely (like returning from a function, in which the handle was a local variable).<br />
<br />
<span class="default">&lt;?php<br />
touch</span><span class="keyword">(</span><span class="string">"testfile"</span><span class="keyword">);<br />
<br />
function </span><span class="default">mylock</span><span class="keyword">() {<br />
&nbsp; </span><span class="default">$F1 </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"testfile"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />
&nbsp; if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$F1</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">)) echo </span><span class="string">"First lock OK\n"</span><span class="keyword">; else echo </span><span class="string">"First lock FAIL\n"</span><span class="keyword">;<br />
&nbsp; </span><span class="default">$F2 </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"testfile"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />
&nbsp; if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$F2</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">)) echo </span><span class="string">"Second lock OK\n"</span><span class="keyword">; else echo </span><span class="string">"Second lock FAIL\n"</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">mylock</span><span class="keyword">();<br />
echo </span><span class="string">"Function returned.\n"</span><span class="keyword">;<br />
</span><span class="default">mylock</span><span class="keyword">();<br />
<br />
</span><span class="default">unlink</span><span class="keyword">(</span><span class="string">"testfile"</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Prints out:<br />
<br />
First lock OK<br />
Second lock FAIL<br />
Function returned.<br />
First lock OK<br />
Second lock FAIL<br />
<br />
This will lock the testfile, then attempt to lock it again with a new file handle (obviously failing). Trying this again, though, results in proper locking again (and then failing again), because when exiting the function both handles are lost and automatically unlocked.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="114928""></a>
  <div class="note">
   <strong class="user">tom dot vom dot berg at online dot de</strong>
   <a href="#114928" class="date">28-Apr-2014 06:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if you are used to reply with qualified error messages by using "track_errors = 1" and $php_errormsg,&nbsp; flock() will nark you, if you use LOCK_NB .<br />
<br />
If flock() fails due to LOCK_NB $php_errormsg will not be created and filled with an error message like 'could not lock file, file already locked'.<br />
<br />
You can use some little workaround which does also on WIN:<br />
<br />
#---------------------------------<br />
GLOBAL $MYERRORMSG;<br />
<br />
function some_file_operations($filename)<br />
{<br />
&nbsp;&nbsp;&nbsp; GLOBAL $MYERRORMSG;<br />
<br />
&nbsp;&nbsp;&nbsp; # ...<br />
&nbsp;&nbsp;&nbsp; # ...<br />
<br />
&nbsp;&nbsp;&nbsp; if (! @flock($fh, LOCK_SH | LOCK_NB, $wb))<br />
&nbsp;&nbsp; &nbsp; &nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!isset($php_errormsg)) $php_errormsg = 'could not lock file, file already locked';<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $MYERRORMSG = $php_errormsg;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return false;<br />
&nbsp;&nbsp;&nbsp; }&nbsp; &nbsp; <br />
}<br />
#--------------------------------<br />
<br />
In case of fail $MYERRORMSG now will hold a qualified error message</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="114036""></a>
  <div class="note">
   <strong class="user">enyby at yandex dot ru</strong>
   <a href="#114036" class="date">04-Jan-2014 08:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Use rename or unlink on handled file breaked LOCK_EX flock on handle (Linux only).<br />
<br />
Example:<br />
<br />
$handle = fopen($lockFile, 'c');<br />
var_dump(flock($handle, LOCK_EX | LOCK_NB)); // false because flock use other php process<br />
rename($lockFile, $lockFile.'.old'); // or unlink<br />
var_dump(flock($handle, LOCK_EX | LOCK_NB)); // always true (!!!)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111984""></a>
  <div class="note">
   <strong class="user">metamarkers at gmail dot com</strong>
   <a href="#111984" class="date">19-Apr-2013 12:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
you can wrap a lock as an object to make it a scope-based lock. when the lock object is no longer referenced, like when it's unset or the owner returns, the destructor will call unlock.<br />
<br />
this way you can just create a lock object and forget about it.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">lock </span><span class="keyword">{<br />
<br />
&nbsp;&nbsp;&nbsp; private </span><span class="default">$handle</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">read </span><span class="keyword">( </span><span class="default">$handle </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lock </span><span class="keyword">= new static();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lock</span><span class="keyword">-&gt;</span><span class="default">handle </span><span class="keyword">= </span><span class="default">$handle</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_SH</span><span class="keyword">) ? </span><span class="default">$lock </span><span class="keyword">: </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">write </span><span class="keyword">( </span><span class="default">$handle </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lock </span><span class="keyword">= new static();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lock</span><span class="keyword">-&gt;</span><span class="default">handle </span><span class="keyword">= </span><span class="default">$handle</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">) ? </span><span class="default">$lock </span><span class="keyword">: </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__destruct </span><span class="keyword">( ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">handle</span><span class="keyword">,</span><span class="default">LOCK_UN</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111443""></a>
  <div class="note">
   <strong class="user">steven at aubergine-it dot nl</strong>
   <a href="#111443" class="date">20-Feb-2013 03:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You cannot combine gzopen with flock; so:<br />
<br />
<span class="default">&lt;?php<br />
$f </span><span class="keyword">= </span><span class="default">gzopen</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">,</span><span class="string">'w'</span><span class="keyword">);<br />
</span><span class="default">$o </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$o</span><span class="keyword">);<br />
</span><span class="default">flush</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span><br />
Gives:<br />
<br />
boolean false</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="109237""></a>
  <div class="note">
   <strong class="user">mdessaintes at gmail dot com</strong>
   <a href="#109237" class="date">28-Jun-2012 04:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I just spent some time (again) to understand why a reading with file_get_contents() and file was returning me an empty string "" or array() whereas the file was existing and the contents not empty.
<br />

<br />
In fact, i was locking file when writing it (file_put_contents third arg) but not testing if file was locked when reading it (and the file was accessed a lot).
<br />

<br />
So, please pay attention that file_get_contents(), file() and maybe others php files functions are going to return empty data like if the contents of the file was an empty string.
<br />

<br />
To avoid this problem, you have to set a LOCK_SH on your file before reading it (and then waiting if locked).
<br />

<br />
Something like this :
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">public static function </span><span class="default">getContents</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="default">$waitIfLocked </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; if(!</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'File "'</span><span class="keyword">.</span><span class="default">$path</span><span class="keyword">.</span><span class="string">'" does not exists'</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; else {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fo </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$locked </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">, </span><span class="default">LOCK_SH</span><span class="keyword">, </span><span class="default">$waitIfLocked</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">$locked</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$cts </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$cts</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; }
<br />
}
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Code to test by yourself :
<br />

<br />
abc.txt :
<br />
someText
<br />

<br />
file.php :
<br />
<span class="default">&lt;?php
<br />
$fo </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'abc.txt'</span><span class="keyword">, </span><span class="string">'r+'</span><span class="keyword">);
<br />

<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);
<br />
</span><span class="default">sleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">);
<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
file2.php : 
<br />
<span class="default">&lt;?php
<br />
var_dump</span><span class="keyword">(</span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">'abc.txt'</span><span class="keyword">));
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">file</span><span class="keyword">(</span><span class="string">'abc.txt'</span><span class="keyword">));
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Then launch file.php and switch to file2.php during the 10 seconds and see the difference before/after</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107939""></a>
  <div class="note">
   <strong class="user">ondrej dot nemecek at gmail dot com</strong>
   <a href="#107939" class="date">15-Mar-2012 03:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Notice: On NFS with NFS locking daemon you cannot open file for reading and than lock exklusively:<br />
<br />
$rFopened&nbsp; = fopen($sFile,'r');<br />
$bResult&nbsp;&nbsp; = flock($rFopened, LOCK_EX);<br />
<br />
var_dump($bResult); // returns FALSE<br />
<br />
Mixed fopen modes (a+, w+ ...) works with LOCK_EX fine.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105879""></a>
  <div class="note">
   <strong class="user">mdessaintes at gmail dot com</strong>
   <a href="#105879" class="date">22-Sep-2011 08:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I just spend a long time to understand why write function returns me "0", on a basic file opening and then writing.
<br />

<br />
I discovered that if you use LOCK_SH and then you write something, that will not work :
<br />

<br />
<span class="default">&lt;?php
<br />
$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.txt'</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">);
<br />

<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">LOCK_SH</span><span class="keyword">);
<br />

<br />
</span><span class="default">$written </span><span class="keyword">= </span><span class="default">fputs</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'data'</span><span class="keyword">);
<br />

<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$written</span><span class="keyword">); </span><span class="comment">// 0 and file is not changed
<br />

<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101701""></a>
  <div class="note">
   <strong class="user">Evan Battaglia</strong>
   <a href="#101701" class="date">05-Jan-2011 05:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
LOCK_NB seems to be checked and works fine in Windows, too, in PHP 5.3.3.
<br />

<br />
For instance, try concurrently running two instances of the following script (via the CLI). The second prints "Didn't quite get the lock..." as expected, whereas w/o the LOCK_NB flag, it just hangs.
<br />

<br />
<span class="default">&lt;?php
<br />
$x </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"flocktest.txt"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);
<br />
if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">)) {
<br />
&nbsp;&nbsp;&nbsp; print </span><span class="string">"No problems, I got the lock, now I'm going to sit on it."</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; while (</span><span class="default">true</span><span class="keyword">)
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">5</span><span class="keyword">);
<br />
} else {
<br />
&nbsp;&nbsp;&nbsp; print </span><span class="string">"Didn't quite get the lock. Quitting now. Good night."</span><span class="keyword">;
<br />
}
<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">);
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101226""></a>
  <div class="note">
   <strong class="user">holdoffhunger at gmail dot com</strong>
   <a href="#101226" class="date">03-Dec-2010 07:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I've been having trouble getting Flock to work when I read a file, delete it, and then output slightly changed information back to the same location.&nbsp; When deleting with Unlink, there's a very brief period of time where no file exists.&nbsp; But, if you do an fopen using the "w" mode, it keeps the file in existence, but deletes all of its data when you go to write to it.&nbsp; That way, the file never actually disappears, and another script accessing the same file with flock won't get a "file doesn't exist" error.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="100864""></a>
  <div class="note">
   <strong class="user">webmaster at bitpush dot com</strong>
   <a href="#100864" class="date">11-Nov-2010 08:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Regarding the change in PHP 5.3.2 with locked files:<br />
<br />
Without having studied the PHP source code in detail, the situation appears to be as follows when the PHP function fclose() is called:<br />
<br />
Before 5.3.2 PHP would check if the file was locked, then release the lock, and then close the file.<br />
<br />
From 5.3.2 PHP just closes the file.<br />
<br />
But note, that the operating system releases the lock automatically when the file is closed. Therefore a call to fclose() STILL releases the lock (this is tested with PHP 5.3.2, Linux, x64).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99931""></a>
  <div class="note">
   <strong class="user">mirco dot babin at gmail dot com</strong>
   <a href="#99931" class="date">15-Sep-2010 10:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Because:<br />
1) flock() is not safe if multiple php sessions are simultaneously locking.<br />
2) fopen( , 'a') is not safe if multiple php sessions are simultaneously appending.<br />
3) usleep and sleep are known for having problems.<br />
<br />
I wrote the Weblog function, it's purpose is to append a line to logging. This function handles the concurrency as follows:<br />
- Try to create a lockfile named: $directory . date('Ymd') . $logfile . 1 . lock<br />
- If this fails, try to create lockfile named: $directory . date('Ymd') . $logfile . 2 . lock<br />
- etc. After 100 tries return false.<br />
<br />
- When the lockfile is acquired the file named: $directory.date('Ymd').$logfile.1 (or .2 or .3 or .25) is opened or created.<br />
- If created the a "extended log file" header is written.<br />
- Write out the line.<br />
- Close the flie and if created set the correct access rights. (I had some problems creating files on a webserver, I did not see them when I opened a FTP session to the webdirectory. The chmod did the trick for me).<br />
<br />
- Remove the lockfile.<br />
<br />
There is only one drawback, multiple logfiles are created.<br />
e.g. (executed on 15 september 2010)<br />
&nbsp;&nbsp;&nbsp; Weblog('./' , 'visit', 'Somebody requested the index page');<br />
Could lead to 100 files, depending how many concurrent php sessions are simultaneously trying to append a logline:<br />
./20100915visit.1<br />
./20100915visit.2 <br />
./20100915visit.3<br />
./20100915visit.4<br />
...<br />
./20100915visit.100<br />
<br />
This function is donated to the public domain. Maybe you can give me some credit by leaving in the author comment, but it is not required. You may modify this as you wish.<br />
(This function was inspired by the function m_lock_file presented by Kuzma dot Deretuke at gmail dot com)<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">Weblog</span><span class="keyword">(</span><span class="default">$directory</span><span class="keyword">, </span><span class="default">$logfile</span><span class="keyword">, </span><span class="default">$message</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Created 15 september 2010: Mirco Babin<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$curtime </span><span class="keyword">= </span><span class="default">time</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$logfile </span><span class="keyword">= </span><span class="default">date</span><span class="keyword">(</span><span class="string">'Ymd'</span><span class="keyword">,</span><span class="default">$curtime</span><span class="keyword">) . </span><span class="default">$logfile</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; if (!isset(</span><span class="default">$directory</span><span class="keyword">) || </span><span class="default">$directory </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$directory </span><span class="keyword">= </span><span class="string">'./'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$directory</span><span class="keyword">,-</span><span class="default">1</span><span class="keyword">) !== </span><span class="string">'/'</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$directory </span><span class="keyword">= </span><span class="default">$directory </span><span class="keyword">. </span><span class="string">'/'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$count </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; while(</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$logfilename </span><span class="keyword">= </span><span class="default">$directory </span><span class="keyword">. </span><span class="default">$logfile </span><span class="keyword">. </span><span class="string">'.' </span><span class="keyword">. </span><span class="default">$count</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lockfile </span><span class="keyword">= </span><span class="default">$logfilename </span><span class="keyword">. </span><span class="string">'.lock'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lockhandle </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">) || @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">)) <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lockhandle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">, </span><span class="string">'xb'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$lockhandle </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">) break;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$count</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$count </span><span class="keyword">&gt; </span><span class="default">100</span><span class="keyword">) return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$created&nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$loghandle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">, </span><span class="string">'ab'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$loghandle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">, </span><span class="string">'xb'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$loghandle </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$created </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str </span><span class="keyword">= </span><span class="string">'#version: 1.0' </span><span class="keyword">. </span><span class="string">"\r\n" </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">'#Fields: date time c-ip x-msg' </span><span class="keyword">. </span><span class="string">"\r\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$loghandle</span><span class="keyword">,</span><span class="default">$str</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$loghandle </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str </span><span class="keyword">= </span><span class="default">date</span><span class="keyword">(</span><span class="string">'Y-m-d'</span><span class="keyword">,</span><span class="default">$curtime</span><span class="keyword">) . </span><span class="string">"\t" </span><span class="keyword">. <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">date</span><span class="keyword">(</span><span class="string">'H:i:s'</span><span class="keyword">, </span><span class="default">$curtime</span><span class="keyword">) .&nbsp; </span><span class="string">"\t" </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (isset(</span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REMOTE_ADDR'</span><span class="keyword">]) ? </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REMOTE_ADDR'</span><span class="keyword">] : </span><span class="string">'-'</span><span class="keyword">) . </span><span class="string">"\t" </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">'"' </span><span class="keyword">. </span><span class="default">str_replace</span><span class="keyword">(</span><span class="string">'"'</span><span class="keyword">, </span><span class="string">'""'</span><span class="keyword">, </span><span class="default">$message</span><span class="keyword">) . </span><span class="string">'"' </span><span class="keyword">. </span><span class="string">"\r\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$loghandle</span><span class="keyword">,</span><span class="default">$str</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$loghandle</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$created</span><span class="keyword">) </span><span class="default">chmod</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">,</span><span class="default">0644</span><span class="keyword">); </span><span class="comment">// Read and write for owner, read for everybody else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$lockhandle</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$result</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95257""></a>
  <div class="note">
   <strong class="user">dejangex at yahoo dot com</strong>
   <a href="#95257" class="date">21-Dec-2009 01:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Actually, there is no use of the while loop with the usleep. My testing has revealed the following:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//some code here<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">) </span><span class="comment">// &lt;- Your code will pause here untill you get the lock for indefinite amount of time or till your script times out<br />
//some code here<br />
</span><span class="default">?&gt;<br />
</span><br />
This will actually check for the lock without pausing and then it will sleep:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//code here<br />
</span><span class="keyword">while (!</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">| </span><span class="default">LOCK_NB</span><span class="keyword">)) {<br />
&nbsp;</span><span class="comment">//Lock not acquired, try again in:<br />
&nbsp;</span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">)*</span><span class="default">1000</span><span class="keyword">)) </span><span class="comment">//0-100 miliseconds<br />
</span><span class="keyword">}<br />
</span><span class="comment">//lock acquired<br />
//rest of the code<br />
</span><span class="default">?&gt;<br />
</span><br />
The problem is, if you have a busy site and a lots of locking, the while loop may not acquire the lock for some time. Locking without LOCK_NB is much more persistent and it will wait for the lock for as long as it takes. It is almose guaranteed that the file will be locked, unless the script times out or something.<br />
<br />
Consider these two scripts: 1st one is ran, and the second one is ran 5 seconds after the first.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//1st script<br />
</span><span class="default">$file_handle </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.test'</span><span class="keyword">, </span><span class="string">'r+'</span><span class="keyword">);<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">); </span><span class="comment">//lock the file<br />
</span><span class="default">sleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">); </span><span class="comment">//sleep 10 seconds<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">); </span><span class="comment">//close and unlock the file<br />
</span><span class="default">?&gt;<br />
</span><br />
<span class="default">&lt;?php<br />
</span><span class="comment">//2nd script<br />
</span><span class="default">$file_handle </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.test'</span><span class="keyword">, </span><span class="string">'r+'</span><span class="keyword">);<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">); </span><span class="comment">//lock the file<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">); </span><span class="comment">//close and unlock the file<br />
</span><span class="default">?&gt;<br />
</span><br />
If you run 1st and then the 2nd script,the 2nd script will wait untill the 1st has finished. As soon as the first script finishes, the second one will acquire the lock and finish the execution. If you use flock($file_handle, LOCK_EX | LOCK_NB) in the 2nd script while the 1st script is running, it would finish execution immediately and you would not get the lock.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93400""></a>
  <div class="note">
   <strong class="user">daniel AT brightbyte DOT de</strong>
   <a href="#93400" class="date">08-Sep-2009 12:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
flock on Solaris is slightly strange: it will fail if you try to get an exclusive lock on a file not opened for writing. That is, for reading files, you MUST use a shared lock. From the Solaris man page for flock:<br />
<br />
"Read permission is required on a file to obtain a shared lock, and write&nbsp; permission is required to obtain an exclusive lock."<br />
<br />
In contrast, this is from the Linux man page for flock:<br />
<br />
"The mode used to open the file doesn't matter to flock."<br />
<br />
So, beware...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="92731""></a>
  <div class="note">
   <strong class="user">Kuzma dot Deretuke at gmail dot com</strong>
   <a href="#92731" class="date">06-Aug-2009 04:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I use exclusive writing to replace standard flock():<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// get/set lock file name<br />
</span><span class="keyword">function </span><span class="default">m_lock_file</span><span class="keyword">( </span><span class="default">$format </span><span class="keyword">= </span><span class="default">null </span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; static </span><span class="default">$file_format </span><span class="keyword">= </span><span class="string">'./%s.lock'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$format </span><span class="keyword">!== </span><span class="default">null</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$file_format </span><span class="keyword">= </span><span class="default">$format</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$file_format</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">// acquire/check/release lock<br />
</span><span class="keyword">function </span><span class="default">m_lock</span><span class="keyword">( </span><span class="default">$lockId</span><span class="keyword">, </span><span class="default">$acquire </span><span class="keyword">= </span><span class="default">null </span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; static </span><span class="default">$handlers </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">is_bool</span><span class="keyword">(</span><span class="default">$acquire</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$file </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="default">m_lock_file</span><span class="keyword">(), </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">), </span><span class="default">$lockId</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$acquire </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (isset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; @</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">"Lock '</span><span class="default">$lockId</span><span class="string">' is already unlocked"</span><span class="keyword">, </span><span class="default">E_USER_WARNING</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$acquire </span><span class="keyword">=== </span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!isset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$handler </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$count </span><span class="keyword">= </span><span class="default">100</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; do {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">) || @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$handler </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">, </span><span class="string">"x"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">false </span><span class="keyword">=== </span><span class="default">$handler</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">10000</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">] = </span><span class="default">$handler</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } while (</span><span class="default">false </span><span class="keyword">=== </span><span class="default">$handler </span><span class="keyword">&amp;&amp; </span><span class="default">$count</span><span class="keyword">-- &gt; </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">"Lock '</span><span class="default">$lockId</span><span class="string">' is already locked"</span><span class="keyword">, </span><span class="default">E_USER_WARNING</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; return isset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">]);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Usage sample:<br />
<br />
<span class="default">&lt;?php<br />
$lockId </span><span class="keyword">= </span><span class="string">"qq"</span><span class="keyword">;<br />
<br />
</span><span class="default">m_lock</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
if (</span><span class="default">m_lock</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"locked"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// here you can perform any thread-safe operations<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">300 </span><span class="keyword">* </span><span class="default">1000</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">m_lock</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">);<br />
} else {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"not locked"</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="88907""></a>
  <div class="note">
   <strong class="user">Fernando Gabrieli fgabrieli at gmail</strong>
   <a href="#88907" class="date">12-Feb-2009 11:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When writing to a file, you should avoid using w+ because it would erase the contents of the file before locking
<br />

<br />
If you need to write the complete file again you could use the following instead:
<br />

<br />
<span class="default">&lt;?php
<br />
$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'yourfile.txt'</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">) ;
<br />

<br />
if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">) ; </span><span class="comment">// &lt;-- this will erase the contents such as 'w+'
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fputs</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'test string'</span><span class="keyword">) ;
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">) ;
<br />
}
<br />

<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">) ;
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Best,
<br />
Fernando Gabrieli</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84824""></a>
  <div class="note">
   <strong class="user">tinymountain at nospam dot gmail dot com</strong>
   <a href="#84824" class="date">31-Jul-2008 01:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here's a handy class to allow retrying a write with flock a set number of times. If it can't flock, it will sleep for a brief random interval and try again. If you have a lot of concurrent writes going on, you can use it to avoid data corruption.
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">class </span><span class="default">SafeWriter
<br />
</span><span class="keyword">{
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// suggested mode 'a' for writing to the end of the file
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public static function </span><span class="default">writeData</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$retries </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$max_retries </span><span class="keyword">= </span><span class="default">100</span><span class="keyword">;
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">$fp</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// failure
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">false</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// keep trying to get a lock as long as possible
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">do {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$retries </span><span class="keyword">&gt; </span><span class="default">0</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">, </span><span class="default">10000</span><span class="keyword">));
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$retries </span><span class="keyword">+= </span><span class="default">1</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } while (!</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">) and </span><span class="default">$retries </span><span class="keyword">&lt;= </span><span class="default">$max_retries</span><span class="keyword">);
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// couldn't get the lock, give up
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$retries </span><span class="keyword">== </span><span class="default">$max_retries</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// failure
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">false</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// got the lock, write the data
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"</span><span class="default">$data</span><span class="string">\n"</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// release the lock
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// success
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">true</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82521""></a>
  <div class="note">
   <strong class="user">John dot wellesz at teaser dot fr</strong>
   <a href="#82521" class="date">14-Apr-2008 05:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I just want to add a note about making atomic lock on NFS, there is only two<br />
ways:<br />
<br />
- 1 (the most robust but the most complicate) - It's to use link() to create a<br />
&nbsp; hard link to a file you want to lock (on the same FS of course).<br />
&nbsp; (On most NFS implementations, Link() is atomic)<br />
<br />
Once you created a hard link (not a symbolic link), with a unique randomly<br />
generated name, call stat() on it and count the number of link (nlink), if there<br />
is only 2 then the file is locked.<br />
<br />
If there is more than two you have to unlink() the link you just created and<br />
create a new one with a new unique name (else NFS will use its cache and stat<br />
will return wrong data) then call stat() on the new link and test the number of<br />
links again, repeat this operation until you get the lock.<br />
<br />
You have to use usleep() between the link() attempts with a fixed + random<br />
sleep value to avoid dead lock situations (link() and unlink() may be atomic<br />
but not instantaneous)<br />
<br />
Also note than when you unlink a file through NFS, if NFS think that the file<br />
is still in use, it will create a .nfs link to this file until it realizes the<br />
file is no longer in use... A wrong timing could generate thousands of those<br />
files and a deadlock situation.&nbsp; Because of this when a deadlock situation<br />
occurs or if your stat() command returns a very high number of links, you have<br />
to look for .nfs file in the same directory you created your links and unlink<br />
all the .nfs file you find (sometimes NFS take its time to remove them)<br />
<br />
- 2 (the simplest) - the second method is to use a lock server and lock daemons<br />
&nbsp; on each client that will forward lock request to the server... (this is more<br />
dangerous than the first method because the daemons may be killed...)<br />
<br />
Here is for reference the function I created to make atomic locks through NFS<br />
(this function is in production since at least 4 years now), it's just for<br />
reference because it uses many external functions to do its job but you can see<br />
the principle:<br />
<br />
<a href="http://pastey.net/85793" rel="nofollow" target="_blank">http://pastey.net/85793</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80006""></a>
  <div class="note">
   <strong class="user">admin ifyouwantblood de</strong>
   <a href="#80006" class="date">23-Dec-2007 07:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
besides from what the manual says about locking a file opendend in w or w+ and using a special lock file for these cases, you should simply truncate the file yourself with ftruncate() after writing:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$data</span><span class="keyword">=</span><span class="string">'some data'</span><span class="keyword">;<br />
</span><span class="default">$handle</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file'</span><span class="keyword">,</span><span class="string">'r+'</span><span class="keyword">);<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">);<br />
</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">ftell</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">));<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_UN</span><span class="keyword">);<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
now the file will have the size of $data without opening the file in w mode but with a lock on the file.<br />
<br />
to the previous writers jpriebe and mallory:<br />
of course the lock is lost in this case, but thats simply because the file is closed by PHP. and closing the file means unlocking it (same as when you use fclose() yourself).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79913""></a>
  <div class="note">
   <strong class="user">mallory dot dessaintes at gmail dot com</strong>
   <a href="#79913" class="date">19-Dec-2007 07:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have noticed that if you change the value of your fopen ressource, the lock is working no longer..<br />
<br />
<span class="default">&lt;?php<br />
<br />
$fo </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'lockfile.txt'</span><span class="keyword">,</span><span class="string">'a'</span><span class="keyword">);<br />
<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">);<br />
<br />
</span><span class="default">$fo </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
<br />
</span><span class="comment">// Lock is disable<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79668""></a>
  <div class="note">
   <strong class="user">candide at idees-et-solutions dot fr</strong>
   <a href="#79668" class="date">07-Dec-2007 03:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a comment about the last method to lock files using filemtime().<br />
What if&nbsp;&nbsp; filemtime($fp[1]) == $fp[3]&nbsp;&nbsp; because somebody modified the file less than 1s after the value of $fp[3] was picked up?<br />
Then this modification will be lost...? <br />
<br />
This system to lock files is made to prevent problems when two modifications are so close that they can interfere, so the case "less than 1s" will often happen?<br />
<br />
However, lose some modifications is better than spoil all the file...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="78320""></a>
  <div class="note">
   <strong class="user">Antti Haapala</strong>
   <a href="#78320" class="date">06-Oct-2007 04:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Further information on flock: The system is not restarted if a signal is delivered to the process, so flock will happily return false in case of SIGALRM, SIGFPE or something else.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="78318""></a>
  <div class="note">
   <strong class="user">Antti Haapala</strong>
   <a href="#78318" class="date">06-Oct-2007 03:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The supplied documentation is vague, ambiguous and lacking, and the user comments contain erroneous information! The flock function follows the semantics of the Unix system call bearing the same name. Flock utilizes ADVISORY locking only; that is, other processes may ignore the lock completely; it only affects those that call the flock call.<br />
<br />
LOCK_SH means SHARED LOCK. Any number of processes MAY HAVE A SHARED LOCK simultaneously. It is commonly called a reader lock.<br />
<br />
LOCK_EX means EXCLUSIVE LOCK. Only a single process may possess an exclusive lock to a given file at a time.<br />
<br />
If the file has been LOCKED with LOCK_SH in another process, flock with LOCK_SH will SUCCEED. flock with LOCK_EX will BLOCK UNTIL ALL READER LOCKS HAVE BEEN RELEASED.<br />
<br />
If the file has been locked with LOCK_EX in another process, the CALL WILL BLOCK UNTIL ALL OTHER LOCKS have been released.<br />
<br />
If however, you call flock on a file on which you possess the lock, it will try to change it. So: flock(LOCK_EX) followed by flock(LOCK_SH) will get you a SHARED lock, not "read-write" lock.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="74155""></a>
  <div class="note">
   <strong class="user">Will Reiher</strong>
   <a href="#74155" class="date">27-Mar-2007 04:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I've been testing a few custom file access functions but I always liked the simplicity of file_get_contents(). Of course it doesn't seem to respect any file locks created with flock(). I created the function below to wrap around file_get_contents() so it can support locked files. It's an odd way of doing it but it works for me.
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">flock_get_contents</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">){
<br />

<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$return </span><span class="keyword">= </span><span class="default">FALSE</span><span class="keyword">;
<br />

<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">is_string</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">) &amp;&amp; !empty(</span><span class="default">$filename</span><span class="keyword">)){
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">is_readable</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">)){
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$handle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">)){
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(!</span><span class="default">$return</span><span class="keyword">){
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">, </span><span class="default">LOCK_SH</span><span class="keyword">)){
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$return </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">)){
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$return</span><span class="keyword">;
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68875""></a>
  <div class="note">
   <strong class="user">jerry at gh33 dot org</strong>
   <a href="#68875" class="date">14-Aug-2006 09:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Indeed, flock() will not work reliably when the underlying filesystem is NFS. The proper way to perform file locking, in this case, would be to use PHP's link() function. From the Linux man page of open():<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; O_EXCL When used with O_CREAT, if the file&nbsp; already&nbsp; exists&nbsp; it&nbsp; is&nbsp; an<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; error&nbsp; and&nbsp; the open will fail. In this context, a symbolic link<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; exists, regardless of where its points to.&nbsp; O_EXCL is broken&nbsp; on<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; NFS file systems, programs which rely on it for performing lock-<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ing tasks will contain a race condition.&nbsp; The solution for&nbsp; per-<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; forming&nbsp; atomic&nbsp; file&nbsp; locking&nbsp; using&nbsp; a lockfile is to create a<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unique file on the same fs&nbsp; (e.g.,&nbsp; incorporating&nbsp; hostname&nbsp; and<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pid),&nbsp; use&nbsp; link(2)&nbsp; to&nbsp; make&nbsp; a link to the lockfile. If link()<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; returns 0, the lock is successful.&nbsp; Otherwise,&nbsp; use&nbsp; stat(2)&nbsp; on<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; the&nbsp; unique&nbsp; file to check if its link count has increased to 2,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; in which case the lock is also successful.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="61921""></a>
  <div class="note">
   <strong class="user">marc dot vanwoerkom at fernuni-hagen dot de</strong>
   <a href="#61921" class="date">15-Feb-2006 02:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I ran into a loop because I just checked for true (= you got the lock) as return value of flock() and tried again when I got a false.
<br />

<br />
<span class="default">&lt;?php
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">naive_wait_for_file</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while (</span><span class="default">true</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$k </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">$k </span><span class="keyword">* </span><span class="default">10000</span><span class="keyword">));&nbsp; </span><span class="comment"># k * 10ms
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}
<br />
&nbsp;&nbsp;&nbsp; }
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Unfortunately in one case the $fp I put in was invalid, so I always got false and got stuck.
<br />
Lesson: check if your $fp is valid before entering the loop, or look closer if you get a false.
<br />

<br />
<span class="default">&lt;?php
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">wait_for_file</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$fp </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while (</span><span class="default">true</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$k </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">$k </span><span class="keyword">* </span><span class="default">10000</span><span class="keyword">));&nbsp; </span><span class="comment"># k * 10ms
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}
<br />
&nbsp;&nbsp;&nbsp; }
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="55664""></a>
  <div class="note">
   <strong class="user">damasta at onwebworx dot net</strong>
   <a href="#55664" class="date">09-Aug-2005 08:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
just wanted to say that you will most likely fail if you use a separate lock file together with register_shutdown_function.<br />
<br />
my script did some different actions... resizing pictures, rotating them and this stuff. it needed a "database" file to get the correct file locations. this database file also stored some flags. and of course the script had to save that file when it was done.<br />
<br />
because of my script exited on many different points depending on the action i used register_shutdown_function to save the file. it wanted to use a locking system to be sure the script doesn't overwrite the data another process had written into it some microseconds before. i was running on windows 2000 and apache2 on my developing machine, and flock always returned true for some reason... so i used a separate lock file. the script looked for it at the beginning and exited if it was found. otherwise it created it. but this file had to be deleted at the end. i put the unlink command into the registered shutdown-function but it never deleted the file. i tried clearstatcache and some other stuff but it didn't help.<br />
<br />
maybe this helps someone.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="45464""></a>
  <div class="note">
   <strong class="user">rudy dot metzger at pareto dot nl</strong>
   <a href="#45464" class="date">08-Sep-2004 03:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Like a user already noted, most Linux kernels (at least the Redhat ones) will return false, even if you locked the file. This is because the lock is only ADVISORY (you can check that in /proc/locks). What you have to do there is to evalute the 3rd parameter of flock(), $eWouldBlock. See for an example below. Note however that if you<br />
lock the file in non blocking mode, flock() will work as expected (and blocks the script).<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">( </span><span class="string">"/var/lock/process.pid"</span><span class="keyword">, </span><span class="string">"a" </span><span class="keyword">);<br />
if ( !</span><span class="default">$fp </span><span class="keyword">|| !</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">,</span><span class="default">$eWouldBlock</span><span class="keyword">) || </span><span class="default">$eWouldBlock </span><span class="keyword">) {<br />
&nbsp; </span><span class="default">fputs</span><span class="keyword">( </span><span class="default">STDERR</span><span class="keyword">, </span><span class="string">"Failed to acquire lock!\n" </span><span class="keyword">);<br />
&nbsp; exit;<br />
}<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="comment">// do your work here<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$fp </span><span class="keyword">);<br />
</span><span class="default">unlink</span><span class="keyword">( </span><span class="string">"/var/lock/process.pid" </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="43705""></a>
  <div class="note">
   <strong class="user">Joby &lt;god at NOSPAMPLEASE dot greentinted dot net&gt;</strong>
   <a href="#43705" class="date">30-Jun-2004 05:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I'm thinking that a good way to ensure that no data is lost would be to create a buffer directory that could store the instructions for what is to be written to a file, then whenever the file is decidedly unlocked, a single execution could loop through every file in that directory and apply the indicated changes to the file.<br />
<br />
I'm working on writing this for a flat-file based database.&nbsp; The way it works is, whenever a command is issued (addline, removeline, editline), the command is stored in a flat file stored in a folder named a shortened version of the filename to be edited and named by the time and a random number.&nbsp; In that file is a standardized set of commands that define what is to be done to what file (the likes of "file: SecuraLog/index_uid" new line "editline: 14").<br />
<br />
Each execution will check every folder in that directory for files and a certain amount of time (I don't know how long, maybe 1-2 seconds) is spent making pending changes to unlocked files.&nbsp; This way no changes will be lost (i.e. person 1 makes a change at the same time as person 2, and person 1 loses the race by just enough to have their changed version of the file overwritten by person 2's version) and there will be no problems with opening an empty open file.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="39466""></a>
  <div class="note">
   <strong class="user">Glip</strong>
   <a href="#39466" class="date">29-Jan-2004 10:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you don't want use secondary lock file while truncating, try this:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/tmp/lock.txt"</span><span class="keyword">, </span><span class="string">"a+"</span><span class="keyword">);<br />
<br />
if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) { </span><span class="comment">// do an exclusive lock<br />
&nbsp;&nbsp; </span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"Write something here\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">); </span><span class="comment">// release the lock<br />
</span><span class="keyword">} else {<br />
&nbsp;&nbsp; echo </span><span class="string">"Couldn't lock the file !"</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="32443""></a>
  <div class="note">
   <strong class="user">joel[at_sign]purerave.com</strong>
   <a href="#32443" class="date">27-May-2003 06:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have found that if you open a currently locked file with 'w' or 'w+' ("file pointer at the beginning of the file and truncate the file to zero length")&nbsp; then it will not truncate the file when the lock is released and the file available.
<br />

<br />
Example I used to test it:
<br />
<span class="default">&lt;?php
<br />
</span><span class="comment">// a.php
<br />
</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">( </span><span class="string">"/tmp/lock.txt"</span><span class="keyword">, </span><span class="string">"w+" </span><span class="keyword">);
<br />
</span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">); </span><span class="comment">// exclusive lock
<br />

<br />
</span><span class="default">$steps </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">;
<br />
</span><span class="comment">// write to the file
<br />
</span><span class="keyword">for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt; </span><span class="default">$steps</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'a '</span><span class="keyword">.</span><span class="default">time</span><span class="keyword">().</span><span class="string">' test '</span><span class="keyword">. </span><span class="default">$i</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);
<br />
}
<br />
</span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN </span><span class="keyword">); </span><span class="comment">// release the lock
<br />
</span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$fp </span><span class="keyword">);
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
----------
<br />
<span class="default">&lt;?php
<br />
</span><span class="comment">// b.php
<br />

<br />
</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">( </span><span class="string">"/tmp/lock.txt"</span><span class="keyword">, </span><span class="string">"w+" </span><span class="keyword">);
<br />
</span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">); </span><span class="comment">// exclusive lock
<br />

<br />
// ftruncate($fp, 0) is needed here! &lt;----
<br />

<br />
</span><span class="default">$steps </span><span class="keyword">= </span><span class="default">5</span><span class="keyword">;
<br />
</span><span class="comment">// write to the file
<br />
</span><span class="keyword">for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt; </span><span class="default">$steps</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'b '</span><span class="keyword">.</span><span class="default">time</span><span class="keyword">().</span><span class="string">' test '</span><span class="keyword">. </span><span class="default">$i</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);
<br />
}
<br />
</span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN </span><span class="keyword">); </span><span class="comment">// release the lock
<br />
</span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$fp </span><span class="keyword">);
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Loading a.php then loading b.php right after will result in:
<br />
b 1054075769 test 0
<br />
b 1054075770 test 1
<br />
b 1054075771 test 2
<br />
b 1054075772 test 3
<br />
b 1054075773 test 4
<br />
a 1054075764 test 5
<br />
a 1054075765 test 6
<br />
a 1054075766 test 7
<br />
a 1054075767 test 8
<br />
a 1054075768 test 9
<br />

<br />
As you can see, b.php does not truncate the file as the w+ would suggest if the file were instantly available. But only moves the pointer to the begining of the file. If b.php was loaded after a.php finished then there would be no "a ..." lines in the file, since it would be truncated.
<br />

<br />
To fix this you have to add ftruncate($fp, 0) right after the flock.
<br />

<br />
'r+' and 'a' seem to work fine, though.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="24100""></a>
  <div class="note">
   <strong class="user">geoff at message dot hu</strong>
   <a href="#24100" class="date">06-Aug-2002 01:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You should lock the file _before_ opening it, and unlock _after_ closing it. Othervise an another process might be able to access the file between the lock/unlock and the open/close operation.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
