<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>创建一个套接字（通讯节点）</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.socket-create-pair.html">? socket_create_pair</a></li>
      <li style="float: right;"><a href="function.socket-export-stream.html">socket_export_stream ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.sockets.html">Socket 函数</a></li>
    <li>创建一个套接字（通讯节点）</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.socket-create" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">socket_create</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.1.0, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">socket_create</span> &mdash; <span class="dc-title">创建一个套接字（通讯节点）</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.socket-create-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>socket_create</strong></span>(<span class="methodparam"><span class="type">int</span> <code class="parameter">$domain</code></span>, <span class="methodparam"><span class="type">int</span> <code class="parameter">$type</code></span>, <span class="methodparam"><span class="type">int</span> <code class="parameter">$protocol</code></span>): <span class="type"><span class="type"><a href="class.socket.html" class="type Socket">Socket</a></span>|<span class="type"><span class="type false">false</span></span></span></div>

  <p class="para rdfs-comment">
   创建并返回一个 <span class="classname"><a href="class.socket.html" class="classname">Socket</a></span> 实例，也称作一个通讯节点。一个典型的网络连接由 2 个套接字构成，一个运行在客户端，另一个运行在服务器端。
  </p>
 </div>

 
 <div class="refsect1 parameters" id="refsect1-function.socket-create-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">domain</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">domain</code> 参数指定哪个协议用在当前套接字上。
      </p>
      <table class="doctable table">
       <caption><strong>可用的地址/协议</strong></caption>
       
        <thead>
         <tr>
          <th>Domain</th>
          <th>描述</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td><strong><code>AF_INET</code></strong></td>
          <td>
           IPv4 网络协议。TCP 和 UDP 都可使用此协议。
          </td>
         </tr>

         <tr>
          <td><strong><code>AF_INET6</code></strong></td>
          <td>
           IPv6 网络协议。TCP 和 UDP 都可使用此协议。
          </td>
         </tr>

         <tr>
          <td><strong><code>AF_UNIX</code></strong></td>
          <td>
           本地通讯协议。具有高性能和低成本的 IPC（进程间通讯）。
          </td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    
    
     <dt>
<code class="parameter">type</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">type</code> 参数用于选择套接字使用的类型。
      </p>
      <table class="doctable table">
       <caption><strong>可用的套接字类型</strong></caption>
       
        <thead>
         <tr>
          <th>类型</th>
          <th>描述</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td><strong><code>SOCK_STREAM</code></strong></td>
          <td>
           提供一个顺序化的、可靠的、全双工的、基于连接的字节流。支持数据传送流量控制机制。TCP 协议即基于这种流式套接字。
          </td>
         </tr>

         <tr>
          <td><strong><code>SOCK_DGRAM</code></strong></td>
          <td>
           提供数据报文的支持。(无连接，不可靠、固定最大长度).UDP协议即基于这种数据报文套接字。
          </td>
         </tr>

         <tr>
          <td><strong><code>SOCK_SEQPACKET</code></strong></td>
          <td>
           提供一个顺序化的、可靠的、全双工的、面向连接的、固定最大长度的数据通信；数据端通过接收每一个数据段来读取整个数据包。
          </td>
         </tr>

         <tr>
          <td><strong><code>SOCK_RAW</code></strong></td>
          <td>
           提供读取原始的网络协议。这种特殊的套接字可用于手工构建任意类型的协议。一般使用这个套接字来实现 ICMP 请求（例如 ping）。
          </td>
         </tr>

         <tr>
          <td><strong><code>SOCK_RDM</code></strong></td>
          <td>
           提供一个可靠的数据层，但不保证到达顺序。一般的操作系统都未实现此功能。
          </td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    
    
     <dt>
<code class="parameter">protocol</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">protocol</code> 参数，是设置指定 <code class="parameter">domain</code> 
       套接字下的具体协议。这个值可以使用 <span class="function"><a href="function.getprotobyname.html" class="function">getprotobyname()</a></span>
       函数进行读取。如果所需的协议是 TCP 或 UDP，可以直接使用常量 <strong><code>SOL_TCP</code></strong> 和 <strong><code>SOL_UDP</code></strong> 。
      </p>
      <table class="doctable table">
       <caption><strong>常见协议</strong></caption>
       
        <thead>
         <tr>
          <th>名称</th>
          <th>描述</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td>icmp</td>
          <td>
           Internet Control Message Protocol
           主要用于网关和主机报告错误的数据通信。例如"ping"命令（在目前大部分的操作系统中）就是使用 ICMP 协议实现的。
          </td>
         </tr>

         <tr>
          <td>udp</td>
          <td>
           User Datagram Protocol 是一个无连接的、不可靠的、具有固定最大长度的报文协议。由于这些特性，UDP 协议拥有最小的协议开销。
          </td>
         </tr>

         <tr>
          <td>tcp</td>
          <td>
           Transmission Control Protocol 是一个可靠的、基于连接的、面向数据流的全双工协议。TCP
           能够保障所有的数据包是按照其发送顺序而接收的。如果任意数据包在通讯时丢失，TCP
           将自动重发数据包直到目标主机应答已接收。因为可靠性和性能的原因，TCP 在数据传输层使用 8bit 字节边界。因此，TCP 应用程序必须允许传送部分报文的可能。
          </td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    
   </dl>

  </p>
 </div>

 
 <div class="refsect1 returnvalues" id="refsect1-function.socket-create-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   <span class="function"><strong>socket_create()</strong></span> 正确时返回一个 <span class="classname"><a href="class.socket.html" class="classname">Socket</a></span> 实例，失败时返回
   <strong><code>false</code></strong>。要读取错误代码，可以调用 <span class="function"><a href="function.socket-last-error.html" class="function">socket_last_error()</a></span>。这个错误代码可以通过 <span class="function"><a href="function.socket-strerror.html" class="function">socket_strerror()</a></span> 读取文字的错误说明。
  </p>
 </div>


 <div class="refsect1 errors" id="refsect1-function.socket-create-errors">
  <h3 class="title">错误／异常</h3>
  <p class="para">
   如果使用一个无效的 <code class="parameter">domain</code> 或 <code class="parameter">type</code>，<span class="function"><strong>socket_create()</strong></span>
   会使用 <strong><code>AF_INET</code></strong> 和
   <strong><code>SOCK_STREAM</code></strong> 替代无效参数，同时会发出 <strong><code>E_WARNING</code></strong> 警告信息。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.socket-create-changelog">
  <h3 class="title">更新日志</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>版本</th>
       <th>说明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>5.0.0</td>
       <td>
        增加 <strong><code>AF_INET6</code></strong> 支持。
       </td>
      </tr>

      <tr>
       <td>8.0.0</td>
       <td>
        创建成功时，该函数现在返回一个 <span class="classname"><a href="class.socket.html" class="classname">Socket</a></span> 实例；
        在此之前，返回的是一个 <span class="type">resource</span>。
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.socket-create-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.socket-accept.html" class="function" rel="rdfs-seeAlso">socket_accept()</a> - Accepts a connection on a socket</span></li>
    <li class="member"><span class="function"><a href="function.socket-bind.html" class="function" rel="rdfs-seeAlso">socket_bind()</a> - 给套接字绑定名字</span></li>
    <li class="member"><span class="function"><a href="function.socket-connect.html" class="function" rel="rdfs-seeAlso">socket_connect()</a> - 开启一个套接字连接</span></li>
    <li class="member"><span class="function"><a href="function.socket-listen.html" class="function" rel="rdfs-seeAlso">socket_listen()</a> - Listens for a connection on a socket</span></li>
    <li class="member"><span class="function"><a href="function.socket-last-error.html" class="function" rel="rdfs-seeAlso">socket_last_error()</a> - Returns the last error on the socket</span></li>
    <li class="member"><span class="function"><a href="function.socket-strerror.html" class="function" rel="rdfs-seeAlso">socket_strerror()</a> - Return a string describing a socket error</span></li>
   </ul>
  </p>
 </div>

 
</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="120174""></a>
  <div class="note">
   <strong class="user">Sakrizz</strong>
   <a href="#120174" class="date">16-Nov-2016 10:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here's a solution for icmpv6 ping with php, dropping it here in case if someone has problems with icmpv6 with php.<br />
<br />
<span class="default">&lt;?php<br />
$host </span><span class="keyword">= </span><span class="string">"2a03:2880:f11b:83:face:b00c:0:25de"</span><span class="keyword">;<br />
</span><span class="default">$timeout </span><span class="keyword">= </span><span class="default">100000</span><span class="keyword">;<br />
</span><span class="default">$count </span><span class="keyword">= </span><span class="default">3</span><span class="keyword">;<br />
echo </span><span class="string">"Latency: "</span><span class="keyword">. </span><span class="default">round</span><span class="keyword">(</span><span class="default">1000 </span><span class="keyword">* </span><span class="default">pingv6</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">,</span><span class="default">$timeout</span><span class="keyword">,</span><span class="default">$count</span><span class="keyword">),</span><span class="default">5</span><span class="keyword">) .</span><span class="string">" ms \n"</span><span class="keyword">;<br />
<br />
function </span><span class="default">pingv6</span><span class="keyword">(</span><span class="default">$target</span><span class="keyword">,</span><span class="default">$timeout</span><span class="keyword">,</span><span class="default">$count</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"target is ipv6 address, "</span><span class="keyword">. </span><span class="default">getprotobyname</span><span class="keyword">(</span><span class="string">'ipv6-icmp'</span><span class="keyword">). </span><span class="string">" \n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* create the socket, the last '1' denotes ICMP */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET6</span><span class="keyword">, </span><span class="default">SOCK_RAW</span><span class="keyword">, </span><span class="default">getprotobyname</span><span class="keyword">(</span><span class="string">'ipv6-icmp'</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* set socket receive timeout to 1 second */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sec</span><span class="keyword">=</span><span class="default">intval</span><span class="keyword">(</span><span class="default">$timeout</span><span class="keyword">/</span><span class="default">1000</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$usec</span><span class="keyword">=</span><span class="default">$timeout</span><span class="keyword">%</span><span class="default">1000</span><span class="keyword">*</span><span class="default">1000</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">SOL_SOCKET</span><span class="keyword">, </span><span class="default">SO_RCVTIMEO</span><span class="keyword">, array(</span><span class="string">"sec"</span><span class="keyword">=&gt;</span><span class="default">$sec</span><span class="keyword">, </span><span class="string">"usec"</span><span class="keyword">=&gt;</span><span class="default">$usec</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* socket package parameters */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$type </span><span class="keyword">= </span><span class="string">"\x80"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$seqNumber </span><span class="keyword">= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">floor</span><span class="keyword">(</span><span class="default">$i</span><span class="keyword">/</span><span class="default">256</span><span class="keyword">)%</span><span class="default">256</span><span class="keyword">) . </span><span class="default">chr</span><span class="keyword">(</span><span class="default">$i</span><span class="keyword">%</span><span class="default">256</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$checksum</span><span class="keyword">= </span><span class="string">"\x00\x00"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$code </span><span class="keyword">= </span><span class="string">"\x00"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$identifier </span><span class="keyword">= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,</span><span class="default">255</span><span class="keyword">)) . </span><span class="default">chr</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,</span><span class="default">255</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$msg </span><span class="keyword">= </span><span class="string">"!\"#$%&amp;'()*+,-./1234567"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$package </span><span class="keyword">= </span><span class="default">$type</span><span class="keyword">.</span><span class="default">$code</span><span class="keyword">.</span><span class="default">$checksum</span><span class="keyword">.</span><span class="default">$identifier</span><span class="keyword">.</span><span class="default">$seqNumber</span><span class="keyword">.</span><span class="default">$msg</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$checksum </span><span class="keyword">= </span><span class="default">icmpChecksum</span><span class="keyword">(</span><span class="default">$package</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$package </span><span class="keyword">= </span><span class="default">$type</span><span class="keyword">.</span><span class="default">$code</span><span class="keyword">.</span><span class="default">$checksum</span><span class="keyword">.</span><span class="default">$identifier</span><span class="keyword">.</span><span class="default">$seqNumber</span><span class="keyword">.</span><span class="default">$msg</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* socket connect */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(@</span><span class="default">socket_connect</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$target</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$count</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; list(</span><span class="default">$start_usec</span><span class="keyword">, </span><span class="default">$start_sec</span><span class="keyword">) = </span><span class="default">explode</span><span class="keyword">(</span><span class="string">" "</span><span class="keyword">, </span><span class="default">microtime</span><span class="keyword">());<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$start_time </span><span class="keyword">= ((float) </span><span class="default">$start_usec </span><span class="keyword">+ (float) </span><span class="default">$start_sec</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$startTime </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_send</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$package</span><span class="keyword">, </span><span class="default">strLen</span><span class="keyword">(</span><span class="default">$package</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while (</span><span class="default">$startTime </span><span class="keyword">+ </span><span class="default">$timeout</span><span class="keyword">*</span><span class="default">1000 </span><span class="keyword">&gt; </span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">) !== </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; list(</span><span class="default">$end_usec</span><span class="keyword">, </span><span class="default">$end_sec</span><span class="keyword">) = </span><span class="default">explode</span><span class="keyword">(</span><span class="string">" "</span><span class="keyword">, </span><span class="default">microtime</span><span class="keyword">());<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$end_time </span><span class="keyword">= ((float) </span><span class="default">$end_usec </span><span class="keyword">+ (float) </span><span class="default">$end_sec</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$total_time </span><span class="keyword">= </span><span class="default">$end_time </span><span class="keyword">- </span><span class="default">$start_time</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"round trip time ("</span><span class="keyword">.</span><span class="default">$i</span><span class="keyword">.</span><span class="string">"): "</span><span class="keyword">. </span><span class="default">$total_time </span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$total_time</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="string">"null"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Timed out ("</span><span class="keyword">.</span><span class="default">$i</span><span class="keyword">.</span><span class="string">"), Got no echo reply\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">$interval</span><span class="keyword">*</span><span class="default">1000</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
function </span><span class="default">icmpChecksum</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">){<br />
if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">)%</span><span class="default">2</span><span class="keyword">) </span><span class="default">$data </span><span class="keyword">.= </span><span class="string">"\x00"</span><span class="keyword">;<br />
</span><span class="default">$bit </span><span class="keyword">= </span><span class="default">unpack</span><span class="keyword">(</span><span class="string">'n*'</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">$sum </span><span class="keyword">= </span><span class="default">array_sum</span><span class="keyword">(</span><span class="default">$bit</span><span class="keyword">);<br />
while (</span><span class="default">$sum </span><span class="keyword">&gt;&gt; </span><span class="default">16</span><span class="keyword">)<br />
&nbsp; </span><span class="default">$sum </span><span class="keyword">= (</span><span class="default">$sum </span><span class="keyword">&gt;&gt; </span><span class="default">16</span><span class="keyword">) + (</span><span class="default">$sum </span><span class="keyword">&amp; </span><span class="default">0xffff</span><span class="keyword">);<br />
return </span><span class="default">pack</span><span class="keyword">(</span><span class="string">'n*'</span><span class="keyword">, ~</span><span class="default">$sum</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="108535""></a>
  <div class="note">
   <strong class="user">ab1965 at yandex dot ru</strong>
   <a href="#108535" class="date">04-May-2012 12:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It took some time to understand how one PHP process can communicate with another by means of unix udp sockets. Examples of 'server' and 'client' code are given below. Server is assumed to run before client starts.<br />
<br />
'Server' code<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">if (!</span><span class="default">extension_loaded</span><span class="keyword">(</span><span class="string">'sockets'</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; die(</span><span class="string">'The sockets extension is not loaded.'</span><span class="keyword">);<br />
}<br />
</span><span class="comment">// create unix udp socket<br />
</span><span class="default">$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_UNIX</span><span class="keyword">, </span><span class="default">SOCK_DGRAM</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
if (!</span><span class="default">$socket</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to create AF_UNIX socket'</span><span class="keyword">);<br />
<br />
</span><span class="comment">// same socket will be used in recv_from and send_to<br />
</span><span class="default">$server_side_sock </span><span class="keyword">= </span><span class="default">dirname</span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">).</span><span class="string">"/server.sock"</span><span class="keyword">;<br />
if (!</span><span class="default">socket_bind</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$server_side_sock</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">"Unable to bind to </span><span class="default">$server_side_sock</span><span class="string">"</span><span class="keyword">);<br />
<br />
while(</span><span class="default">1</span><span class="keyword">) </span><span class="comment">// server never exits<br />
</span><span class="keyword">{<br />
</span><span class="comment">// receive query<br />
</span><span class="keyword">if (!</span><span class="default">socket_set_block</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to set blocking mode for socket'</span><span class="keyword">);<br />
</span><span class="default">$buf </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
</span><span class="default">$from </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
echo </span><span class="string">"Ready to receive...\n"</span><span class="keyword">;<br />
</span><span class="comment">// will block to wait client query<br />
</span><span class="default">$bytes_received </span><span class="keyword">= </span><span class="default">socket_recvfrom</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$buf</span><span class="keyword">, </span><span class="default">65536</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$from</span><span class="keyword">);<br />
if (</span><span class="default">$bytes_received </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'An error occured while receiving from the socket'</span><span class="keyword">);<br />
echo </span><span class="string">"Received </span><span class="default">$buf</span><span class="string"> from </span><span class="default">$from</span><span class="string">\n"</span><span class="keyword">;<br />
<br />
</span><span class="default">$buf </span><span class="keyword">.= </span><span class="string">"-&gt;Response"</span><span class="keyword">; </span><span class="comment">// process client query here<br />
<br />
// send response<br />
</span><span class="keyword">if (!</span><span class="default">socket_set_nonblock</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to set nonblocking mode for socket'</span><span class="keyword">);<br />
</span><span class="comment">// client side socket filename is known from client request: $from<br />
</span><span class="default">$len </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$buf</span><span class="keyword">);<br />
</span><span class="default">$bytes_sent </span><span class="keyword">= </span><span class="default">socket_sendto</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$buf</span><span class="keyword">, </span><span class="default">$len</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$from</span><span class="keyword">);<br />
if (</span><span class="default">$bytes_sent </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'An error occured while sending to the socket'</span><span class="keyword">);<br />
else if (</span><span class="default">$bytes_sent </span><span class="keyword">!= </span><span class="default">$len</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="default">$bytes_sent </span><span class="keyword">. </span><span class="string">' bytes have been sent instead of the ' </span><span class="keyword">. </span><span class="default">$len </span><span class="keyword">. </span><span class="string">' bytes expected'</span><span class="keyword">);<br />
echo </span><span class="string">"Request processed\n"</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
'Client' code<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">if (!</span><span class="default">extension_loaded</span><span class="keyword">(</span><span class="string">'sockets'</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; die(</span><span class="string">'The sockets extension is not loaded.'</span><span class="keyword">);<br />
}<br />
</span><span class="comment">// create unix udp socket<br />
</span><span class="default">$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_UNIX</span><span class="keyword">, </span><span class="default">SOCK_DGRAM</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
if (!</span><span class="default">$socket</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to create AF_UNIX socket'</span><span class="keyword">);<br />
<br />
</span><span class="comment">// same socket will be later used in recv_from<br />
// no binding is required if you wish only send and never receive<br />
</span><span class="default">$client_side_sock </span><span class="keyword">= </span><span class="default">dirname</span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">).</span><span class="string">"/client.sock"</span><span class="keyword">;<br />
if (!</span><span class="default">socket_bind</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$client_side_sock</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">"Unable to bind to </span><span class="default">$client_side_sock</span><span class="string">"</span><span class="keyword">);<br />
<br />
</span><span class="comment">// use socket to send data<br />
</span><span class="keyword">if (!</span><span class="default">socket_set_nonblock</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to set nonblocking mode for socket'</span><span class="keyword">);<br />
</span><span class="comment">// server side socket filename is known apriori<br />
</span><span class="default">$server_side_sock </span><span class="keyword">= </span><span class="default">dirname</span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">).</span><span class="string">"/server.sock"</span><span class="keyword">;<br />
</span><span class="default">$msg </span><span class="keyword">= </span><span class="string">"Message"</span><span class="keyword">;<br />
</span><span class="default">$len </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$msg</span><span class="keyword">);<br />
</span><span class="comment">// at this point 'server' process must be running and bound to receive from serv.sock<br />
</span><span class="default">$bytes_sent </span><span class="keyword">= </span><span class="default">socket_sendto</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$msg</span><span class="keyword">, </span><span class="default">$len</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$server_side_sock</span><span class="keyword">);<br />
if (</span><span class="default">$bytes_sent </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'An error occured while sending to the socket'</span><span class="keyword">);<br />
else if (</span><span class="default">$bytes_sent </span><span class="keyword">!= </span><span class="default">$len</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="default">$bytes_sent </span><span class="keyword">. </span><span class="string">' bytes have been sent instead of the ' </span><span class="keyword">. </span><span class="default">$len </span><span class="keyword">. </span><span class="string">' bytes expected'</span><span class="keyword">);<br />
<br />
</span><span class="comment">// use socket to receive data<br />
</span><span class="keyword">if (!</span><span class="default">socket_set_block</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to set blocking mode for socket'</span><span class="keyword">);<br />
</span><span class="default">$buf </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
</span><span class="default">$from </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
</span><span class="comment">// will block to wait server response<br />
</span><span class="default">$bytes_received </span><span class="keyword">= </span><span class="default">socket_recvfrom</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$buf</span><span class="keyword">, </span><span class="default">65536</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$from</span><span class="keyword">);<br />
if (</span><span class="default">$bytes_received </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'An error occured while receiving from the socket'</span><span class="keyword">);<br />
echo </span><span class="string">"Received </span><span class="default">$buf</span><span class="string"> from </span><span class="default">$from</span><span class="string">\n"</span><span class="keyword">;<br />
<br />
</span><span class="comment">// close socket and delete own .sock file<br />
</span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$client_side_sock</span><span class="keyword">);<br />
echo </span><span class="string">"Client exits\n"</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101012""></a>
  <div class="note">
   <strong class="user">geoff at spacevs dot com</strong>
   <a href="#101012" class="date">20-Nov-2010 01:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is a ping function for PHP without using exec/system/passthrough/etc... Very useful to use to just test if a host is online before attempting to connect to it. Timeout is in seconds.<br />
<br />
<span class="default">&lt;?PHP<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">ping</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$timeout </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">/* ICMP ping packet with a pre-calculated checksum */<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$package </span><span class="keyword">= </span><span class="string">"\x08\x00\x7d\x4b\x00\x00\x00\x00PingHost"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$socket&nbsp; </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_RAW</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">SOL_SOCKET</span><span class="keyword">, </span><span class="default">SO_RCVTIMEO</span><span class="keyword">, array(</span><span class="string">'sec' </span><span class="keyword">=&gt; </span><span class="default">$timeout</span><span class="keyword">, </span><span class="string">'usec' </span><span class="keyword">=&gt; </span><span class="default">0</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_connect</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ts </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_send</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$package</span><span class="keyword">, </span><span class="default">strLen</span><span class="keyword">(</span><span class="default">$package</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">) - </span><span class="default">$ts</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else&nbsp; &nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$result</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93415""></a>
  <div class="note">
   <strong class="user">rhollencamp at gmail dot com</strong>
   <a href="#93415" class="date">08-Sep-2009 09:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that if you create a socket with AF_UNIX, a file will be created in the filesystem. This file is not removed when you call socket_close - you should unlink the file after you close the socket.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="81938""></a>
  <div class="note">
   <strong class="user">alexander dot krause at ed-solutions dot de</strong>
   <a href="#81938" class="date">20-Mar-2008 12:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
On UNIX systems php needs /etc/protocols for constants like SOL_UDP and SOL_TCP.<br />
<br />
This file was missing on my embedded platform.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80775""></a>
  <div class="note">
   <strong class="user">Jean Charles MAMMANA</strong>
   <a href="#80775" class="date">31-Jan-2008 04:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I've written the ping() function using socket_create() with SOCK_RAW.<br />
(on Unix System, you need to have the root acces to execute this function)<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">/// start ping.inc.php ///<br />
<br />
</span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"No Error"</span><span class="keyword">;<br />
<br />
</span><span class="comment">// timeout in ms<br />
</span><span class="keyword">function </span><span class="default">ping</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$timeout</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$port </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$datasize </span><span class="keyword">= </span><span class="default">64</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; global </span><span class="default">$g_icmp_error</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"No Error"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ident </span><span class="keyword">= array(</span><span class="default">ord</span><span class="keyword">(</span><span class="string">'J'</span><span class="keyword">), </span><span class="default">ord</span><span class="keyword">(</span><span class="string">'C'</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$seq&nbsp;&nbsp; </span><span class="keyword">= array(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">), </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$packet </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">8</span><span class="keyword">); </span><span class="comment">// type = 8 : request<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">); </span><span class="comment">// code = 0<br />
<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">); </span><span class="comment">// checksum init<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">); </span><span class="comment">// checksum init<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">$ident</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]); </span><span class="comment">// identifier<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">$ident</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]); </span><span class="comment">// identifier<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">$seq</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]); </span><span class="comment">// seq<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">$seq</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]); </span><span class="comment">// seq<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$datasize</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$chk </span><span class="keyword">= </span><span class="default">icmpChecksum</span><span class="keyword">(</span><span class="default">$packet</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] = </span><span class="default">$chk</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// checksum init<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">] = </span><span class="default">$chk</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]; </span><span class="comment">// checksum init<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sock </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_RAW</span><span class="keyword">,&nbsp; </span><span class="default">getprotobyname</span><span class="keyword">(</span><span class="string">'icmp'</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$time_start </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_sendto</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="default">$packet</span><span class="keyword">, </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$packet</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$read&nbsp;&nbsp; </span><span class="keyword">= array(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$write&nbsp; </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$except </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$select </span><span class="keyword">= </span><span class="default">socket_select</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">, </span><span class="default">$write</span><span class="keyword">, </span><span class="default">$except</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$timeout </span><span class="keyword">* </span><span class="default">1000</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$select </span><span class="keyword">=== </span><span class="default">NULL</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Select Error"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; elseif (</span><span class="default">$select </span><span class="keyword">=== </span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Timeout"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$recv </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$time_stop </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_recvfrom</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="default">$recv</span><span class="keyword">, </span><span class="default">65535</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$recv </span><span class="keyword">= </span><span class="default">unpack</span><span class="keyword">(</span><span class="string">'C*'</span><span class="keyword">, </span><span class="default">$recv</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$recv</span><span class="keyword">[</span><span class="default">10</span><span class="keyword">] !== </span><span class="default">1</span><span class="keyword">) </span><span class="comment">// ICMP proto = 1<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Not ICMP packet"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$recv</span><span class="keyword">[</span><span class="default">21</span><span class="keyword">] !== </span><span class="default">0</span><span class="keyword">) </span><span class="comment">// ICMP response = 0<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Not ICMP response"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$ident</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] !== </span><span class="default">$recv</span><span class="keyword">[</span><span class="default">25</span><span class="keyword">] || </span><span class="default">$ident</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] !== </span><span class="default">$recv</span><span class="keyword">[</span><span class="default">26</span><span class="keyword">])<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Bad identification number"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$seq</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] !== </span><span class="default">$recv</span><span class="keyword">[</span><span class="default">27</span><span class="keyword">] || </span><span class="default">$seq</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] !== </span><span class="default">$recv</span><span class="keyword">[</span><span class="default">28</span><span class="keyword">])<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Bad sequence number"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ms </span><span class="keyword">= (</span><span class="default">$time_stop </span><span class="keyword">- </span><span class="default">$time_start</span><span class="keyword">) * </span><span class="default">1000</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$ms </span><span class="keyword">&lt; </span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Response too long"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ms </span><span class="keyword">= -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$ms</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">icmpChecksum</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bit </span><span class="keyword">= </span><span class="default">unpack</span><span class="keyword">(</span><span class="string">'n*'</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sum </span><span class="keyword">= </span><span class="default">array_sum</span><span class="keyword">(</span><span class="default">$bit</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">) % </span><span class="default">2</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$temp </span><span class="keyword">= </span><span class="default">unpack</span><span class="keyword">(</span><span class="string">'C*'</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">[</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">) - </span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sum </span><span class="keyword">+= </span><span class="default">$temp</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sum </span><span class="keyword">= (</span><span class="default">$sum </span><span class="keyword">&gt;&gt; </span><span class="default">16</span><span class="keyword">) + (</span><span class="default">$sum </span><span class="keyword">&amp; </span><span class="default">0xffff</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sum </span><span class="keyword">+= (</span><span class="default">$sum </span><span class="keyword">&gt;&gt; </span><span class="default">16</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">pack</span><span class="keyword">(</span><span class="string">'n*'</span><span class="keyword">, ~</span><span class="default">$sum</span><span class="keyword">);<br />
}<br />
<br />
function </span><span class="default">getLastIcmpError</span><span class="keyword">()<br />
{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; global </span><span class="default">$g_icmp_error</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$g_icmp_error</span><span class="keyword">;<br />
}<br />
</span><span class="comment">/// end ping.inc.php ///<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68709""></a>
  <div class="note">
   <strong class="user">jens at surefoot dot com</strong>
   <a href="#68709" class="date">08-Aug-2006 05:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please be aware that RAW sockets (as used for the ping example) are restricted to root accounts on *nix systems. Since web servers hardly ever run as root, they won't work on webpages.<br />
<br />
On Windows based servers it should work regardless.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60438""></a>
  <div class="note">
   
   <a href="#60438" class="date">06-Jan-2006 02:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here's a ping function that uses sockets instead of exec().&nbsp; Note: I was unable to get socket_create() to work without running from CLI as root.&nbsp; I've already calculated the package's checksum to simplify the code (the message is 'ping' but it doesn't actually matter).<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">ping</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$package </span><span class="keyword">= </span><span class="string">"\x08\x00\x19\x2f\x00\x00\x00\x00\x70\x69\x6e\x67"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* create the socket, the last '1' denotes ICMP */&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_RAW</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* set socket receive timeout to 1 second */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">SOL_SOCKET</span><span class="keyword">, </span><span class="default">SO_RCVTIMEO</span><span class="keyword">, array(</span><span class="string">"sec" </span><span class="keyword">=&gt; </span><span class="default">1</span><span class="keyword">, </span><span class="string">"usec" </span><span class="keyword">=&gt; </span><span class="default">0</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* connect to socket */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_connect</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* record start time */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">list(</span><span class="default">$start_usec</span><span class="keyword">, </span><span class="default">$start_sec</span><span class="keyword">) = </span><span class="default">explode</span><span class="keyword">(</span><span class="string">" "</span><span class="keyword">, </span><span class="default">microtime</span><span class="keyword">());<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$start_time </span><span class="keyword">= ((float) </span><span class="default">$start_usec </span><span class="keyword">+ (float) </span><span class="default">$start_sec</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_send</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$package</span><span class="keyword">, </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$package</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if(@</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; list(</span><span class="default">$end_usec</span><span class="keyword">, </span><span class="default">$end_sec</span><span class="keyword">) = </span><span class="default">explode</span><span class="keyword">(</span><span class="string">" "</span><span class="keyword">, </span><span class="default">microtime</span><span class="keyword">());<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$end_time </span><span class="keyword">= ((float) </span><span class="default">$end_usec </span><span class="keyword">+ (float) </span><span class="default">$end_sec</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$total_time </span><span class="keyword">= </span><span class="default">$end_time </span><span class="keyword">- </span><span class="default">$start_time</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$total_time</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58257""></a>
  <div class="note">
   <strong class="user">kyle gibson</strong>
   <a href="#58257" class="date">28-Oct-2005 05:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Took me about 20 minutes to figure out the proper arguments to supply for a AF_UNIX socket. Anything else, and I would get a PHP warning about the 'type' not being supported. I hope this saves someone else time.<br />
<br />
<span class="default">&lt;?php <br />
$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_UNIX</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
</span><span class="comment">// code<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="49368""></a>
  <div class="note">
   <strong class="user">david at eder dot us</strong>
   <a href="#49368" class="date">25-Jan-2005 11:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Sometimes when you are running CLI, you need to know your own ip address.<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp; $addr </span><span class="keyword">= </span><span class="default">my_ip</span><span class="keyword">();<br />
&nbsp; echo </span><span class="string">"my ip address is </span><span class="default">$addr</span><span class="string">\n"</span><span class="keyword">;<br />
<br />
&nbsp; function </span><span class="default">my_ip</span><span class="keyword">(</span><span class="default">$dest</span><span class="keyword">=</span><span class="string">'64.0.0.0'</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">=</span><span class="default">80</span><span class="keyword">)<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_DGRAM</span><span class="keyword">, </span><span class="default">SOL_UDP</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_connect</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$dest</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_getsockname</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$addr</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$addr</span><span class="keyword">;<br />
&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="43057""></a>
  <div class="note">
   <strong class="user">david at eder dot us</strong>
   <a href="#43057" class="date">08-Jun-2004 08:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Seems there aren't any examples of UDP clients out there.&nbsp; This is a tftp client.&nbsp; I hope this makes someone's life easier.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="keyword">function </span><span class="default">tftp_fetch</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$filename</span><span class="keyword">)<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_DGRAM</span><span class="keyword">, </span><span class="default">SOL_UDP</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// create the request packet<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">) . </span><span class="default">chr</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">) . </span><span class="default">$filename </span><span class="keyword">. </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">) . </span><span class="string">'octet' </span><span class="keyword">. </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// UDP is connectionless, so we just send on it.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_sendto</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$packet</span><span class="keyword">, </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$packet</span><span class="keyword">), </span><span class="default">0x100</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">69</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$buffer </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$port </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; do<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// $buffer and $port both come back with information for the ack<br />
&nbsp;&nbsp; &nbsp;&nbsp; // 516 = 4 bytes for the header + 512 bytes of data<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">socket_recvfrom</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$buffer</span><span class="keyword">, </span><span class="default">516</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// add the block number from the data packet to the ack packet<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">) . </span><span class="default">chr</span><span class="keyword">(</span><span class="default">4</span><span class="keyword">) . </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// send ack<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">socket_sendto</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$packet</span><span class="keyword">, </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$packet</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// append the data to the return variable<br />
&nbsp;&nbsp; &nbsp;&nbsp; // for large files this function should take a file handle as an arg<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">.= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">, </span><span class="default">4</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; while(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">) == </span><span class="default">516</span><span class="keyword">);&nbsp; </span><span class="comment">// the first non-full packet is the last.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">$ret</span><span class="keyword">;<br />
&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="19075""></a>
  <div class="note">
   <strong class="user">evan at coeus hyphen group dot com</strong>
   <a href="#19075" class="date">14-Feb-2002 06:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Okay I talked with Richard a little (via e-mail). We agree that getprotobyname() and using the constants should be the same in functionality and speed, the use of one or the other is merely coding style. Personally, we both think the constants are prettier :).<br />
<br />
The eight different protocols are the ones implemented in PHP- not the total number in existance (RFC 1340 has 98).<br />
<br />
All we disagree on is using 0- Richard says that "accordning to the official unix/bsd sockets 0 is more than fine." I think that since 0 is a reserved number according to RFC 1320, and when used usually refers to IP, not one of it's sub-protocols (TCP, UDP, etc.)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
