<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>拷贝并合并图像的一部分</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.imagecopy.html">? imagecopy</a></li>
      <li style="float: right;"><a href="function.imagecopymergegray.html">imagecopymergegray ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.image.html">GD 和图像处理 函数</a></li>
    <li>拷贝并合并图像的一部分</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.imagecopymerge" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">imagecopymerge</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.0.1, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">imagecopymerge</span> &mdash; <span class="dc-title">拷贝并合并图像的一部分</span></p>

 </div>
 <div class="refsect1 unknown-unknown-seealsq" id="refsect1-function.imagecopymerge-unknown-unknown-seealsq">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>imagecopymerge</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">resource</span> <code class="parameter">$dst_im</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">resource</span> <code class="parameter">$src_im</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$dst_x</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$dst_y</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$src_x</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$src_y</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$src_w</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$src_h</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$pct</code></span><br>): <span class="type">bool</span></div>

  <p class="para rdfs-comment">
   将 <code class="parameter">src_im</code> 图像中坐标从
   <code class="parameter">src_x</code>，<code class="parameter">src_y </code>
   开始，宽度为 <code class="parameter">src_w</code>，高度为 <code class="parameter">src_h</code>
   的一部分拷贝到
   <code class="parameter">dst_im</code> 图像中坐标为
   <code class="parameter">dst_x</code> 和 <code class="parameter">dst_y</code>
   的位置上。两图像将根据 <code class="parameter">pct</code>
   来决定合并程度，其值范围从 0 到 100。当 <code class="parameter">pct</code> = 0
   时，实际上什么也没做，当为 100 时对于调色板图像本函数和
   <span class="function"><a href="function.imagecopy.html" class="function">imagecopy()</a></span> 完全一样，它对真彩色图像实现了 alpha 透明。
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    本函数是 PHP 4.0.6 新加的。
   </p>
  </p></blockquote>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="123999""></a>
  <div class="note">
   <strong class="user">highton ridley</strong>
   <a href="#123999" class="date">01-Jul-2019 08:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
killing_wombles0000 gave an almost working piece of code to mirror an image with increasing transparency. With help from showdev on stackexchange, here's the corrected and fully working code:<br />
<span class="default">&lt;?php<br />
$in </span><span class="keyword">= </span><span class="default">imagecreatefromjpeg</span><span class="keyword">(</span><span class="string">'https://picsum.photos/id/1084/536/354?grayscale'</span><span class="keyword">);<br />
</span><span class="default">$reflection_strength </span><span class="keyword">= </span><span class="default">120</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//&nbsp; &nbsp; starting transparency (0-127, 0 being opaque)<br />
</span><span class="default">$reflection_height </span><span class="keyword">= </span><span class="default">40</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//&nbsp; &nbsp;&nbsp; height of reflection in pixels<br />
</span><span class="default">$gap </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//&nbsp; &nbsp; gap between image and reflection<br />
<br />
</span><span class="default">$orig_height </span><span class="keyword">= </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//&nbsp; &nbsp; store height of original image<br />
</span><span class="default">$orig_width </span><span class="keyword">= </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//&nbsp; &nbsp; store height of original image<br />
</span><span class="default">$output_height </span><span class="keyword">= </span><span class="default">$orig_height </span><span class="keyword">+ </span><span class="default">$reflection_height </span><span class="keyword">+ </span><span class="default">$gap</span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment">//&nbsp; &nbsp; calculate height of output image<br />
<br />
// create new image to use for output. fill with BLACK.<br />
</span><span class="default">$out </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$orig_width</span><span class="keyword">, </span><span class="default">$output_height</span><span class="keyword">);<br />
</span><span class="comment">//imagealphablending($out, false);<br />
//$bg = imagecolortransparent($out, imagecolorallocatealpha($out, 255, 255, 255, 127));<br />
</span><span class="default">$bg </span><span class="keyword">= </span><span class="default">imagecolorallocatealpha</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">);<br />
</span><span class="default">imagefill</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$bg</span><span class="keyword">);<br />
</span><span class="default">imagefilledrectangle</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">$bg</span><span class="keyword">);<br />
<br />
</span><span class="comment">// copy original image onto new one, leaving space underneath for reflection and 'gap'<br />
</span><span class="default">imagecopyresampled </span><span class="keyword">( </span><span class="default">$out </span><span class="keyword">, </span><span class="default">$in </span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">));<br />
<br />
&nbsp;</span><span class="comment">// create new single-line image to act as buffer while applying transparency<br />
</span><span class="default">$reflection_section </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">1</span><span class="keyword">);<br />
</span><span class="default">imagealphablending</span><span class="keyword">(</span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">);<br />
</span><span class="default">$bg1 </span><span class="keyword">= </span><span class="default">imagecolortransparent</span><span class="keyword">(</span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">imagecolorallocatealpha</span><span class="keyword">(</span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">127</span><span class="keyword">));<br />
</span><span class="default">imagefill</span><span class="keyword">(</span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$bg1</span><span class="keyword">);<br />
<br />
</span><span class="comment">// 1. copy each line individually, starting at the 'bottom' of the image, working upwards.<br />
// 2. set transparency to vary between reflection_strength and 127<br />
// 3. copy line back to mirrored position in original<br />
</span><span class="keyword">for (</span><span class="default">$y </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$y</span><span class="keyword">&lt;</span><span class="default">$reflection_height</span><span class="keyword">;</span><span class="default">$y</span><span class="keyword">++)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$t </span><span class="keyword">= ((</span><span class="default">127</span><span class="keyword">-</span><span class="default">$reflection_strength</span><span class="keyword">) + (</span><span class="default">$reflection_strength</span><span class="keyword">*(</span><span class="default">$y</span><span class="keyword">/</span><span class="default">$reflection_height</span><span class="keyword">)));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagecopy</span><span class="keyword">(</span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">$out</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">)&nbsp; - </span><span class="default">$y</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagefilter</span><span class="keyword">(</span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">IMG_FILTER_COLORIZE</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$t</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagecopyresized</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">, </span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">) + </span><span class="default">$y </span><span class="keyword">+ </span><span class="default">$gap</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">) - </span><span class="default">0</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">1</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">// output image to view<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">'Content-type: image/png'</span><span class="keyword">);<br />
</span><span class="default">imagesavealpha</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">,</span><span class="default">true</span><span class="keyword">);<br />
</span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107066""></a>
  <div class="note">
   <strong class="user">Leo</strong>
   <a href="#107066" class="date">04-Jan-2012 09:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The following function creates mask of a true color image for a given color. Beforehand for creating an image mask I used to loop over all image pixels and check their color using imagecolorat and copy if the color matches with imagesetpixel. This was very slow for large images, so the following code improves the process.<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">getOppositeColor </span><span class="keyword">(</span><span class="default">$color</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return (<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ( (</span><span class="default">255 </span><span class="keyword">- (</span><span class="default">$color </span><span class="keyword">&gt;&gt; </span><span class="default">16</span><span class="keyword">) &amp; </span><span class="default">0xFF</span><span class="keyword">) &lt;&lt; </span><span class="default">16 </span><span class="keyword">) +<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ( (</span><span class="default">255 </span><span class="keyword">- (</span><span class="default">$color </span><span class="keyword">&gt;&gt; </span><span class="default">8&nbsp; </span><span class="keyword">) &amp; </span><span class="default">0xFF</span><span class="keyword">) &lt;&lt; </span><span class="default">8&nbsp; </span><span class="keyword">) +<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ( (</span><span class="default">255 </span><span class="keyword">- (</span><span class="default">$color&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">) &amp; </span><span class="default">0xFF</span><span class="keyword">)&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; )<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; );<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">createImageMask </span><span class="keyword">(&amp;</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$w </span><span class="keyword">= </span><span class="default">imagesx </span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$h </span><span class="keyword">= </span><span class="default">imagesy </span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmpImage </span><span class="keyword">= </span><span class="default">imagecreatetruecolor </span><span class="keyword">(</span><span class="default">$w</span><span class="keyword">, </span><span class="default">$h</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagecopy </span><span class="keyword">(</span><span class="default">$tmpImage</span><span class="keyword">, </span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$w</span><span class="keyword">, </span><span class="default">$h</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagefilter </span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">IMG_FILTER_NEGATE</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagecolortransparent </span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">getOppositeColor </span><span class="keyword">(</span><span class="default">$color</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagecopymerge </span><span class="keyword">(</span><span class="default">$tmpImage</span><span class="keyword">, </span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$w</span><span class="keyword">, </span><span class="default">$h</span><span class="keyword">, </span><span class="default">50</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagedestroy </span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$image </span><span class="keyword">= </span><span class="default">$tmpImage</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
So for example, if we have a photo and we specify color = (255, 0, 0), i.e. red, the result will be image of the same size with red pixels everywhere the original photo was red and grey pixels exerywhere else.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107060""></a>
  <div class="note">
   <strong class="user">Leo</strong>
   <a href="#107060" class="date">04-Jan-2012 06:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
imagecopymerge PHP function helped me to create a fast method that replaces one color by another in true color images.<br />
<br />
Beforehand for this purpose I had to loop over all the pixels of an image and replace color pixel by pixel using imagecolorat and imagesetpixel; this method is really slow for large images.<br />
<br />
So here is the fast one:<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">replaceColorInImage </span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$old_r</span><span class="keyword">, </span><span class="default">$old_g</span><span class="keyword">, </span><span class="default">$old_b</span><span class="keyword">, </span><span class="default">$new_r</span><span class="keyword">, </span><span class="default">$new_g</span><span class="keyword">, </span><span class="default">$new_b</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagecolortransparent </span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">imagecolorallocate </span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$old_r</span><span class="keyword">, </span><span class="default">$old_g</span><span class="keyword">, </span><span class="default">$old_b</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$w </span><span class="keyword">= </span><span class="default">imagesx </span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$h </span><span class="keyword">= </span><span class="default">imagesy </span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$resImage </span><span class="keyword">= </span><span class="default">imagecreatetruecolor </span><span class="keyword">(</span><span class="default">$w</span><span class="keyword">, </span><span class="default">$h</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagefill </span><span class="keyword">(</span><span class="default">$resImage</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagecolorallocate </span><span class="keyword">(</span><span class="default">$resImage</span><span class="keyword">, </span><span class="default">$new_r</span><span class="keyword">, </span><span class="default">$new_g</span><span class="keyword">, </span><span class="default">$new_b</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagecopymerge </span><span class="keyword">(</span><span class="default">$resImage</span><span class="keyword">, </span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$w</span><span class="keyword">, </span><span class="default">$h</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$resImage</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="102844""></a>
  <div class="note">
   <strong class="user">thciobanu</strong>
   <a href="#102844" class="date">09-Mar-2011 12:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This is what I use for merging two images while respecting the alpha channel (formulas are taken from the wikipedia article on alpha compositing; they're not too pretty as I didn't really try to make them look so, but instead just work and make sense when checked out months from now), with a quirk - an additional parameter (that defaults to NULL to be ignored) to manually specify a "transparent" color, which won't be copied over from the source to the destination. In comparison to the other implementation here, only one pass over $src_im is done, but more calculations are performed:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">imagecopymerge_alpha</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">$dst_x</span><span class="keyword">, </span><span class="default">$dst_y</span><span class="keyword">, </span><span class="default">$src_x</span><span class="keyword">, </span><span class="default">$src_y</span><span class="keyword">, </span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">, </span><span class="default">$pct</span><span class="keyword">, </span><span class="default">$trans </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">)<br />
{<br />
&nbsp; </span><span class="default">$dst_w </span><span class="keyword">= </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$dst_h </span><span class="keyword">= </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">);<br />
<br />
&nbsp; </span><span class="comment">// bounds checking<br />
&nbsp; </span><span class="default">$src_x </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">(</span><span class="default">$src_x</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$src_y </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">(</span><span class="default">$src_y</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$dst_x </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">(</span><span class="default">$dst_x</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$dst_y </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">(</span><span class="default">$dst_y</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
&nbsp; if (</span><span class="default">$dst_x </span><span class="keyword">+ </span><span class="default">$src_w </span><span class="keyword">&gt; </span><span class="default">$dst_w</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$src_w </span><span class="keyword">= </span><span class="default">$dst_w </span><span class="keyword">- </span><span class="default">$dst_x</span><span class="keyword">;<br />
&nbsp; if (</span><span class="default">$dst_y </span><span class="keyword">+ </span><span class="default">$src_h </span><span class="keyword">&gt; </span><span class="default">$dst_h</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$src_h </span><span class="keyword">= </span><span class="default">$dst_h </span><span class="keyword">- </span><span class="default">$dst_y</span><span class="keyword">;<br />
<br />
&nbsp; for(</span><span class="default">$x_offset </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$x_offset </span><span class="keyword">&lt; </span><span class="default">$src_w</span><span class="keyword">; </span><span class="default">$x_offset</span><span class="keyword">++)<br />
&nbsp;&nbsp;&nbsp; for(</span><span class="default">$y_offset </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$y_offset </span><span class="keyword">&lt; </span><span class="default">$src_h</span><span class="keyword">; </span><span class="default">$y_offset</span><span class="keyword">++)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// get source &amp; dest color<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$srccolor </span><span class="keyword">= </span><span class="default">imagecolorsforindex</span><span class="keyword">(</span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">imagecolorat</span><span class="keyword">(</span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">$src_x </span><span class="keyword">+ </span><span class="default">$x_offset</span><span class="keyword">, </span><span class="default">$src_y </span><span class="keyword">+ </span><span class="default">$y_offset</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$dstcolor </span><span class="keyword">= </span><span class="default">imagecolorsforindex</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">imagecolorat</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">$dst_x </span><span class="keyword">+ </span><span class="default">$x_offset</span><span class="keyword">, </span><span class="default">$dst_y </span><span class="keyword">+ </span><span class="default">$y_offset</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// apply transparency<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">is_null</span><span class="keyword">(</span><span class="default">$trans</span><span class="keyword">) || (</span><span class="default">$srccolor </span><span class="keyword">!== </span><span class="default">$trans</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$src_a </span><span class="keyword">= </span><span class="default">$srccolor</span><span class="keyword">[</span><span class="string">'alpha'</span><span class="keyword">] * </span><span class="default">$pct </span><span class="keyword">/ </span><span class="default">100</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// blend<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$src_a </span><span class="keyword">= </span><span class="default">127 </span><span class="keyword">- </span><span class="default">$src_a</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dst_a </span><span class="keyword">= </span><span class="default">127 </span><span class="keyword">- </span><span class="default">$dstcolor</span><span class="keyword">[</span><span class="string">'alpha'</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dst_r </span><span class="keyword">= (</span><span class="default">$srccolor</span><span class="keyword">[</span><span class="string">'red'</span><span class="keyword">] * </span><span class="default">$src_a </span><span class="keyword">+ </span><span class="default">$dstcolor</span><span class="keyword">[</span><span class="string">'red'</span><span class="keyword">] * </span><span class="default">$dst_a </span><span class="keyword">* (</span><span class="default">127 </span><span class="keyword">- </span><span class="default">$src_a</span><span class="keyword">) / </span><span class="default">127</span><span class="keyword">) / </span><span class="default">127</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dst_g </span><span class="keyword">= (</span><span class="default">$srccolor</span><span class="keyword">[</span><span class="string">'green'</span><span class="keyword">] * </span><span class="default">$src_a </span><span class="keyword">+ </span><span class="default">$dstcolor</span><span class="keyword">[</span><span class="string">'green'</span><span class="keyword">] * </span><span class="default">$dst_a </span><span class="keyword">* (</span><span class="default">127 </span><span class="keyword">- </span><span class="default">$src_a</span><span class="keyword">) / </span><span class="default">127</span><span class="keyword">) / </span><span class="default">127</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dst_b </span><span class="keyword">= (</span><span class="default">$srccolor</span><span class="keyword">[</span><span class="string">'blue'</span><span class="keyword">] * </span><span class="default">$src_a </span><span class="keyword">+ </span><span class="default">$dstcolor</span><span class="keyword">[</span><span class="string">'blue'</span><span class="keyword">] * </span><span class="default">$dst_a </span><span class="keyword">* (</span><span class="default">127 </span><span class="keyword">- </span><span class="default">$src_a</span><span class="keyword">) / </span><span class="default">127</span><span class="keyword">) / </span><span class="default">127</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dst_a </span><span class="keyword">= </span><span class="default">127 </span><span class="keyword">- (</span><span class="default">$src_a </span><span class="keyword">+ </span><span class="default">$dst_a </span><span class="keyword">* (</span><span class="default">127 </span><span class="keyword">- </span><span class="default">$src_a</span><span class="keyword">) / </span><span class="default">127</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$color </span><span class="keyword">= </span><span class="default">imagecolorallocatealpha</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">$dst_r</span><span class="keyword">, </span><span class="default">$dst_g</span><span class="keyword">, </span><span class="default">$dst_b</span><span class="keyword">, </span><span class="default">$dst_a</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// paint<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (!</span><span class="default">imagesetpixel</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">$dst_x </span><span class="keyword">+ </span><span class="default">$x_offset</span><span class="keyword">, </span><span class="default">$dst_y </span><span class="keyword">+ </span><span class="default">$y_offset</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagecolordeallocate</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">// use it like this (identical to imagecopymerge)<br />
</span><span class="keyword">function </span><span class="default">imagecopymerge_alpha</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">$dst_x</span><span class="keyword">, </span><span class="default">$dst_y</span><span class="keyword">, </span><span class="default">$src_x</span><span class="keyword">, </span><span class="default">$src_y</span><span class="keyword">, </span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">, </span><span class="default">$pct</span><span class="keyword">)<br />
</span><span class="comment">// or this<br />
</span><span class="keyword">function </span><span class="default">imagecopymerge_alpha</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">$dst_x</span><span class="keyword">, </span><span class="default">$dst_y</span><span class="keyword">, </span><span class="default">$src_x</span><span class="keyword">, </span><span class="default">$src_y</span><span class="keyword">, </span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">, </span><span class="default">$pct</span><span class="keyword">, array(</span><span class="string">'red' </span><span class="keyword">=&gt; </span><span class="default">1</span><span class="keyword">, </span><span class="string">'green' </span><span class="keyword">=&gt; </span><span class="default">2</span><span class="keyword">, </span><span class="string">'blue' </span><span class="keyword">=&gt; </span><span class="default">3</span><span class="keyword">, </span><span class="string">'alpha' </span><span class="keyword">=&gt;</span><span class="default">4</span><span class="keyword">))<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="102496""></a>
  <div class="note">
   <strong class="user">killing_wombles0000 at hotmail dot com</strong>
   <a href="#102496" class="date">17-Feb-2011 09:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Anyone wanting to create a reflecion of an image. Simple process that copies, line by line, from the bottom of the image, a given number of pixels. Each line gets gradually more transparent. Outputs PNG to screen.<br />
<br />
This is pretty hot-coded - all four input variables (input image, reflection height, starting transparency, gap between image and reflection) are set manually here.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; $in </span><span class="keyword">= </span><span class="default">imagecreatefromjpeg</span><span class="keyword">(</span><span class="string">'C:\test.jpg'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$reflection_strength </span><span class="keyword">= </span><span class="default">120</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//&nbsp; &nbsp; starting transparency (0-127, 0 being opaque)<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$reflection_height </span><span class="keyword">= </span><span class="default">40</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//&nbsp; &nbsp;&nbsp; height of reflection in pixels<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$gap </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//&nbsp; &nbsp; gap between image and reflection<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$orig_height </span><span class="keyword">= </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//&nbsp; &nbsp; store height of original image<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$orig_width </span><span class="keyword">= </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//&nbsp; &nbsp; store height of original image<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$output_height </span><span class="keyword">= </span><span class="default">$orig_height </span><span class="keyword">+ </span><span class="default">$reflection_height </span><span class="keyword">+ </span><span class="default">$gap</span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment">//&nbsp; &nbsp; calculate height of output image<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; // create new image to use for output. fill with transparency. ALPHA BLENDING MUST BE FALSE<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$out </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$orig_width</span><span class="keyword">, </span><span class="default">$output_height</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagealphablending</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bg </span><span class="keyword">= </span><span class="default">imagecolortransparent</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">, </span><span class="default">imagecolorallocatealpha</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">127</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagefill</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$bg</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagefilledrectangle</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">$bg1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// copy original image onto new one, leaving space underneath for reflection and 'gap'<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagecopyresampled </span><span class="keyword">( </span><span class="default">$out </span><span class="keyword">, </span><span class="default">$in </span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp; &nbsp; </span><span class="comment">// create new single-line image to act as buffer while applying transparency<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$reflection_section </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagealphablending</span><span class="keyword">(</span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bg1 </span><span class="keyword">= </span><span class="default">imagecolortransparent</span><span class="keyword">(</span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">imagecolorallocatealpha</span><span class="keyword">(</span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">127</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagefill</span><span class="keyword">(</span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$bg1</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// 1. copy each line individually, starting at the 'bottom' of the image, working upwards. <br />
&nbsp;&nbsp;&nbsp; // 2. set transparency to vary between reflection_strength and 127<br />
&nbsp;&nbsp;&nbsp; // 3. copy line back to mirrored position in original<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">for (</span><span class="default">$y </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$y</span><span class="keyword">&lt;</span><span class="default">$reflection_height</span><span class="keyword">;</span><span class="default">$y</span><span class="keyword">++)<br />
&nbsp;&nbsp;&nbsp; {&nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$t </span><span class="keyword">= ((</span><span class="default">127</span><span class="keyword">-</span><span class="default">$reflection_strength</span><span class="keyword">) + (</span><span class="default">$reflection_strength</span><span class="keyword">*(</span><span class="default">$y</span><span class="keyword">/</span><span class="default">$reflection_height</span><span class="keyword">)));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagecopy</span><span class="keyword">(</span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">$out</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">)&nbsp; - </span><span class="default">$y</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagefilter</span><span class="keyword">(</span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">IMG_FILTER_COLORIZE</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$t</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagecopyresized</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">, </span><span class="default">$reflection_section</span><span class="keyword">, </span><span class="default">$a</span><span class="keyword">, </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">) + </span><span class="default">$y </span><span class="keyword">+ </span><span class="default">$gap</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">) - (</span><span class="default">2</span><span class="keyword">*</span><span class="default">$a</span><span class="keyword">), </span><span class="default">1</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">), </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// output image to view<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">'Content-type: image/png'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagesavealpha</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">,</span><span class="default">true</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="92787""></a>
  <div class="note">
   <strong class="user">Sina Salek</strong>
   <a href="#92787" class="date">09-Aug-2009 01:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I've just checked PHP's issue tracker and a core developer says that this function was never meant to support alpha channel! and they refused to commit the provided patch! so ridicules 
<br />
Anyway i tried rodrigo's workaround and it worked quite well, thanks rodrigo for sharing it.
<br />
I came up with another idea which is much faster than his solution, (it may need a little bit more memory)
<br />

<br />
Hope it helps someone.
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="comment">/**
<br />
&nbsp;* PNG ALPHA CHANNEL SUPPORT for imagecopymerge();
<br />
&nbsp;* by Sina Salek
<br />
&nbsp;*
<br />
&nbsp;* Bugfix by Ralph Voigt (bug which causes it
<br />
&nbsp;* to work only for $src_x = $src_y = 0. 
<br />
&nbsp;* Also, inverting opacity is not necessary.)
<br />
&nbsp;* 08-JAN-2011
<br />
&nbsp;*
<br />
&nbsp;**/
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">imagecopymerge_alpha</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">$dst_x</span><span class="keyword">, </span><span class="default">$dst_y</span><span class="keyword">, </span><span class="default">$src_x</span><span class="keyword">, </span><span class="default">$src_y</span><span class="keyword">, </span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">, </span><span class="default">$pct</span><span class="keyword">){
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// creating a cut resource
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$cut </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">);
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// copying relevant section from background to the cut resource
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagecopy</span><span class="keyword">(</span><span class="default">$cut</span><span class="keyword">, </span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$dst_x</span><span class="keyword">, </span><span class="default">$dst_y</span><span class="keyword">, </span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// copying relevant section from watermark to the cut resource
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagecopy</span><span class="keyword">(</span><span class="default">$cut</span><span class="keyword">, </span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$src_x</span><span class="keyword">, </span><span class="default">$src_y</span><span class="keyword">, </span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// insert cut resource to destination image
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagecopymerge</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">$cut</span><span class="keyword">, </span><span class="default">$dst_x</span><span class="keyword">, </span><span class="default">$dst_y</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">, </span><span class="default">$pct</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; } 
<br />

<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90471""></a>
  <div class="note">
   <strong class="user">santin1991[at]gmail[dot]com</strong>
   <a href="#90471" class="date">23-Apr-2009 04:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Add logo on image script.
<br />
<span class="default">&lt;?php
<br />
</span><span class="comment">/**
<br />
&nbsp;* Put logo on low right jpeg image
<br />
&nbsp;* used stefan's script for position
<br />
&nbsp;**/
<br />
</span><span class="default">$logo_file </span><span class="keyword">= </span><span class="string">"logo.png"</span><span class="keyword">; 
<br />
</span><span class="default">$image_file </span><span class="keyword">= </span><span class="string">"img.jpg"</span><span class="keyword">; 
<br />
</span><span class="default">$targetfile </span><span class="keyword">= </span><span class="string">"img2.jpg"</span><span class="keyword">;
<br />
</span><span class="default">$photo </span><span class="keyword">= </span><span class="default">imagecreatefromjpeg</span><span class="keyword">(</span><span class="default">$image_file</span><span class="keyword">);
<br />
</span><span class="default">$fotoW </span><span class="keyword">= </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$photo</span><span class="keyword">);
<br />
</span><span class="default">$fotoH </span><span class="keyword">= </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$photo</span><span class="keyword">);
<br />
</span><span class="default">$logoImage </span><span class="keyword">= </span><span class="default">imagecreatefrompng</span><span class="keyword">(</span><span class="default">$logo_file</span><span class="keyword">);
<br />
</span><span class="default">$logoW </span><span class="keyword">= </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$logoImage</span><span class="keyword">); 
<br />
</span><span class="default">$logoH </span><span class="keyword">= </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$logoImage</span><span class="keyword">); 
<br />
</span><span class="default">$photoFrame </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$fotoW</span><span class="keyword">,</span><span class="default">$fotoH</span><span class="keyword">);
<br />
</span><span class="default">$dest_x </span><span class="keyword">= </span><span class="default">$fotoW </span><span class="keyword">- </span><span class="default">$logoW</span><span class="keyword">;
<br />
</span><span class="default">$dest_y </span><span class="keyword">= </span><span class="default">$fotoH </span><span class="keyword">- </span><span class="default">$logoH</span><span class="keyword">;
<br />
</span><span class="default">imagecopyresampled</span><span class="keyword">(</span><span class="default">$photoFrame</span><span class="keyword">, </span><span class="default">$photo</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$fotoW</span><span class="keyword">, </span><span class="default">$fotoH</span><span class="keyword">, </span><span class="default">$fotoW</span><span class="keyword">, </span><span class="default">$fotoH</span><span class="keyword">);
<br />
</span><span class="default">imagecopy</span><span class="keyword">(</span><span class="default">$photoFrame</span><span class="keyword">, </span><span class="default">$logoImage</span><span class="keyword">, </span><span class="default">$dest_x</span><span class="keyword">, </span><span class="default">$dest_y</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$logoW</span><span class="keyword">, </span><span class="default">$logoH</span><span class="keyword">);
<br />
</span><span class="default">imagejpeg</span><span class="keyword">(</span><span class="default">$photoFrame</span><span class="keyword">, </span><span class="default">$targetfile</span><span class="keyword">);&nbsp; 
<br />
echo </span><span class="string">'&lt;img src="'</span><span class="keyword">.</span><span class="default">$targetfile</span><span class="keyword">.</span><span class="string">'" /&gt;'</span><span class="keyword">;
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="88456""></a>
  <div class="note">
   <strong class="user">rodrigo dot polo at gmail dot com</strong>
   <a href="#88456" class="date">25-Jan-2009 02:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php
<br />
</span><span class="comment">/**
<br />
&nbsp;* PNG ALPHA CHANNEL SUPPORT for imagecopymerge();
<br />
&nbsp;* This is a function like imagecopymerge but it handle alpha channel well!!!
<br />
&nbsp;**/
<br />

<br />
// A fix to get a function like imagecopymerge WITH ALPHA SUPPORT
<br />
// Main script by aiden dot mail at freemail dot hu 
<br />
// Transformed to imagecopymerge_alpha() by rodrigo dot polo at gmail dot com
<br />
</span><span class="keyword">function </span><span class="default">imagecopymerge_alpha</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">$dst_x</span><span class="keyword">, </span><span class="default">$dst_y</span><span class="keyword">, </span><span class="default">$src_x</span><span class="keyword">, </span><span class="default">$src_y</span><span class="keyword">, </span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">, </span><span class="default">$pct</span><span class="keyword">){
<br />
&nbsp;&nbsp;&nbsp; if(!isset(</span><span class="default">$pct</span><span class="keyword">)){ 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">; 
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pct </span><span class="keyword">/= </span><span class="default">100</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Get image width and height
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$w </span><span class="keyword">= </span><span class="default">imagesx</span><span class="keyword">( </span><span class="default">$src_im </span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$h </span><span class="keyword">= </span><span class="default">imagesy</span><span class="keyword">( </span><span class="default">$src_im </span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Turn alpha blending off
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagealphablending</span><span class="keyword">( </span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">false </span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Find the most opaque pixel in the image (the one with the smallest alpha value)
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$minalpha </span><span class="keyword">= </span><span class="default">127</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; for( </span><span class="default">$x </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$x </span><span class="keyword">&lt; </span><span class="default">$w</span><span class="keyword">; </span><span class="default">$x</span><span class="keyword">++ )
<br />
&nbsp;&nbsp;&nbsp; for( </span><span class="default">$y </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$y </span><span class="keyword">&lt; </span><span class="default">$h</span><span class="keyword">; </span><span class="default">$y</span><span class="keyword">++ ){
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$alpha </span><span class="keyword">= ( </span><span class="default">imagecolorat</span><span class="keyword">( </span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y </span><span class="keyword">) &gt;&gt; </span><span class="default">24 </span><span class="keyword">) &amp; </span><span class="default">0xFF</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if( </span><span class="default">$alpha </span><span class="keyword">&lt; </span><span class="default">$minalpha </span><span class="keyword">){ 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$minalpha </span><span class="keyword">= </span><span class="default">$alpha</span><span class="keyword">; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//loop through image pixels and modify alpha for each
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">for( </span><span class="default">$x </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$x </span><span class="keyword">&lt; </span><span class="default">$w</span><span class="keyword">; </span><span class="default">$x</span><span class="keyword">++ ){
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for( </span><span class="default">$y </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$y </span><span class="keyword">&lt; </span><span class="default">$h</span><span class="keyword">; </span><span class="default">$y</span><span class="keyword">++ ){
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//get current alpha value (represents the TANSPARENCY!)
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$colorxy </span><span class="keyword">= </span><span class="default">imagecolorat</span><span class="keyword">( </span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y </span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$alpha </span><span class="keyword">= ( </span><span class="default">$colorxy </span><span class="keyword">&gt;&gt; </span><span class="default">24 </span><span class="keyword">) &amp; </span><span class="default">0xFF</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//calculate new alpha
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">$minalpha </span><span class="keyword">!== </span><span class="default">127 </span><span class="keyword">){ 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$alpha </span><span class="keyword">= </span><span class="default">127 </span><span class="keyword">+ </span><span class="default">127 </span><span class="keyword">* </span><span class="default">$pct </span><span class="keyword">* ( </span><span class="default">$alpha </span><span class="keyword">- </span><span class="default">127 </span><span class="keyword">) / ( </span><span class="default">127 </span><span class="keyword">- </span><span class="default">$minalpha </span><span class="keyword">); 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else { 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$alpha </span><span class="keyword">+= </span><span class="default">127 </span><span class="keyword">* </span><span class="default">$pct</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//get the color index with new alpha
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$alphacolorxy </span><span class="keyword">= </span><span class="default">imagecolorallocatealpha</span><span class="keyword">( </span><span class="default">$src_im</span><span class="keyword">, ( </span><span class="default">$colorxy </span><span class="keyword">&gt;&gt; </span><span class="default">16 </span><span class="keyword">) &amp; </span><span class="default">0xFF</span><span class="keyword">, ( </span><span class="default">$colorxy </span><span class="keyword">&gt;&gt; </span><span class="default">8 </span><span class="keyword">) &amp; </span><span class="default">0xFF</span><span class="keyword">, </span><span class="default">$colorxy </span><span class="keyword">&amp; </span><span class="default">0xFF</span><span class="keyword">, </span><span class="default">$alpha </span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//set pixel with the new color + opacity
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if( !</span><span class="default">imagesetpixel</span><span class="keyword">( </span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">$x</span><span class="keyword">, </span><span class="default">$y</span><span class="keyword">, </span><span class="default">$alphacolorxy </span><span class="keyword">) ){ 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// The image copy
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagecopy</span><span class="keyword">(</span><span class="default">$dst_im</span><span class="keyword">, </span><span class="default">$src_im</span><span class="keyword">, </span><span class="default">$dst_x</span><span class="keyword">, </span><span class="default">$dst_y</span><span class="keyword">, </span><span class="default">$src_x</span><span class="keyword">, </span><span class="default">$src_y</span><span class="keyword">, </span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">);
<br />
}
<br />

<br />
</span><span class="comment">// USAGE EXAMPLE:
<br />
</span><span class="default">$img_a </span><span class="keyword">= </span><span class="default">imagecreatefrompng</span><span class="keyword">(</span><span class="string">'image1.png'</span><span class="keyword">);
<br />
</span><span class="default">$img_b </span><span class="keyword">= </span><span class="default">imagecreatefrompng</span><span class="keyword">(</span><span class="string">'wm2.png'</span><span class="keyword">);
<br />

<br />
</span><span class="comment">// SAME COMMANDS:
<br />
</span><span class="default">imagecopymerge_alpha</span><span class="keyword">(</span><span class="default">$img_a</span><span class="keyword">, </span><span class="default">$img_b</span><span class="keyword">, </span><span class="default">10</span><span class="keyword">, </span><span class="default">10</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$img_b</span><span class="keyword">), </span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$img_b</span><span class="keyword">),</span><span class="default">50</span><span class="keyword">);
<br />

<br />
</span><span class="comment">// OUTPUT IMAGE:
<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-Type: image/png"</span><span class="keyword">);
<br />
</span><span class="default">imagesavealpha</span><span class="keyword">(</span><span class="default">$img_a</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);
<br />
</span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$img_a</span><span class="keyword">, </span><span class="default">NULL</span><span class="keyword">);
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85517""></a>
  <div class="note">
   <strong class="user">gigitrix</strong>
   <a href="#85517" class="date">03-Sep-2008 06:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Some highly amusing stuff: This code appears normal and is a way to cut out slices of an image randomly.<br />
<br />
<span class="default">&lt;?php<br />
header</span><span class="keyword">(</span><span class="string">"Content-Type: image/jpeg"</span><span class="keyword">);<br />
</span><span class="default">$width</span><span class="keyword">=</span><span class="default">837</span><span class="keyword">;<br />
</span><span class="default">$height</span><span class="keyword">=</span><span class="default">771</span><span class="keyword">;<br />
</span><span class="default">$origim </span><span class="keyword">= </span><span class="default">imagecreatefromjpeg</span><span class="keyword">(</span><span class="string">"theimage.jpeg"</span><span class="keyword">); </span><span class="comment">/* Attempt to open */<br />
</span><span class="default">$imagetodisplay</span><span class="keyword">=</span><span class="default">imagecreate</span><span class="keyword">(</span><span class="default">$width</span><span class="keyword">, </span><span class="default">$height</span><span class="keyword">);<br />
<br />
for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;=</span><span class="default">100</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++)<br />
{<br />
</span><span class="default">$xPos</span><span class="keyword">=</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">-</span><span class="default">9</span><span class="keyword">);<br />
</span><span class="default">$yPos</span><span class="keyword">=</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">-</span><span class="default">9</span><span class="keyword">);<br />
</span><span class="default">imagecopy</span><span class="keyword">(</span><span class="default">$imagetodisplay</span><span class="keyword">, </span><span class="default">$origim</span><span class="keyword">, </span><span class="default">$xPos</span><span class="keyword">, </span><span class="default">$yPos </span><span class="keyword">, </span><span class="default">$xPos</span><span class="keyword">, </span><span class="default">$yPos </span><span class="keyword">, </span><span class="default">10&nbsp; </span><span class="keyword">, </span><span class="default">10</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="default">imagejpeg</span><span class="keyword">(</span><span class="default">$imagetodisplay</span><span class="keyword">);<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$imagetodisplay</span><span class="keyword">);<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$origim</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Try running this however and an omitted detail adds to the fun. Since the first colour that is defined is taken to be the background colour, we have a random colour selected from $origim as the background colour for $imagetodisplay, but this random colour is weighted according to the background image. It was a surprise (I thought the bg would be black) but I am now keeping it as it looks good.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="76286""></a>
  <div class="note">
   <strong class="user">Al</strong>
   <a href="#76286" class="date">09-Jul-2007 07:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Check your header... He is false... <br />
<br />
<span class="default">&lt;?php<br />
header</span><span class="keyword">(</span><span class="string">"Content-Type: image/png"</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73477""></a>
  <div class="note">
   <strong class="user">jay at zylex dot net dot nz</strong>
   <a href="#73477" class="date">24-Feb-2007 03:45</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hi<br />
i wrote this script to add a watermark image into the bottom right a larger image. Its very basic i know but its all i need for now. It also is an easy function for noobs to grasp. It just takes an two image types as arguments<br />
<br />
for example <br />
$image = imagecreatefromjpeg("FILELOCATION");<br />
$insert = imagecreatefrompng("WATERMARKFILELOCATION");<br />
$image = image_overlap($image, $insert);<br />
<br />
function image_overlap($background, $foreground){<br />
&nbsp;&nbsp; $insertWidth = imagesx($foreground);<br />
&nbsp;&nbsp; $insertHeight = imagesy($foreground);<br />
<br />
&nbsp;&nbsp; $imageWidth = imagesx($background);<br />
&nbsp;&nbsp; $imageHeight = imagesy($background);<br />
<br />
&nbsp;&nbsp; $overlapX = $imageWidth-$insertWidth-5;<br />
&nbsp;&nbsp; $overlapY = $imageHeight-$insertHeight-5;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imagecolortransparent($foreground,<br />
imagecolorat($foreground,0,0));&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imagecopymerge($background,$foreground,<br />
$overlapX,$overlapY,0,0,$insertWidth,$insertHeight,100);&nbsp;&nbsp; return $background;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
It doesnt smooth the edges between the two images but it works easily.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62202""></a>
  <div class="note">
   <strong class="user">jylyn at hotmail dot com</strong>
   <a href="#62202" class="date">22-Feb-2006 01:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A few corrections to the code supplied by nick at prient:<br />
<br />
$iTemplate should be $iBackground<br />
$iWorking should be $iSource<br />
<br />
After fixing those two I found the script really useful, thanks!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58361""></a>
  <div class="note">
   <strong class="user">nick at prient dot co dot uk</strong>
   <a href="#58361" class="date">01-Nov-2005 02:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Task: Rotate a large image, then reduce it in size and place it on a small background (i.e. as an Inset).<br />
<br />
Problem: If you resize the image first, the rotation becomes hugely aliased...&nbsp; So, it makes sense to rotate it first, then shrink it.<br />
Unfortunately, when you resample the image, you lose the background color (at least, some of it may change), so you can no longer set transparancy as you require.&nbsp; If instead you resize the image (rather than resample), again, the aliasing looks bad.<br />
<br />
Solution:&nbsp; Resize the background - make it bigger.&nbsp; Then add the original (large) inset, and resize the whole thing back to normal.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/* We will shrink the inset to 25% */<br />
</span><span class="default">$resizePercentage </span><span class="keyword">= </span><span class="default">0.25</span><span class="keyword">;<br />
<br />
</span><span class="comment">/* Load a source image and a background */<br />
</span><span class="default">$iSource </span><span class="keyword">= </span><span class="default">ImageCreateFromJpeg</span><span class="keyword">(</span><span class="default">$source_file</span><span class="keyword">);<br />
</span><span class="default">$iBackground </span><span class="keyword">= </span><span class="default">ImageCreateFromJpeg</span><span class="keyword">(</span><span class="default">$background_file</span><span class="keyword">);<br />
<br />
</span><span class="comment">/* Do something here, such a rotate, skew etc */<br />
</span><span class="keyword">...<br />
</span><span class="comment">/* Assume $iSource is still the image we want to insert onto the background */<br />
<br />
/* Set the background color to be transparent */<br />
</span><span class="default">$cBackground </span><span class="keyword">= </span><span class="default">ImageColorClosest</span><span class="keyword">(</span><span class="default">$iSource</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">);<br />
</span><span class="default">ImageColorTransparent</span><span class="keyword">(</span><span class="default">$iSource</span><span class="keyword">, </span><span class="default">$cBackground</span><span class="keyword">);<br />
<br />
</span><span class="comment">/* Resize the background - make it huge */<br />
</span><span class="default">$iBackground </span><span class="keyword">= </span><span class="default">ImageResize</span><span class="keyword">(</span><span class="default">$iTemplate</span><span class="keyword">, </span><span class="default">ImageSX</span><span class="keyword">(</span><span class="default">$iBackground </span><span class="keyword">) / </span><span class="default">$resizePercentage</span><span class="keyword">, </span><span class="default">ImageSY</span><span class="keyword">(</span><span class="default">$iBackground </span><span class="keyword">) / </span><span class="default">$resizePercentage</span><span class="keyword">);<br />
</span><span class="comment">/* Place the image on the background - all full size, so no aliasing issues */<br />
</span><span class="default">ImageCopyMerge</span><span class="keyword">(</span><span class="default">$iBackground </span><span class="keyword">, </span><span class="default">$iSource</span><span class="keyword">, <br />
&nbsp;&nbsp;&nbsp; ((</span><span class="default">ImageSX</span><span class="keyword">(</span><span class="default">$iBackground </span><span class="keyword">) - </span><span class="default">ImageSX</span><span class="keyword">(</span><span class="default">$iSource</span><span class="keyword">)) / </span><span class="default">2</span><span class="keyword">), <br />
&nbsp;&nbsp;&nbsp; ((</span><span class="default">ImageSY</span><span class="keyword">(</span><span class="default">$iBackground </span><span class="keyword">) - </span><span class="default">ImageSY</span><span class="keyword">(</span><span class="default">$iSource</span><span class="keyword">)) / </span><span class="default">2</span><span class="keyword">) - </span><span class="default">25</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">ImageSX</span><span class="keyword">(</span><span class="default">$iWorking</span><span class="keyword">), </span><span class="default">ImageSY</span><span class="keyword">(</span><span class="default">$iSource</span><span class="keyword">), </span><span class="default">100</span><span class="keyword">);<br />
</span><span class="comment">/* Shrink the combined image... no issues with transparancy! */<br />
</span><span class="default">$iBackground </span><span class="keyword">= </span><span class="default">ImageResize</span><span class="keyword">(</span><span class="default">$iTemplate</span><span class="keyword">, </span><span class="default">ImageSX</span><span class="keyword">(</span><span class="default">$iBackground </span><span class="keyword">) * </span><span class="default">$resizePercentage</span><span class="keyword">, </span><span class="default">ImageSY</span><span class="keyword">(</span><span class="default">$iBackground </span><span class="keyword">) * </span><span class="default">$resizePercentage</span><span class="keyword">);<br />
<br />
</span><span class="comment">/* Output the image as a PNG */<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-Type: image/png"</span><span class="keyword">);<br />
</span><span class="default">ImagePng</span><span class="keyword">(</span><span class="default">$iBackground</span><span class="keyword">);<br />
exit();<br />
<br />
function </span><span class="default">ImageResize</span><span class="keyword">(</span><span class="default">$pImage</span><span class="keyword">, </span><span class="default">$t_width</span><span class="keyword">, </span><span class="default">$t_height</span><span class="keyword">) {<br />
&nbsp; </span><span class="comment">// Target image<br />
&nbsp; </span><span class="default">$iCanvas </span><span class="keyword">= @</span><span class="default">ImageCreateTrueColor</span><span class="keyword">(</span><span class="default">$t_width</span><span class="keyword">, </span><span class="default">$t_height</span><span class="keyword">);<br />
&nbsp; </span><span class="comment">// Source dimensions<br />
&nbsp; </span><span class="default">$s_width </span><span class="keyword">= </span><span class="default">ImageSX</span><span class="keyword">(</span><span class="default">$pImage</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$s_height </span><span class="keyword">= </span><span class="default">ImageSY</span><span class="keyword">(</span><span class="default">$pImage</span><span class="keyword">);<br />
&nbsp; </span><span class="comment">// Copy image<br />
&nbsp; </span><span class="default">ImageCopyResampled</span><span class="keyword">(</span><span class="default">$iCanvas</span><span class="keyword">, </span><span class="default">$pImage</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$t_width</span><span class="keyword">, </span><span class="default">$t_height</span><span class="keyword">, </span><span class="default">$s_width</span><span class="keyword">, </span><span class="default">$s_height</span><span class="keyword">);<br />
&nbsp; </span><span class="comment">// Return image<br />
&nbsp; </span><span class="keyword">return </span><span class="default">$iCanvas</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="53131""></a>
  <div class="note">
   <strong class="user">Ascent [at] WebAQ.com</strong>
   <a href="#53131" class="date">24-May-2005 02:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
First you need make 0~9 gif format images and background image.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/*<br />
make random image number check<br />
20050524 by ascent WebAQ.com<br />
*/<br />
<br />
</span><span class="default">$rands </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">1000</span><span class="keyword">,</span><span class="default">9999</span><span class="keyword">);<br />
<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'random_image_number_check'</span><span class="keyword">] = </span><span class="default">$rands</span><span class="keyword">;<br />
<br />
</span><span class="default">$bg </span><span class="keyword">= </span><span class="string">'./random_image_bg.jpg'</span><span class="keyword">;<br />
</span><span class="default">$numimgp </span><span class="keyword">= </span><span class="string">'./random_image_number_%d.gif'</span><span class="keyword">;<br />
<br />
</span><span class="default">$numimg1 </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="default">$numimgp</span><span class="keyword">,</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$rands</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">));<br />
</span><span class="default">$numimg2 </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="default">$numimgp</span><span class="keyword">,</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$rands</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">));<br />
</span><span class="default">$numimg3 </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="default">$numimgp</span><span class="keyword">,</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$rands</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">));<br />
</span><span class="default">$numimg4 </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="default">$numimgp</span><span class="keyword">,</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$rands</span><span class="keyword">,</span><span class="default">3</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">));<br />
</span><span class="default">$ys1 </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(-</span><span class="default">4</span><span class="keyword">,</span><span class="default">4</span><span class="keyword">);<br />
</span><span class="default">$ys2 </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(-</span><span class="default">4</span><span class="keyword">,</span><span class="default">4</span><span class="keyword">);<br />
</span><span class="default">$ys3 </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(-</span><span class="default">4</span><span class="keyword">,</span><span class="default">4</span><span class="keyword">);<br />
</span><span class="default">$ys4 </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(-</span><span class="default">4</span><span class="keyword">,</span><span class="default">4</span><span class="keyword">);<br />
<br />
</span><span class="default">$bgImg </span><span class="keyword">= </span><span class="default">imageCreateFromJPEG</span><span class="keyword">(</span><span class="default">$bg</span><span class="keyword">);<br />
</span><span class="default">$nmImg1 </span><span class="keyword">= </span><span class="default">imageCreateFromGIF</span><span class="keyword">(</span><span class="default">$numimg1</span><span class="keyword">);<br />
</span><span class="default">$nmImg2 </span><span class="keyword">= </span><span class="default">imageCreateFromGIF</span><span class="keyword">(</span><span class="default">$numimg2</span><span class="keyword">);<br />
</span><span class="default">$nmImg3 </span><span class="keyword">= </span><span class="default">imageCreateFromGIF</span><span class="keyword">(</span><span class="default">$numimg3</span><span class="keyword">);<br />
</span><span class="default">$nmImg4 </span><span class="keyword">= </span><span class="default">imageCreateFromGIF</span><span class="keyword">(</span><span class="default">$numimg4</span><span class="keyword">);<br />
</span><span class="default">imageCopyMerge</span><span class="keyword">(</span><span class="default">$bgImg</span><span class="keyword">, </span><span class="default">$nmImg1</span><span class="keyword">, </span><span class="default">10</span><span class="keyword">, </span><span class="default">$ys1</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">, </span><span class="default">30</span><span class="keyword">, </span><span class="default">50</span><span class="keyword">);<br />
</span><span class="default">imageCopyMerge</span><span class="keyword">(</span><span class="default">$bgImg</span><span class="keyword">, </span><span class="default">$nmImg2</span><span class="keyword">, </span><span class="default">30</span><span class="keyword">, </span><span class="default">$ys2</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">, </span><span class="default">30</span><span class="keyword">, </span><span class="default">50</span><span class="keyword">);<br />
</span><span class="default">imageCopyMerge</span><span class="keyword">(</span><span class="default">$bgImg</span><span class="keyword">, </span><span class="default">$nmImg3</span><span class="keyword">, </span><span class="default">50</span><span class="keyword">, </span><span class="default">$ys3</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">, </span><span class="default">30</span><span class="keyword">, </span><span class="default">50</span><span class="keyword">);<br />
</span><span class="default">imageCopyMerge</span><span class="keyword">(</span><span class="default">$bgImg</span><span class="keyword">, </span><span class="default">$nmImg4</span><span class="keyword">, </span><span class="default">70</span><span class="keyword">, </span><span class="default">$ys4</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">, </span><span class="default">30</span><span class="keyword">, </span><span class="default">50</span><span class="keyword">);<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-type: image/jpg"</span><span class="keyword">);<br />
</span><span class="default">ImageJPEG</span><span class="keyword">(</span><span class="default">$bgImg</span><span class="keyword">,</span><span class="string">""</span><span class="keyword">,</span><span class="default">100</span><span class="keyword">);<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$bgImg</span><span class="keyword">);<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$nmImg1</span><span class="keyword">);<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$nmImg2</span><span class="keyword">);<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$nmImg3</span><span class="keyword">);<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$nmImg4</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
enjoy!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="53100""></a>
  <div class="note">
   <strong class="user">Steve</strong>
   <a href="#53100" class="date">23-May-2005 11:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Building upon backglancer's and stefan's posts below, the following script will lay a 24-bit PNG watermark over any image.<br />
<br />
To prepare a 24-bit watermark, I recommend creating a white logo or text over a transparent background in Photoshop.&nbsp; Save this as a 24-bit PNG via 'Save for the Web...'.&nbsp; Be sure to set the transparency of the logo layer in Photoshop itself.&nbsp; 30-40% is a good setting.<br />
<br />
Once the assets are prepared, throw the full or relative server paths at the watermark function below:<br />
<br />
/******************************************************************/<br />
<br />
function watermark($sourcefile, $watermarkfile) {<br />
&nbsp; <br />
&nbsp;&nbsp;&nbsp; #<br />
&nbsp;&nbsp;&nbsp; # $sourcefile = Filename of the picture to be watermarked.<br />
&nbsp;&nbsp;&nbsp; # $watermarkfile = Filename of the 24-bit PNG watermark file.<br />
&nbsp;&nbsp;&nbsp; #<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; //Get the resource ids of the pictures<br />
&nbsp;&nbsp;&nbsp; $watermarkfile_id = imagecreatefrompng($watermarkfile);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; imageAlphaBlending($watermarkfile_id, false);<br />
&nbsp;&nbsp;&nbsp; imageSaveAlpha($watermarkfile_id, true);<br />
<br />
&nbsp;&nbsp;&nbsp; $fileType = strtolower(substr($sourcefile, strlen($sourcefile)-3));<br />
<br />
&nbsp;&nbsp;&nbsp; switch($fileType) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; case('gif'):<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $sourcefile_id = imagecreatefromgif($sourcefile);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; case('png'):<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $sourcefile_id = imagecreatefrompng($sourcefile);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; default:<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $sourcefile_id = imagecreatefromjpeg($sourcefile);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; //Get the sizes of both pix&nbsp;&nbsp; <br />
&nbsp; $sourcefile_width=imageSX($sourcefile_id);<br />
&nbsp; $sourcefile_height=imageSY($sourcefile_id);<br />
&nbsp; $watermarkfile_width=imageSX($watermarkfile_id);<br />
&nbsp; $watermarkfile_height=imageSY($watermarkfile_id);<br />
<br />
&nbsp;&nbsp;&nbsp; $dest_x = ( $sourcefile_width / 2 ) - ( $watermarkfile_width / 2 );<br />
&nbsp;&nbsp;&nbsp; $dest_y = ( $sourcefile_height / 2 ) - ( $watermarkfile_height / 2 );<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; // if a gif, we have to upsample it to a truecolor image<br />
&nbsp;&nbsp;&nbsp; if($fileType == 'gif') {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // create an empty truecolor container<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $tempimage = imagecreatetruecolor($sourcefile_width,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $sourcefile_height);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // copy the 8-bit gif into the truecolor image<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; imagecopy($tempimage, $sourcefile_id, 0, 0, 0, 0, <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $sourcefile_width, $sourcefile_height);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // copy the source_id int<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $sourcefile_id = $tempimage;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; imagecopy($sourcefile_id, $watermarkfile_id, $dest_x, $dest_y, 0, 0,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $watermarkfile_width, $watermarkfile_height);<br />
<br />
&nbsp;&nbsp;&nbsp; //Create a jpeg out of the modified picture<br />
&nbsp;&nbsp;&nbsp; switch($fileType) {<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // remember we don't need gif any more, so we use only png or jpeg.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // See the upsaple code immediately above to see how we handle gifs<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; case('png'):<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; header("Content-type: image/png");<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; imagepng ($sourcefile_id);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; default:<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; header("Content-type: image/jpg");<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; imagejpeg ($sourcefile_id);<br />
&nbsp;&nbsp;&nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp; <br />
&nbsp;&nbsp;&nbsp; imagedestroy($sourcefile_id);<br />
&nbsp;&nbsp;&nbsp; imagedestroy($watermarkfile_id);<br />
&nbsp;&nbsp;&nbsp; <br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52903""></a>
  <div class="note">
   <strong class="user">backglancer in the hotmail</strong>
   <a href="#52903" class="date">17-May-2005 02:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was about to kill myself....<br />
any one of you trying to merge a SEMI transparent png...<br />
use imagecopy&nbsp;&nbsp; :)<br />
&lt;?<br />
$flag = imagecreatefrompng('flags/images/flagWhiteFill.png');<br />
$mask = imagecreatefrompng('flags/images/flag_transparent.png');<br />
<br />
imagealphablending($flag, 1);<br />
imagealphablending($mask, 1);<br />
<br />
imagecopy($flag, $mask, 0,0,0,0,25,43);<br />
<br />
Header("Content-type: image/jpeg");<br />
imagepng($flag);<br />
?&gt;<br />
<br />
ImageSaveAlpha(resource, bool);&nbsp;&nbsp; made the transparent color - not transparent... dunno why :)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52900""></a>
  <div class="note">
   <strong class="user">barbarina_sv at libero dot it</strong>
   <a href="#52900" class="date">17-May-2005 01:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I needed to draw a "pointer" image over a map, but had some problems with png image transparency.<br />
So I created a png image with white background (not transparent) and merged it on my map, after defining white color as transparent:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$src_file </span><span class="keyword">= </span><span class="string">'source.jpg'</span><span class="keyword">;<br />
list(</span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">, </span><span class="default">$src_t</span><span class="keyword">, </span><span class="default">$src_a</span><span class="keyword">) = </span><span class="default">getimagesize</span><span class="keyword">(</span><span class="default">$src_file</span><span class="keyword">);<br />
<br />
</span><span class="default">$ptr_file </span><span class="keyword">= </span><span class="string">'pointer.png'</span><span class="keyword">; </span><span class="comment">// must have no transparency, but white background<br />
</span><span class="keyword">list(</span><span class="default">$ptr_w</span><span class="keyword">, </span><span class="default">$ptr_h</span><span class="keyword">, </span><span class="default">$ptr_t</span><span class="keyword">, </span><span class="default">$ptr_a</span><span class="keyword">) = </span><span class="default">getimagesize</span><span class="keyword">(</span><span class="default">$ptr_file</span><span class="keyword">);<br />
<br />
</span><span class="comment">// destination image dimensions:<br />
</span><span class="default">$dst_w </span><span class="keyword">= </span><span class="default">400</span><span class="keyword">;<br />
</span><span class="default">$dst_h </span><span class="keyword">= </span><span class="default">200</span><span class="keyword">;<br />
<br />
</span><span class="comment">// pointer position:<br />
</span><span class="default">$ptr_x </span><span class="keyword">= </span><span class="default">195</span><span class="keyword">;<br />
</span><span class="default">$ptr_y </span><span class="keyword">= </span><span class="default">70</span><span class="keyword">;<br />
<br />
</span><span class="default">$srcImage </span><span class="keyword">= </span><span class="default">imageCreateFromJpeg</span><span class="keyword">(</span><span class="default">$src_file</span><span class="keyword">) or die (</span><span class="string">'failed imageCreateFromJpg'</span><span class="keyword">); <br />
</span><span class="default">$dstImage </span><span class="keyword">= </span><span class="default">imageCreateTrueColor</span><span class="keyword">(</span><span class="default">$dst_w</span><span class="keyword">, </span><span class="default">$dst_h</span><span class="keyword">) or die (</span><span class="string">'failed imageCreateTrueColor'</span><span class="keyword">); <br />
<br />
</span><span class="default">imageCopyResampled</span><span class="keyword">(</span><span class="default">$dstImage</span><span class="keyword">, </span><span class="default">$srcImage</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$dst_w</span><span class="keyword">, </span><span class="default">$dst_h</span><span class="keyword">, </span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">) or die (</span><span class="string">'failed imageCopyResampled'</span><span class="keyword">); <br />
<br />
</span><span class="default">$ptrImage </span><span class="keyword">= </span><span class="default">imageCreateFromPng</span><span class="keyword">(</span><span class="default">$ptr_file</span><span class="keyword">) or die (</span><span class="string">'failed imageCreateFromPng'</span><span class="keyword">); <br />
<br />
</span><span class="default">$ptr_white </span><span class="keyword">= </span><span class="default">imageColorAllocate</span><span class="keyword">(</span><span class="default">$ptrImage</span><span class="keyword">,</span><span class="default">255</span><span class="keyword">,</span><span class="default">255</span><span class="keyword">,</span><span class="default">255</span><span class="keyword">);<br />
</span><span class="default">imageColorTransparent</span><span class="keyword">(</span><span class="default">$ptrImage</span><span class="keyword">,</span><span class="default">$ptr_white</span><span class="keyword">);<br />
<br />
</span><span class="default">imageCopyMerge</span><span class="keyword">(</span><span class="default">$dstImage</span><span class="keyword">, </span><span class="default">$ptrImage</span><span class="keyword">, </span><span class="default">$ptr_x</span><span class="keyword">, </span><span class="default">$ptr_y</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$ptr_w</span><span class="keyword">, </span><span class="default">$ptr_h</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">) or die (</span><span class="string">'failed imageCopyMerge'</span><span class="keyword">);<br />
<br />
</span><span class="default">imageJpeg</span><span class="keyword">(</span><span class="default">$dstImage</span><span class="keyword">,</span><span class="string">''</span><span class="keyword">,</span><span class="default">100</span><span class="keyword">) or die (</span><span class="string">'failed imageJpeg'</span><span class="keyword">);<br />
<br />
</span><span class="default">imageDestroy</span><span class="keyword">(</span><span class="default">$srcImage</span><span class="keyword">) or die (</span><span class="string">'failed imageDestroy(1)'</span><span class="keyword">);<br />
</span><span class="default">imageDestroy</span><span class="keyword">(</span><span class="default">$dstImage</span><span class="keyword">) or die (</span><span class="string">'failed imageDestroy(2)'</span><span class="keyword">);<br />
</span><span class="default">imageDestroy</span><span class="keyword">(</span><span class="default">$ptrImage</span><span class="keyword">) or die (</span><span class="string">'failed imageDestroy(3)'</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="48169""></a>
  <div class="note">
   <strong class="user">jtacon at php dot net</strong>
   <a href="#48169" class="date">14-Dec-2004 05:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This example shows how to use imageCopyMerge to create a water mark function with four random positions (the corners).<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">waterMark</span><span class="keyword">(</span><span class="default">$fileInHD</span><span class="keyword">, </span><span class="default">$wmFile</span><span class="keyword">, </span><span class="default">$transparency </span><span class="keyword">= </span><span class="default">50</span><span class="keyword">, </span><span class="default">$jpegQuality </span><span class="keyword">= </span><span class="default">90</span><span class="keyword">, </span><span class="default">$margin </span><span class="keyword">= </span><span class="default">5</span><span class="keyword">) {<br />
<br />
&nbsp;</span><span class="default">$wmImg&nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">imageCreateFromGIF</span><span class="keyword">(</span><span class="default">$wmFile</span><span class="keyword">);<br />
&nbsp;</span><span class="default">$jpegImg </span><span class="keyword">= </span><span class="default">imageCreateFromJPEG</span><span class="keyword">(</span><span class="default">$fileInHD</span><span class="keyword">);<br />
<br />
&nbsp;</span><span class="comment">// Water mark random position<br />
&nbsp;</span><span class="default">$wmX </span><span class="keyword">= (bool)</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">) ? </span><span class="default">$margin </span><span class="keyword">: (</span><span class="default">imageSX</span><span class="keyword">(</span><span class="default">$jpegImg</span><span class="keyword">) - </span><span class="default">imageSX</span><span class="keyword">(</span><span class="default">$wmImg</span><span class="keyword">)) - </span><span class="default">$margin</span><span class="keyword">;<br />
&nbsp;</span><span class="default">$wmY </span><span class="keyword">= (bool)</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">) ? </span><span class="default">$margin </span><span class="keyword">: (</span><span class="default">imageSY</span><span class="keyword">(</span><span class="default">$jpegImg</span><span class="keyword">) - </span><span class="default">imageSY</span><span class="keyword">(</span><span class="default">$wmImg</span><span class="keyword">)) - </span><span class="default">$margin</span><span class="keyword">;<br />
<br />
&nbsp;</span><span class="comment">// Water mark process<br />
&nbsp;</span><span class="default">imageCopyMerge</span><span class="keyword">(</span><span class="default">$jpegImg</span><span class="keyword">, </span><span class="default">$wmImg</span><span class="keyword">, </span><span class="default">$wmX</span><span class="keyword">, </span><span class="default">$wmY</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">imageSX</span><span class="keyword">(</span><span class="default">$wmImg</span><span class="keyword">), </span><span class="default">imageSY</span><span class="keyword">(</span><span class="default">$wmImg</span><span class="keyword">), </span><span class="default">$transparency</span><span class="keyword">);<br />
<br />
&nbsp;</span><span class="comment">// Overwriting image<br />
&nbsp;</span><span class="default">ImageJPEG</span><span class="keyword">(</span><span class="default">$jpegImg</span><span class="keyword">, </span><span class="default">$fileInHD</span><span class="keyword">, </span><span class="default">$jpegQuality</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="default">waterMark</span><span class="keyword">(</span><span class="string">'myImage.jpg'</span><span class="keyword">,</span><span class="string">'waterMark.gif'</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
HTH.<br />
<br />
Javier Tac?n.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="42243""></a>
  <div class="note">
   <strong class="user">claudio dot gaetani at gdldesign dot it</strong>
   <a href="#42243" class="date">09-May-2004 11:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This function is intended to serve as an example for the "imageCopyMerge"-"ImageCopyResized", "ImageColorTransparent" functions. <br />
I hope it will help. <br />
This function pick an image, square cut it resampled at the size requested and finishing merge the result with another one to obtain a circular image result. I have a problem to obtain an thumbnail that respect the colors and at the same time where cutted in a circular form, I hope this solution can gives you a clue to obtain a free form images, I use this one also to create multicutted images.<br />
<br />
<span class="default">&lt;?php<br />
$generalsrc</span><span class="keyword">=</span><span class="string">"</span><span class="default">$image</span><span class="string">"</span><span class="keyword">; </span><span class="comment">//the image to resample, resize and iconaize<br />
</span><span class="default">$final_thumbwidth </span><span class="keyword">=</span><span class="string">"125"</span><span class="keyword">;<br />
</span><span class="default">$final_thumbheight </span><span class="keyword">=</span><span class="string">"125"</span><span class="keyword">;<br />
<br />
</span><span class="default">$abc </span><span class="keyword">= </span><span class="default">imagecreatefromjpeg</span><span class="keyword">(</span><span class="string">"</span><span class="default">$generalsrc</span><span class="string">"</span><span class="keyword">); <br />
</span><span class="default">$def </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$final_thumbwidth</span><span class="keyword">, </span><span class="default">$final_thumbheight</span><span class="keyword">); <br />
</span><span class="default">$src_mx </span><span class="keyword">= </span><span class="default">round</span><span class="keyword">((</span><span class="default">imagesx</span><span class="keyword">(</span><span class="default">$abc</span><span class="keyword">) / </span><span class="default">2</span><span class="keyword">)-</span><span class="string">"0.1"</span><span class="keyword">); </span><span class="comment">// middle x point of the image<br />
</span><span class="default">$src_my </span><span class="keyword">= </span><span class="default">round</span><span class="keyword">((</span><span class="default">imagesy</span><span class="keyword">(</span><span class="default">$abc</span><span class="keyword">) / </span><span class="default">2</span><span class="keyword">)-</span><span class="string">"0.1"</span><span class="keyword">); </span><span class="comment">// middle y point of the image<br />
</span><span class="default">$src_x </span><span class="keyword">= (</span><span class="default">$src_mx </span><span class="keyword">* </span><span class="default">2</span><span class="keyword">);<br />
</span><span class="default">$src_y </span><span class="keyword">= (</span><span class="default">$src_my </span><span class="keyword">* </span><span class="default">2</span><span class="keyword">);<br />
</span><span class="default">$src_sq </span><span class="keyword">= (</span><span class="default">$src_x </span><span class="keyword">&gt;= </span><span class="default">$src_y</span><span class="keyword">)?</span><span class="default">$src_y</span><span class="keyword">:</span><span class="default">$src_x</span><span class="keyword">; </span><span class="comment">//used to define the best size for a square cut of the image<br />
</span><span class="default">$pl </span><span class="keyword">= (</span><span class="default">$src_x </span><span class="keyword">&gt;= </span><span class="default">$src_y</span><span class="keyword">)?</span><span class="string">"1"</span><span class="keyword">:</span><span class="string">"2"</span><span class="keyword">; </span><span class="comment">//define if the image is portait or landscape<br />
</span><span class="default">$strt_pntx </span><span class="keyword">= (</span><span class="default">$pl</span><span class="keyword">==</span><span class="string">"1"</span><span class="keyword">)?</span><span class="default">round</span><span class="keyword">((</span><span class="default">$src_my </span><span class="keyword">/ </span><span class="default">2</span><span class="keyword">)-</span><span class="string">"0. 1"</span><span class="keyword">):</span><span class="string">"0"</span><span class="keyword">;&nbsp; </span><span class="comment">//defines the x start point<br />
</span><span class="default">$strt_pnty </span><span class="keyword">= (</span><span class="default">$pl</span><span class="keyword">==</span><span class="string">"2"</span><span class="keyword">)?</span><span class="default">round</span><span class="keyword">((</span><span class="default">$src_mx </span><span class="keyword">/ </span><span class="default">2</span><span class="keyword">)-</span><span class="string">"0. 1"</span><span class="keyword">):</span><span class="string">"0"</span><span class="keyword">;&nbsp; </span><span class="comment">//defines the y start point<br />
<br />
</span><span class="default">imagecopyresized</span><span class="keyword">(</span><span class="default">$def</span><span class="keyword">, </span><span class="default">$abc</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$strt_pntx</span><span class="keyword">, </span><span class="default">$strt_pnty</span><span class="keyword">, </span><span class="default">$final_thumbwidth</span><span class="keyword">, </span><span class="default">$final_thumbheight</span><span class="keyword">, </span><span class="default">$src_sq</span><span class="keyword">, </span><span class="default">$src_sq</span><span class="keyword">);<br />
<br />
</span><span class="default">$overlay_img </span><span class="keyword">= </span><span class="default">imagecreatefromPNG</span><span class="keyword">(</span><span class="string">"circle_125.png"</span><span class="keyword">); </span><span class="comment">//NOTE use png for this<br />
</span><span class="default">$src_w </span><span class="keyword">= </span><span class="string">"ImageSX(</span><span class="default">$overlay_img</span><span class="string">)"</span><span class="keyword">;<br />
</span><span class="default">$src_h&nbsp; </span><span class="keyword">= </span><span class="string">"ImageSY(</span><span class="default">$overlay_img</span><span class="string">)"</span><span class="keyword">;<br />
<br />
</span><span class="default">$can_img </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">);<br />
<br />
</span><span class="default">$black </span><span class="keyword">= </span><span class="default">ImageColorAllocate </span><span class="keyword">(</span><span class="default">$overlay_img</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
<br />
</span><span class="default">ImageColorTransparent</span><span class="keyword">(</span><span class="default">$overlay_img </span><span class="keyword">, </span><span class="default">$black</span><span class="keyword">);<br />
<br />
</span><span class="default">imagecopy</span><span class="keyword">(</span><span class="default">$can_img</span><span class="keyword">, </span><span class="default">$def</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">, </span><span class="default">$src_w</span><span class="keyword">, </span><span class="default">$src_h</span><span class="keyword">);<br />
</span><span class="default">imagecopymerge</span><span class="keyword">(</span><span class="default">$can_img</span><span class="keyword">, </span><span class="default">$overlay_img </span><span class="keyword">, </span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">, </span><span class="default">ImageSX</span><span class="keyword">(</span><span class="default">$overlay_img</span><span class="keyword">), </span><span class="default">ImageSY</span><span class="keyword">(</span><span class="default">$overlay_img</span><span class="keyword">),</span><span class="default">100</span><span class="keyword">); </span><span class="comment">//Imagecopy won't work, you must used imagecopymerge<br />
<br />
</span><span class="default">ImageJPEG</span><span class="keyword">(</span><span class="default">$can_img</span><span class="keyword">,</span><span class="string">"merge_</span><span class="default">$generalsrc</span><span class="string">"</span><span class="keyword">,</span><span class="default">100</span><span class="keyword">);<br />
<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$overlay_img</span><span class="keyword">);<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$can_img</span><span class="keyword">);<br />
</span><span class="default">ImageDestroy</span><span class="keyword">(</span><span class="default">$abc</span><span class="keyword">); <br />
</span><span class="default">ImageDestroy</span><span class="keyword">(</span><span class="default">$def</span><span class="keyword">); <br />
<br />
print </span><span class="string">"&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;test&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;<br />
original:&lt;hr&gt;&lt;img src=\"</span><span class="default">$generalsrc</span><span class="string">\" width=\"300\"&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;new:&lt;hr&gt;&lt;img src=\"merge_</span><span class="default">$generalsrc</span><span class="string">\"&gt;<br />
&lt;br&gt;width = </span><span class="default">$src_x</span><span class="string"><br />
&lt;br&gt;height = </span><span class="default">$src_y</span><span class="string"><br />
&lt;br&gt;mdlw = </span><span class="default">$src_mx</span><span class="string"><br />
&lt;br&gt;mdlh = </span><span class="default">$src_my</span><span class="string"><br />
&lt;br&gt;sqr = </span><span class="default">$src_sq</span><span class="string"><br />
&lt;br&gt;pl = </span><span class="default">$pl</span><span class="string"><br />
&lt;br&gt;start point x = </span><span class="default">$strt_pntx</span><span class="string"><br />
&lt;br&gt;start point y = </span><span class="default">$strt_pnty</span><span class="string"><br />
&lt;/BODY&gt;&lt;/HTML&gt;"</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="32393""></a>
  <div class="note">
   <strong class="user">bjorn AT smokingmedia DOT com</strong>
   <a href="#32393" class="date">26-May-2003 11:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
in addition to stefan's posting:<br />
<br />
i found that if you use imagecopymerge with png-24 files with an alpha channel, it doesn't work use imagecopy instead.<br />
it seems that imagecopymerge doesn't respect the alpha channel the way it should (a bug??).<br />
<br />
some sample code here to place an image (image.png) on a backgroundcolor or backgroundimage.<br />
<br />
<span class="default">&lt;?php<br />
<br />
$im </span><span class="keyword">= </span><span class="string">"image.png"</span><span class="keyword">;<br />
</span><span class="default">$bg </span><span class="keyword">= </span><span class="string">"ffddee"</span><span class="keyword">;&nbsp; &nbsp;&nbsp; </span><span class="comment">// hex representation of the color (i.e. #ffffff for white)<br />
</span><span class="default">$out </span><span class="keyword">= </span><span class="string">"png"</span><span class="keyword">;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// or "jpg" for jpg file output<br />
// $backgroundfile = "";&nbsp; // optional backgroundfile if you don't want to use a color<br />
<br />
//<br />
// function to convert hex colorcode to decimal<br />
//<br />
<br />
</span><span class="keyword">function </span><span class="default">colordecode</span><span class="keyword">(</span><span class="default">$hex</span><span class="keyword">){<br />
<br />
&nbsp;&nbsp; </span><span class="default">$code</span><span class="keyword">[</span><span class="default">r</span><span class="keyword">] = </span><span class="default">hexdec</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$hex</span><span class="keyword">, </span><span class="default">0 </span><span class="keyword">,</span><span class="default">2</span><span class="keyword">));<br />
&nbsp;&nbsp; </span><span class="default">$code</span><span class="keyword">[</span><span class="default">g</span><span class="keyword">] = </span><span class="default">hexdec</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$hex</span><span class="keyword">, </span><span class="default">2 </span><span class="keyword">,</span><span class="default">2</span><span class="keyword">));<br />
&nbsp;&nbsp; </span><span class="default">$code</span><span class="keyword">[</span><span class="default">b</span><span class="keyword">] = </span><span class="default">hexdec</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$hex</span><span class="keyword">, </span><span class="default">4 </span><span class="keyword">,</span><span class="default">2</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp; return </span><span class="default">$code</span><span class="keyword">;<br />
<br />
} </span><span class="comment">// end func colordecode<br />
<br />
// create the resource id<br />
</span><span class="default">$image_id </span><span class="keyword">= </span><span class="default">imageCreateFromPNG</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">);<br />
<br />
</span><span class="comment">// get image size<br />
</span><span class="default">$im_X </span><span class="keyword">= </span><span class="default">ImageSX</span><span class="keyword">(</span><span class="default">$image_id</span><span class="keyword">);<br />
</span><span class="default">$im_Y </span><span class="keyword">= </span><span class="default">ImageSY</span><span class="keyword">(</span><span class="default">$image_id</span><span class="keyword">);<br />
<br />
</span><span class="comment">// create a truecolor background image of the right size<br />
// or use a background image like this<br />
// $backgroundimage = imageCreateFromPNG($backgroundfile);<br />
</span><span class="default">$backgroundimage </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$im_X</span><span class="keyword">, </span><span class="default">$im_Y</span><span class="keyword">);<br />
<br />
</span><span class="comment">// get the desired backgroundcolor:<br />
// don't use this if you want to use a background image<br />
</span><span class="default">$code </span><span class="keyword">= </span><span class="default">colordecode</span><span class="keyword">(</span><span class="default">$bg</span><span class="keyword">);<br />
</span><span class="default">$backgroundcolor </span><span class="keyword">= </span><span class="default">ImageColorAllocate</span><span class="keyword">(</span><span class="default">$backgroundimage</span><span class="keyword">, </span><span class="default">$code</span><span class="keyword">[</span><span class="default">r</span><span class="keyword">], </span><span class="default">$code</span><span class="keyword">[</span><span class="default">g</span><span class="keyword">], </span><span class="default">$code</span><span class="keyword">[</span><span class="default">b</span><span class="keyword">]);<br />
</span><span class="default">ImageFilledRectangle</span><span class="keyword">(</span><span class="default">$backgroundimage</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$im_X</span><span class="keyword">, </span><span class="default">$im_Y</span><span class="keyword">, </span><span class="default">$backgroundcolor</span><span class="keyword">);<br />
<br />
</span><span class="comment">// merge the two together with alphablending on!<br />
</span><span class="default">ImageAlphaBlending</span><span class="keyword">(</span><span class="default">$backgroundimage</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
</span><span class="default">imagecopy</span><span class="keyword">(</span><span class="default">$backgroundimage</span><span class="keyword">, </span><span class="default">$image_id</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$im_X</span><span class="keyword">, </span><span class="default">$im_Y</span><span class="keyword">);<br />
<br />
</span><span class="comment">// output the image:<br />
</span><span class="keyword">if(</span><span class="default">$output </span><span class="keyword">== </span><span class="string">"jpg"</span><span class="keyword">){<br />
&nbsp;&nbsp; </span><span class="default">Header</span><span class="keyword">( </span><span class="string">"Content-type: image/jpeg"</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">ImageJPEG</span><span class="keyword">(</span><span class="default">$backgroundimage</span><span class="keyword">);<br />
&nbsp;&nbsp; }<br />
&nbsp;&nbsp; else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">Header</span><span class="keyword">( </span><span class="string">"Content-type: image/png"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">ImagePNG</span><span class="keyword">(</span><span class="default">$backgroundimage</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; }<br />
<br />
</span><span class="comment">// destroy the memory<br />
</span><span class="default">ImageDestroy</span><span class="keyword">(</span><span class="default">$backgroundimage</span><span class="keyword">);<br />
</span><span class="default">ImageDestroy</span><span class="keyword">(</span><span class="default">$image_id</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="25585""></a>
  <div class="note">
   <strong class="user">jonny at sanriowasteland dot net</strong>
   <a href="#25585" class="date">29-Sep-2002 05:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you need to merge 2 png's (or&nbsp; presumably 2 gifs) with different color palettes, I have found this is the function to use.&nbsp; Just set pct to 99, and you are rocking.&nbsp; With pct set to 100, or imagecopy for that matter, the palette seems to go wonky.&nbsp; (It probably just uses the palette of the source image. but don't quote me on that).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="14316""></a>
  <div class="note">
   <strong class="user">stefan dot wehowsky at profilschmiede dot de</strong>
   <a href="#14316" class="date">26-Jul-2001 09:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This function is intended to serve as an example for the "imageCopyMerge"-function.
<br />
I hope it will help some of the less experienced php-coders here.
<br />
I wrote it to mark objects of a real estate broker as "sold" by copying the "sold"-picture right into the picture of the house.
<br />

<br />
<span class="default">&lt;?php
<br />

<br />
</span><span class="comment">//$sourcefile = Filename of the picture into that $insertfile will be inserted.
<br />
//$insertfile = Filename of the picture that is to be inserted into $sourcefile.
<br />
//$targetfile = Filename of the modified picture.
<br />
//$transition = Intensity of the transition (in percent)
<br />
//$pos&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = Position where $insertfile will be inserted in $sourcefile
<br />
//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 = middle
<br />
//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 = top left
<br />
//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 = top right
<br />
//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3 = bottom right
<br />
//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 = bottom left
<br />
//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 = top middle
<br />
//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6 = middle right
<br />
//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7 = bottom middle
<br />
//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8 = middle left
<br />
//
<br />
//
<br />
</span><span class="keyword">function </span><span class="default">mergePix</span><span class="keyword">(</span><span class="default">$sourcefile</span><span class="keyword">,</span><span class="default">$insertfile</span><span class="keyword">, </span><span class="default">$targetfile</span><span class="keyword">, </span><span class="default">$pos</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">,</span><span class="default">$transition</span><span class="keyword">=</span><span class="default">50</span><span class="keyword">)
<br />
{
<br />
&nbsp;&nbsp;&nbsp; 
<br />
</span><span class="comment">//Get the resource id?s of the pictures
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$insertfile_id </span><span class="keyword">= </span><span class="default">imageCreateFromJPEG</span><span class="keyword">(</span><span class="default">$insertfile</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sourcefile_id </span><span class="keyword">= </span><span class="default">imageCreateFromJPEG</span><span class="keyword">(</span><span class="default">$sourcefile</span><span class="keyword">);
<br />

<br />
</span><span class="comment">//Get the sizes of both pix&nbsp; &nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sourcefile_width</span><span class="keyword">=</span><span class="default">imageSX</span><span class="keyword">(</span><span class="default">$sourcefile_id</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sourcefile_height</span><span class="keyword">=</span><span class="default">imageSY</span><span class="keyword">(</span><span class="default">$sourcefile_id</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$insertfile_width</span><span class="keyword">=</span><span class="default">imageSX</span><span class="keyword">(</span><span class="default">$insertfile_id</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$insertfile_height</span><span class="keyword">=</span><span class="default">imageSY</span><span class="keyword">(</span><span class="default">$insertfile_id</span><span class="keyword">);
<br />

<br />
</span><span class="comment">//middle
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">$pos </span><span class="keyword">== </span><span class="default">0 </span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_x </span><span class="keyword">= ( </span><span class="default">$sourcefile_width </span><span class="keyword">/ </span><span class="default">2 </span><span class="keyword">) - ( </span><span class="default">$insertfile_width </span><span class="keyword">/ </span><span class="default">2 </span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_y </span><span class="keyword">= ( </span><span class="default">$sourcefile_height </span><span class="keyword">/ </span><span class="default">2 </span><span class="keyword">) - ( </span><span class="default">$insertfile_height </span><span class="keyword">/ </span><span class="default">2 </span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; }
<br />

<br />
</span><span class="comment">//top left
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">$pos </span><span class="keyword">== </span><span class="default">1 </span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_x </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_y </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />

<br />
</span><span class="comment">//top right
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">$pos </span><span class="keyword">== </span><span class="default">2 </span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_x </span><span class="keyword">= </span><span class="default">$sourcefile_width </span><span class="keyword">- </span><span class="default">$insertfile_width</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_y </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />

<br />
</span><span class="comment">//bottom right
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">$pos </span><span class="keyword">== </span><span class="default">3 </span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_x </span><span class="keyword">= </span><span class="default">$sourcefile_width </span><span class="keyword">- </span><span class="default">$insertfile_width</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_y </span><span class="keyword">= </span><span class="default">$sourcefile_height </span><span class="keyword">- </span><span class="default">$insertfile_height</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />

<br />
</span><span class="comment">//bottom left&nbsp; &nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">$pos </span><span class="keyword">== </span><span class="default">4 </span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_x </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_y </span><span class="keyword">= </span><span class="default">$sourcefile_height </span><span class="keyword">- </span><span class="default">$insertfile_height</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />

<br />
</span><span class="comment">//top middle
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">$pos </span><span class="keyword">== </span><span class="default">5 </span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_x </span><span class="keyword">= ( ( </span><span class="default">$sourcefile_width </span><span class="keyword">- </span><span class="default">$insertfile_width </span><span class="keyword">) / </span><span class="default">2 </span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_y </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />

<br />
</span><span class="comment">//middle right
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">$pos </span><span class="keyword">== </span><span class="default">6 </span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_x </span><span class="keyword">= </span><span class="default">$sourcefile_width </span><span class="keyword">- </span><span class="default">$insertfile_width</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_y </span><span class="keyword">= ( </span><span class="default">$sourcefile_height </span><span class="keyword">/ </span><span class="default">2 </span><span class="keyword">) - ( </span><span class="default">$insertfile_height </span><span class="keyword">/ </span><span class="default">2 </span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 
<br />
</span><span class="comment">//bottom middle&nbsp; &nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">$pos </span><span class="keyword">== </span><span class="default">7 </span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_x </span><span class="keyword">= ( ( </span><span class="default">$sourcefile_width </span><span class="keyword">- </span><span class="default">$insertfile_width </span><span class="keyword">) / </span><span class="default">2 </span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_y </span><span class="keyword">= </span><span class="default">$sourcefile_height </span><span class="keyword">- </span><span class="default">$insertfile_height</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />

<br />
</span><span class="comment">//middle left
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">$pos </span><span class="keyword">== </span><span class="default">8 </span><span class="keyword">)
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_x </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dest_y </span><span class="keyword">= ( </span><span class="default">$sourcefile_height </span><span class="keyword">/ </span><span class="default">2 </span><span class="keyword">) - ( </span><span class="default">$insertfile_height </span><span class="keyword">/ </span><span class="default">2 </span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; 
<br />
</span><span class="comment">//The main thing : merge the two pix&nbsp; &nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imageCopyMerge</span><span class="keyword">(</span><span class="default">$sourcefile_id</span><span class="keyword">, </span><span class="default">$insertfile_id</span><span class="keyword">,</span><span class="default">$dest_x</span><span class="keyword">,</span><span class="default">$dest_y</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$insertfile_width</span><span class="keyword">,</span><span class="default">$insertfile_height</span><span class="keyword">,</span><span class="default">$transition</span><span class="keyword">);
<br />

<br />
</span><span class="comment">//Create a jpeg out of the modified picture
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagejpeg </span><span class="keyword">(</span><span class="default">$sourcefile_id</span><span class="keyword">,</span><span class="string">"</span><span class="default">$targetfile</span><span class="string">"</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; 
<br />
}</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
