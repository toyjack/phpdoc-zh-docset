<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>Runs the select() system call on the given arrays of sockets with a specified timeout</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.socket-recvmsg.html">? socket_recvmsg</a></li>
      <li style="float: right;"><a href="function.socket-send.html">socket_send ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.sockets.html">Socket 函数</a></li>
    <li>Runs the select() system call on the given arrays of sockets with a specified timeout</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.socket-select" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">socket_select</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.1.0, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">socket_select</span> &mdash; <span class="dc-title">Runs the select() system call on the given arrays of sockets with a specified timeout</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.socket-select-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>socket_select</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">array</span><span class="type"></span></span> <code class="parameter reference">&$read</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">array</span><span class="type"></span></span> <code class="parameter reference">&$write</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">array</span><span class="type"></span></span> <code class="parameter reference">&$except</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">int</span><span class="type"></span></span> <code class="parameter">$seconds</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$microseconds</code><span class="initializer"> = 0</span></span><br>): <span class="type"><span class="type">int</span>|<span class="type"><span class="type false">false</span></span></span></div>

  <p class="para rdfs-comment">
   <span class="function"><strong>socket_select()</strong></span> accepts arrays of sockets and waits for
   them to change status. Those coming with BSD sockets background will
   recognize that those socket arrays are in fact the so-called file
   descriptor sets. Three independent arrays of sockets are watched.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.socket-select-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">read</code></dt>

     <dd>

      <p class="para">
       The sockets listed in the <code class="parameter">read</code> array will be
       watched to see if characters become available for reading (more
       precisely, to see if a read will not block - in particular, a socket
       is also ready on end-of-file, in which case a
       <span class="function"><a href="function.socket-read.html" class="function">socket_read()</a></span> will return a zero length string).
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">write</code></dt>

     <dd>

      <p class="para">
       The sockets listed in the <code class="parameter">write</code> array will be
       watched to see if a write will not block.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">except</code></dt>

     <dd>

      <p class="para">
       The sockets listed in the <code class="parameter">except</code> array will be
       watched for exceptions.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">seconds</code></dt>

     <dd>

      <p class="para">
       The <code class="parameter">seconds</code> and <code class="parameter">microseconds</code>
       together form the <code class="literal">timeout</code> parameter. The
       <code class="literal">timeout</code> is an upper bound on the amount of time
       elapsed before <span class="function"><strong>socket_select()</strong></span> return.
       <code class="parameter">seconds</code> may be zero , causing
       <span class="function"><strong>socket_select()</strong></span> to return immediately. This is useful
       for polling. If <code class="parameter">seconds</code> is <strong><code>null</code></strong> (no timeout),
       <span class="function"><strong>socket_select()</strong></span> can block indefinitely.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">microseconds</code></dt>

     <dd>

      <p class="para">
      </p>
     </dd>

    
   </dl>

  </p>
  <div class="warning"><strong class="warning">Warning</strong>
   <p class="para">
    On exit, the arrays are modified to indicate which socket
    actually changed status.
   </p>
  </div>
  <p class="para">
   You do not need to pass every array to
   <span class="function"><strong>socket_select()</strong></span>. You can leave it out and use an
   empty array or <strong><code>null</code></strong> instead. Also do not forget that those arrays are
   passed <em class="emphasis">by reference</em> and will be modified after
   <span class="function"><strong>socket_select()</strong></span> returns.
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    Due a limitation in the current Zend Engine it is not possible to pass a
    constant modifier like <strong><code>null</code></strong> directly as a parameter to a function
    which expects this parameter to be passed by reference. Instead use a
    temporary variable or an expression with the leftmost member being a
    temporary variable:
    <div class="example" id="example-4413">
     <p><strong>Example #1 Using <strong><code>null</code></strong> with <span class="function"><strong>socket_select()</strong></span></strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$e&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">socket_select</span><span style="color: #007700">(</span><span style="color: #0000BB">$r</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$w</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$e</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

    </div>
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.socket-select-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   On success <span class="function"><strong>socket_select()</strong></span> returns the number of
   sockets contained in the modified arrays, which may be zero if
   the timeout expires before anything interesting happens.On error <strong><code>false</code></strong>
   is returned. The error code can be retrieved with
   <span class="function"><a href="function.socket-last-error.html" class="function">socket_last_error()</a></span>.
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    Be sure to use the <code class="literal">===</code> operator when checking for an
    error. Since the <span class="function"><strong>socket_select()</strong></span> may return 0 the
    comparison with <code class="literal">==</code> would evaluate to <strong><code>true</code></strong>:
    <div class="example" id="example-4414">
     <p><strong>Example #2 Understanding <span class="function"><strong>socket_select()</strong></span>&#039;s result</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$e&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br />if&nbsp;(</span><span style="color: #0000BB">false&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">socket_select</span><span style="color: #007700">(</span><span style="color: #0000BB">$r</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$w</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$e</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"socket_select()&nbsp;failed,&nbsp;reason:&nbsp;"&nbsp;</span><span style="color: #007700">.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">socket_strerror</span><span style="color: #007700">(</span><span style="color: #0000BB">socket_last_error</span><span style="color: #007700">())&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

    </div>
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 examples" id="refsect1-function.socket-select-examples">
  <h3 class="title">范例</h3>
  <p class="para">
   <div class="example" id="example-4415">
    <p><strong>Example #3 <span class="function"><strong>socket_select()</strong></span> example</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;Prepare&nbsp;the&nbsp;read&nbsp;array&nbsp;*/<br /></span><span style="color: #0000BB">$read&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #0000BB">$socket1</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$socket2</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$write&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$except&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$num_changed_sockets&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">socket_select</span><span style="color: #007700">(</span><span style="color: #0000BB">$read</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$write</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$except</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">);<br /><br />if&nbsp;(</span><span style="color: #0000BB">$num_changed_sockets&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Error&nbsp;handling&nbsp;*/<br /></span><span style="color: #007700">}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000BB">$num_changed_sockets&nbsp;</span><span style="color: #007700">&gt;&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;At&nbsp;least&nbsp;at&nbsp;one&nbsp;of&nbsp;the&nbsp;sockets&nbsp;something&nbsp;interesting&nbsp;happened&nbsp;*/<br /></span><span style="color: #007700">}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.socket-select-notes">
  <h3 class="title">注释</h3>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    Be aware that some socket implementations need to be handled very
    carefully. A few basic rules:
    <ul class="itemizedlist">
     <li class="listitem">
      <span class="simpara">
       You should always try to use <span class="function"><strong>socket_select()</strong></span>
       without timeout. Your program should have nothing to do if there is
       no data available. Code that depends on timeouts is not usually
       portable and difficult to debug.
      </span>
     </li>
     <li class="listitem">
      <span class="simpara">
       No socket must be added to any set if you do not intend to
       check its result after the <span class="function"><strong>socket_select()</strong></span> call,
       and respond appropriately. After <span class="function"><strong>socket_select()</strong></span>
       returns, all sockets in all arrays must be checked. Any
       socket that is available for writing must be written to, and
       any socket available for reading must be read from.
      </span>
     </li>
     <li class="listitem">
      <span class="simpara">
       If you read/write to a socket returns in the arrays be aware that
       they do not necessarily read/write the full amount of data you have
       requested. Be prepared to even only be able to read/write a single
       byte.
      </span>
     </li>
     <li class="listitem">
      <span class="simpara">
       It&#039;s common to most socket implementations that the only exception
       caught with the <code class="parameter">except</code> array is out-of-bound
       data received on a socket.
      </span>
     </li>
    </ul>
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.socket-select-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.socket-read.html" class="function" rel="rdfs-seeAlso">socket_read()</a> - 从套接字中读取最大长度的数据</span></li>
    <li class="member"><span class="function"><a href="function.socket-write.html" class="function" rel="rdfs-seeAlso">socket_write()</a> - Write to a socket</span></li>
    <li class="member"><span class="function"><a href="function.socket-last-error.html" class="function" rel="rdfs-seeAlso">socket_last_error()</a> - Returns the last error on the socket</span></li>
    <li class="member"><span class="function"><a href="function.socket-strerror.html" class="function" rel="rdfs-seeAlso">socket_strerror()</a> - Return a string describing a socket error</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="124613""></a>
  <div class="note">
   <strong class="user">juanfe0245 at gmail dot com</strong>
   <a href="#124613" class="date">14-Jan-2020 09:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php<br />
</span><span class="comment">//Creamos un socket de transmisión de tipo TCP / IP.<br />
</span><span class="default">$servidorSocket</span><span class="keyword">=</span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">SOL_TCP</span><span class="keyword">);<br />
</span><span class="comment">//Configuramos la opción para reutilizar el puerto.<br />
</span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$servidorSocket</span><span class="keyword">,</span><span class="default">SOL_SOCKET</span><span class="keyword">,</span><span class="default">SO_REUSEADDR</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">);<br />
</span><span class="comment">/*<br />
&nbsp;&nbsp;&nbsp; Vinculamos el socket a nuestro puerto y dirección IP.<br />
&nbsp;&nbsp;&nbsp; Ahora, todas las conecciones en este puerto son nuestro responsabilidad para recibir y enviar datos.<br />
*/<br />
</span><span class="default">socket_bind</span><span class="keyword">(</span><span class="default">$servidorSocket</span><span class="keyword">,</span><span class="string">'localhost'</span><span class="keyword">,</span><span class="default">9000</span><span class="keyword">);<br />
</span><span class="comment">//Comenzamos a escuchar conexiones.<br />
</span><span class="default">socket_listen</span><span class="keyword">(</span><span class="default">$servidorSocket</span><span class="keyword">);<br />
</span><span class="comment">/*<br />
&nbsp;&nbsp;&nbsp; Creamos un arreglo con todos los clientes que se conectarán a nuestro servidor.<br />
&nbsp;&nbsp;&nbsp; A?adimos nuestro socket servidor al arreglo de clientes.<br />
*/<br />
</span><span class="default">$clientes</span><span class="keyword">=[</span><span class="default">$servidorSocket</span><span class="keyword">];<br />
</span><span class="default">$null</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">;<br />
while(</span><span class="default">true</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//Creamos una copia de $clientes, debido a que $clientes no se modifica por la función socket_select().<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$nuevoClienteLector</span><span class="keyword">=</span><span class="default">$clientes</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//Obtenemos una lista de todos los clientes que tienen datos para leer.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_select</span><span class="keyword">(</span><span class="default">$nuevoClienteLector</span><span class="keyword">,</span><span class="default">$null</span><span class="keyword">,</span><span class="default">$null</span><span class="keyword">,</span><span class="default">10</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//Verificamos si hay un cliente tratando de conectarse.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">in_array</span><span class="keyword">(</span><span class="default">$servidorSocket</span><span class="keyword">,</span><span class="default">$nuevoClienteLector</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Aceptamos el cliente y lo a?adimos al arreglo de $clientes.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$nuevoCliente</span><span class="keyword">=</span><span class="default">socket_accept</span><span class="keyword">(</span><span class="default">$servidorSocket</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Socket aceptado.\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$clientes</span><span class="keyword">[]=</span><span class="default">$nuevoCliente</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Obtenemos el encabezado del cliente y realizamos la comprobación del handshake.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$encabezado</span><span class="keyword">=</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$nuevoCliente</span><span class="keyword">,</span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">handshake</span><span class="keyword">(</span><span class="default">$nuevoCliente</span><span class="keyword">,</span><span class="default">$encabezado</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Eliminamos el cliente del arreglo $nuevoClienteLector.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$nuevoClienteIndex</span><span class="keyword">=</span><span class="default">array_search</span><span class="keyword">(</span><span class="default">$servidorSocket</span><span class="keyword">,</span><span class="default">$nuevoClienteLector</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$nuevoClienteLector</span><span class="keyword">[</span><span class="default">$nuevoClienteIndex</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//Recorremos todos los clientes que tienen datos por leer.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">foreach(</span><span class="default">$nuevoClienteLector </span><span class="keyword">as </span><span class="default">$cliente</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Recibimos información del cliente conectado.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while(</span><span class="default">socket_recv</span><span class="keyword">(</span><span class="default">$cliente</span><span class="keyword">,</span><span class="default">$datosCliente</span><span class="keyword">,</span><span class="default">1024</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">)&gt;=</span><span class="default">1</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Decodificamos el mensaje que viene en bytes.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$mensaje</span><span class="keyword">=</span><span class="default">decodificar</span><span class="keyword">(</span><span class="default">$datosCliente</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Enviamos el mensaje a todos los sockets conectados.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">enviar</span><span class="keyword">(</span><span class="default">$clientes</span><span class="keyword">,</span><span class="default">$mensaje</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="default">$mensaje</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break </span><span class="default">2</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Verificamos si el cliente esta desconectado.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$datosCliente</span><span class="keyword">=@</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$cliente</span><span class="keyword">,</span><span class="default">1024</span><span class="keyword">,</span><span class="default">PHP_NORMAL_READ</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$datosCliente</span><span class="keyword">===</span><span class="default">false</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$clienteIndex</span><span class="keyword">=</span><span class="default">array_search</span><span class="keyword">(</span><span class="default">$cliente</span><span class="keyword">,</span><span class="default">$clientes</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Eliminamos el cliente del arreglo $clientes.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">unset(</span><span class="default">$clientes</span><span class="keyword">[</span><span class="default">$clienteIndex</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Cliente desconectado.\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
function </span><span class="default">enviar</span><span class="keyword">(</span><span class="default">$clientes</span><span class="keyword">,</span><span class="default">$mensaje</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mensaje</span><span class="keyword">=</span><span class="default">codificar</span><span class="keyword">(</span><span class="default">$mensaje</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; foreach(</span><span class="default">$clientes </span><span class="keyword">as </span><span class="default">$cliente</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; @</span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$cliente</span><span class="keyword">,</span><span class="default">$mensaje</span><span class="keyword">,</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$mensaje</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$servidorSocket</span><span class="keyword">);<br />
function </span><span class="default">codificar</span><span class="keyword">(</span><span class="default">$socketData</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$b1 </span><span class="keyword">= </span><span class="default">0x80 </span><span class="keyword">| (</span><span class="default">0x1 </span><span class="keyword">&amp; </span><span class="default">0x0f</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$length </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$socketData</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">$length </span><span class="keyword">&lt;= </span><span class="default">125</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$header </span><span class="keyword">= </span><span class="default">pack</span><span class="keyword">(</span><span class="string">'CC'</span><span class="keyword">, </span><span class="default">$b1</span><span class="keyword">, </span><span class="default">$length</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; elseif(</span><span class="default">$length </span><span class="keyword">&gt; </span><span class="default">125 </span><span class="keyword">&amp;&amp; </span><span class="default">$length </span><span class="keyword">&lt; </span><span class="default">65536</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$header </span><span class="keyword">= </span><span class="default">pack</span><span class="keyword">(</span><span class="string">'CCn'</span><span class="keyword">, </span><span class="default">$b1</span><span class="keyword">, </span><span class="default">126</span><span class="keyword">, </span><span class="default">$length</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; elseif(</span><span class="default">$length </span><span class="keyword">&gt;= </span><span class="default">65536</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$header </span><span class="keyword">= </span><span class="default">pack</span><span class="keyword">(</span><span class="string">'CCNN'</span><span class="keyword">, </span><span class="default">$b1</span><span class="keyword">, </span><span class="default">127</span><span class="keyword">, </span><span class="default">$length</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$header</span><span class="keyword">.</span><span class="default">$socketData</span><span class="keyword">;<br />
}<br />
function </span><span class="default">decodificar</span><span class="keyword">(</span><span class="default">$socketData</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$length </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$socketData</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]) &amp; </span><span class="default">127</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">$length </span><span class="keyword">== </span><span class="default">126</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$masks </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$socketData</span><span class="keyword">, </span><span class="default">4</span><span class="keyword">, </span><span class="default">4</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$socketData</span><span class="keyword">, </span><span class="default">8</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; elseif(</span><span class="default">$length </span><span class="keyword">== </span><span class="default">127</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$masks </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$socketData</span><span class="keyword">, </span><span class="default">10</span><span class="keyword">, </span><span class="default">4</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$socketData</span><span class="keyword">, </span><span class="default">14</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$masks </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$socketData</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">, </span><span class="default">4</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$socketData</span><span class="keyword">, </span><span class="default">6</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$socketData </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">); ++</span><span class="default">$i</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$socketData </span><span class="keyword">.= </span><span class="default">$data</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] ^ </span><span class="default">$masks</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">%</span><span class="default">4</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$socketData</span><span class="keyword">;<br />
}<br />
function </span><span class="default">handshake</span><span class="keyword">(</span><span class="default">$client_socket_resource</span><span class="keyword">,</span><span class="default">$received_header</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$headers </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$lines </span><span class="keyword">= </span><span class="default">preg_split</span><span class="keyword">(</span><span class="string">"/\r\n/"</span><span class="keyword">, </span><span class="default">$received_header</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; foreach(</span><span class="default">$lines </span><span class="keyword">as </span><span class="default">$line</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="default">chop</span><span class="keyword">(</span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">'/\A(\S+): (.*)\z/'</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">, </span><span class="default">$matches</span><span class="keyword">)) </span><span class="default">$headers</span><span class="keyword">[</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]] = </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$secKey </span><span class="keyword">= </span><span class="default">$headers</span><span class="keyword">[</span><span class="string">'Sec-WebSocket-Key'</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$secAccept </span><span class="keyword">= </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">pack</span><span class="keyword">(</span><span class="string">'H*'</span><span class="keyword">, </span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$secKey </span><span class="keyword">. </span><span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span><span class="keyword">)));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$buffer&nbsp; </span><span class="keyword">= </span><span class="string">"HTTP/1.1 101 Web Socket Protocol Handshake\r\n" </span><span class="keyword">.<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"Upgrade: websocket\r\n" </span><span class="keyword">.<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"Connection: Upgrade\r\n" </span><span class="keyword">.<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"Sec-WebSocket-Accept:</span><span class="default">$secAccept</span><span class="string">\r\n\r\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$client_socket_resource</span><span class="keyword">,</span><span class="default">$buffer</span><span class="keyword">,</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">));<br />
}</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="123763""></a>
  <div class="note">
   <strong class="user">renmengyang567 at gmail dot com</strong>
   <a href="#123763" class="date">09-Apr-2019 12:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
&lt;explain&gt;<br />
&nbsp;A simple socket-select case ^_^<br />
<br />
<span class="default">&lt;?php<br />
$sock </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">getprotobyname</span><span class="keyword">(</span><span class="string">'tcp'</span><span class="keyword">));<br />
</span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="default">SOL_SOCKET</span><span class="keyword">, </span><span class="default">SO_REUSEADDR</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);<br />
</span><span class="default">socket_bind</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="string">'127.0.0.1'</span><span class="keyword">,</span><span class="default">5000</span><span class="keyword">);<br />
</span><span class="default">socket_listen</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">1024</span><span class="keyword">);<br />
</span><span class="default">$all_sock</span><span class="keyword">[(int)</span><span class="default">$sock</span><span class="keyword">] = </span><span class="default">$sock</span><span class="keyword">;<br />
<br />
while (</span><span class="default">true</span><span class="keyword">) { <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$read </span><span class="keyword">= </span><span class="default">$write </span><span class="keyword">= </span><span class="default">$except </span><span class="keyword">= [];<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tv_sec </span><span class="keyword">= </span><span class="default">5</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tv_usec </span><span class="keyword">= </span><span class="default">5000</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$read </span><span class="keyword">= </span><span class="default">$all_sock</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$changed </span><span class="keyword">= </span><span class="default">socket_select</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">, </span><span class="default">$write</span><span class="keyword">, </span><span class="default">$except</span><span class="keyword">, </span><span class="default">$tv_sec</span><span class="keyword">, </span><span class="default">$tv_sec</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">false </span><span class="keyword">== </span><span class="default">$changed</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print </span><span class="string">"[error]socket_select() failed <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; (" </span><span class="keyword">.</span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">()) . </span><span class="string">")\n"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$changed </span><span class="keyword">&lt; </span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; continue;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//var_dump($read);<br />
&nbsp;&nbsp;&nbsp; //sleep(2);<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$read </span><span class="keyword">as </span><span class="default">$rsock</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// 服务端连接<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$rsock </span><span class="keyword">=== </span><span class="default">$sock</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$client </span><span class="keyword">= </span><span class="default">socket_accept</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$all_sock</span><span class="keyword">[(int)</span><span class="default">$client</span><span class="keyword">] = </span><span class="default">$client</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {</span><span class="comment">//客户端连接 <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$msg</span><span class="keyword">= </span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$rsock</span><span class="keyword">, </span><span class="default">400</span><span class="keyword">,</span><span class="default">PHP_NORMAL_READ</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$msg </span><span class="keyword">!== </span><span class="string">''</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$msg</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="119675""></a>
  <div class="note">
   <strong class="user">malcolm.murphy</strong>
   <a href="#119675" class="date">31-Jul-2016 06:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This was mentioned by [Viorel] above but I think it warrants being repeated...<br />
<br />
The example provided by [vardhan ( at ) rogers ( dot ) com], while otherwise exceptional, uses the value int(0) for $tv_sec which will cause the iteration to loop as fast as possible, consequently using up any available CPU time.<br />
<br />
*** Ideally, $tv_sec should always be set to NULL ***, especially if you are using socket_select in a loop. If you must temporarily stop listening for events to perform another task, then the timeout should be as high as possible to reduce CPU strain (another note suggested preventing 100% CPU usage by setting a low $tv_usec value, which only makes the problem slightly less worse but does not solve it).<br />
<br />
Setting the timeout to an explicit null value is basically the same as setting it to infinite. The script will only execute the while loop once every time there is an event.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118501""></a>
  <div class="note">
   <strong class="user">antti r</strong>
   <a href="#118501" class="date">16-Dec-2015 12:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
as of 12/2015 and php 5.3.3, the socket_select() maximum sockets is still 1024 and not risable by process file limits (bash ulimit -n). PHP new compilation is required to raise the limits. Or one might rather choose forking or multiple binaries.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="113842""></a>
  <div class="note">
   <strong class="user">simon dot riget at gmail dot com</strong>
   <a href="#113842" class="date">07-Dec-2013 08:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A verry simple HTTP webserver written in PHP<br />
Run it in the shell with php &lt;name of file&gt; and test in in the browser with &lt;server address&gt;:8080/test<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="comment">// Reduce the amount of warnings displayed<br />
&nbsp; </span><span class="default">error_reporting</span><span class="keyword">(</span><span class="default">E_ALL </span><span class="keyword">^ </span><span class="default">E_NOTICE</span><span class="keyword">);<br />
<br />
&nbsp; </span><span class="comment">// Set up socket for listening <br />
&nbsp; </span><span class="default">$host_socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">SOL_TCP</span><span class="keyword">);<br />
&nbsp; if(!</span><span class="default">$host_socket</span><span class="keyword">) die(</span><span class="string">"Failed to start event server. socket_create: "</span><span class="keyword">. </span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">()).</span><span class="string">"\n"</span><span class="keyword">);<br />
<br />
&nbsp; </span><span class="comment">// set the option to reuse the port<br />
&nbsp; </span><span class="keyword">if(! </span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$host_socket</span><span class="keyword">, </span><span class="default">SOL_SOCKET</span><span class="keyword">, </span><span class="default">SO_REUSEADDR</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">) )<br />
&nbsp;&nbsp;&nbsp; die(</span><span class="string">"Failed to start event server. socket_set_option: "</span><span class="keyword">. </span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">()).</span><span class="string">"\n"</span><span class="keyword">);<br />
<br />
&nbsp; </span><span class="comment">// bind host socket to localhost or 0.0.0.0 on port 8080<br />
&nbsp; </span><span class="keyword">if(! </span><span class="default">socket_bind</span><span class="keyword">(</span><span class="default">$host_socket</span><span class="keyword">,</span><span class="string">"0.0.0.0"</span><span class="keyword">,</span><span class="default">8080</span><span class="keyword">) )<br />
&nbsp;&nbsp;&nbsp; die(</span><span class="string">"Failed to start event server. socket_bind: "</span><span class="keyword">. </span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">()).</span><span class="string">"\n"</span><span class="keyword">);<br />
<br />
&nbsp; </span><span class="comment">// start listening for connections<br />
&nbsp; </span><span class="keyword">if(! </span><span class="default">socket_listen</span><span class="keyword">(</span><span class="default">$host_socket</span><span class="keyword">,</span><span class="default">10</span><span class="keyword">) )<br />
&nbsp;&nbsp;&nbsp; die(</span><span class="string">"Failed to start event server. socket_listen: "</span><span class="keyword">.</span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">()).</span><span class="string">"\n"</span><span class="keyword">);<br />
<br />
&nbsp; while (</span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Make list of sockets to listen for changes in, including host<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$read </span><span class="keyword">= array(</span><span class="default">$host_socket</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// get a list of all the clients that have data to be read from<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ready</span><span class="keyword">=@</span><span class="default">socket_select</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">, </span><span class="default">$write </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">, </span><span class="default">$except </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$ready</span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp;&nbsp; die(</span><span class="string">"Failed to listen for clients: "</span><span class="keyword">. </span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">()));<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// a client request service<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">elseif(</span><span class="default">$ready</span><span class="keyword">&gt;</span><span class="default">0</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// accept new client<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$newsocket </span><span class="keyword">= </span><span class="default">socket_accept</span><span class="keyword">(</span><span class="default">$host_socket</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// Read from socket<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$input </span><span class="keyword">= </span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$newsocket</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; if(</span><span class="default">$input</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$client_header</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Read headers; Split into safe lines<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line</span><span class="keyword">=</span><span class="default">explode</span><span class="keyword">(</span><span class="string">"\n"</span><span class="keyword">,</span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">'/[^A-Za-z0-9\-+\n :;=%*?.,\/_]/'</span><span class="keyword">,</span><span class="string">''</span><span class="keyword">,</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$input</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">2000</span><span class="keyword">)));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Split request line into its parts<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">list(</span><span class="default">$client_header</span><span class="keyword">[</span><span class="string">"method"</span><span class="keyword">],</span><span class="default">$client_header</span><span class="keyword">[</span><span class="string">"url"</span><span class="keyword">],</span><span class="default">$client_header</span><span class="keyword">[</span><span class="string">"protocol"</span><span class="keyword">])=</span><span class="default">explode</span><span class="keyword">(</span><span class="string">" "</span><span class="keyword">,</span><span class="default">$line</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Remove the request line again.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">unset(</span><span class="default">$line</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Make key=value array of headers<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">foreach(</span><span class="default">$line </span><span class="keyword">as </span><span class="default">$l</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; list(</span><span class="default">$key</span><span class="keyword">,</span><span class="default">$val</span><span class="keyword">)=</span><span class="default">explode</span><span class="keyword">(</span><span class="string">": "</span><span class="keyword">,</span><span class="default">$l</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$key</span><span class="keyword">) </span><span class="default">$client_header</span><span class="keyword">[</span><span class="default">strtolower</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">)]=</span><span class="default">$val</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Get IP of client<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_getpeername</span><span class="keyword">(</span><span class="default">$newsocket</span><span class="keyword">, </span><span class="default">$client_header</span><span class="keyword">[</span><span class="string">'ip'</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Decode url<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$client_header</span><span class="keyword">+=(array)</span><span class="default">parse_url</span><span class="keyword">(</span><span class="default">$client_header</span><span class="keyword">[</span><span class="string">'url'</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">parse_str</span><span class="keyword">(</span><span class="default">$client_header</span><span class="keyword">[</span><span class="string">'query'</span><span class="keyword">],</span><span class="default">$client_header</span><span class="keyword">[</span><span class="string">'arg'</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$client_header</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Serve file<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">strpos</span><span class="keyword">(</span><span class="default">$client_header</span><span class="keyword">[</span><span class="string">'path'</span><span class="keyword">],</span><span class="string">".html"</span><span class="keyword">) &amp;&amp; </span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">__DIR__</span><span class="keyword">.</span><span class="default">$client_header</span><span class="keyword">[</span><span class="string">'path'</span><span class="keyword">])){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Sending a HTML page to client\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$newsocket</span><span class="keyword">,</span><span class="string">"</span><span class="default">$client_header</span><span class="keyword">[</span><span class="default">protocol</span><span class="keyword">]</span><span class="string"> 200 OK\r\n"</span><span class="keyword">);&nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$newsocket</span><span class="keyword">,</span><span class="string">"Content-type: text/html; CHARSET=gb2312\r\n\r\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$newsocket</span><span class="keyword">,</span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">__DIR__</span><span class="keyword">.</span><span class="default">$client_header</span><span class="keyword">[</span><span class="string">'path'</span><span class="keyword">]).</span><span class="string">"\r\n\r\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$newsocket</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }elseif(</span><span class="default">$client_header</span><span class="keyword">[</span><span class="string">'path'</span><span class="keyword">]==</span><span class="string">"/test"</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Sending test HTML page to client\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$newsocket</span><span class="keyword">,</span><span class="string">"&lt;!DOCTYPE HTML&gt;&lt;html&gt;&lt;head&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Its working!&lt;/h1&gt;Have fun\r\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$newsocket</span><span class="keyword">,</span><span class="string">"&lt;pre&gt;Request header: "</span><span class="keyword">. </span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$client_header</span><span class="keyword">,</span><span class="default">true</span><span class="keyword">) . </span><span class="string">"&lt;/pre&gt;\r\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$newsocket</span><span class="keyword">,</span><span class="string">"&lt;/body&gt;&lt;/html&gt;\r\n\r\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$newsocket</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"</span><span class="default">$client_header</span><span class="keyword">[</span><span class="default">protocol</span><span class="keyword">]</span><span class="string"> 404 Not Found\r\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$newsocket</span><span class="keyword">,</span><span class="string">"</span><span class="default">$client_header</span><span class="keyword">[</span><span class="default">protocol</span><span class="keyword">]</span><span class="string"> 404 Not Found\r\n\r\n"</span><span class="keyword">);&nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$newsocket</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; }<br />
&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$host_socket</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111592""></a>
  <div class="note">
   <strong class="user">Viorel</strong>
   <a href="#111592" class="date">06-Mar-2013 07:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Probably you will want to use <br />
<br />
// get a list of all the clients that have data to be read from<br />
// if there are no clients with data, go to next iteration<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (socket_select($read, $write = NULL, $except = NULL, NULL) &lt; 1)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; continue;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
instead&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (socket_select($read, $write = NULL, $except = NULL, 0) &lt; 1)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; continue;<br />
which will hang your CPU to 100% (return immediate if nothing to be done)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="102270""></a>
  <div class="note">
   <strong class="user">jean at briskula dot si</strong>
   <a href="#102270" class="date">04-Feb-2011 05:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As it was already said, some clients need \0 character to end transmission, for example Flash's XMLSocket.<br />
<br />
You should also be prepared to read less data than you have requested. <br />
<br />
Here is an example of a socket buffer - it's an array which has socket resources for keys and an array of a timestamp and recieved data as values.<br />
<br />
I find that the best practice for sending data is trailing it with a new line and zero character (\n\0), because you will probably have different types of clients which behave differently for reading data from sockets. Some need a \n to fire an event, some need \0.<br />
<br />
For recieving data, sometimes you will get splitted data - this can hapen because the buffer is full (in my example 8192 bytes) or it just gets broken during transmission in lower levels.<br />
<br />
Sometimes you can read two messages at once, but they have a zero character in between, so you can just use preg_split() to split the messages. The second message may not be complete, so you add it to your buffer.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">const </span><span class="default">message_delimiter </span><span class="keyword">= </span><span class="string">"\n\0"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/*<br />
&nbsp;&nbsp; &nbsp; * Clear socket buffers older than 1 hour<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">clear_buffer</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">buffer </span><span class="keyword">as </span><span class="default">$key</span><span class="keyword">=&gt;</span><span class="default">$val</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">time</span><span class="keyword">() - </span><span class="default">$val</span><span class="keyword">[</span><span class="string">'ts'</span><span class="keyword">] &gt; </span><span class="default">3600</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">buffer</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/*<br />
&nbsp;&nbsp; &nbsp; * Add data to a buffer<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">buffer_add</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">$data</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!isset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">buffer</span><span class="keyword">[</span><span class="default">$sock</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">buffer</span><span class="keyword">[</span><span class="default">$sock</span><span class="keyword">][</span><span class="string">'data'</span><span class="keyword">] = </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">buffer</span><span class="keyword">[</span><span class="default">$sock</span><span class="keyword">][</span><span class="string">'data'</span><span class="keyword">] .= </span><span class="default">$data</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">buffer</span><span class="keyword">[</span><span class="default">$sock</span><span class="keyword">][</span><span class="string">'ts'</span><span class="keyword">] = </span><span class="default">time</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">buffer_get</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// split buffer by the end of string<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lines </span><span class="keyword">= </span><span class="default">preg_split</span><span class="keyword">(</span><span class="string">'/\0/'</span><span class="keyword">,</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">buffer</span><span class="keyword">[</span><span class="default">$sock</span><span class="keyword">][</span><span class="string">'data'</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// reset buffer to the last line of input<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // if the buffer was sent completely, the last line of input should be<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // an empty string<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">buffer</span><span class="keyword">[</span><span class="default">$sock</span><span class="keyword">][</span><span class="string">'data'</span><span class="keyword">] = </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$lines</span><span class="keyword">[</span><span class="default">count</span><span class="keyword">(</span><span class="default">$lines</span><span class="keyword">)-</span><span class="default">1</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!empty(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">buffer</span><span class="keyword">[</span><span class="default">$sock</span><span class="keyword">][</span><span class="string">'data'</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">debug</span><span class="keyword">(</span><span class="string">"buffer is not empty for </span><span class="default">$sock</span><span class="string">, len: "</span><span class="keyword">.</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">buffer</span><span class="keyword">[</span><span class="default">$sock</span><span class="keyword">][</span><span class="string">'data'</span><span class="keyword">]));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// remove the last line of input (incomplete data)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // parse any complete data<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">unset(</span><span class="default">$lines</span><span class="keyword">[</span><span class="default">count</span><span class="keyword">(</span><span class="default">$lines</span><span class="keyword">)-</span><span class="default">1</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// return only the fully sent data<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">$lines</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">read</span><span class="keyword">(&amp;</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">$len</span><span class="keyword">=</span><span class="default">8192</span><span class="keyword">,</span><span class="default">$flag</span><span class="keyword">=</span><span class="default">MSG_DONTWAIT</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lines </span><span class="keyword">= array();<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">clear_buffer</span><span class="keyword">();<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bytes_read </span><span class="keyword">= @</span><span class="default">socket_recv</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">$read_data</span><span class="keyword">,</span><span class="default">$len</span><span class="keyword">,</span><span class="default">$flag</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$bytes_read </span><span class="keyword">=== </span><span class="default">false </span><span class="keyword">|| </span><span class="default">$bytes_read </span><span class="keyword">== </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">debug</span><span class="keyword">(</span><span class="string">"recv: </span><span class="default">$read_data</span><span class="string">"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">buffer_add</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">$read_data</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">buffer_get</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/*<br />
&nbsp;&nbsp; &nbsp; * Write to a socket<br />
&nbsp;&nbsp; &nbsp; * add a newline and null character at the end<br />
&nbsp;&nbsp; &nbsp; * some clients don't read until new line is recieved<br />
&nbsp;&nbsp; &nbsp; *<br />
&nbsp;&nbsp; &nbsp; * try to send the rest of the data if it gets truncated<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">write</span><span class="keyword">(&amp;</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">$msg</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$msg </span><span class="keyword">= </span><span class="default">$msg</span><span class="keyword">.</span><span class="default">self</span><span class="keyword">::</span><span class="default">message_delimiter</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$length </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$msg</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sent </span><span class="keyword">= @</span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">$msg</span><span class="keyword">,</span><span class="default">$length</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$sent </span><span class="keyword">&lt;= </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$sent </span><span class="keyword">&lt; </span><span class="default">$length</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$msg </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$msg</span><span class="keyword">, </span><span class="default">$sent</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$length </span><span class="keyword">-= </span><span class="default">$sent</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">debug</span><span class="keyword">(</span><span class="string">"Message truncated: Resending: </span><span class="default">$msg</span><span class="string">"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98222""></a>
  <div class="note">
   <strong class="user">John</strong>
   <a href="#98222" class="date">02-Jun-2010 09:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The way the document describes socket_select()'s handling of sockets polled for read is rather obscure.<br />
<br />
It says that it checks to see if reading would not "block," but the overall description of socket_select() says it checks for a change in blocking status. Unfortunately, these are in conflict.<br />
<br />
If a socket already has data in the buffer, calling socket_select() on that socket would never return (assuming null timeout), and would block forever. :-( This is because the blocking status wouldn't change. It simply stays "non-blocking"<br />
<br />
It is important to remember NOT to select() on a socket which may already have data available.<br />
<br />
An example...<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//... $socket is already here...<br />
</span><span class="default">$done </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
</span><span class="default">$n </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
do{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tmp </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$r </span><span class="keyword">= </span><span class="default">$w </span><span class="keyword">= </span><span class="default">$e </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$r </span><span class="keyword">= array(</span><span class="default">$socket</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_select</span><span class="keyword">(</span><span class="default">$r</span><span class="keyword">,</span><span class="default">$w</span><span class="keyword">,</span><span class="default">$e</span><span class="keyword">,</span><span class="default">null</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$n </span><span class="keyword">= </span><span class="default">socket_recv</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$tmp</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//$done = true; //Something determines that we are done reading...<br />
</span><span class="keyword">}while(!</span><span class="default">$done</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span>This MAY NOT work... socket_select() is always being called... but we may have data in the input buffer.<br />
<br />
We need to ensure that the last time we read, nothing was read... (empty buffer)<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//... $socket is already here...<br />
</span><span class="default">$done </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
</span><span class="default">$n </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
do{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tmp </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$r </span><span class="keyword">= </span><span class="default">$w </span><span class="keyword">= </span><span class="default">$e </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$r </span><span class="keyword">= array(</span><span class="default">$socket</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">$n </span><span class="keyword">=== </span><span class="default">0</span><span class="keyword">) </span><span class="default">socket_select</span><span class="keyword">(</span><span class="default">$r</span><span class="keyword">,</span><span class="default">$w</span><span class="keyword">,</span><span class="default">$e</span><span class="keyword">,</span><span class="default">null</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$n </span><span class="keyword">= </span><span class="default">socket_recv</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$tmp</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//$done = true; //Something determines that we are done reading...<br />
</span><span class="keyword">}while(!</span><span class="default">$done</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97390""></a>
  <div class="note">
   <strong class="user">magemerlin at list dot ru</strong>
   <a href="#97390" class="date">17-Apr-2010 03:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you using a Flash client - you should know some specific features:<br />
<br />
1) when client connects to the server - it is sending to you "&lt;policy-file-request/&gt;"."\0" string. Server should answer an XML policy file, then disconnect from this client. Code is something like <br />
<br />
if ('&lt;policy-file-request/&gt;'==substr($data, 0, 22))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo "policy requset.\n";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; flush();ob_flush();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $msg = '&lt;'.'?xml version="1.0"?&gt;<br />
&lt;!DOCTYPE cross-domain-policy SYSTEM "<a href="http://www.macromedia.com/xml/dtds/cross-domain-policy.dtd" rel="nofollow" target="_blank">http://www.macromedia.com/xml/dtds/cross-domain-policy.dtd</a>"&gt;<br />
&lt;cross-domain-policy&gt;<br />
&lt;allow-access-from domain="*" to-ports="*" /&gt;<br />
&lt;/cross-domain-policy&gt;'."\0";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo "Say to client (crossdomain.xml) ... ";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; flush();ob_flush();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; socket_write($read_sock, $msg, strlen($msg));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo "OK\n";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; flush();ob_flush();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo "Closing ... ";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; flush();ob_flush();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; socket_close($read_sock);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo "OK\n";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; flush();ob_flush();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
// here is normal IO operations with client<br />
}<br />
<br />
2) every output to client should be ended with "\0" (if using XMLSocket in Flash client) - otherwise flash will not generate onData event<br />
<br />
Russian examples is there - <a href="http://www.flasher.ru/forum/showpost.php?p=901346&amp;postcount=7" rel="nofollow" target="_blank">http://www.flasher.ru/forum/showpost.php?p=901346&amp;postcount=7</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93943""></a>
  <div class="note">
   <strong class="user">Aaron (aaron at acephalo dot us)</strong>
   <a href="#93943" class="date">07-Oct-2009 11:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
socket_select() can also serve as a more granular sleep():
<br />

<br />
<span class="default">&lt;?php
<br />
&nbsp; </span><span class="comment"># half-second sleep
<br />
&nbsp; </span><span class="default">$undef </span><span class="keyword">= array();
<br />
&nbsp; </span><span class="default">socket_select</span><span class="keyword">(</span><span class="default">$undef</span><span class="keyword">, </span><span class="default">$undef</span><span class="keyword">, </span><span class="default">$undef</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="string">"500000"</span><span class="keyword">);
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89666""></a>
  <div class="note">
   <strong class="user">eidberger at jakota dot de</strong>
   <a href="#89666" class="date">18-Mar-2009 06:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just noticed that you have to loop socket_select () when using UDP to get all queued packets:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">while (</span><span class="default">socket_select </span><span class="keyword">(</span><span class="default">$aRead</span><span class="keyword">, </span><span class="default">$aWrite</span><span class="keyword">, </span><span class="default">$aExcept</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">) &gt; </span><span class="default">0</span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">$aReadUdp </span><span class="keyword">as </span><span class="default">$oSocket</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">clientReadUdp </span><span class="keyword">(</span><span class="default">$oSocket</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; }
<br />
}
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
That's important because every call of socket_select () on UDP brings you only one result. But there could be 10.000 results queued and if your turnarround time is to slow (server busy, other sleeps etc.), you'll never progress all results in near realtime.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85758""></a>
  <div class="note">
   <strong class="user">danny at dansheps dot com</strong>
   <a href="#85758" class="date">16-Sep-2008 09:45</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just to add to this.&nbsp; Since the information contained in the notes is somewhat old.&nbsp;&nbsp; It appears keys are being preserved now.<br />
<br />
So, if you rely on knowing which keys need to be worked with and were like me and thought that it didnot preserve.&nbsp; Well it does.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79512""></a>
  <div class="note">
   <strong class="user">qartis at gmail dot com</strong>
   <a href="#79512" class="date">30-Nov-2007 01:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In regards to the code posted by vardhan ( at ) rogers ( dot ) com, it appears that on the following line:<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (socket_select($read, $write = NULL, $except = NULL, 0) &lt; 1)<br />
the timeout parameter is accidentally set to 0, rather than NULL. This means that the select call will return immediately rather than blocking indefinitely.<br />
<br />
Change the socket_select line to the following for great success:<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (socket_select($read, $write = NULL, $except = NULL, NULL) &lt; 1)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="72547""></a>
  <div class="note">
   
   <a href="#72547" class="date">23-Jan-2007 03:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want to use a simple fractional value for timeout:<br />
<br />
<span class="default">&lt;?php<br />
socket_select</span><span class="keyword">(..., </span><span class="default">floor</span><span class="keyword">(</span><span class="default">$timeout</span><span class="keyword">), </span><span class="default">ceil</span><span class="keyword">(</span><span class="default">$timeout</span><span class="keyword">*</span><span class="default">1000000</span><span class="keyword">));<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="64728""></a>
  <div class="note">
   <strong class="user">Whosawhatsis at that google email thingy</strong>
   <a href="#64728" class="date">19-Apr-2006 07:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Another solution to the problem of keys not being preserved is to have an additional array for looking up sockets that uses their resource identifiers as keys. This can be obtained using array_flip() in some cases, but is particularly useful if each socket is associated with an object. In this case, you can make the object's constructor add a pointer to itself to the lookup array with its socket resource identifier as a key and use the following code to execute a read method for the object associated with each socket returned by socket_select():<br />
<br />
<span class="default">&lt;?php<br />
socket_select</span><span class="keyword">(</span><span class="default">$reads</span><span class="keyword">, </span><span class="default">$writes</span><span class="keyword">, </span><span class="default">$excepts</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
<br />
foreach (</span><span class="default">$sockets </span><span class="keyword">as </span><span class="default">$socket</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$lookuparray</span><span class="keyword">[</span><span class="default">$socket</span><span class="keyword">]-&gt;</span><span class="default">read</span><span class="keyword">();<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58367""></a>
  <div class="note">
   <strong class="user">ludvig dot ericson at gmail dot com</strong>
   <a href="#58367" class="date">01-Nov-2005 05:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Regarding the comment below, No, it does not, it's a system call and I believe it's rather hard to preserve keys.<br />
<br />
Additionally, socket_select should be used like it was a user-inputted array, that you don't know what you sent in to.<br />
<br />
<span class="default">&lt;?php<br />
$reads </span><span class="keyword">= </span><span class="default">$clients</span><span class="keyword">;<br />
</span><span class="default">$reads</span><span class="keyword">[] = </span><span class="default">$server</span><span class="keyword">;<br />
<br />
</span><span class="default">socket_select</span><span class="keyword">(</span><span class="default">$reads</span><span class="keyword">);<br />
<br />
foreach (</span><span class="default">$reads </span><span class="keyword">as </span><span class="default">$read</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* do some stuff */<br />
</span><span class="keyword">}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="57347""></a>
  <div class="note">
   <strong class="user">crimson at NOSPAMtechnologist dot com</strong>
   <a href="#57347" class="date">30-Sep-2005 04:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that the resulting arrays do NOT maintain keys (PHP 4.3.2) after being run through this function:<br />
<br />
Before:<br />
Array<br />
(<br />
&nbsp;&nbsp;&nbsp; [Client_Socket] =&gt; Resource id #6<br />
&nbsp;&nbsp;&nbsp; [Server_Socket] =&gt; Resource id #9<br />
)<br />
<br />
After:<br />
Array<br />
(<br />
&nbsp;&nbsp;&nbsp; [0] =&gt; Resource id #6<br />
&nbsp;&nbsp;&nbsp; [1] =&gt; Resource id #9<br />
)<br />
<br />
It would have been nice to have the keys stay to figure out which stream you need to receive from, but you'll have to use some fancy foreach loop to figure out which sockets to check.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="56241""></a>
  <div class="note">
   <strong class="user">vardhan ( at ) rogers ( dot ) com</strong>
   <a href="#56241" class="date">28-Aug-2005 07:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A simple PHP script using socket_select() to manage multiple connections.<br />
connect using "telnet localhost 9050". it broadcasts your messages that you send through telnet to other users connected to the server -- sort of like a chat script<br />
<br />
#!/usr/local/bin/php<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp;&nbsp; $port </span><span class="keyword">= </span><span class="default">9050</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// create a streaming socket, of type TCP/IP<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sock </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">SOL_TCP</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// set the option to reuse the port<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="default">SOL_SOCKET</span><span class="keyword">, </span><span class="default">SO_REUSEADDR</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// "bind" the socket to the address to "localhost", on port $port<br />
&nbsp;&nbsp;&nbsp; // so this means that all connections on this port are now our resposibility to send/recv data, disconnect, etc..<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_bind</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// start listen for connections<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_listen</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// create a list of all the clients that will be connected to us..<br />
&nbsp;&nbsp;&nbsp; // add the listening socket to this list<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$clients </span><span class="keyword">= array(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; while (</span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// create a copy, so $clients doesn't get modified by socket_select()<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$read </span><span class="keyword">= </span><span class="default">$clients</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// get a list of all the clients that have data to be read from<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // if there are no clients with data, go to next iteration<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">socket_select</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">, </span><span class="default">$write </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">, </span><span class="default">$except </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">) &lt; </span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; continue;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// check if there is a client trying to connect<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">in_array</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="default">$read</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// accept the client, and add him to the $clients array<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$clients</span><span class="keyword">[] = </span><span class="default">$newsock </span><span class="keyword">= </span><span class="default">socket_accept</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// send the client a welcome message<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$newsock</span><span class="keyword">, </span><span class="string">"no noobs, but ill make an exception :)\n"</span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"There are "</span><span class="keyword">.(</span><span class="default">count</span><span class="keyword">(</span><span class="default">$clients</span><span class="keyword">) - </span><span class="default">1</span><span class="keyword">).</span><span class="string">" client(s) connected to the server\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_getpeername</span><span class="keyword">(</span><span class="default">$newsock</span><span class="keyword">, </span><span class="default">$ip</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"New client connected: </span><span class="keyword">{</span><span class="default">$ip</span><span class="keyword">}</span><span class="string">\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// remove the listening socket from the clients-with-data array<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">array_search</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="default">$read</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$read</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// loop through all the clients that have data to read from<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$read </span><span class="keyword">as </span><span class="default">$read_sock</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// read until newline or 1024 bytes<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // socket_read while show errors when the client is disconnected, so silence the error messages<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= @</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$read_sock</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">, </span><span class="default">PHP_NORMAL_READ</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// check if the client is disconnected<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$data </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// remove client for $clients array<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">array_search</span><span class="keyword">(</span><span class="default">$read_sock</span><span class="keyword">, </span><span class="default">$clients</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$clients</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"client disconnected.\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// continue to the next client to read from, if any<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">continue;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// trim off the trailing/beginning white spaces<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// check if there is any data after trimming off the spaces<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (!empty(</span><span class="default">$data</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// send this to all the clients in the $clients array (except the first one, which is a listening socket)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$clients </span><span class="keyword">as </span><span class="default">$send_sock</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// if its the listening sock or the client that we got the message from, go to the next one in the list<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$send_sock </span><span class="keyword">== </span><span class="default">$sock </span><span class="keyword">|| </span><span class="default">$send_sock </span><span class="keyword">== </span><span class="default">$read_sock</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; continue;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// write the message to the client -- add a newline character to the end of the message<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$send_sock</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } </span><span class="comment">// end of broadcast foreach<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } </span><span class="comment">// end of reading foreach<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// close the listening socket<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52443""></a>
  <div class="note">
   <strong class="user">drenintell</strong>
   <a href="#52443" class="date">01-May-2005 01:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The continuation of my my previous post on 28-Apr-2005 10:19 at<br />
<a href="http://ca3.php.net/manual/en/function.socket-select.php" rel="nofollow" target="_blank">http://ca3.php.net/manual/en/function.socket-select.php</a><br />
<br />
Here it is: (Link is broken into 2 parts)<br />
<br />
'<a href="http://gtkphp.org/php_socket_select_hangs" rel="nofollow" target="_blank">http://gtkphp.org/php_socket_select_hangs</a><br />
_explanation_and_solution.html'</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="45737""></a>
  <div class="note">
   <strong class="user">Richard Neill</strong>
   <a href="#45737" class="date">16-Sep-2004 09:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It is probably a bad idea to watch an array of sockets for input with socket_select, and then socket_read() using PHP_NORMAL_READ.<br />
<br />
Although this seems desirable, you can end up with a permanently blocked program, if someone sends you malformed input which is missing a trailing \n \r. Guess how I found that out.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="29467""></a>
  <div class="note">
   <strong class="user">calimero dot NOSPAM at NOSPAM dot creatixnet dot com</strong>
   <a href="#29467" class="date">14-Feb-2003 04:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please note that the timeout parameter has important side-effects on the CPU usage of your script.<br />
<br />
Setting the timeout to 0 will make your CPU looping without any time to have some rest and handle other running processes on your system, causing the system load to increase heavily while your script is running.<br />
<br />
Personnaly, I use a value of 15 ms for this parameter. this ensures a good listening frequency while letting your system load clear.<br />
<br />
Example :<br />
$read = array($ListeningSocket);<br />
$num_changed_sockets = socket_select($read, $write = NULL, $except = NULL, 0, 10);<br />
<br />
Hope this helps.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="25054""></a>
  <div class="note">
   <strong class="user">daveb at optusnet dot com dot au</strong>
   <a href="#25054" class="date">09-Sep-2002 09:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you haven't done any network programming before, PHP's socket_select() might appear a bit strange to you. I've written a simple php "partyline" script to demonstrate the multi-socket use of select'ing at <a href="http://dave.dapond.com/socketselect.php.txt" rel="nofollow" target="_blank">http://dave.dapond.com/socketselect.php.txt</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="23098""></a>
  <div class="note">
   <strong class="user">julian dot haupt at gmx dot de</strong>
   <a href="#23098" class="date">09-Jul-2002 10:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
hello,
<br />
i just made a class which acts similiar to Perl's IO::Select in order to make socket selecting very easy
<br />

<br />
your script should look something like that:
<br />

<br />
<span class="default">&lt;?php
<br />
$server </span><span class="keyword">= new </span><span class="default">Server</span><span class="keyword">;
<br />
</span><span class="default">$client </span><span class="keyword">= new </span><span class="default">Client</span><span class="keyword">;
<br />

<br />
for (;;) {
<br />
&nbsp; foreach (</span><span class="default">$select</span><span class="keyword">-&gt;</span><span class="default">can_read</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">) as </span><span class="default">$socket</span><span class="keyword">) {
<br />

<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$socket </span><span class="keyword">== </span><span class="default">$client</span><span class="keyword">-&gt;</span><span class="default">socket</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// New Client Socket
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$select</span><span class="keyword">-&gt;</span><span class="default">add</span><span class="keyword">(</span><span class="default">socket_accept</span><span class="keyword">(</span><span class="default">$client</span><span class="keyword">-&gt;</span><span class="default">socket</span><span class="keyword">));
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; else {
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">//there's something to read on $socket
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}
<br />
&nbsp; }
<br />
}
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
you should of course implement some routines to detect broken sockets and remove them from the select object.
<br />

<br />
you can also do output buffering and check in the main-loop for sockets that are ready to write
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">class </span><span class="default">select </span><span class="keyword">{
<br />
&nbsp; var </span><span class="default">$sockets</span><span class="keyword">;
<br />

<br />
&nbsp; function </span><span class="default">select</span><span class="keyword">(</span><span class="default">$sockets</span><span class="keyword">) {
<br />

<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sockets </span><span class="keyword">= array();
<br />

<br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">$sockets </span><span class="keyword">as </span><span class="default">$socket</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">add</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp; }
<br />

<br />
&nbsp; function </span><span class="default">add</span><span class="keyword">(</span><span class="default">$add_socket</span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">array_push</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sockets</span><span class="keyword">,</span><span class="default">$add_socket</span><span class="keyword">);
<br />
&nbsp; }
<br />

<br />
&nbsp; function </span><span class="default">remove</span><span class="keyword">(</span><span class="default">$remove_socket</span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sockets </span><span class="keyword">= array();
<br />

<br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sockets </span><span class="keyword">as </span><span class="default">$socket</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp;&nbsp; if(</span><span class="default">$remove_socket </span><span class="keyword">!= </span><span class="default">$socket</span><span class="keyword">)
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sockets</span><span class="keyword">[] = </span><span class="default">$socket</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />

<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sockets </span><span class="keyword">= </span><span class="default">$sockets</span><span class="keyword">;
<br />
&nbsp; }
<br />

<br />
&nbsp; function </span><span class="default">can_read</span><span class="keyword">(</span><span class="default">$timeout</span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$read </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sockets</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_select</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">,</span><span class="default">$write </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">,</span><span class="default">$except </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">,</span><span class="default">$timeout</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$read</span><span class="keyword">;
<br />
&nbsp; }
<br />

<br />
&nbsp; function </span><span class="default">can_write</span><span class="keyword">(</span><span class="default">$timeout</span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$write </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sockets</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_select</span><span class="keyword">(</span><span class="default">$read </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">,</span><span class="default">$write</span><span class="keyword">,</span><span class="default">$except </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">,</span><span class="default">$timeout</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$write</span><span class="keyword">;
<br />
&nbsp; }
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
