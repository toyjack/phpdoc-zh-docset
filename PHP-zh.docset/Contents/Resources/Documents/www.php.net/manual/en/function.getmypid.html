<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>获取 PHP 进程的 ID</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.getmyinode.html">? getmyinode</a></li>
      <li style="float: right;"><a href="function.getmyuid.html">getmyuid ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.info.html">PHP 选项/信息 函数</a></li>
    <li>获取 PHP 进程的 ID</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.getmypid" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">getmypid</h1>
  <p class="verinfo">(PHP 4, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">getmypid</span> &mdash; <span class="dc-title">获取 PHP 进程的 ID</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.getmypid-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>getmypid</strong></span>(): <span class="type">int</span></div>

  <p class="para rdfs-comment">
   获取当前 PHP 进程 ID。
  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.getmypid-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   返回当前 PHP 进程 ID，或在错误时返回 <strong><code>false</code></strong>。
  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.getmypid-notes">
  <h3 class="title">注释</h3>
  <div class="warning"><strong class="warning">Warning</strong>
   <p class="para">
    进程 ID 并不是唯一的，所以他们是一个弱熵源。
    对安全性有依赖的上下文中我们不推荐依赖于 pid。
   </p>
  </div>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.getmypid-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.getmygid.html" class="function" rel="rdfs-seeAlso">getmygid()</a> - 获取当前 PHP 脚本拥有者的 GID</span></li>
    <li class="member"><span class="function"><a href="function.getmyuid.html" class="function" rel="rdfs-seeAlso">getmyuid()</a> - 获取 PHP 脚本所有者的 UID</span></li>
    <li class="member"><span class="function"><a href="function.get-current-user.html" class="function" rel="rdfs-seeAlso">get_current_user()</a> - 获取当前 PHP 脚本所有者名称</span></li>
    <li class="member"><span class="function"><a href="function.getmyinode.html" class="function" rel="rdfs-seeAlso">getmyinode()</a> - 获取当前脚本的索引节点（inode）</span></li>
    <li class="member"><span class="function"><a href="function.getlastmod.html" class="function" rel="rdfs-seeAlso">getlastmod()</a> - 获取页面最后修改的时间</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="118865""></a>
  <div class="note">
   <strong class="user">martijn at nowhere dot com</strong>
   <a href="#118865" class="date">18-Feb-2016 03:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
On windows, you can get a list of PID's using this single line statement: <span class="default">&lt;?php $pids </span><span class="keyword">= </span><span class="default">array_column</span><span class="keyword">(</span><span class="default">array_map</span><span class="keyword">(</span><span class="string">'str_getcsv'</span><span class="keyword">, </span><span class="default">explode</span><span class="keyword">(</span><span class="string">"\n"</span><span class="keyword">,</span><span class="default">trim</span><span class="keyword">(`</span><span class="string">tasklist /FO csv /NH</span><span class="keyword">`))), </span><span class="default">1</span><span class="keyword">); </span><span class="default">?&gt;</span>.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="113055""></a>
  <div class="note">
   <strong class="user">brospam at gmail dot com</strong>
   <a href="#113055" class="date">23-Aug-2013 10:19</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
My lockfile system<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">isLocked</span><span class="keyword">(){<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">LOCK_FILE</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lockingPID </span><span class="keyword">= </span><span class="default">trim</span><span class="keyword">(</span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">LOCK_FILE</span><span class="keyword">)); <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$test</span><span class="keyword">=</span><span class="default">trim</span><span class="keyword">(`</span><span class="string">ps -p </span><span class="default">$lockingPID</span><span class="string"> -o pid=</span><span class="keyword">`);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!empty(</span><span class="default">$test</span><span class="keyword">)) return </span><span class="default">true</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Removing stale lock file.\n"</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">unlink</span><span class="keyword">(</span><span class="default">LOCK_FILE</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="default">LOCK_FILE</span><span class="keyword">, </span><span class="default">getmypid</span><span class="keyword">().</span><span class="string">"\n"</span><span class="keyword">); <br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="112782""></a>
  <div class="note">
   <strong class="user">Radu Cristescu</strong>
   <a href="#112782" class="date">22-Jul-2013 06:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The lock-file mechanism in Kevin Trass's note is incorrect because it is subject to race conditions.<br />
<br />
For locks you need an atomic way of verifying if a lock file exists and creating it if it doesn't exist. Between file_exists and file_put_contents, another process could be faster than us to write the lock.<br />
<br />
The only filesystem operation that matches the above requirements that I know of is symlink().<br />
<br />
Thus, if you need a lock-file mechanism, here's the code. This won't work on a system without /proc (so there go Windows, BSD, OS X, and possibly others), but it can be adapted to work around that deficiency (say, by linking to your pid file like in my script, then operating through the symlink like in Kevin's solution).<br />
<br />
#!/usr/bin/php<br />
<span class="default">&lt;?php<br />
<br />
define</span><span class="keyword">(</span><span class="string">'LOCK_FILE'</span><span class="keyword">, </span><span class="string">"/var/run/" </span><span class="keyword">. </span><span class="default">basename</span><span class="keyword">(</span><span class="default">$argv</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">".php"</span><span class="keyword">) . </span><span class="string">".lock"</span><span class="keyword">);<br />
<br />
if (!</span><span class="default">tryLock</span><span class="keyword">())<br />
&nbsp;&nbsp;&nbsp; die(</span><span class="string">"Already running.\n"</span><span class="keyword">);<br />
<br />
</span><span class="comment"># remove the lock on exit (Control+C doesn't count as 'exit'?)<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'unlink'</span><span class="keyword">, </span><span class="default">LOCK_FILE</span><span class="keyword">);<br />
<br />
</span><span class="comment"># The rest of your script goes here....<br />
</span><span class="keyword">echo </span><span class="string">"Hello world!\n"</span><span class="keyword">;<br />
</span><span class="default">sleep</span><span class="keyword">(</span><span class="default">30</span><span class="keyword">);<br />
<br />
exit(</span><span class="default">0</span><span class="keyword">);<br />
<br />
function </span><span class="default">tryLock</span><span class="keyword">()<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># If lock file exists, check if stale.&nbsp; If exists and is not stale, return TRUE<br />
&nbsp;&nbsp;&nbsp; # Else, create lock file and return FALSE.<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (@</span><span class="default">symlink</span><span class="keyword">(</span><span class="string">"/proc/" </span><span class="keyword">. </span><span class="default">getmypid</span><span class="keyword">(), </span><span class="default">LOCK_FILE</span><span class="keyword">) !== </span><span class="default">FALSE</span><span class="keyword">) </span><span class="comment"># the @ in front of 'symlink' is to suppress the NOTICE you get if the LOCK_FILE exists<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">true</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># link already exists<br />
&nbsp;&nbsp;&nbsp; # check if it's stale<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">is_link</span><span class="keyword">(</span><span class="default">LOCK_FILE</span><span class="keyword">) &amp;&amp; !</span><span class="default">is_dir</span><span class="keyword">(</span><span class="default">LOCK_FILE</span><span class="keyword">))<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">unlink</span><span class="keyword">(</span><span class="default">LOCK_FILE</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment"># try to lock again<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">tryLock</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="109333""></a>
  <div class="note">
   <strong class="user">eight_hf at live dot fr</strong>
   <a href="#109333" class="date">07-Jul-2012 12:19</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
On Linux you can check if a process is still running by verifying if the PID exists in the /proc directory :<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">if(</span><span class="default">file_exists</span><span class="keyword">(</span><span class="string">'/proc/'</span><span class="keyword">.</span><span class="default">$pid</span><span class="keyword">))<br />
{<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">'The process is still running.'</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107022""></a>
  <div class="note">
   <strong class="user">pdc at example dot com</strong>
   <a href="#107022" class="date">29-Dec-2011 12:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is how you'd use exec on a posix system to accomplish counting processes quickly.
<br />

<br />
I want to know how many processes are running with 'update.php' in the command:
<br />

<br />
ps aux|grep "[u]pdate.php"|wc -l
<br />

<br />
(the trick of using [u]pdate.php instead of update.php makes sure that the grep command itself is not matched).&nbsp; Be sure to use quotes in the command, or it won't work either.
<br />

<br />
So, the code:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">countProcesses</span><span class="keyword">(</span><span class="default">$scriptName</span><span class="keyword">)
<br />
{
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// ps aux|grep "[u]pdate.php"|wc -l
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$first&nbsp; &nbsp; </span><span class="keyword">=&nbsp; &nbsp; </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$scriptName</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$rest&nbsp; &nbsp; </span><span class="keyword">=&nbsp; &nbsp; </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$scriptName</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$name&nbsp; &nbsp; </span><span class="keyword">=&nbsp; &nbsp; </span><span class="string">'"['</span><span class="keyword">.</span><span class="default">$first</span><span class="keyword">.</span><span class="string">']'</span><span class="keyword">.</span><span class="default">$rest</span><span class="keyword">.</span><span class="string">'"'</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$cmd&nbsp; &nbsp; </span><span class="keyword">=&nbsp; &nbsp; </span><span class="string">"ps aux | grep </span><span class="default">$name</span><span class="string"> | wc -l"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result&nbsp; &nbsp; </span><span class="keyword">=&nbsp; &nbsp; </span><span class="default">exec</span><span class="keyword">(</span><span class="default">$cmd</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$result</span><span class="keyword">;
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104275""></a>
  <div class="note">
   <strong class="user">wouter99999 at gmail dot com</strong>
   <a href="#104275" class="date">05-Jun-2011 03:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
On windows, ps is not available. Instead, to view a list of running processes, you can use exec('tasklist'); To kill processes you can use exec('taskkill); Enter taskkill /? for more information.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="103807""></a>
  <div class="note">
   <strong class="user">Robert Mays Jr</strong>
   <a href="#103807" class="date">04-May-2011 09:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
All of the examples above require you to have shell command execution turned on- this example uses only PHP functions and should work on any system (posix is included by default)-<br />
<br />
the key is posix_getsid which will return FALSE if the processes does not exist.<br />
<br />
<span class="default">&lt;?php <br />
$lockfile </span><span class="keyword">= </span><span class="default">sys_get_temp_dir</span><span class="keyword">() . </span><span class="string">'/myScript.lock'</span><span class="keyword">; <br />
</span><span class="default">$pid </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">); <br />
if (</span><span class="default">posix_getsid</span><span class="keyword">(</span><span class="default">$pid</span><span class="keyword">) === </span><span class="default">false</span><span class="keyword">) { <br />
&nbsp;&nbsp; print </span><span class="string">"process has died! restarting...\n"</span><span class="keyword">; <br />
&nbsp;&nbsp; </span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">, </span><span class="default">getmypid</span><span class="keyword">()); </span><span class="comment">// create lockfile <br />
</span><span class="keyword">} else { <br />
&nbsp;&nbsp; print </span><span class="string">"PID is still alive! can not run twice!\n"</span><span class="keyword">; <br />
&nbsp;&nbsp; exit; <br />
} <br />
</span><span class="default">?&gt;</span> <br />
<br />
:-) perfect if you need to make sure a cron job or shell script has ended before it can be started again.<br />
<br />
This works across users- if the cron job is started as 'root' your 'web user' can see if the process is still alive (useful for system status pages)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96007""></a>
  <div class="note">
   <strong class="user">gabe at fijiwebdesign dot com</strong>
   <a href="#96007" class="date">02-Feb-2010 09:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Based on what james at voodoo dot co dot uk said, but modified for CLI scripts (ie: there is no $_SERVER). <br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">/**<br />
&nbsp;* Check for a current process by filename<br />
&nbsp;* @param $file[optional] Filename<br />
&nbsp;* @return Boolean<br />
&nbsp;*/<br />
</span><span class="keyword">function </span><span class="default">processExists</span><span class="keyword">(</span><span class="default">$file </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$exists&nbsp; &nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$file&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">$file </span><span class="keyword">? </span><span class="default">$file </span><span class="keyword">: </span><span class="default">__FILE__</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Check if file is in process list<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">exec</span><span class="keyword">(</span><span class="string">"ps -C </span><span class="default">$file</span><span class="string"> -o pid="</span><span class="keyword">, </span><span class="default">$pids</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$pids</span><span class="keyword">) &gt; </span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$exists </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$exists</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95303""></a>
  <div class="note">
   <strong class="user">james at voodoo dot co dot uk</strong>
   <a href="#95303" class="date">25-Dec-2009 01:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The 'ps' command has an option that can make filtering for a specific process more efficient.&nbsp; Using this the work of looking for matching processes can be made neater:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/*<br />
&nbsp;&nbsp;&nbsp; Return an array of the pids of the processes that are running for the specific command<br />
&nbsp;&nbsp;&nbsp; e.g.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; returnPids('myprocess.php');<br />
&nbsp;&nbsp;&nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">returnPids</span><span class="keyword">(</span><span class="default">$command</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">exec</span><span class="keyword">(</span><span class="string">"ps -C </span><span class="default">$command</span><span class="string"> -o pid="</span><span class="keyword">,</span><span class="default">$pids</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach (</span><span class="default">$pids </span><span class="keyword">as </span><span class="default">$key</span><span class="keyword">=&gt;</span><span class="default">$value</span><span class="keyword">) </span><span class="default">$pids</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">]=</span><span class="default">trim</span><span class="keyword">(</span><span class="default">$value</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$pids</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }&nbsp; &nbsp; <br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/*<br />
&nbsp;&nbsp;&nbsp; Returns an array of the pids for processes that are like me, i.e. my program running<br />
&nbsp;&nbsp;&nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">returnMyPids</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">returnPids</span><span class="keyword">(</span><span class="default">basename</span><span class="keyword">(</span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">"SCRIPT_NAME"</span><span class="keyword">]));<br />
&nbsp;&nbsp;&nbsp; }<br />
</span><span class="default">?&gt;<br />
</span><br />
e.g. to bomb out if I'm running already<br />
<br />
if (count(returnMyPids())&gt;1) exit;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="94531""></a>
  <div class="note">
   <strong class="user">Erickson Reyes ercbluemonday at yahoo dot com</strong>
   <a href="#94531" class="date">10-Nov-2009 05:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
We also had this challenge in our company to prevent a php script in a cron job from overlapping each other. <br />
<br />
We made this solution<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Initialize variables<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$found&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$file&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">basename</span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$commands&nbsp; &nbsp; </span><span class="keyword">= array();<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Get running processes.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">exec</span><span class="keyword">(</span><span class="string">"ps w"</span><span class="keyword">, </span><span class="default">$commands</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// If processes are found<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$commands</span><span class="keyword">) &gt; </span><span class="default">0</span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach (</span><span class="default">$commands </span><span class="keyword">as </span><span class="default">$command</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">strpos</span><span class="keyword">(</span><span class="default">$command</span><span class="keyword">, </span><span class="default">$file</span><span class="keyword">) === </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Do nothin'<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Let's count how many times the file is found.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$found</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// If the instance of the file is found more than once.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$found </span><span class="keyword">&gt; </span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Another process is running.\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die();<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">/**<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; * <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; * Regular process here...<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; * <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; */<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93753""></a>
  <div class="note">
   <strong class="user">Kevin Traas (ktraas- at -gmail dot com)</strong>
   <a href="#93753" class="date">25-Sep-2009 01:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Looking to create a lock-file mechanism for a cmd-line script?
<br />

<br />
Enjoy!
<br />

<br />
#!/usr/bin/php
<br />
<span class="default">&lt;?php
<br />

<br />
define</span><span class="keyword">( </span><span class="string">'LOCK_FILE'</span><span class="keyword">, </span><span class="string">"/var/run/"</span><span class="keyword">.</span><span class="default">basename</span><span class="keyword">( </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">".php" </span><span class="keyword">).</span><span class="string">".lock" </span><span class="keyword">);
<br />
if( </span><span class="default">isLocked</span><span class="keyword">() ) die( </span><span class="string">"Already running.\n" </span><span class="keyword">);
<br />

<br />
</span><span class="comment"># The rest of your script goes here....
<br />
</span><span class="keyword">echo </span><span class="string">"Hello world!\n"</span><span class="keyword">;
<br />
</span><span class="default">sleep</span><span class="keyword">(</span><span class="default">30</span><span class="keyword">);
<br />

<br />
</span><span class="default">unlink</span><span class="keyword">( </span><span class="default">LOCK_FILE </span><span class="keyword">);
<br />
exit(</span><span class="default">0</span><span class="keyword">);
<br />

<br />
function </span><span class="default">isLocked</span><span class="keyword">()
<br />
{
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># If lock file exists, check if stale.&nbsp; If exists and is not stale, return TRUE
<br />
&nbsp;&nbsp;&nbsp; # Else, create lock file and return FALSE.
<br />

<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">file_exists</span><span class="keyword">( </span><span class="default">LOCK_FILE </span><span class="keyword">) )
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment"># check if it's stale
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lockingPID </span><span class="keyword">= </span><span class="default">trim</span><span class="keyword">( </span><span class="default">file_get_contents</span><span class="keyword">( </span><span class="default">LOCK_FILE </span><span class="keyword">) );
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="comment"># Get all active PIDs.
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pids </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">( </span><span class="string">"\n"</span><span class="keyword">, </span><span class="default">trim</span><span class="keyword">( `</span><span class="string">ps -e | awk '{print $1}'</span><span class="keyword">` ) );
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment"># If PID is still active, return true
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">in_array</span><span class="keyword">( </span><span class="default">$lockingPID</span><span class="keyword">, </span><span class="default">$pids </span><span class="keyword">) )&nbsp; return </span><span class="default">true</span><span class="keyword">;
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment"># Lock-file is stale, so kill it.&nbsp; Then move on to re-creating it.
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"Removing stale lock file.\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">unlink</span><span class="keyword">( </span><span class="default">LOCK_FILE </span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">file_put_contents</span><span class="keyword">( </span><span class="default">LOCK_FILE</span><span class="keyword">, </span><span class="default">getmypid</span><span class="keyword">() . </span><span class="string">"\n" </span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;
<br />

<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="59889""></a>
  <div class="note">
   <strong class="user">kroczu at interia dot pl</strong>
   <a href="#59889" class="date">19-Dec-2005 04:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php
<br />
</span><span class="comment">/*
<br />

<br />
mixed getpidinfo(mixed pid [, string system_ps_command_options])
<br />

<br />
this function gets PID-info from system ps command and return it in useful assoc-array,
<br />
or return false and trigger warning if PID doesn't exists
<br />

<br />
$pidifo=getpidinfo(12345);
<br />

<br />
print_r($pidifo);
<br />

<br />
Array
<br />
(
<br />
&nbsp;&nbsp;&nbsp; [USER] =&gt; user
<br />
&nbsp;&nbsp;&nbsp; [PID] =&gt; 12345
<br />
&nbsp;&nbsp;&nbsp; [%CPU] =&gt; 0.0
<br />
&nbsp;&nbsp;&nbsp; [%MEM] =&gt; 0.0
<br />
&nbsp;&nbsp;&nbsp; [VSZ] =&gt; 1720
<br />
&nbsp;&nbsp;&nbsp; [RSS] =&gt; 8
<br />
&nbsp;&nbsp;&nbsp; [TT] =&gt; ??
<br />
&nbsp;&nbsp;&nbsp; [STAT] =&gt; Is
<br />
&nbsp;&nbsp;&nbsp; [STARTED] =&gt; 6:00PM
<br />
&nbsp;&nbsp;&nbsp; [TIME] =&gt; 0:00.01
<br />
&nbsp;&nbsp;&nbsp; [COMMAND] =&gt; php someproces.php &gt; logfile
<br />
)
<br />

<br />
*/
<br />

<br />
//////////////////////////////////////////////
<br />

<br />
</span><span class="keyword">function </span><span class="default">getpidinfo</span><span class="keyword">(</span><span class="default">$pid</span><span class="keyword">, </span><span class="default">$ps_opt</span><span class="keyword">=</span><span class="string">"aux"</span><span class="keyword">){
<br />

<br />
&nbsp;&nbsp; </span><span class="default">$ps</span><span class="keyword">=</span><span class="default">shell_exec</span><span class="keyword">(</span><span class="string">"ps "</span><span class="keyword">.</span><span class="default">$ps_opt</span><span class="keyword">.</span><span class="string">"p "</span><span class="keyword">.</span><span class="default">$pid</span><span class="keyword">);
<br />
&nbsp;&nbsp; </span><span class="default">$ps</span><span class="keyword">=</span><span class="default">explode</span><span class="keyword">(</span><span class="string">"\n"</span><span class="keyword">, </span><span class="default">$ps</span><span class="keyword">);
<br />
&nbsp;&nbsp; 
<br />
&nbsp;&nbsp; if(</span><span class="default">count</span><span class="keyword">(</span><span class="default">$ps</span><span class="keyword">)&lt;</span><span class="default">2</span><span class="keyword">){
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">"PID "</span><span class="keyword">.</span><span class="default">$pid</span><span class="keyword">.</span><span class="string">" doesn't exists"</span><span class="keyword">, </span><span class="default">E_USER_WARNING</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;
<br />
&nbsp;&nbsp; }
<br />

<br />
&nbsp;&nbsp; foreach(</span><span class="default">$ps </span><span class="keyword">as </span><span class="default">$key</span><span class="keyword">=&gt;</span><span class="default">$val</span><span class="keyword">){
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$ps</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">]=</span><span class="default">explode</span><span class="keyword">(</span><span class="string">" "</span><span class="keyword">, </span><span class="default">ereg_replace</span><span class="keyword">(</span><span class="string">" +"</span><span class="keyword">, </span><span class="string">" "</span><span class="keyword">, </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$ps</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">])));
<br />
&nbsp;&nbsp; }
<br />

<br />
&nbsp;&nbsp; foreach(</span><span class="default">$ps</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] as </span><span class="default">$key</span><span class="keyword">=&gt;</span><span class="default">$val</span><span class="keyword">){
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$pidinfo</span><span class="keyword">[</span><span class="default">$val</span><span class="keyword">] = </span><span class="default">$ps</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">][</span><span class="default">$key</span><span class="keyword">];
<br />
&nbsp;&nbsp; &nbsp;&nbsp; unset(</span><span class="default">$ps</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">][</span><span class="default">$key</span><span class="keyword">]);
<br />
&nbsp;&nbsp; }
<br />
&nbsp;&nbsp; 
<br />
&nbsp;&nbsp; if(</span><span class="default">is_array</span><span class="keyword">(</span><span class="default">$ps</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])){
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$pidinfo</span><span class="keyword">[</span><span class="default">$val</span><span class="keyword">].=</span><span class="string">" "</span><span class="keyword">.</span><span class="default">implode</span><span class="keyword">(</span><span class="string">" "</span><span class="keyword">, </span><span class="default">$ps</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);
<br />
&nbsp;&nbsp; }
<br />
&nbsp;&nbsp; return </span><span class="default">$pidinfo</span><span class="keyword">;
<br />
}
<br />

<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="51148""></a>
  <div class="note">
   <strong class="user">Pure-PHP</strong>
   <a href="#51148" class="date">21-Mar-2005 02:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can use this function also to avoid more than one instance of your app.<br />
<br />
You can also use this class.<br />
<a href="http://www.pure-php.de/node/20" rel="nofollow" target="_blank">http://www.pure-php.de/node/20</a><br />
<br />
Usage:<br />
<br />
<span class="default">&lt;?php<br />
<br />
inlude</span><span class="keyword">(</span><span class="string">"ProcessHandler.class.php"</span><span class="keyword">);<br />
<br />
if(</span><span class="default">ProcessHandler</span><span class="keyword">::</span><span class="default">isActive</span><span class="keyword">()){<br />
&nbsp;&nbsp; die(</span><span class="string">"Already running!\n"</span><span class="keyword">;);<br />
}else{<br />
&nbsp;&nbsp; </span><span class="default">ProcessHandler</span><span class="keyword">::</span><span class="default">activate</span><span class="keyword">();<br />
&nbsp;&nbsp; </span><span class="comment">//run my app<br />
</span><span class="keyword">}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="36859""></a>
  <div class="note">
   <strong class="user">brooke at jump dot net</strong>
   <a href="#36859" class="date">24-Oct-2003 05:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
One good use for this is deciding on a concurrency-safe temporary file or directory name. You can be assured that no two processes on the same server have the same PID, so this is enough to avoid collisions. For example:
<br />

<br />
<span class="default">&lt;?php
<br />
$tmpfile </span><span class="keyword">= </span><span class="string">"/tmp/foo_"</span><span class="keyword">.</span><span class="default">getmypid</span><span class="keyword">();
<br />
</span><span class="comment">// Use $tmpfile...
<br />
// Use $tmpfile...
<br />
// Use $tmpfile...
<br />
</span><span class="default">unlink </span><span class="keyword">(</span><span class="default">$tmpfile</span><span class="keyword">);
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
If you are sharing /tmp over the network (which is odd....) then you can, of course, mix in the PHP server's IP address.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
