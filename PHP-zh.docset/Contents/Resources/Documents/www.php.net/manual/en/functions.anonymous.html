<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>匿名函数</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="functions.internal.html">? 内部（内置）函数</a></li>
      <li style="float: right;"><a href="functions.arrow.html">箭头函数 ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="language.functions.html">函数</a></li>
    <li>匿名函数</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="functions.anonymous" class="sect1">
   <h2 class="title">匿名函数</h2>

   <p class="simpara">
    匿名函数（Anonymous functions），也叫闭包函数（<code class="literal">closures</code>），允许
    临时创建一个没有指定名称的函数。最经常用作回调函数 <span class="type"><a href="language.types.callable.html" class="type callable">callable</a></span>参数的值。当然，也有其它应用的情况。
   </p>
   <p class="simpara">
    匿名函数目前是通过 <a href="class.closure.html" class="link">
    <a href="class.closure.html" class="classname">Closure</a></a> 类来实现的。
   </p>

   <div class="example" id="example-175">
    <p><strong>Example #1 匿名函数示例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">echo&nbsp;</span><span style="color: #0000BB">preg_replace_callback</span><span style="color: #007700">(</span><span style="color: #DD0000">'~-([a-z])~'</span><span style="color: #007700">,&nbsp;function&nbsp;(</span><span style="color: #0000BB">$match</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">strtoupper</span><span style="color: #007700">(</span><span style="color: #0000BB">$match</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">]);<br />},&nbsp;</span><span style="color: #DD0000">'hello-world'</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//&nbsp;输出&nbsp;helloWorld<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>

   <p class="simpara">
    闭包函数也可以作为变量的值来使用。PHP 会自动把此种表达式转换成内置类
    <a href="class.closure.html" class="classname">Closure</a> 的对象实例。把一个 closure
    对象赋值给一个变量的方式与普通变量赋值的语法是一样的，最后也要加上分号：
   </p>

   <div class="example" id="example-176">
    <p><strong>Example #2 匿名函数变量赋值示例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$greet&nbsp;</span><span style="color: #007700">=&nbsp;function(</span><span style="color: #0000BB">$name</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Hello&nbsp;%s\r\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$name</span><span style="color: #007700">);<br />};<br /><br /></span><span style="color: #0000BB">$greet</span><span style="color: #007700">(</span><span style="color: #DD0000">'World'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$greet</span><span style="color: #007700">(</span><span style="color: #DD0000">'PHP'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>

   <p class="simpara">
    闭包可以从父作用域中继承变量。
   任何此类变量都应该用 <code class="literal">use</code> 语言结构传递进去。
    PHP 7.1 起，不能传入此类变量：  <a href="language.variables.predefined.html" class="link">superglobals</a>、 <var class="varname">$this</var> 或者和参数重名。
   </p>

   <div class="example" id="example-177">
    <p><strong>Example #3 从父作用域继承变量</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$message&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'hello'</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;没有&nbsp;"use"<br /></span><span style="color: #0000BB">$example&nbsp;</span><span style="color: #007700">=&nbsp;function&nbsp;()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$message</span><span style="color: #007700">);<br />};<br /></span><span style="color: #0000BB">$example</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;继承&nbsp;$message<br /></span><span style="color: #0000BB">$example&nbsp;</span><span style="color: #007700">=&nbsp;function&nbsp;()&nbsp;use&nbsp;(</span><span style="color: #0000BB">$message</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$message</span><span style="color: #007700">);<br />};<br /></span><span style="color: #0000BB">$example</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;Inherited&nbsp;variable's&nbsp;value&nbsp;is&nbsp;from&nbsp;when&nbsp;the&nbsp;function<br />//&nbsp;is&nbsp;defined,&nbsp;not&nbsp;when&nbsp;called<br /></span><span style="color: #0000BB">$message&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'world'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$example</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;Reset&nbsp;message<br /></span><span style="color: #0000BB">$message&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'hello'</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;Inherit&nbsp;by-reference<br /></span><span style="color: #0000BB">$example&nbsp;</span><span style="color: #007700">=&nbsp;function&nbsp;()&nbsp;use&nbsp;(&amp;</span><span style="color: #0000BB">$message</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$message</span><span style="color: #007700">);<br />};<br /></span><span style="color: #0000BB">$example</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;The&nbsp;changed&nbsp;value&nbsp;in&nbsp;the&nbsp;parent&nbsp;scope<br />//&nbsp;is&nbsp;reflected&nbsp;inside&nbsp;the&nbsp;function&nbsp;call<br /></span><span style="color: #0000BB">$message&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'world'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$example</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;Closures&nbsp;can&nbsp;also&nbsp;accept&nbsp;regular&nbsp;arguments<br /></span><span style="color: #0000BB">$example&nbsp;</span><span style="color: #007700">=&nbsp;function&nbsp;(</span><span style="color: #0000BB">$arg</span><span style="color: #007700">)&nbsp;use&nbsp;(</span><span style="color: #0000BB">$message</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$arg&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">'&nbsp;'&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$message</span><span style="color: #007700">);<br />};<br /></span><span style="color: #0000BB">$example</span><span style="color: #007700">(</span><span style="color: #DD0000">"hello"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>以上例程的输出类似于：</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
Notice: Undefined variable: message in /example.php on line 6
NULL
string(5) &quot;hello&quot;
string(5) &quot;hello&quot;
string(5) &quot;hello&quot;
string(5) &quot;world&quot;
string(11) &quot;hello world&quot;
</pre></div>
    </div>
   </div>

   <p class="para">
    从 PHP 8.0.0 开始，作用域继承的变量列表可能包含一个尾部的逗号，这个逗号将被忽略。
   </p>
  <p class="simpara">
    这些变量都必须在函数或类的头部声明。

    从父作用域中继承变量与使用全局变量是<em class="emphasis">不同</em>的。全局变量存在于一个全局的范围，无论当前在执行的是哪个函数。而
    闭包的父作用域是定义该闭包的函数（不一定是调用它的函数）。示例如下：
   </p>

   <div class="example" id="example-178">
    <p><strong>Example #4 Closures 和作用域</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">//&nbsp;一个基本的购物车，包括一些已经添加的商品和每种商品的数量。<br />//&nbsp;其中有一个方法用来计算购物车中所有商品的总价格，该方法使<br />//&nbsp;用了一个&nbsp;closure&nbsp;作为回调函数。<br /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Cart<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;</span><span style="color: #0000BB">PRICE_BUTTER&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">1.00</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;</span><span style="color: #0000BB">PRICE_MILK&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">3.00</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;</span><span style="color: #0000BB">PRICE_EGGS&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">6.95</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;</span><span style="color: #0000BB">$products&nbsp;</span><span style="color: #007700">=&nbsp;array();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">add</span><span style="color: #007700">(</span><span style="color: #0000BB">$product</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$quantity</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">products</span><span style="color: #007700">[</span><span style="color: #0000BB">$product</span><span style="color: #007700">]&nbsp;=&nbsp;</span><span style="color: #0000BB">$quantity</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getQuantity</span><span style="color: #007700">(</span><span style="color: #0000BB">$product</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;isset(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">products</span><span style="color: #007700">[</span><span style="color: #0000BB">$product</span><span style="color: #007700">])&nbsp;?&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">products</span><span style="color: #007700">[</span><span style="color: #0000BB">$product</span><span style="color: #007700">]&nbsp;:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">FALSE</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getTotal</span><span style="color: #007700">(</span><span style="color: #0000BB">$tax</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$total&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">0.00</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$callback&nbsp;</span><span style="color: #007700">=<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;(</span><span style="color: #0000BB">$quantity</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$product</span><span style="color: #007700">)&nbsp;use&nbsp;(</span><span style="color: #0000BB">$tax</span><span style="color: #007700">,&nbsp;&amp;</span><span style="color: #0000BB">$total</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$pricePerItem&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">constant</span><span style="color: #007700">(</span><span style="color: #0000BB">__CLASS__&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">"::PRICE_"&nbsp;</span><span style="color: #007700">.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">strtoupper</span><span style="color: #007700">(</span><span style="color: #0000BB">$product</span><span style="color: #007700">));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$total&nbsp;</span><span style="color: #007700">+=&nbsp;(</span><span style="color: #0000BB">$pricePerItem&nbsp;</span><span style="color: #007700">*&nbsp;</span><span style="color: #0000BB">$quantity</span><span style="color: #007700">)&nbsp;*&nbsp;(</span><span style="color: #0000BB">$tax&nbsp;</span><span style="color: #007700">+&nbsp;</span><span style="color: #0000BB">1.0</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">array_walk</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">products</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$callback</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">round</span><span style="color: #007700">(</span><span style="color: #0000BB">$total</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">2</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br /></span><span style="color: #0000BB">$my_cart&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Cart</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;往购物车里添加条目<br /></span><span style="color: #0000BB">$my_cart</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">add</span><span style="color: #007700">(</span><span style="color: #DD0000">'butter'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$my_cart</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">add</span><span style="color: #007700">(</span><span style="color: #DD0000">'milk'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">3</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$my_cart</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">add</span><span style="color: #007700">(</span><span style="color: #DD0000">'eggs'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">6</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;打出出总价格，其中有&nbsp;5%&nbsp;的销售税.<br /></span><span style="color: #007700">print&nbsp;</span><span style="color: #0000BB">$my_cart</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getTotal</span><span style="color: #007700">(</span><span style="color: #0000BB">0.05</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br /></span><span style="color: #FF8000">//&nbsp;最后结果是&nbsp;54.29<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>

   <div class="example" id="example-179">
    <p><strong>Example #5 自动绑定 <code class="literal">$this</code></strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Test<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">testing</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;function()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br /></span><span style="color: #0000BB">$object&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Test</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$function&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$object</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">testing</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$function</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>以上例程会输出：</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
object(Test)#1 (0) {
}
</pre></div>
    </div>
   </div>

   <p class="para">
    当在类的上下文中声明时，当前的类会自动与之绑定，使得
    <code class="literal">$this</code> 在函数的作用域中可用。如果不需要当前类的自动绑定，可以使用
    <a href="functions.anonymous.html#functions.anonymous-functions.static" class="link">静态匿名函数</a> 替代。
   </p>

   <div class="sect2" id="functions.anonymous-functions.static">
    <h3 class="title">静态匿名函数</h3>
    <p class="para">
     匿名函数允许被定义为静态化。这样可以防止当前类自动绑定到它们身上，对象在运行时也可能不会被绑定到它们上面。
    </p>
    <p class="para">
     <div class="example" id="example-180">
      <p><strong>Example #6 试图在静态匿名函数中使用 <code class="literal">$this</code></strong></p>
      <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Foo<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;</span><span style="color: #0000BB">__construct</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$func&nbsp;</span><span style="color: #007700">=&nbsp;static&nbsp;function()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$func</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />};<br />new&nbsp;</span><span style="color: #0000BB">Foo</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
      </div>

      <div class="example-contents"><p>以上例程会输出：</p></div>
      <div class="example-contents screen">
<div class="cdata"><pre>
Notice: Undefined variable: this in %s on line %d
NULL
</pre></div>
      </div>
     </div>
    </p>

    <p class="para">
     <div class="example" id="example-181">
      <p><strong>Example #7 试图将对象绑定到静态匿名函数</strong></p>
      <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$func&nbsp;</span><span style="color: #007700">=&nbsp;static&nbsp;function()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;function&nbsp;body<br /></span><span style="color: #007700">};<br /></span><span style="color: #0000BB">$func&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$func</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bindTo</span><span style="color: #007700">(new&nbsp;</span><span style="color: #0000BB">StdClass</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$func</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
      </div>

      <div class="example-contents"><p>以上例程会输出：</p></div>
      <div class="example-contents screen">
<div class="cdata"><pre>
Warning: Cannot bind an instance to a static closure in %s on line %d
</pre></div>
      </div>
     </div>
    </p>
   </div>

   <div class="sect2">
    <h3 class="title">更新日志</h3>
    <p class="para">
     <table class="doctable informaltable">
      
       <thead>
        <tr>
         <th>版本</th>
         <th>说明</th>
        </tr>

       </thead>

       <tbody class="tbody">
        <tr>
         <td>7.1.0</td>
         <td>
          Anonymous functions may not close over <a href="language.variables.predefined.html" class="link">superglobals</a>,
          <var class="varname">$this</var>, or any variable with the same name as a
          parameter.
         </td>
        </tr>

       </tbody>
      
     </table>

    </p>
   </div>

   <div class="sect2">
    <h3 class="title">注释</h3>
    <blockquote class="note"><p><strong class="note">Note</strong>: 
     <span class="simpara">
      可以在闭包中使用
      <span class="function"><a href="function.func-num-args.html" class="function">func_num_args()</a></span>，<span class="function"><a href="function.func-get-arg.html" class="function">func_get_arg()</a></span>
      和 <span class="function"><a href="function.func-get-args.html" class="function">func_get_args()</a></span>。
     </span>
    </p></blockquote>
   </div>

  </div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="123498""></a>
  <div class="note">
   <strong class="user">jake dot tunaley at berkeleyit dot com</strong>
   <a href="#123498" class="date">07-Jan-2019 05:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Beware of using $this in anonymous functions assigned to a static variable.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">Foo </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">bar</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; static </span><span class="default">$anonymous </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$anonymous </span><span class="keyword">=== </span><span class="default">null</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Expression is not allowed as static initializer workaround<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$anonymous </span><span class="keyword">= function () {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; };<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$anonymous</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">$a </span><span class="keyword">= new </span><span class="default">Foo</span><span class="keyword">();<br />
</span><span class="default">$b </span><span class="keyword">= new </span><span class="default">Foo</span><span class="keyword">();<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$a</span><span class="keyword">-&gt;</span><span class="default">bar</span><span class="keyword">() === </span><span class="default">$a</span><span class="keyword">); </span><span class="comment">// True<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$b</span><span class="keyword">-&gt;</span><span class="default">bar</span><span class="keyword">() === </span><span class="default">$a</span><span class="keyword">); </span><span class="comment">// Also true<br />
</span><span class="default">?&gt;<br />
</span><br />
In a static anonymous function, $this will be the value of whatever object instance that method was called on first.<br />
<br />
To get the behaviour you're probably expecting, you need to pass the $this context into the function.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">Foo </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">bar</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; static </span><span class="default">$anonymous </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$anonymous </span><span class="keyword">=== </span><span class="default">null</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Expression is not allowed as static initializer workaround<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$anonymous </span><span class="keyword">= function (</span><span class="default">self $thisObj</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$thisObj</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; };<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$anonymous</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">$a </span><span class="keyword">= new </span><span class="default">Foo</span><span class="keyword">();<br />
</span><span class="default">$b </span><span class="keyword">= new </span><span class="default">Foo</span><span class="keyword">();<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$a</span><span class="keyword">-&gt;</span><span class="default">bar</span><span class="keyword">() === </span><span class="default">$a</span><span class="keyword">); </span><span class="comment">// True<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$b</span><span class="keyword">-&gt;</span><span class="default">bar</span><span class="keyword">() === </span><span class="default">$a</span><span class="keyword">); </span><span class="comment">// False<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="122809""></a>
  <div class="note">
   <strong class="user">dexen dot devries at gmail dot com</strong>
   <a href="#122809" class="date">07-Jun-2018 09:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Every instance of a lambda has own instance of static variables. This provides for great event handlers, accumulators, etc., etc.<br />
<br />
Creating new lambda with function() { ... }; expression creates new instance of its static variables. Assigning a lambda to a variable does not create a new instance. A lambda is object of class Closure, and assigning lambdas to variables has the same semantics as assigning object instance to variables.<br />
<br />
Example script: $a and $b have separate instances of static variables, thus produce different output. However $b and $c share their instance of static variables - because $c is refers to the same object of class Closure as $b - thus produce the same output.<br />
<br />
#!/usr/bin/env php<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">generate_lambda</span><span class="keyword">() : </span><span class="default">Closure<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment"># creates new instance of lambda<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">return function(</span><span class="default">$v </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; static </span><span class="default">$stored</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$v </span><span class="keyword">!== </span><span class="default">null</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$stored </span><span class="keyword">= </span><span class="default">$v</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$stored</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; };<br />
}<br />
<br />
</span><span class="default">$a </span><span class="keyword">= </span><span class="default">generate_lambda</span><span class="keyword">();&nbsp; </span><span class="comment"># creates new instance of statics<br />
</span><span class="default">$b </span><span class="keyword">= </span><span class="default">generate_lambda</span><span class="keyword">();&nbsp; </span><span class="comment"># creates new instance of statics<br />
</span><span class="default">$c </span><span class="keyword">= </span><span class="default">$b</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment"># uses the same instance of statics as $b<br />
<br />
</span><span class="default">$a</span><span class="keyword">(</span><span class="string">'test AAA'</span><span class="keyword">);<br />
</span><span class="default">$b</span><span class="keyword">(</span><span class="string">'test BBB'</span><span class="keyword">);<br />
</span><span class="default">$c</span><span class="keyword">(</span><span class="string">'test CCC'</span><span class="keyword">);&nbsp; </span><span class="comment"># this overwrites content held by $b, because it refers to the same object<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">([ </span><span class="default">$a</span><span class="keyword">(), </span><span class="default">$b</span><span class="keyword">(), </span><span class="default">$c</span><span class="keyword">() ]);<br />
</span><span class="default">?&gt;<br />
</span><br />
This test script outputs:<br />
array(3) {<br />
&nbsp; [0]=&gt;<br />
&nbsp; string(8) "test AAA"<br />
&nbsp; [1]=&gt;<br />
&nbsp; string(8) "test CCC"<br />
&nbsp; [2]=&gt;<br />
&nbsp; string(8) "test CCC"<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="122182""></a>
  <div class="note">
   <strong class="user">toonitw at gmail dot com</strong>
   <a href="#122182" class="date">27-Dec-2017 05:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As of PHP 7.0, you can use IIFE(Immediately-invoked function expression) by wrapping your anonymous function with ().<br />
<br />
<span class="default">&lt;?php<br />
$type </span><span class="keyword">= </span><span class="string">'number'</span><span class="keyword">;<br />
</span><span class="default">var_dump</span><span class="keyword">( ...( function() use (</span><span class="default">$type</span><span class="keyword">) { <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$type</span><span class="keyword">==</span><span class="string">'number'</span><span class="keyword">) return [</span><span class="default">1</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">,</span><span class="default">3</span><span class="keyword">]; <br />
&nbsp;&nbsp;&nbsp; else if (</span><span class="default">$type</span><span class="keyword">==</span><span class="string">'alphabet'</span><span class="keyword">) return [</span><span class="string">'a'</span><span class="keyword">,</span><span class="string">'b'</span><span class="keyword">,</span><span class="string">'c'</span><span class="keyword">];<br />
} )() );<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121034""></a>
  <div class="note">
   <strong class="user">ayon at hyurl dot com</strong>
   <a href="#121034" class="date">29-Apr-2017 05:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
One way to call a anonymous function recursively is to use the USE keyword and pass a reference to the function itself:<br />
<br />
<span class="default">&lt;?php<br />
$count </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br />
</span><span class="default">$add </span><span class="keyword">= function(</span><span class="default">$count</span><span class="keyword">) use (&amp;</span><span class="default">$add</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$count </span><span class="keyword">+= </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">$count </span><span class="keyword">&lt; </span><span class="default">10</span><span class="keyword">) </span><span class="default">$count </span><span class="keyword">= </span><span class="default">$add</span><span class="keyword">(</span><span class="default">$count</span><span class="keyword">); </span><span class="comment">//recursive calling<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">$count</span><span class="keyword">;<br />
};<br />
echo </span><span class="default">$add</span><span class="keyword">(</span><span class="default">$count</span><span class="keyword">); </span><span class="comment">//Will output 10 as expected<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120611""></a>
  <div class="note">
   <strong class="user">john at binkmail dot com</strong>
   <a href="#120611" class="date">07-Feb-2017 07:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PERFORMANCE BENCHMARK 2017!<br />
<br />
I decided to compare a single, saved closure against constantly creating the same anonymous closure on every loop iteration. And I tried 10 million loop iterations, in PHP 7.0.14 from Dec 2016. Result:<br />
<br />
a single saved closure kept in a variable and re-used (10000000 iterations): 1.3874590396881 seconds<br />
<br />
new anonymous closure created each time (10000000 iterations): 2.8460240364075 seconds<br />
<br />
In other words, over the course of 10 million iterations, creating the closure again during every iteration only added a total of "1.459 seconds" to the runtime. So that means that every creation of a new anonymous closure takes about 146 nanoseconds on my 7 years old dual-core laptop. I guess PHP keeps a cached "template" for the anonymous function and therefore doesn't need much time to create a new instance of the closure!<br />
<br />
So you do NOT have to worry about constantly re-creating your anonymous closures over and over again in tight loops! At least not as of PHP 7! There is absolutely NO need to save an instance in a variable and re-use it. And not being restricted by that is a great thing, because it means you can feel free to use anonymous functions exactly where they matter, as opposed to defining them somewhere else in the code. :-)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117504""></a>
  <div class="note">
   <strong class="user">erolmon dot kskn at gmail dot com</strong>
   <a href="#117504" class="date">19-Jun-2015 09:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/*<br />
&nbsp;&nbsp;&nbsp; (string) $name Name of the function that you will add to class.<br />
&nbsp;&nbsp;&nbsp; Usage : $Foo-&gt;add(function(){},$name);<br />
&nbsp;&nbsp;&nbsp; This will add a public function in Foo Class.<br />
&nbsp;&nbsp;&nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">class </span><span class="default">Foo<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public function </span><span class="default">add</span><span class="keyword">(</span><span class="default">$func</span><span class="keyword">,</span><span class="default">$name</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;{</span><span class="default">$name</span><span class="keyword">} = </span><span class="default">$func</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public function </span><span class="default">__call</span><span class="keyword">(</span><span class="default">$func</span><span class="keyword">,</span><span class="default">$arguments</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">call_user_func_array</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;{</span><span class="default">$func</span><span class="keyword">}, </span><span class="default">$arguments</span><span class="keyword">); <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$Foo </span><span class="keyword">= new </span><span class="default">Foo</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$Foo</span><span class="keyword">-&gt;</span><span class="default">add</span><span class="keyword">(function(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Hello World"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; },</span><span class="string">"helloWorldFunction"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$Foo</span><span class="keyword">-&gt;</span><span class="default">add</span><span class="keyword">(function(</span><span class="default">$parameterone</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="default">$parameterone</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; },</span><span class="string">"exampleFunction"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$Foo</span><span class="keyword">-&gt;</span><span class="default">helloWorldFunction</span><span class="keyword">(); </span><span class="comment">/*Output : Hello World*/<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$Foo</span><span class="keyword">-&gt;</span><span class="default">exampleFunction</span><span class="keyword">(</span><span class="string">"Hello PHP"</span><span class="keyword">); </span><span class="comment">/*Output : Hello PHP*/<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="114433""></a>
  <div class="note">
   <strong class="user">mail at mkharitonov dot net</strong>
   <a href="#114433" class="date">20-Feb-2014 11:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Some comparisons of PHP and JavaScript closures.<br />
<br />
=== Example 1 (passing by value) ===<br />
PHP code:<br />
<span class="default">&lt;?php<br />
$aaa </span><span class="keyword">= </span><span class="default">111</span><span class="keyword">;<br />
</span><span class="default">$func </span><span class="keyword">= function() use(</span><span class="default">$aaa</span><span class="keyword">){ print </span><span class="default">$aaa</span><span class="keyword">; };<br />
</span><span class="default">$aaa </span><span class="keyword">= </span><span class="default">222</span><span class="keyword">;<br />
</span><span class="default">$func</span><span class="keyword">(); </span><span class="comment">// Outputs "111"<br />
</span><span class="default">?&gt;<br />
</span><br />
Similar JavaScript code:<br />
&lt;script type="text/javascript"&gt;<br />
var aaa = 111;<br />
var func = (function(aaa){ return function(){ alert(aaa); } })(aaa);<br />
aaa = 222;<br />
func(); // Outputs "111"<br />
&lt;/script&gt;<br />
<br />
Be careful, following code is not similar to previous code:<br />
&lt;script type="text/javascript"&gt;<br />
var aaa = 111;<br />
var bbb = aaa;<br />
var func = function(){ alert(bbb); };<br />
aaa = 222;<br />
func(); // Outputs "111", but only while "bbb" is not changed after function declaration<br />
<br />
// And this technique is not working in loops:<br />
var functions = [];<br />
for (var i = 0; i &lt; 2; i++)<br />
{<br />
&nbsp;&nbsp;&nbsp; var i2 = i;<br />
&nbsp;&nbsp;&nbsp; functions.push(function(){ alert(i2); });<br />
}<br />
functions[0](); // Outputs "1", wrong!<br />
functions[1](); // Outputs "1", ok<br />
&lt;/script&gt;<br />
<br />
=== Example 2 (passing by reference) ===<br />
PHP code:<br />
<span class="default">&lt;?php<br />
$aaa </span><span class="keyword">= </span><span class="default">111</span><span class="keyword">;<br />
</span><span class="default">$func </span><span class="keyword">= function() use(&amp;</span><span class="default">$aaa</span><span class="keyword">){ print </span><span class="default">$aaa</span><span class="keyword">; };<br />
</span><span class="default">$aaa </span><span class="keyword">= </span><span class="default">222</span><span class="keyword">;<br />
</span><span class="default">$func</span><span class="keyword">(); </span><span class="comment">// Outputs "222"<br />
</span><span class="default">?&gt;<br />
</span><br />
Similar JavaScript code:<br />
&lt;script type="text/javascript"&gt;<br />
var aaa = 111;<br />
var func = function(){ alert(aaa); };<br />
aaa = 222; // Outputs "222"<br />
func();<br />
&lt;/script&gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="114079""></a>
  <div class="note">
   <strong class="user">derkontrollfreak+9hy5l at gmail dot com</strong>
   <a href="#114079" class="date">09-Jan-2014 04:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Beware that since PHP 5.4 registering a Closure as an object property that has been instantiated in the same object scope will create a circular reference which prevents immediate object destruction:<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">class </span><span class="default">Test<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; private </span><span class="default">$closure</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__construct</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">closure </span><span class="keyword">= function () {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; };<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__destruct</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"destructed\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
new </span><span class="default">Test</span><span class="keyword">;<br />
echo </span><span class="string">"finished\n"</span><span class="keyword">;<br />
<br />
</span><span class="comment">/*<br />
&nbsp;* Result in PHP 5.3:<br />
&nbsp;* ------------------<br />
&nbsp;* destructed<br />
&nbsp;* finished<br />
&nbsp;*<br />
&nbsp;* Result since PHP 5.4:<br />
&nbsp;* ---------------------<br />
&nbsp;* finished<br />
&nbsp;* destructed<br />
&nbsp;*/<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
To circumvent this, you can instantiate the Closure in a static method:<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">public function </span><span class="default">__construct</span><span class="keyword">()<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">closure </span><span class="keyword">= </span><span class="default">self</span><span class="keyword">::</span><span class="default">createClosure</span><span class="keyword">();<br />
}<br />
<br />
public static function </span><span class="default">createClosure</span><span class="keyword">()<br />
{<br />
&nbsp;&nbsp;&nbsp; return function () {<br />
&nbsp;&nbsp;&nbsp; };<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="113896""></a>
  <div class="note">
   <strong class="user">cHao</strong>
   <a href="#113896" class="date">13-Dec-2013 11:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In case you were wondering (cause i was), anonymous functions can return references just like named functions can.&nbsp; Simply use the &amp; the same way you would for a named function...right after the `function` keyword (and right before the nonexistent name).<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; $value </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$fn </span><span class="keyword">= function &amp;() use (&amp;</span><span class="default">$value</span><span class="keyword">) { return </span><span class="default">$value</span><span class="keyword">; };<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$x </span><span class="keyword">=&amp; </span><span class="default">$fn</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">, </span><span class="default">$value</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// 'int(0)', 'int(0)'<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">++</span><span class="default">$x</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">, </span><span class="default">$value</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// 'int(1)', 'int(1)'</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107245""></a>
  <div class="note">
   <strong class="user">mike at borft dot student dot utwente dot nl</strong>
   <a href="#107245" class="date">24-Jan-2012 02:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Since it is possible to assign closures to class variables, it is a shame it is not possible to call them directly. ie. the following does not work:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">foo </span><span class="keyword">{<br />
<br />
&nbsp; public </span><span class="default">test</span><span class="keyword">;<br />
<br />
&nbsp; public function </span><span class="default">__construct</span><span class="keyword">(){<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">test </span><span class="keyword">= function(</span><span class="default">$a</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; print </span><span class="string">"</span><span class="default">$a</span><span class="string">\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; };<br />
&nbsp; }<br />
}<br />
<br />
</span><span class="default">$f </span><span class="keyword">= new </span><span class="default">foo</span><span class="keyword">();<br />
<br />
</span><span class="default">$f</span><span class="keyword">-&gt;</span><span class="default">test</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span><br />
However, it is possible using the magic __call function:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">foo </span><span class="keyword">{<br />
<br />
&nbsp; public </span><span class="default">test</span><span class="keyword">;<br />
<br />
&nbsp; public function </span><span class="default">__construct</span><span class="keyword">(){<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">test </span><span class="keyword">= function(</span><span class="default">$a</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; print </span><span class="string">"</span><span class="default">$a</span><span class="string">\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; };<br />
&nbsp; }<br />
<br />
&nbsp; public function </span><span class="default">__call</span><span class="keyword">(</span><span class="default">$method</span><span class="keyword">, </span><span class="default">$args</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; if ( </span><span class="default">$this</span><span class="keyword">-&gt;{</span><span class="default">$method</span><span class="keyword">} instanceof </span><span class="default">Closure </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; return </span><span class="default">call_user_func_array</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;{</span><span class="default">$method</span><span class="keyword">},</span><span class="default">$args</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp;&nbsp; return </span><span class="default">parent</span><span class="keyword">::</span><span class="default">__call</span><span class="keyword">(</span><span class="default">$method</span><span class="keyword">, </span><span class="default">$args</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; }<br />
}<br />
</span><span class="default">$f </span><span class="keyword">= new </span><span class="default">foo</span><span class="keyword">();<br />
</span><span class="default">$f</span><span class="keyword">-&gt;</span><span class="default">test</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span>it <br />
Hope it helps someone ;)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105261""></a>
  <div class="note">
   <strong class="user">simon at generalflows dot com</strong>
   <a href="#105261" class="date">05-Aug-2011 08:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">/* <br />
&nbsp;* An example showing how to use closures to implement a Python-like decorator <br />
&nbsp;* pattern.<br />
&nbsp;*<br />
&nbsp;* My goal was that you should be able to decorate a function with any<br />
&nbsp;* other function, then call the decorated function directly: <br />
&nbsp;*<br />
&nbsp;* Define function:&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $foo = function($a, $b, $c, ...) {...}<br />
&nbsp;* Define decorator:&nbsp; &nbsp; &nbsp; &nbsp; $decorator = function($func) {...}<br />
&nbsp;* Decorate it:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $foo = $decorator($foo)<br />
&nbsp;* Call it:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $foo($a, $b, $c, ...)<br />
&nbsp;*<br />
&nbsp;* This example show an authentication decorator for a service, using a simple<br />
&nbsp;* mock session and mock service. <br />
&nbsp;*/<br />
&nbsp;<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
<br />
</span><span class="comment">/* <br />
&nbsp;* Define an example decorator. A decorator function should take the form:<br />
&nbsp;* $decorator = function($func) {<br />
&nbsp;*&nbsp; &nbsp;&nbsp; return function() use $func) {<br />
&nbsp;*&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // Do something, then call the decorated function when needed:<br />
&nbsp;*&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $args = func_get_args($func);<br />
&nbsp;*&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; call_user_func_array($func, $args);<br />
&nbsp;*&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // Do something else.<br />
&nbsp;*&nbsp; &nbsp;&nbsp; };<br />
&nbsp;* };<br />
&nbsp;*/<br />
</span><span class="default">$authorise </span><span class="keyword">= function(</span><span class="default">$func</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; return function() use (</span><span class="default">$func</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'is_authorised'</span><span class="keyword">] == </span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$args </span><span class="keyword">= </span><span class="default">func_get_args</span><span class="keyword">(</span><span class="default">$func</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">call_user_func_array</span><span class="keyword">(</span><span class="default">$func</span><span class="keyword">, </span><span class="default">$args</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Access Denied"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; };<br />
};<br />
<br />
</span><span class="comment">/* <br />
&nbsp;* Define a function to be decorated, in this example a mock service that<br />
&nbsp;* need to be authorised. <br />
&nbsp;*/ <br />
</span><span class="default">$service </span><span class="keyword">= function(</span><span class="default">$foo</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Service returns: </span><span class="default">$foo</span><span class="string">"</span><span class="keyword">;<br />
};<br />
<br />
</span><span class="comment">/* <br />
&nbsp;* Decorate it. Ensure you replace the origin function reference with the<br />
&nbsp;* decorated function; ie just $authorise($service) won't work, so do<br />
&nbsp;* $service = $authorise($service)<br />
&nbsp;*/<br />
</span><span class="default">$service </span><span class="keyword">= </span><span class="default">$authorise</span><span class="keyword">(</span><span class="default">$service</span><span class="keyword">);<br />
<br />
</span><span class="comment">/* <br />
&nbsp;* Establish mock authorisation, call the service; should get <br />
&nbsp;* 'Service returns: test 1'. <br />
&nbsp;*/<br />
</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'is_authorised'</span><span class="keyword">] = </span><span class="default">true</span><span class="keyword">;<br />
</span><span class="default">$service</span><span class="keyword">(</span><span class="string">'test 1'</span><span class="keyword">);<br />
<br />
</span><span class="comment">/* <br />
&nbsp;* Remove mock authorisation, call the service; should get 'Access Denied'. <br />
&nbsp;*/<br />
</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'is_authorised'</span><span class="keyword">] = </span><span class="default">false</span><span class="keyword">;<br />
</span><span class="default">$service</span><span class="keyword">(</span><span class="string">'test 2'</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99287""></a>
  <div class="note">
   <strong class="user">orls</strong>
   <a href="#99287" class="date">08-Aug-2010 06:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Watch out when 'importing' variables to a closure's scope&nbsp; -- it's easy to miss / forget that they are actually being *copied* into the closure's scope, rather than just being made available.<br />
<br />
So you will need to explicitly pass them in by reference if your closure cares about their contents over time:<br />
<br />
<span class="default">&lt;?php<br />
$result </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
<br />
</span><span class="default">$one </span><span class="keyword">= function()<br />
{ </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">); };<br />
<br />
</span><span class="default">$two </span><span class="keyword">= function() use (</span><span class="default">$result</span><span class="keyword">)<br />
{ </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">); };<br />
<br />
</span><span class="default">$three </span><span class="keyword">= function() use (&amp;</span><span class="default">$result</span><span class="keyword">)<br />
{ </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">); };<br />
<br />
</span><span class="default">$result</span><span class="keyword">++;<br />
<br />
</span><span class="default">$one</span><span class="keyword">();&nbsp; &nbsp; </span><span class="comment">// outputs NULL: $result is not in scope<br />
</span><span class="default">$two</span><span class="keyword">();&nbsp; &nbsp; </span><span class="comment">// outputs int(0): $result was copied<br />
</span><span class="default">$three</span><span class="keyword">();&nbsp; &nbsp; </span><span class="comment">// outputs int(1)<br />
</span><span class="default">?&gt;<br />
</span><br />
Another less trivial example with objects (what I actually tripped up on):<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//set up variable in advance<br />
</span><span class="default">$myInstance </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
<br />
</span><span class="default">$broken </span><span class="keyword">= function() </span><span class="default">uses </span><span class="keyword">(</span><span class="default">$myInstance</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; if(!empty(</span><span class="default">$myInstance</span><span class="keyword">)) </span><span class="default">$myInstance</span><span class="keyword">-&gt;</span><span class="default">doSomething</span><span class="keyword">();<br />
};<br />
<br />
</span><span class="default">$working </span><span class="keyword">= function() </span><span class="default">uses </span><span class="keyword">(&amp;</span><span class="default">$myInstance</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; if(!empty(</span><span class="default">$myInstance</span><span class="keyword">)) </span><span class="default">$myInstance</span><span class="keyword">-&gt;</span><span class="default">doSomething</span><span class="keyword">();<br />
}<br />
<br />
</span><span class="comment">//$myInstance might be instantiated, might not be<br />
</span><span class="keyword">if(</span><span class="default">SomeBusinessLogic</span><span class="keyword">::</span><span class="default">worked</span><span class="keyword">() == </span><span class="default">true</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$myInstance </span><span class="keyword">= new </span><span class="default">myClass</span><span class="keyword">();<br />
}<br />
<br />
</span><span class="default">$broken</span><span class="keyword">();&nbsp; &nbsp; </span><span class="comment">// will never do anything: $myInstance will ALWAYS be null inside this closure.<br />
</span><span class="default">$working</span><span class="keyword">();&nbsp; &nbsp; </span><span class="comment">// will call doSomething if $myInstance is instantiated<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98978""></a>
  <div class="note">
   <strong class="user">gabriel dot totoliciu at ddsec dot net</strong>
   <a href="#98978" class="date">19-Jul-2010 10:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want to make a recursive closure, you will need to write this:<br />
<br />
$some_var1="1";<br />
$some_var2="2";<br />
<br />
function($param1, $param2) use ($some_var1, $some_var2)<br />
{<br />
<br />
//some code here<br />
<br />
call_user_func(__FUNCTION__, $other_param1, $other_param2);<br />
<br />
//some code here<br />
<br />
}<br />
<br />
If you need to pass values by reference you should check out<br />
<br />
<a href="http://www.php.net/manual/en/function.call-user-func.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/function.call-user-func.php</a><br />
<a href="http://www.php.net/manual/en/function.call-user-func-array.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/function.call-user-func-array.php</a><br />
<br />
If you're wondering if $some_var1 and $some_var2 are still visible by using the call_user_func, yes, they are available.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97906""></a>
  <div class="note">
   <strong class="user">kdelux at gmail dot com</strong>
   <a href="#97906" class="date">14-May-2010 08:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is an example of one way to define, then use the variable ( $this ) in Closure functions.&nbsp; The code below explores all uses, and shows restrictions.<br />
<br />
The most useful tool in this snippet is the requesting_class() function that will tell you which class is responsible for executing the current Closure().&nbsp; <br />
<br />
Overview:<br />
-----------------------<br />
Successfully find calling object reference.<br />
Successfully call $this(__invoke);<br />
Successfully reference $$this-&gt;name;<br />
Successfully call call_user_func(array($this, 'method'))<br />
<br />
Failure: reference anything through $this-&gt;<br />
Failure: $this-&gt;name = ''; <br />
Failure: $this-&gt;delfect(); <br />
<br />
<span class="default">&lt;?php<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">requesting_class</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach(</span><span class="default">debug_backtrace</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">) as </span><span class="default">$stack</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(isset(</span><span class="default">$stack</span><span class="keyword">[</span><span class="string">'object'</span><span class="keyword">])){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$stack</span><span class="keyword">[</span><span class="string">'object'</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; class </span><span class="default">Person<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public </span><span class="default">$name </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public </span><span class="default">$head </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public </span><span class="default">$feet </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public </span><span class="default">$deflected </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">__invoke</span><span class="keyword">(</span><span class="default">$p</span><span class="keyword">){ return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">$p</span><span class="keyword">; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">__toString</span><span class="keyword">(){ return </span><span class="string">'this'</span><span class="keyword">; } </span><span class="comment">// test for reference<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$name</span><span class="keyword">){ </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">name </span><span class="keyword">= </span><span class="default">$name</span><span class="keyword">; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">deflect</span><span class="keyword">(){ </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">deflected </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public function </span><span class="default">shoot</span><span class="keyword">()<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; { </span><span class="comment">// If customAttack is defined, use that as the shoot resut.&nbsp; Otherwise shoot feet<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">is_callable</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">customAttack</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">call_user_func</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">customAttack</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">feet </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$p </span><span class="keyword">= new </span><span class="default">Person</span><span class="keyword">(</span><span class="string">'Bob'</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$p</span><span class="keyword">-&gt;</span><span class="default">customAttack </span><span class="keyword">= <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; function(){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="default">$this</span><span class="keyword">; </span><span class="comment">// Notice: Undefined variable: this<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #$this = new Class() // FATAL ERROR<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // Trick to assign the variable '$this'<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">extract</span><span class="keyword">(array(</span><span class="string">'this' </span><span class="keyword">=&gt; </span><span class="default">requesting_class</span><span class="keyword">())); </span><span class="comment">// Determine what class is responsible for making the call to Closure<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">( </span><span class="default">$this&nbsp; </span><span class="keyword">);&nbsp; </span><span class="comment">// Passive reference works<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">( $</span><span class="default">$this </span><span class="keyword">); </span><span class="comment">// Added to class:&nbsp; function __toString(){ return 'this'; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$name </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">(</span><span class="string">'name'</span><span class="keyword">); </span><span class="comment">// Success<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">echo </span><span class="default">$name</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Outputs: Bob<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">'&lt;br /&gt;'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo $</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">name</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">call_user_func_array</span><span class="keyword">(array(</span><span class="default">$this</span><span class="keyword">, </span><span class="string">'deflect'</span><span class="keyword">), array()); </span><span class="comment">// SUCCESSFULLY CALLED<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #$this-&gt;head = 0; //** FATAL ERROR: Using $this when not in object context<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">$</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">head </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;&nbsp; </span><span class="comment">// Successfully sets value<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">};<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$p</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$p</span><span class="keyword">-&gt;</span><span class="default">shoot</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$p</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; die();<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="94804""></a>
  <div class="note">
   <strong class="user">rob at ubrio dot us</strong>
   <a href="#94804" class="date">25-Nov-2009 10:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can always call protected members using the __call() method - similar to how you hack around this in Ruby using send.
<br />

<br />
<span class="default">&lt;?php
<br />

<br />
</span><span class="keyword">class </span><span class="default">Fun
<br />
</span><span class="keyword">{
<br />
&nbsp;protected function </span><span class="default">debug</span><span class="keyword">(</span><span class="default">$message</span><span class="keyword">)
<br />
&nbsp;{
<br />
&nbsp;&nbsp; echo </span><span class="string">"DEBUG: </span><span class="default">$message</span><span class="string">\n"</span><span class="keyword">;
<br />
&nbsp;}
<br />

<br />
&nbsp;public function </span><span class="default">yield_something</span><span class="keyword">(</span><span class="default">$callback</span><span class="keyword">)
<br />
&nbsp;{
<br />
&nbsp;&nbsp; return </span><span class="default">$callback</span><span class="keyword">(</span><span class="string">"Soemthing!!"</span><span class="keyword">);
<br />
&nbsp;}
<br />

<br />
&nbsp;public function </span><span class="default">having_fun</span><span class="keyword">()
<br />
&nbsp;{
<br />
&nbsp;&nbsp; </span><span class="default">$self </span><span class="keyword">=&amp; </span><span class="default">$this</span><span class="keyword">;
<br />
&nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">yield_something</span><span class="keyword">(function(</span><span class="default">$data</span><span class="keyword">) use (&amp;</span><span class="default">$self</span><span class="keyword">)
<br />
&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$self</span><span class="keyword">-&gt;</span><span class="default">debug</span><span class="keyword">(</span><span class="string">"Doing stuff to the data"</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; </span><span class="comment">// do something with $data
<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$self</span><span class="keyword">-&gt;</span><span class="default">debug</span><span class="keyword">(</span><span class="string">"Finished doing stuff with the data."</span><span class="keyword">);
<br />
&nbsp;&nbsp; });
<br />
&nbsp;}
<br />

<br />
&nbsp;</span><span class="comment">// Ah-Ha!
<br />
&nbsp;</span><span class="keyword">public function </span><span class="default">__call</span><span class="keyword">(</span><span class="default">$method</span><span class="keyword">, </span><span class="default">$args </span><span class="keyword">= array())
<br />
&nbsp;{
<br />
&nbsp;&nbsp; if(</span><span class="default">is_callable</span><span class="keyword">(array(</span><span class="default">$this</span><span class="keyword">, </span><span class="default">$method</span><span class="keyword">)))
<br />
&nbsp;&nbsp; &nbsp; return </span><span class="default">call_user_func_array</span><span class="keyword">(array(</span><span class="default">$this</span><span class="keyword">, </span><span class="default">$method</span><span class="keyword">), </span><span class="default">$args</span><span class="keyword">);
<br />
&nbsp;}
<br />
}
<br />

<br />
</span><span class="default">$fun </span><span class="keyword">= new </span><span class="default">Fun</span><span class="keyword">();
<br />
echo </span><span class="default">$fun</span><span class="keyword">-&gt;</span><span class="default">having_fun</span><span class="keyword">();
<br />

<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="92664""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#92664" class="date">03-Aug-2009 02:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want to check whether you're dealing with a closure specifically and not a string or array callback you can do this:<br />
<br />
<span class="default">&lt;?php<br />
$isAClosure </span><span class="keyword">= </span><span class="default">is_callable</span><span class="keyword">(</span><span class="default">$thing</span><span class="keyword">) &amp;&amp; </span><span class="default">is_object</span><span class="keyword">(</span><span class="default">$thing</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="91610""></a>
  <div class="note">
   <strong class="user">a dot schaffhirt at sedna-soft dot de</strong>
   <a href="#91610" class="date">19-Jun-2009 02:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When using anonymous functions as properties in Classes, note that there are three name scopes: one for constants, one for properties and one for methods. That means, you can use the same name for a constant, for a property and for a method at a time.<br />
<br />
Since a property can be also an anonymous function as of PHP 5.3.0, an oddity arises when they share the same name, not meaning that there would be any conflict.<br />
<br />
Consider the following example:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">class </span><span class="default">MyClass </span><span class="keyword">{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; const </span><span class="default">member </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public </span><span class="default">$member</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public function </span><span class="default">member </span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="string">"method 'member'"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public function </span><span class="default">__construct </span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">member </span><span class="keyword">= function () {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="string">"anonymous function 'member'"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; };<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-Type: text/plain"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$myObj </span><span class="keyword">= new </span><span class="default">MyClass</span><span class="keyword">();<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">MyClass</span><span class="keyword">::</span><span class="default">member</span><span class="keyword">);&nbsp; </span><span class="comment">// int(1)<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$myObj</span><span class="keyword">-&gt;</span><span class="default">member</span><span class="keyword">);&nbsp;&nbsp; </span><span class="comment">// object(Closure)#2 (0) {}<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$myObj</span><span class="keyword">-&gt;</span><span class="default">member</span><span class="keyword">()); </span><span class="comment">// string(15) "method 'member'"<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$myMember </span><span class="keyword">= </span><span class="default">$myObj</span><span class="keyword">-&gt;</span><span class="default">member</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$myMember</span><span class="keyword">());&nbsp; &nbsp; &nbsp; </span><span class="comment">// string(27) "anonymous function 'member'"<br />
</span><span class="default">?&gt;<br />
</span><br />
That means, regular method invocations work like expected and like before. The anonymous function instead, must be retrieved into a variable first (just like a property) and can only then be invoked.<br />
<br />
Best regards,</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
