<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>pthreads</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="parallel-sync.invoke.html">? parallel\Sync::__invoke</a></li>
      <li style="float: right;"><a href="intro.pthreads.html">简介 ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="refs.fileprocess.process.html">进程控制扩展</a></li>
    <li>pthreads</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="book.pthreads" class="book">
 
 <h1 class="title">pthreads</h1>
 

 

 








 








 







 








 








 






 








 






<ul class="chunklist chunklist_book"><li><a href="intro.pthreads.html">简介</a></li><li><a href="pthreads.setup.html">安装／配置</a><ul class="chunklist chunklist_book chunklist_children"><li><a href="pthreads.requirements.html">需求</a></li><li><a href="pthreads.installation.html">安装</a></li><li><a href="pthreads.configuration.html">运行时配置</a></li></ul></li><li><a href="pthreads.constants.html">预定义常量</a></li><li><a href="class.threaded.html">Threaded</a> &mdash; Threaded 类<ul class="chunklist chunklist_book chunklist_children"><li><a href="threaded.chunk.html">Threaded::chunk</a> &mdash; 操作</li><li><a href="threaded.count.html">Threaded::count</a> &mdash; 操作</li><li><a href="threaded.extend.html">Threaded::extend</a> &mdash; Runtime Manipulation</li><li><a href="thread.isrunning.html">Threaded::isRunning</a> &mdash; 状态检测</li><li><a href="threaded.isterminated.html">Threaded::isTerminated</a> &mdash; 状态检测</li><li><a href="threaded.merge.html">Threaded::merge</a> &mdash; 操作</li><li><a href="threaded.notify.html">Threaded::notify</a> &mdash; 同步控制</li><li><a href="threaded.notifyone.html">Threaded::notifyOne</a> &mdash; Synchronization</li><li><a href="threaded.pop.html">Threaded::pop</a> &mdash; 操作</li><li><a href="threaded.run.html">Threaded::run</a> &mdash; 执行</li><li><a href="threaded.shift.html">Threaded::shift</a> &mdash; Manipulation</li><li><a href="threaded.synchronized.html">Threaded::synchronized</a> &mdash; 同步控制</li><li><a href="threaded.wait.html">Threaded::wait</a> &mdash; Synchronization</li></ul></li><li><a href="class.thread.html">Thread</a> &mdash; Thread 类<ul class="chunklist chunklist_book chunklist_children"><li><a href="thread.getcreatorid.html">Thread::getCreatorId</a> &mdash; 识别</li><li><a href="thread.getcurrentthread.html">Thread::getCurrentThread</a> &mdash; 识别</li><li><a href="thread.getcurrentthreadid.html">Thread::getCurrentThreadId</a> &mdash; 识别</li><li><a href="thread.getthreadid.html">Thread::getThreadId</a> &mdash; 识别</li><li><a href="thread.isjoined.html">Thread::isJoined</a> &mdash; 状态监测</li><li><a href="thread.isstarted.html">Thread::isStarted</a> &mdash; 状态检测</li><li><a href="thread.join.html">Thread::join</a> &mdash; 同步</li><li><a href="thread.start.html">Thread::start</a> &mdash; 执行</li></ul></li><li><a href="class.worker.html">Worker</a> &mdash; Worker 类<ul class="chunklist chunklist_book chunklist_children"><li><a href="worker.collect.html">Worker::collect</a> &mdash; Collect references to completed tasks</li><li><a href="worker.getstacked.html">Worker::getStacked</a> &mdash; 获取剩余的栈大小</li><li><a href="worker.isshutdown.html">Worker::isShutdown</a> &mdash; 状态检测</li><li><a href="worker.shutdown.html">Worker::shutdown</a> &mdash; 关闭 Worker</li><li><a href="worker.stack.html">Worker::stack</a> &mdash; 将要执行的任务入栈</li><li><a href="worker.unstack.html">Worker::unstack</a> &mdash; 将要执行的任务出栈</li></ul></li><li><a href="class.collectable.html">Collectable</a> &mdash; The Collectable interface<ul class="chunklist chunklist_book chunklist_children"><li><a href="collectable.isgarbage.html">Collectable::isGarbage</a> &mdash; Determine whether an object has been marked as garbage</li></ul></li><li><a href="class.pool.html">Pool</a> &mdash; Pool 类<ul class="chunklist chunklist_book chunklist_children"><li><a href="pool.collect.html">Pool::collect</a> &mdash; 回收已完成任务的引用</li><li><a href="pool.construct.html">Pool::__construct</a> &mdash; 创建新的 Worker 对象池</li><li><a href="pool.resize.html">Pool::resize</a> &mdash; 改变 Pool 对象的可容纳 Worker 对象的数量</li><li><a href="pool.shutdown.html">Pool::shutdown</a> &mdash; 停止所有的 Worker 对象</li><li><a href="pool.submit.html">Pool::submit</a> &mdash; 提交对象以执行</li><li><a href="pool.submitTo.html">Pool::submitTo</a> &mdash; 提交一个任务到特定的 Worker 以执行</li></ul></li><li><a href="class.volatile.html">Volatile</a> &mdash; The Volatile class</li></ul></div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="125640""></a>
  <div class="note">
   <strong class="user">meadowsjared at gmail dot com</strong>
   <a href="#125640" class="date">29-Dec-2020 04:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In this example, it shows how to use a threaded with a pool to get an array of results, using pThreads v3.2.1 and php 7.3.23<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">TestWork </span><span class="keyword">extends </span><span class="default">Threaded </span><span class="keyword">{<br />
</span><span class="comment">//updated version that works with pThreads v3.2.1 and php 7.3.23<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">protected </span><span class="default">$complete</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//$pData is the data sent to your worker thread to do it's job.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$pData</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//transfer all the variables to local variables<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">complete </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">testData </span><span class="keyword">= </span><span class="default">$pData</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//This is where all of your work will be done.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">run</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">2000000</span><span class="keyword">); </span><span class="comment">//sleep 2 seconds to simulate a large job<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">complete </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">isDone</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">complete</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
class </span><span class="default">ExamplePool </span><span class="keyword">extends </span><span class="default">Pool </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$data </span><span class="keyword">= array(); </span><span class="comment">// used to return data after we're done<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private </span><span class="default">$numTasks </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="comment">// counter used to know when we're done<br />
&nbsp;&nbsp;&nbsp; /**<br />
&nbsp;&nbsp; &nbsp; * override the submit function from the parent<br />
&nbsp;&nbsp; &nbsp; * to keep track of our jobs<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">submit</span><span class="keyword">(</span><span class="default">Threaded $task</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">numTasks</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">parent</span><span class="keyword">::</span><span class="default">submit</span><span class="keyword">(</span><span class="default">$task</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/**<br />
&nbsp;&nbsp; &nbsp; * used to wait until all workers are done<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">process</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Run this loop as long as we have<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // jobs in the pool<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">data</span><span class="keyword">) &lt; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">numTasks</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">collect</span><span class="keyword">(function (</span><span class="default">TestWork $task</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// If a task was marked as done<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // collect its results<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$task</span><span class="keyword">-&gt;</span><span class="default">isDone</span><span class="keyword">()) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmpObj </span><span class="keyword">= new </span><span class="default">stdclass</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmpObj</span><span class="keyword">-&gt;</span><span class="default">complete </span><span class="keyword">= </span><span class="default">$task</span><span class="keyword">-&gt;</span><span class="default">complete</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//this is how you get your completed data back out [accessed by $pool-&gt;process()]<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">data</span><span class="keyword">[] = </span><span class="default">$tmpObj</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$task</span><span class="keyword">-&gt;</span><span class="default">isDone</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; });<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// All jobs are done<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // we can shutdown the pool<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">shutdown</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">data</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">$pool </span><span class="keyword">= new </span><span class="default">ExamplePool</span><span class="keyword">(</span><span class="default">3</span><span class="keyword">);<br />
</span><span class="default">$testData </span><span class="keyword">= </span><span class="string">'asdf'</span><span class="keyword">;<br />
for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">5</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">submit</span><span class="keyword">(new </span><span class="default">TestWork</span><span class="keyword">(</span><span class="default">$testData</span><span class="keyword">));<br />
}<br />
</span><span class="default">$retArr </span><span class="keyword">= </span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">process</span><span class="keyword">(); </span><span class="comment">//get all of the results<br />
</span><span class="keyword">echo </span><span class="string">'&lt;pre&gt;'</span><span class="keyword">;<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$retArr</span><span class="keyword">); </span><span class="comment">//return the array of results (and maybe errors)<br />
</span><span class="keyword">echo </span><span class="string">'&lt;/pre&gt;'</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="123162""></a>
  <div class="note">
   <strong class="user">mckaygerhard at gmail dot com</strong>
   <a href="#123162" class="date">26-Sep-2018 03:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
mayority of that problems only happned for guindows, .. porr os</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121173""></a>
  <div class="note">
   <strong class="user">anonymous at example dot com</strong>
   <a href="#121173" class="date">02-Jun-2017 03:19</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here are some notes regarding PHP pThreads v3 that I have gathered:<br />
-namespace: It does not understand namespaces. <br />
-globals: It won't serialize GLOBALS at all! And will not register new ones.<br />
-classes: It registers new classes okay.<br />
-functions: Will not register ANY functions - they must all be in static classes. It does understand PHP native functions. <br />
-consts: previous constants will transfer over. Don't make any new ones thou!<br />
-pThreads only work in CLI - of course!<br />
-If a thread crashes it automatically gets recreated.<br />
-In order to 'force kill' any thread the parent must be killed. Or wait until all other tasks queued are complete and then terminate.<br />
-Anything registered in a pThread does not seem to join the main thread ... which is good!<br />
-pThreads seem to be very powerful on multi-core environments, just need to be careful on system resources... it can and will lock up a system if mis-configured.<br />
-Finally, finding help for PHP pThreads is slim to none... especially v3!<br />
<br />
Good luck!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118320""></a>
  <div class="note">
   <strong class="user">r3x at engelhardt-stefan dot de</strong>
   <a href="#118320" class="date">17-Nov-2015 06:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you try to test threading, remember to let php think slow:<br />
<br />
Skript: -- C:\Webserver\htdocs&gt;php mttest.php<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">My </span><span class="keyword">extends </span><span class="default">Thread</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">run</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">10</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="default">Thread</span><span class="keyword">::</span><span class="default">getCurrentThreadId</span><span class="keyword">() .&nbsp; </span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">2</span><span class="keyword">);&nbsp; &nbsp;&nbsp; </span><span class="comment">// &lt;------<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">2</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++){<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pool</span><span class="keyword">[] = new </span><span class="default">My</span><span class="keyword">(); <br />
}<br />
<br />
foreach(</span><span class="default">$pool </span><span class="keyword">as </span><span class="default">$worker</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$worker</span><span class="keyword">-&gt;</span><span class="default">start</span><span class="keyword">();<br />
}<br />
foreach(</span><span class="default">$pool </span><span class="keyword">as </span><span class="default">$worker</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$worker</span><span class="keyword">-&gt;</span><span class="default">join</span><span class="keyword">();<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Output: -- C:\Webserver\htdocs&gt;php mttest.php<br />
6300<br />
5816<br />
6300<br />
5816<br />
6300<br />
5816<br />
6300<br />
5816<br />
6300<br />
5816<br />
6300<br />
5816<br />
6300<br />
5816<br />
6300<br />
5816<br />
6300<br />
5816<br />
<br />
If you leave sleep() out, the cpu-time for the threads is long enough to complete the script at once.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="115576""></a>
  <div class="note">
   <strong class="user">admin at deosnet dot com</strong>
   <a href="#115576" class="date">19-Aug-2014 10:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hello,<br />
<br />
WARNING : When using Stackable objects in callable functions by your Threads, you must be very careful if you use it as an array. Indeed, if you do not copy your Stackable "array" in a local variable, the execution time can drop drastically !<br />
<br />
Also, if you want to modify an array() in a function, you will also store in a local variable in order that your array is in a thread-safe context.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="114457""></a>
  <div class="note">
   <strong class="user">jasonrlester at yahoo dot com</strong>
   <a href="#114457" class="date">23-Feb-2014 12:08</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that this extension *is* a high level implementation of POSIX threads, including on Windows (which is why pthreadsV*.dll is required)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
