<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>注册一个会在php中止时执行的函数</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.get-defined-functions.html">? get_defined_functions</a></li>
      <li style="float: right;"><a href="function.register-tick-function.html">register_tick_function ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.funchand.html">函数处理 函数</a></li>
    <li>注册一个会在php中止时执行的函数</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.register-shutdown-function" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">register_shutdown_function</h1>
  <p class="verinfo">(PHP 4, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">register_shutdown_function</span> &mdash; <span class="dc-title">注册一个会在php中止时执行的函数</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.register-shutdown-function-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>register_shutdown_function</strong></span>
    ( <span class="methodparam"><span class="type"><a href="language.types.callable.html" class="type callable">callable</a></span> <code class="parameter">$callback</code></span>
   , <span class="methodparam"><span class="type"><a href="language.types.declarations.html#language.types.declarations.mixed" class="type mixed">mixed</a></span> <code class="parameter">$parameter</code> = ?</span>
   , <span class="methodparam"><span class="type"><a href="language.types.declarations.html#language.types.declarations.mixed" class="type mixed">mixed</a></span> <code class="parameter">$...</code> = ?</span>
   ) : <span class="type"><span class="type void">void</span></span></div>

  <p class="para rdfs-comment">
  注册一个 <code class="parameter">callback</code> ，它会在脚本执行完成或者 <span class="function"><a href="function.exit.html" class="function">exit()</a></span> 后被调用。
  </p>
  <p class="para">
   可以多次调用 <span class="function"><strong>register_shutdown_function()</strong></span> ，这些被注册的回调会按照他们注册时的顺序被依次调用。
   如果你在注册的方法内部调用 <span class="function"><a href="function.exit.html" class="function">exit()</a></span>， 那么所有处理会被中止，并且其他注册的中止回调也不会再被调用。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.register-shutdown-function-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">callback</code></dt>

     <dd>

      <p class="para">
       待注册的中止回调
      </p>
      <p class="para">
       中止回调是作为请求的一部分被执行的，因此可以在它们中进行输出或者读取输出缓冲区。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">parameter</code></dt>

     <dd>

      <p class="para">
       可以通过传入额外的参数来将参数传给中止函数
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">...</code></dt>

     <dd>

      <p class="para">
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.register-shutdown-function-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   没有返回值。
  </p>
 </div>

 
 <div class="refsect1 errors" id="refsect1-function.register-shutdown-function-errors">
  <h3 class="title">错误／异常</h3>
  <p class="para">
   如果传入的callback不是可调用的，那么将会产生一个 <strong><code>E_WARNING</code></strong>
   级别的错误。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.register-shutdown-function-examples">
  <h3 class="title">范例</h3>
  <p class="para">
   <div class="example" id="example-5436">
    <p><strong>Example #1 <span class="function"><strong>register_shutdown_function()</strong></span> 例子</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">shutdown</span><span style="color: #007700">()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;This&nbsp;is&nbsp;our&nbsp;shutdown&nbsp;function,&nbsp;in&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;here&nbsp;we&nbsp;can&nbsp;do&nbsp;any&nbsp;last&nbsp;operations<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;before&nbsp;the&nbsp;script&nbsp;is&nbsp;complete.<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">echo&nbsp;</span><span style="color: #DD0000">'Script&nbsp;executed&nbsp;with&nbsp;success'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">register_shutdown_function</span><span style="color: #007700">(</span><span style="color: #DD0000">'shutdown'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.register-shutdown-function-notes">
  <h3 class="title">注释</h3>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    在某些web server（如Apache）上，可以在中止函数内对脚本的工作目录进行修改。
   </p>
  </p></blockquote>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    如果进程被信号SIGTERM或SIGKILL杀死，那么中止函数将不会被调用。尽管你无法中断SIGKILL，但你可以通过<span class="function"><a href="function.pcntl-signal.html" class="function">pcntl_signal()</a></span> 来捕获SIGTERM，通过在其中调用<span class="function"><a href="function.exit.html" class="function">exit()</a></span>来进行一个正常的中止。
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.register-shutdown-function-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><a href="ini.core.html#ini.auto-append-file" class="link">auto_append_file</a></li>
    <li class="member"><span class="function"><a href="function.exit.html" class="function" rel="rdfs-seeAlso">exit()</a> - 输出一个消息并且退出当前脚本</span></li>
    <li class="member"><a href="features.connection-handling.html" class="link">连接处理</a> 章节</li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="125103""></a>
  <div class="note">
   <strong class="user">ohcc at 163 dot com</strong>
   <a href="#125103" class="date">09-Jun-2020 04:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As of PHP 7.4, an exception thrown within the user-defined shutdown function can be caught by the user-defined exception handler.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; set_error_handler</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function(</span><span class="default">$level</span><span class="keyword">, </span><span class="default">$error</span><span class="keyword">, </span><span class="default">$file</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">0 </span><span class="keyword">=== </span><span class="default">error_reporting</span><span class="keyword">()){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">ErrorException</span><span class="keyword">(</span><span class="default">$error</span><span class="keyword">, -</span><span class="default">1</span><span class="keyword">, </span><span class="default">$level</span><span class="keyword">, </span><span class="default">$file</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; },<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">E_ALL<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(function(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">= </span><span class="default">error_get_last</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$error</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">ErrorException</span><span class="keyword">(</span><span class="default">$error</span><span class="keyword">[</span><span class="string">'message'</span><span class="keyword">], -</span><span class="default">1</span><span class="keyword">, </span><span class="default">$error</span><span class="keyword">[</span><span class="string">'type'</span><span class="keyword">], </span><span class="default">$error</span><span class="keyword">[</span><span class="string">'file'</span><span class="keyword">], </span><span class="default">$error</span><span class="keyword">[</span><span class="string">'line'</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; });<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">set_exception_handler</span><span class="keyword">(function(</span><span class="default">$exception</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// ... more code ...<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">});&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; require </span><span class="string">'NotExists.php'</span><span class="keyword">;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="123696""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#123696" class="date">16-Mar-2019 10:08</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
warning: in addition to SIGTERM and SIGKILL, the shutdown functions won't run in response to SIGINT either. (observed on php 7.1.16 on windows 7 SP1 x64 + cygwin&nbsp; and php 7.2.15 on Ubuntu 18.04)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="123383""></a>
  <div class="note">
   <strong class="user">marcelotpcruz at gmail dot com</strong>
   <a href="#123383" class="date">28-Nov-2018 09:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I elaborated following functions, so you can close your connection if you can't count on fastcgi_finish_request.<br />
<br />
You'll use puts instead of echo, so you can close the connection whenever you want as long as you don't touch echo when you use those functions.<br />
It works it compression and is easy to adapt:<br />
<br />
function connsettings($name, $val=null){<br />
&nbsp;&nbsp;&nbsp; static $settings = array();<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if(!isset($settings[$name]))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $settings[$name] = false;<br />
&nbsp;&nbsp;&nbsp; if($val !== null)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $settings[$name] = $val;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; return $settings[$name];<br />
};//Just saving compression and init var to check if it's true or false<br />
<br />
function puts(){<br />
//Using args so it works like echo with comma ands dots<br />
&nbsp;&nbsp;&nbsp; $numargs = func_num_args();<br />
&nbsp;&nbsp;&nbsp; $arg_list = func_get_args();<br />
&nbsp;&nbsp;&nbsp; $string = '';<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if($numargs === 0)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return;<br />
&nbsp;&nbsp;&nbsp; else if($numargs &gt; 1)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for($i = 0; $i &lt; $numargs; $i++)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $string .= $arg_list[$i];<br />
&nbsp;&nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $string = $arg_list[0];<br />
<br />
&nbsp;&nbsp;&nbsp; if(connsettings('init') === false)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // buffer all upcoming output - make sure we care about compression: <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(ob_start("ob_gzhandler"))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; connsettings('compression', true);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ob_start();<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; connsettings('init', true);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; register_shutdown_function('puts', null, true);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; echo $string;<br />
}<br />
function close(){<br />
&nbsp;&nbsp;&nbsp; if(!headers_sent())//it may work without this verification when no compression but may lead to uncomplete data<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // send headers to tell the browser to close the connection<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; ob_end_flush(); // Order here matter, it won't work if it goes after Content-Length<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(connsettings('compression') === false)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; header("Content-Encoding: none");<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; header('Content-Length: ' . ob_get_length()); <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; header('Connection: close');&nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // flush all output <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; //ob_end_flush(); <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; ob_flush(); <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; flush();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // close current session <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (session_id()) session_write_close();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; set_time_limit(0);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; ignore_user_abort(true);<br />
&nbsp;&nbsp;&nbsp; }<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120620""></a>
  <div class="note">
   <strong class="user">raat1979 at gmail dot com</strong>
   <a href="#120620" class="date">08-Feb-2017 07:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I wanted to set the exit code for a CLI application from a shutdown function by using a class property, <br />
<br />
Unfortunataly (as per manual)&nbsp; "If you call exit() within one registered shutdown function, processing will stop completely and no other registered shutdown functions will be called."&nbsp; <br />
<br />
As a result if I call exit in my shutdown function I will break other shutdown functions (like one that logs fatal errors to syslog)&nbsp; <br />
<br />
However! (as per manual)&nbsp; "Multiple calls to register_shutdown_function() can be made, and each will be called in the same order as they were registered."<br />
<br />
As luck would have it you are also able to register a shutdown function from within a shutdown function (at least in PHP 7.0.15 and 5.6.30) <br />
<br />
in other words if you register a shutdown function inside a shutdown function it is appended to the shutdown function queue.<br />
<br />
<span class="default">&lt;?php <br />
</span><span class="keyword">class </span><span class="default">SomeApplication</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; private </span><span class="default">$exitCode </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__construct</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(function(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"some registered shutdown function"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(function(){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"last registered shutdown function"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// one might even consider another register shutdown_function if one expects other shutdown functions to do the same...&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">exit(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">exitCode </span><span class="keyword">=== </span><span class="default">null </span><span class="keyword">? </span><span class="default">0 </span><span class="keyword">: </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">exitCode</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; });<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; });<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118053""></a>
  <div class="note">
   <strong class="user">xcl_rockman at qq dot com</strong>
   <a href="#118053" class="date">25-Sep-2015 06:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
for static call <br />
register_shutdown_function(function () {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; demo::shutdownFunc();<br />
});</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="114940""></a>
  <div class="note">
   <strong class="user">m dot agkopian at gmail dot com</strong>
   <a href="#114940" class="date">30-Apr-2014 10:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Use this small snippet inside your bootstrap in order to always have a way to know reliably what was the last page of your site that the user have visited, without having to use $_SERVER['HTTP_REFERER'].<br />
<br />
<span class="default">&lt;?php<br />
session_start</span><span class="keyword">();<br />
<br />
</span><span class="comment">// Get current page<br />
</span><span class="default">$current_page </span><span class="keyword">= </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'SCRIPT_NAME'</span><span class="keyword">], </span><span class="default">ENT_QUOTES</span><span class="keyword">, </span><span class="string">'UTF-8'</span><span class="keyword">);<br />
</span><span class="default">$current_page </span><span class="keyword">.= </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'QUERY_STRING'</span><span class="keyword">] ? </span><span class="string">'?'</span><span class="keyword">.</span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'QUERY_STRING'</span><span class="keyword">], </span><span class="default">ENT_QUOTES</span><span class="keyword">, </span><span class="string">'UTF-8'</span><span class="keyword">) : </span><span class="string">''</span><span class="keyword">;<br />
<br />
</span><span class="comment">// Set previous page at the end<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(function (</span><span class="default">$current_page</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'previous_page'</span><span class="keyword">] = </span><span class="default">$current_page</span><span class="keyword">;<br />
}, </span><span class="default">$current_page</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="113585""></a>
  <div class="note">
   <strong class="user">Tim</strong>
   <a href="#113585" class="date">01-Nov-2013 04:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
register_shutdown_function seems to be immune to whatever value was set with set_time_limit or the max_execution_time value defined in php.ini. <br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">asdf</span><span class="keyword">() {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">) . </span><span class="string">'&lt;br&gt;'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">) . </span><span class="string">'&lt;br&gt;'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">) . </span><span class="string">'&lt;br&gt;'</span><span class="keyword">;<br />
}<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'asdf'</span><span class="keyword">);<br />
</span><span class="default">set_time_limit</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
<br />
while(</span><span class="default">true</span><span class="keyword">) {}<br />
</span><span class="default">?&gt;<br />
</span>The output is three lines.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111932""></a>
  <div class="note">
   <strong class="user">matteosistisette at gmail dot com</strong>
   <a href="#111932" class="date">13-Apr-2013 05:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In PHP 5.1.6 things don't work as described here.<br />
<br />
The truth is that connection_status() just always returns 0 whether or not the client has aborted (e.g. the user hit the stop button), and that (consistently with this) the registered shutdown function will only be called on exit, but NOT when the connection is aborted from the user.<br />
<br />
That is, PHP does NOT detect when the connection is aborted.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="108212""></a>
  <div class="note">
   <strong class="user">alexyam at live dot com</strong>
   <a href="#108212" class="date">08-Apr-2012 03:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When using php-fpm, fastcgi_finish_request() should be used instead of register_shutdown_function() and exit()<br />
<br />
For example, under nginx and php-fpm 5.3+, this will make browsers wait 10 seconds to show output:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"You have to wait 10 seconds to see this.&lt;br&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'shutdown'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; exit;<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">shutdown</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Because exit() doesn't terminate php-fpm calls immediately.&lt;br&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
</span><span class="default">?&gt;<br />
</span><br />
This doesn't:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"You can see this from the browser immediately.&lt;br&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fastcgi_finish_request</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"You can't see this form the browser."</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="100859""></a>
  <div class="note">
   <strong class="user">david dot schueler at tel-billig dot de</strong>
   <a href="#100859" class="date">11-Nov-2010 04:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I had a problem when forking a child process and accessing the variables by using the "global" keyword in the shutdown function.<br />
So i used another way for getting the variables to the shutdown function: I passed them by reference.<br />
<br />
Example:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">shutdown_function </span><span class="keyword">(&amp;</span><span class="default">$test</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">__FUNCTION__</span><span class="keyword">.</span><span class="string">'(): $test = '</span><span class="keyword">.</span><span class="default">$test</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">$test </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'shutdown_function'</span><span class="keyword">, &amp;</span><span class="default">$test</span><span class="keyword">);<br />
echo </span><span class="string">'$test = '</span><span class="keyword">.</span><span class="default">$test</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">;<br />
<br />
</span><span class="comment">// do some stuff and change the variable values<br />
</span><span class="default">$test </span><span class="keyword">= </span><span class="default">2</span><span class="keyword">;<br />
<br />
</span><span class="comment">// now the shutdown function gets called<br />
</span><span class="keyword">exit(</span><span class="default">0</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Maybe tis helps someone. (I'm using PHP 5.2.11)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="100000""></a>
  <div class="note">
   <strong class="user">emanueledelgrande ad email dot it</strong>
   <a href="#100000" class="date">19-Sep-2010 07:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A lot of useful services may be delegated to this useful trigger.<br />
It is very effective because it is executed at the end of the script but before any object destruction, so all instantiations are still alive.<br />
<br />
Here's a simple shutdown events manager class which allows to manage either functions or static/dynamic methods, with an indefinite number of arguments without using any reflection, availing on a internal handling through func_get_args() and call_user_func_array() specific functions:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// managing the shutdown callback events:<br />
</span><span class="keyword">class </span><span class="default">shutdownScheduler </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; private </span><span class="default">$callbacks</span><span class="keyword">; </span><span class="comment">// array to store user callbacks<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">__construct</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">callbacks </span><span class="keyword">= array();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(array(</span><span class="default">$this</span><span class="keyword">, </span><span class="string">'callRegisteredShutdown'</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">registerShutdownEvent</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$callback </span><span class="keyword">= </span><span class="default">func_get_args</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (empty(</span><span class="default">$callback</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">'No callback passed to '</span><span class="keyword">.</span><span class="default">__FUNCTION__</span><span class="keyword">.</span><span class="string">' method'</span><span class="keyword">, </span><span class="default">E_USER_ERROR</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">is_callable</span><span class="keyword">(</span><span class="default">$callback</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">'Invalid callback passed to the '</span><span class="keyword">.</span><span class="default">__FUNCTION__</span><span class="keyword">.</span><span class="string">' method'</span><span class="keyword">, </span><span class="default">E_USER_ERROR</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">callbacks</span><span class="keyword">[] = </span><span class="default">$callback</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">callRegisteredShutdown</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach (</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">callbacks </span><span class="keyword">as </span><span class="default">$arguments</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$callback </span><span class="keyword">= </span><span class="default">array_shift</span><span class="keyword">(</span><span class="default">$arguments</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">call_user_func_array</span><span class="keyword">(</span><span class="default">$callback</span><span class="keyword">, </span><span class="default">$arguments</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// test methods:<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">dynamicTest</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">'_REQUEST array is '</span><span class="keyword">.</span><span class="default">count</span><span class="keyword">(</span><span class="default">$_REQUEST</span><span class="keyword">).</span><span class="string">' elements long.&lt;br /&gt;'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">staticTest</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">'_SERVER array is '</span><span class="keyword">.</span><span class="default">count</span><span class="keyword">(</span><span class="default">$_SERVER</span><span class="keyword">).</span><span class="string">' elements long.&lt;br /&gt;'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
A simple application:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// a generic function<br />
</span><span class="keyword">function </span><span class="default">say</span><span class="keyword">(</span><span class="default">$a </span><span class="keyword">= </span><span class="string">'a generic greeting'</span><span class="keyword">, </span><span class="default">$b </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Saying </span><span class="keyword">{</span><span class="default">$a</span><span class="keyword">}</span><span class="string"> </span><span class="keyword">{</span><span class="default">$b</span><span class="keyword">}</span><span class="string">&lt;br /&gt;"</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">$scheduler </span><span class="keyword">= new </span><span class="default">shutdownScheduler</span><span class="keyword">();<br />
<br />
</span><span class="comment">// schedule a global scope function:<br />
</span><span class="default">$scheduler</span><span class="keyword">-&gt;</span><span class="default">registerShutdownEvent</span><span class="keyword">(</span><span class="string">'say'</span><span class="keyword">, </span><span class="string">'hello!'</span><span class="keyword">);<br />
<br />
</span><span class="comment">// try to schedule a dyamic method:<br />
</span><span class="default">$scheduler</span><span class="keyword">-&gt;</span><span class="default">registerShutdownEvent</span><span class="keyword">(array(</span><span class="default">$scheduler</span><span class="keyword">, </span><span class="string">'dynamicTest'</span><span class="keyword">));<br />
</span><span class="comment">// try with a static call:<br />
</span><span class="default">$scheduler</span><span class="keyword">-&gt;</span><span class="default">registerShutdownEvent</span><span class="keyword">(</span><span class="string">'scheduler::staticTest'</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
It is easy to guess how to extend this example in a more complex context in which user defined functions and methods should be handled according to the priority depending on specific variables.<br />
<br />
Hope it may help somebody.<br />
Happy coding!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98200""></a>
  <div class="note">
   <strong class="user">clover at fromru dot com</strong>
   <a href="#98200" class="date">01-Jun-2010 02:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you register function that needs to be running last (for example, close database connection) - just register another shutdown function from shutdown function:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">test1</span><span class="keyword">(){<br />
&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'test_last'</span><span class="keyword">);<br />
}<br />
<br />
function </span><span class="default">test2</span><span class="keyword">(){</span><span class="comment">/*...*/</span><span class="keyword">}<br />
function </span><span class="default">test3</span><span class="keyword">(){</span><span class="comment">/*...*/</span><span class="keyword">}<br />
function </span><span class="default">test_last</span><span class="keyword">(){</span><span class="comment">/*...*/</span><span class="keyword">}<br />
<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'test1'</span><span class="keyword">);<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'test2'</span><span class="keyword">);<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'test3'</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
the script will call functions in correct order: test1, test2, test3, test_last</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97852""></a>
  <div class="note">
   <strong class="user">sander @ unity-x</strong>
   <a href="#97852" class="date">12-May-2010 03:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
simple method to disconnect the client and continue processing:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">endOutput</span><span class="keyword">(</span><span class="default">$endMessage</span><span class="keyword">){
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ignore_user_abort</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">set_time_limit</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">"Connection: close"</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-Length: "</span><span class="keyword">.</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$endMessage</span><span class="keyword">));
<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">$endMessage</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="string">"\r\n"</span><span class="keyword">, </span><span class="default">10</span><span class="keyword">); </span><span class="comment">// just to be sure
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">flush</span><span class="keyword">();
<br />
}
<br />

<br />
</span><span class="comment">// Must be called before any output
<br />
</span><span class="default">endOutput</span><span class="keyword">(</span><span class="string">"thank you for visiting, have a nice day');
<br />

<br />
sleep(100);
<br />
mail("</span><span class="default">you</span><span class="keyword">@</span><span class="default">yourmail</span><span class="keyword">.</span><span class="default">com</span><span class="string">", "</span><span class="default">ping</span><span class="string">", "</span><span class="default">i</span><span class="string">'m here");
<br />
?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97447""></a>
  <div class="note">
   <strong class="user">jawsper at aximax dot nl</strong>
   <a href="#97447" class="date">20-Apr-2010 05:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Something found out during testing:<br />
<br />
the ini auto_append_file will be included BEFORE the registered function(s) will be called.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95256""></a>
  <div class="note">
   <strong class="user">ravenswd at gmail dot com</strong>
   <a href="#95256" class="date">21-Dec-2009 01:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You may get the idea to call debug_backtrace or debug_print_backtrace from inside a shutdown function, to trace where a fatal error occurred. Unfortunately, these functions will not work inside a shutdown function.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93846""></a>
  <div class="note">
   <strong class="user">Ant P.</strong>
   <a href="#93846" class="date">02-Oct-2009 12:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As of PHP 5.3.0, the last note about unpredictable working directory also applies to FastCGI, when previously it didn't.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93589""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#93589" class="date">17-Sep-2009 05:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that if the handler function is private static it will never be called! It must be public!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="92959""></a>
  <div class="note">
   <strong class="user">Filip Dalge</strong>
   <a href="#92959" class="date">16-Aug-2009 08:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The following function register_close_function should reproduce the former php behavior of closing the connection before executing the shutdown handler, based on the code posted by sts at mail dot xubion dot hu. It does not work on any machine.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">register_close_function</span><span class="keyword">(</span><span class="default">$func</span><span class="keyword">) {<br />
&nbsp; </span><span class="default">register_close_function</span><span class="keyword">::</span><span class="default">$func </span><span class="keyword">= </span><span class="default">$func</span><span class="keyword">;<br />
&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(array(</span><span class="string">"register_close_function"</span><span class="keyword">, </span><span class="string">"close"</span><span class="keyword">));<br />
&nbsp; </span><span class="default">ob_start</span><span class="keyword">();<br />
}<br />
class </span><span class="default">register_close_function </span><span class="keyword">{<br />
&nbsp; </span><span class="comment">// just a container<br />
&nbsp; </span><span class="keyword">static </span><span class="default">$func</span><span class="keyword">;<br />
&nbsp; function </span><span class="default">close</span><span class="keyword">() {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">"Connection: close"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$size </span><span class="keyword">= </span><span class="default">ob_get_length</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-Length: </span><span class="default">$size</span><span class="string">"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ob_end_flush</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">flush</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">call_user_func</span><span class="keyword">(</span><span class="default">register_close_function</span><span class="keyword">::</span><span class="default">$func</span><span class="keyword">);<br />
&nbsp; }<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="92657""></a>
  <div class="note">
   <strong class="user">pgl at yoyo dot org</strong>
   <a href="#92657" class="date">02-Aug-2009 02:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You definitely need to be careful about using relative paths in after the shutdown function has been called, but the current working directory doesn't (necessarily) get changed to the web server's ServerRoot - I've tested on two different servers and they both have their CWD changed to '/' (which isn't the ServerRoot).
<br />

<br />
This demonstrates the behaviour:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">echocwd</span><span class="keyword">() { echo </span><span class="string">'cwd: '</span><span class="keyword">, </span><span class="default">getcwd</span><span class="keyword">(), </span><span class="string">"\n"</span><span class="keyword">; }
<br />

<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'echocwd'</span><span class="keyword">);
<br />
</span><span class="default">echocwd</span><span class="keyword">() and exit;
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Outputs:
<br />

<br />
cwd: /path/to/my/site/docroot/test
<br />
cwd: /
<br />

<br />
NB: CLI scripts are unaffected, and keep their CWD as the directory the script was called from.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89578""></a>
  <div class="note">
   <strong class="user">cFreed at orange dot fr</strong>
   <a href="#89578" class="date">14-Mar-2009 09:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
May be obvious for most people, but I spent time to clearly understand something which is only INDIRECTLY mentioned by the manual, so I hope this useful for someones.<br />
<br />
Pay attention to the function prototype: the $function argument is a callback one (follow the link for more information).<br />
This means that you must write this argument differently depending on the $function context:<br />
. function-name, as a string, when it is a built-in or user-defined function<br />
. array(class-name, method-name), when it is an object method</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="86140""></a>
  <div class="note">
   <strong class="user">SonOfTron</strong>
   <a href="#86140" class="date">05-Oct-2008 06:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can achieve similar results by using auto_append_file in the php.ini or .htaccess file:<br />
(php.ini)<br />
auto_append_file = /my-auto-append-file.php<br />
(.htaccess)<br />
php_value auto_append_file /my-auto-append-file.php</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85727""></a>
  <div class="note">
   <strong class="user">RLK</strong>
   <a href="#85727" class="date">14-Sep-2008 02:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Contrary to the the note that "headers are always sent" and some of the comments below - You CAN use header() inside of a shutdown function as you would anywhere else; when headers_sent() is false. You can do custom fatal handling this way:<br />
<br />
<span class="default">&lt;?php<br />
ini_set</span><span class="keyword">(</span><span class="string">'display_errors'</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">);<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'shutdown'</span><span class="keyword">);<br />
<br />
</span><span class="default">$obj </span><span class="keyword">= new </span><span class="default">stdClass</span><span class="keyword">();<br />
</span><span class="default">$obj</span><span class="keyword">-&gt;</span><span class="default">method</span><span class="keyword">();<br />
<br />
function </span><span class="default">shutdown</span><span class="keyword">()<br />
{<br />
&nbsp; if(!</span><span class="default">is_null</span><span class="keyword">(</span><span class="default">$e </span><span class="keyword">= </span><span class="default">error_get_last</span><span class="keyword">()))<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">'content-type: text/plain'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; print </span><span class="string">"this is not html:\n\n"</span><span class="keyword">. </span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$e</span><span class="keyword">,</span><span class="default">true</span><span class="keyword">);<br />
&nbsp; }<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="77074""></a>
  <div class="note">
   <strong class="user">Fuzika</strong>
   <a href="#77074" class="date">13-Aug-2007 05:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Sinured's example of how to use a static method did not work for me.
<br />
But this did:
<br />

<br />
<span class="default">&lt;?php
<br />
register_shutdown_function</span><span class="keyword">(array(</span><span class="string">'theClass'</span><span class="keyword">,</span><span class="string">'theStaticMethod'</span><span class="keyword">));
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Hope this helps someone.
<br />

<br />
[EDIT by danbrown AT php DOT net: This example did not work for the author of this note because it is written for PHP 5.&nbsp; The author was using PHP 4.]</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="77027""></a>
  <div class="note">
   <strong class="user">Sinured</strong>
   <a href="#77027" class="date">10-Aug-2007 06:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can use a static method of a class as a shutdown function without passing an instance. I think that doesn't make too much sense, however it's possible.<br />
<br />
<span class="default">&lt;?php<br />
register_shutdown_function</span><span class="keyword">(</span><span class="string">'someClass::someMethod'</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
If this method is *NOT* static, then PHP will complain about an invalid callback instead of just emitting an E_STRICT error.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="76130""></a>
  <div class="note">
   <strong class="user">buraks78 at gmail dot com</strong>
   <a href="#76130" class="date">01-Jul-2007 05:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Read the post regarding the change of working directory to ServerRoot carefully. This means that require_once "path/to/script" (or similar constructs) with relative paths will not work in shutdown functions.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="72604""></a>
  <div class="note">
   <strong class="user">Ldkronos</strong>
   <a href="#72604" class="date">25-Jan-2007 09:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It's already been discussed on the zlib page ( <a href="http://www.php.net/zlib " rel="nofollow" target="_blank">http://www.php.net/zlib </a>), but hasn't been mention here...<br />
<br />
When zlib compression is enabled, register_shutdown_function doesn't work properly. Anything output from your shutdown function will not be readable by the browser. Firefox just ignores it. IE6 will show you a blank page.<br />
<br />
The workaround that worked for me is to add the following to the top of the script.<br />
ini_set('zlib.output_compression', 0);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="63104""></a>
  <div class="note">
   <strong class="user">dweingart at pobox dot com</strong>
   <a href="#63104" class="date">13-Mar-2006 08:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have discovered a change in behavior from PHP 5.0.4 to PHP 5.1.2 when using a shutdown function in conjunction with an output buffering callback.<br />
<br />
In PHP 5.0.4 (and earlier versions I believe) the shutdown function is called after the output buffering callback.<br />
<br />
In PHP 5.1.2 (not sure when the change occurred) the shutdown function is called before the output buffering callback.<br />
<br />
Test code:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">ob_callback</span><span class="keyword">(</span><span class="default">$buf</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$buf </span><span class="keyword">.= </span><span class="string">'&lt;li&gt;' </span><span class="keyword">. </span><span class="default">__FUNCTION__ </span><span class="keyword">.</span><span class="string">'&lt;/li&gt;'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$buf</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">shutdown_func</span><span class="keyword">() {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">'&lt;li&gt;' </span><span class="keyword">. </span><span class="default">__FUNCTION__ </span><span class="keyword">.</span><span class="string">'&lt;/li&gt;'</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">ob_start</span><span class="keyword">(</span><span class="string">'ob_callback'</span><span class="keyword">);<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'shutdown_func'</span><span class="keyword">);<br />
echo </span><span class="string">'&lt;ol&gt;'</span><span class="keyword">;<br />
</span><span class="default">?&gt;<br />
</span><br />
PHP 5.0.4:<br />
<br />
1. ob_callback<br />
2. shutdown_func<br />
<br />
PHP 5.1.2:<br />
<br />
1. shutdown_func<br />
2. ob_callback</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62898""></a>
  <div class="note">
   <strong class="user">me at thomaskeller dot biz</strong>
   <a href="#62898" class="date">11-Mar-2006 02:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Well, it might be obvious, but one should remember that one cannot send any HTTP header in the shutdown callback.<br />
<br />
Something like<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">redirect</span><span class="keyword">()<br />
{<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">"Location: myuri.php"</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">"redirect"</span><span class="keyword">);<br />
<br />
</span><span class="comment">// do something useful here<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
doesn't work and PHP sends out the popular "headers already sent" warning.<br />
<br />
I tried to set a redirection target somewhere in the script, but wanted to make sure that it was only set/executed at the very end of the script, since my custom redirect function also cleaned any output buffers at that point. Well, no luck here =)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="61185""></a>
  <div class="note">
   <strong class="user">kenneth dot kalmer at gmail dot com</strong>
   <a href="#61185" class="date">27-Jan-2006 09:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I performed two tests on the register_shutdown_function() to see under what conditions it was called, and if a can call a static method from a class. Here are the results:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/**<br />
&nbsp;* Tests the shutdown function being able to call a static methods<br />
&nbsp;*/<br />
</span><span class="keyword">class </span><span class="default">Shutdown<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">Method </span><span class="keyword">(</span><span class="default">$mixed </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// we need absolute<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ap </span><span class="keyword">= </span><span class="default">dirname </span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$mixed </span><span class="keyword">= </span><span class="default">time </span><span class="keyword">() . </span><span class="string">" - </span><span class="default">$mixed</span><span class="string">\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">file_put_contents </span><span class="keyword">(</span><span class="string">"</span><span class="default">$ap</span><span class="string">/shutdown.log"</span><span class="keyword">, </span><span class="default">$mixed</span><span class="keyword">, </span><span class="default">FILE_APPEND</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="comment">// 3. Throw an exception<br />
</span><span class="default">register_shutdown_function </span><span class="keyword">(array (</span><span class="string">'Shutdown'</span><span class="keyword">, </span><span class="string">'Method'</span><span class="keyword">), </span><span class="string">'throw'</span><span class="keyword">);<br />
throw new </span><span class="default">Exception </span><span class="keyword">(</span><span class="string">'bla bla'</span><span class="keyword">);<br />
<br />
</span><span class="comment">// 2. Use the exit command<br />
//register_shutdown_function (array ('Shutdown', 'Method'), 'exit');<br />
//exit ('exiting here...')<br />
<br />
// 1. Exit normally<br />
//register_shutdown_function (array ('Shutdown', 'Method'));<br />
</span><span class="default">?&gt;<br />
</span><br />
To test simply leave one of the three test lines uncommented and execute. Executing bottom-up yielded:<br />
<br />
1138382480 - 0<br />
1138382503 - exit<br />
1138382564 - throw<br />
<br />
HTH</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60108""></a>
  <div class="note">
   <strong class="user">sezer yalcin</strong>
   <a href="#60108" class="date">26-Dec-2005 09:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
re:codeslinger at compsalot dot com<br />
<br />
fork() is actually creating 2 processes from one. So there is no surprise register_shutdown_function will be executed per each process.<br />
<br />
I think you have reported this as a bug and now in php 5.1.0 when you exit from child process, it does not execute it. Well, what are you going to do if you have something to register for forked process?<br />
<br />
I hope php will be more stable near soon!<br />
<br />
codeslinger at compsalot dot com<br />
03-Feb-2005 09:22 <br />
Here is a nice little surprise to keep in mind...<br />
<br />
If you register a shutdown function for your main program.&nbsp; And then you fork() a child.<br />
<br />
Guess What?<br />
When the child exits it will run the code that was intended for the main program.&nbsp; This can be a really bad thing&nbsp; ;-)<br />
<br />
Happily there is a simple work-around.&nbsp; All you need to do is to create a global variable such as:<br />
<br />
$IamaChild = [TRUE | FALSE];<br />
<br />
and have your shutdown function check the value...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="59300""></a>
  <div class="note">
   <strong class="user">http://livejournal.com/~sinde1/</strong>
   <a href="#59300" class="date">02-Dec-2005 04:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want to do something with files in function, that registered in register_shutdown_function(), use ABSOLUTE paths to files instead of relative. Because when script processing is complete current working directory chages to ServerRoot (see httpd.conf)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="57081""></a>
  <div class="note">
   <strong class="user">Niels Ganser &lt;php dot comment at depoll dot de&gt;</strong>
   <a href="#57081" class="date">22-Sep-2005 07:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a quick note: from 5.0.5 on objects will be unloaded _before_ your shutdown function is called which means you can't use previously initiated objects (such as mysqli).<br />
<br />
See bug 33772 for more information.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="49643""></a>
  <div class="note">
   <strong class="user">codeslinger at compsalot dot com</strong>
   <a href="#49643" class="date">03-Feb-2005 09:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is a nice little surprise to keep in mind...<br />
<br />
If you register a shutdown function for your main program.&nbsp; And then you fork() a child.<br />
<br />
Guess What?<br />
When the child exits it will run the code that was intended for the main program.&nbsp; This can be a really bad thing&nbsp; ;-)<br />
<br />
Happily there is a simple work-around.&nbsp; All you need to do is to create a global variable such as:<br />
<br />
$IamaChild = [TRUE | FALSE];<br />
<br />
and have your shutdown function check the value...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="40908""></a>
  <div class="note">
   <strong class="user">astrolox at lawyersonline dot co dot uk</strong>
   <a href="#40908" class="date">18-Mar-2004 11:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When using the register_shutdown_function command in php 4. The registered functions are called in the order that you register them.
<br />

<br />
This is important to note if you are doing database work using classes that register shutdown functions for themselves. 
<br />

<br />
You must register the shutdown_functions in the order that you want things to shutdown. ( ie the database needs to shutdown last )
<br />

<br />
Example of what will not work but what you might expect to work :
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">class </span><span class="default">database </span><span class="keyword">{
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">database</span><span class="keyword">() {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"connect to sql server -- (database :: constructor)&lt;br&gt;\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">( array( &amp;</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"phpshutdown" </span><span class="keyword">) );
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connected </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">do_sql</span><span class="keyword">( </span><span class="default">$sql </span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if ( </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connected </span><span class="keyword">== </span><span class="default">1 </span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"performing sql -- (database :: do_sql)&lt;br&gt;\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">" ERROR -- CAN NOT PERFORM SQL -- NOT CONNECTED TO SERVER -- (database :: do_sql)&lt;br&gt;\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">phpshutdown</span><span class="keyword">() {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"close connection to sql server -- &lt;b&gt;(database :: shutdown)&lt;/b&gt;&lt;br&gt;\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connected </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }&nbsp; &nbsp; &nbsp;&nbsp; 
<br />
}
<br />

<br />
class </span><span class="default">table </span><span class="keyword">{
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">table</span><span class="keyword">( &amp;</span><span class="default">$database</span><span class="keyword">, </span><span class="default">$name </span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">database </span><span class="keyword">=&amp; </span><span class="default">$database</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">name </span><span class="keyword">= </span><span class="default">$name</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"read table data using database class -- name=</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">name</span><span class="string"> -- (table :: constructor)&lt;br&gt;\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">( array( &amp;</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"phpshutdown" </span><span class="keyword">) );
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">database</span><span class="keyword">-&gt;</span><span class="default">do_sql</span><span class="keyword">( </span><span class="string">"read table data" </span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">phpshutdown</span><span class="keyword">() {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"save changes to database -- name=</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">name</span><span class="string"> -- &lt;b&gt;(table :: shutdown)&lt;/b&gt;&lt;br&gt;\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">database</span><span class="keyword">-&gt;</span><span class="default">do_sql</span><span class="keyword">( </span><span class="string">"save table data" </span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
}
<br />

<br />
</span><span class="default">$db </span><span class="keyword">=&amp; new </span><span class="default">database</span><span class="keyword">();
<br />

<br />
</span><span class="default">$shoppingcard </span><span class="keyword">=&amp; new </span><span class="default">table</span><span class="keyword">( &amp;</span><span class="default">$db</span><span class="keyword">, </span><span class="string">"cart " </span><span class="keyword">);
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Output of the above example is :-
<br />

<br />
connect to sql server -- (database :: constructor)
<br />
read table data using database class -- name=cart -- (table :: constructor)
<br />
performing sql -- (database :: do_sql)
<br />
close connection to sql server -- (database :: shutdown)
<br />
save changes to database -- name=cart -- (table :: shutdown)
<br />
ERROR -- CAN NOT PERFORM SQL -- NOT CONNECTED TO SERVER -- (database :: do_sql)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="40817""></a>
  <div class="note">
   <strong class="user">Jim Smith</strong>
   <a href="#40817" class="date">15-Mar-2004 04:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was trying to figure out how to pass parameters to the register_shutdown_function() since you cannot register a function with parameters and passing through globals is not appropriate. E.g. what I was trying to do was&nbsp; &lt;? register_shutdown_function("anotherfunction('parameter')") ?&gt;
<br />
Turns out, the trick is to use create_function() to create a "function" that calls the desired function with static parameters.
<br />

<br />
<span class="default">&lt;?php
<br />
$funtext</span><span class="keyword">=</span><span class="string">"mail('u@ho.com','mail test','sent after shutdown');"</span><span class="keyword">;
<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="default">create_function</span><span class="keyword">(</span><span class="string">''</span><span class="keyword">,</span><span class="default">$funtext</span><span class="keyword">));
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Here's another example showing in-line logging and a post-execution version: 
<br />

<br />
Before: in-process logging
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">logit</span><span class="keyword">(</span><span class="default">$message</span><span class="keyword">) {
<br />
&nbsp;&nbsp; </span><span class="default">$oF</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'TEST.log'</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">);
<br />
&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$oF</span><span class="keyword">,</span><span class="string">"</span><span class="default">$message</span><span class="string">\n"</span><span class="keyword">);
<br />
&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$oF</span><span class="keyword">);
<br />
&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">5</span><span class="keyword">);&nbsp; </span><span class="comment">// so you can see the delay
<br />
</span><span class="keyword">}
<br />
print </span><span class="string">"loging"</span><span class="keyword">;
<br />
</span><span class="default">logit</span><span class="keyword">(</span><span class="string">"traditional execution"</span><span class="keyword">);
<br />
print </span><span class="string">"logged"</span><span class="keyword">;
<br />
exit;
<br />
</span><span class="default">?&gt;
<br />
</span>After:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">logit</span><span class="keyword">(</span><span class="default">$message</span><span class="keyword">) {
<br />
&nbsp;&nbsp; </span><span class="default">$forlater</span><span class="keyword">=</span><span class="default">create_function</span><span class="keyword">(</span><span class="string">''</span><span class="keyword">,</span><span class="string">"loglater('</span><span class="default">$message</span><span class="string">');"</span><span class="keyword">);
<br />
&nbsp;&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="default">$forlater</span><span class="keyword">);
<br />
}
<br />
function </span><span class="default">loglater</span><span class="keyword">(</span><span class="default">$message</span><span class="keyword">) {
<br />
&nbsp;&nbsp; </span><span class="default">$oF</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'TEST.log'</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">);
<br />
&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$oF</span><span class="keyword">,</span><span class="string">"</span><span class="default">$message</span><span class="string">\n"</span><span class="keyword">);
<br />
&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$oF</span><span class="keyword">);
<br />
&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">5</span><span class="keyword">);&nbsp; </span><span class="comment">// so you can see the delay
<br />
</span><span class="keyword">}
<br />
print </span><span class="string">"loging"</span><span class="keyword">;
<br />
</span><span class="default">logit</span><span class="keyword">(</span><span class="string">"delayed execution"</span><span class="keyword">);
<br />
print </span><span class="string">"logged"</span><span class="keyword">;
<br />
exit;
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
In the 'before' example, the file is written (and the delay occurs) before the "logged" appears. In the 'after' example, the file is written after execution terminates. 
<br />

<br />
Maybe it would be nice to add a parameter to the register_shutdown_function that does this automatically?</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="40815""></a>
  <div class="note">
   <strong class="user">sts at mail dot xubion dot hu</strong>
   <a href="#40815" class="date">15-Mar-2004 02:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you need the old (&lt;4.1) behavior of register_shutdown_function you can achieve the same with "Connection: close" and "Content-Length: xxxx" headers if you know the exact size of the sent data (which can be easily caught with output buffering).<br />
An example:<br />
<span class="default">&lt;?php<br />
header</span><span class="keyword">(</span><span class="string">"Connection: close"</span><span class="keyword">);<br />
</span><span class="default">ob_start</span><span class="keyword">();<br />
</span><span class="default">phpinfo</span><span class="keyword">();<br />
</span><span class="default">$size</span><span class="keyword">=</span><span class="default">ob_get_length</span><span class="keyword">(); <br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-Length: </span><span class="default">$size</span><span class="string">"</span><span class="keyword">);<br />
</span><span class="default">ob_end_flush</span><span class="keyword">();<br />
</span><span class="default">flush</span><span class="keyword">();<br />
</span><span class="default">sleep</span><span class="keyword">(</span><span class="default">13</span><span class="keyword">);<br />
</span><span class="default">error_log</span><span class="keyword">(</span><span class="string">"do something in the background"</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
The same will work with registered functions.<br />
According to http spec, browsers should close the connection when they got the amount of data specified in Content-Length header. At least it works fine for me in IE6 and Opera7.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="39839""></a>
  <div class="note">
   <strong class="user">James Wyse (James [at] tastyspoon.com)</strong>
   <a href="#39839" class="date">12-Feb-2004 08:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a note to say that if your function uses paths relative to the script you are running (ie. for reading files, "../dir/" etc) then your function may not work correctly when registered as a shutdown function. I'm not sure where the 'working dir' IS when running a shutdown function but I find it best to use absolute paths ("/home/www/dir/").</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="37460""></a>
  <div class="note">
   <strong class="user">phpmanual at NO_SPHAMnetebb dot com</strong>
   <a href="#37460" class="date">15-Nov-2003 08:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Given this code:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">class </span><span class="default">CallbackClass </span><span class="keyword">{
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">CallbackFunction</span><span class="keyword">() {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// refers to $this
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}
<br />

<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">StaticFunction</span><span class="keyword">() {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// doesn't refer to $this
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}
<br />
}
<br />

<br />
function </span><span class="default">NonClassFunction</span><span class="keyword">() {
<br />
}
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
there appear to be 3 ways to set a callback function in PHP (using register_shutdown_function() as an example):
<br />

<br />
1: register_shutdown_function('NonClassFunction');
<br />

<br />
2: register_shutdown_function(array('CallbackClass', 'StaticFunction'));
<br />

<br />
3: $o =&amp; new CallbackClass();
<br />
&nbsp;&nbsp; register_shutdown_function(array($o, 'CallbackFunction'));
<br />

<br />
The following may also prove useful:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">class </span><span class="default">CallbackClass </span><span class="keyword">{
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">CallbackClass</span><span class="keyword">() {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(array(&amp;</span><span class="default">$this</span><span class="keyword">, </span><span class="string">'CallbackFunction'</span><span class="keyword">)); </span><span class="comment">// the &amp; is important
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">CallbackFunction</span><span class="keyword">() {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// refers to $this
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="33575""></a>
  <div class="note">
   <strong class="user">jules at sitepointAASASZZ dot com</strong>
   <a href="#33575" class="date">01-Jul-2003 12:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If your script exceeds the maximum execution time, and terminates thusly:<br />
<br />
Fatal error: Maximum execution time of 20 seconds exceeded in - on line 12<br />
<br />
The registered shutdown functions will still be executed.<br />
<br />
I figured it was important that this be made clear!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="31634""></a>
  <div class="note">
   <strong class="user">php at spandex dot deleteme dot nildram dot co dot uk</strong>
   <a href="#31634" class="date">28-Apr-2003 01:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I've had immense trouble getting any of the examples of emulated destructors to work.&nbsp; They always seemed to have a copy of the object just after initialisation.&nbsp; Many people mention that the register_shutdown_function will take a copy of the object rather than a reference... and this can be cured with an ampersand.&nbsp; If you look in the PEAR docs for the way they emulate destructors you'll find that you also need one before the "new" statement when you create an instance of your object.&nbsp; There's an editors note above that mentions this too... but I thought I'd collect it all here in one example that really works.&nbsp; Honest... I'm using it (PHP 4.3.1):
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">class </span><span class="default">Object </span><span class="keyword">{
<br />
&nbsp;&nbsp;&nbsp; var </span><span class="default">$somevar </span><span class="keyword">= </span><span class="string">"foo"</span><span class="keyword">;
<br />

<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">Object</span><span class="keyword">() {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$somevar </span><span class="keyword">= </span><span class="string">"bar"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(array(&amp;</span><span class="default">$this</span><span class="keyword">, </span><span class="string">'MyDestructor'</span><span class="keyword">));
<br />
&nbsp;&nbsp;&nbsp; }
<br />

<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">MyDestructor</span><span class="keyword">() {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment"># Do useful destructor stuff here...
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}
<br />
}
<br />

<br />
</span><span class="comment"># Now create the object as follows and then 'MyDestructor'
<br />
# will be called on shutdown and will be able to operate on
<br />
# the object as it ended up... not as it started!
<br />
</span><span class="default">$my_object </span><span class="keyword">=&amp; new </span><span class="default">Object</span><span class="keyword">;
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="28973""></a>
  <div class="note">
   <strong class="user">kwazy at php dot net</strong>
   <a href="#28973" class="date">29-Jan-2003 07:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
One more note to add about register_shutdown_function and objects.
<br />

<br />
It is possible to self-register the object from the constructor, but even using the syntax:
<br />
register_shutdown_function(array(&amp;$this,'shutdown'))
<br />

<br />
will only result in the function being called with the object in the "just initialized" state, any changes made to the object after construction will not be there when the script actually exits.
<br />

<br />
But if you use:
<br />

<br />
<span class="default">&lt;?php
<br />
$obj </span><span class="keyword">= new </span><span class="default">object</span><span class="keyword">();
<br />
</span><span class="default">register_shutdown_function</span><span class="keyword">(array(&amp;</span><span class="default">$obj</span><span class="keyword">,</span><span class="string">'shutdown'</span><span class="keyword">));
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
the object method 'shutdown' will be called with the current state of the object intact.
<br />

<br />
[Editor's note: The explanation for this behavior is really simple.
<br />
"$obj = new object()" creates a copy of the object which you can refer with $this in the object's constructor.
<br />
To solve this "problem" you should use "$obj = &amp;new object()" which assign the reference to the current object.]</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="26251""></a>
  <div class="note">
   
   <a href="#26251" class="date">23-Oct-2002 09:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When using CLI ( and perhaps command line without CLI - I didn't test it) the shutdown function doesn't get called if the process gets a SIGINT or SIGTERM. only the natural exit of PHP calls the shutdown function.
<br />
To overcome the problem compile the command line interpreter with --enable-pcntl and add this code:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">sigint</span><span class="keyword">()
<br />
{
<br />
&nbsp;&nbsp;&nbsp; exit;
<br />
}
<br />
</span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGINT</span><span class="keyword">, </span><span class="string">'sigint'</span><span class="keyword">);
<br />
</span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGTERM</span><span class="keyword">, </span><span class="string">'sigint'</span><span class="keyword">);
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
This way when the process recieves one of those signals, it quits normaly, and the shutdown function gets called.
<br />
Note: using the pcntl function in web server envoirment is considered problematic, so if you are writing a script that runs both from the command line and from the server, you should put some conditional code around that block that identifies wheater this is a command line envoirment or not.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="24514""></a>
  <div class="note">
   <strong class="user">adam at saki dot com dot au</strong>
   <a href="#24514" class="date">20-Aug-2002 03:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When using objects the syntax register_shutdown_function(array($object, 'function')) will take a copy of the object at the time of the call.&nbsp; This means you cannot do this in the constructor and have it correctly destruct objects.&nbsp; The alternative is to use register_shutdown_function(array(&amp;$object, 'function')) where the ampersand passes the reference and not the copy.&nbsp; This appears to work fine.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="19893""></a>
  <div class="note">
   <strong class="user">priebe at mi-corporation dot com</strong>
   <a href="#19893" class="date">14-Mar-2002 08:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that register_shutdown_function() does not work under Apache on Windows platforms.&nbsp; Your shutdown function will be called, but the connection will not close until the processing is complete.&nbsp; Zend tells me that this is due to a difference between Apache for *nix and Apache for Windows.<br />
<br />
I'm seeing similar behavior under IIS (using php4isapi).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
