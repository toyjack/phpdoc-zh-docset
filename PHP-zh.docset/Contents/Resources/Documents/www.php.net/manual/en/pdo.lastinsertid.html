<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>返回最后插入行的ID或序列值</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="pdo.intransaction.html">? PDO::inTransaction</a></li>
      <li style="float: right;"><a href="pdo.prepare.html">PDO::prepare ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="class.pdo.html">PDO</a></li>
    <li>返回最后插入行的ID或序列值</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="pdo.lastinsertid" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">PDO::lastInsertId</h1>
  <p class="verinfo">(PHP 5 &gt;= 5.1.0, PHP 7, PECL pdo &gt;= 0.1.0)</p><p class="refpurpose"><span class="refname">PDO::lastInsertId</span> &mdash; <span class="dc-title">
   返回最后插入行的ID或序列值
  </span></p>

 </div>
 <div class="refsect1 description" id="refsect1-pdo.lastinsertid-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>PDO::lastInsertId</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$name</code><span class="initializer"> = <strong><code>null</code></strong></span></span>
   ) : <span class="type">string</span></div>


  <p class="para rdfs-comment">
  返回最后插入行的ID，或者是一个序列对象最后的值，取决于底层的驱动。比如，<span class="function"><strong>PDO_PGSQL()</strong></span> 要求为 <code class="parameter">name</code> 参数指定序列对象的名称。
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    在不同的 PDO 驱动之间，此方法可能不会返回一个有意义或一致的结果，因为底层数据库可能不支持自增字段或序列的概念。
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 parameters" id="refsect1-pdo.lastinsertid-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">name</code></dt>

     <dd>

      <p class="para">
       应该返回ID的那个序列对象的名称。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-pdo.lastinsertid-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   如果没有为参数 <code class="parameter">name</code> 指定序列名称，<span class="function"><strong>PDO::lastInsertId()</strong></span> 则返回一个表示最后插入数据库那一行的行ID的字符串。
  </p>
  <p class="para">
   如果为参数 <code class="parameter">name</code> 指定了序列名称，<span class="function"><strong>PDO::lastInsertId()</strong></span> 则返回一个表示从指定序列对象取回最后的值的字符串。
  </p>
  <p class="para">
  如果当前 PDO 驱动不支持此功能，则 <span class="function"><strong>PDO::lastInsertId()</strong></span> 触发一个 <code class="literal">IM001</code> SQLSTATE 。
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="123467""></a>
  <div class="note">
   <strong class="user">nafsinvk at gmail dot com</strong>
   <a href="#123467" class="date">25-Dec-2018 07:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
$dbh-&gt;commit(); <br />
print $dbh-&gt;lastInsertId(); <br />
The above will always return zero (0)<br />
So it is important to call $dbh-&gt;lastInsertId();&nbsp; before commiting transaction <br />
<br />
the above should be modified as <br />
print $dbh-&gt;lastInsertId(); <br />
$dbh-&gt;commit();</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="122972""></a>
  <div class="note">
   <strong class="user">phackwer at gmail dot com</strong>
   <a href="#122972" class="date">23-Jul-2018 07:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
On version 7.0.9 I've implemented lastInsertId without having to name the sequence for PostgreSQL (I've also have done it for 5.6.can'trememberthenumber, but I can't find the PR).<br />
<br />
Can someone update the documentation about it?<br />
<br />
Here is the Pull Request: https://github.com/php/php-src/pull/2014</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="122009""></a>
  <div class="note">
   <strong class="user">toinenkayt (ta at ta) [iwonderr] gmail d</strong>
   <a href="#122009" class="date">11-Dec-2017 12:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To save time for some of you.<br />
<br />
When using MySQL or MariaDB while inserting multiple rows in a single query (INSERT INTO table (a,b,c) VALUES (1,2,3), (2,3,4), ...) to a table with auto_increment column, PDO::lastInsertId does NOT return the autogenerated id of the last row. Instead, the FIRST generated id is returned. This may very well be explained by taking a look at MySQL and MariaDB's documentation.<br />
<br />
Quotations from their respective documentations, <br />
<br />
MySQL:<br />
"With no argument, LAST_INSERT_ID() returns a BIGINT UNSIGNED (64-bit) value representing the first automatically generated value successfully inserted for an AUTO_INCREMENT column as a result of the most recently executed INSERT statement."<br />
<br />
MariaDB:<br />
"LAST_INSERT_ID() (no arguments) returns the first automatically generated value successfully inserted for an AUTO_INCREMENT column as a result of the most recently executed INSERT statement."<br />
<br />
This is clearly not what lastInsertId's own documentation states. Hopefully this will save someone from debugging the cause of id mismatch.<br />
<br />
tl;dr (MySQL | Mariadb) + multi row insert + PDO::lastInsertId = first autogenerated id<br />
<br />
Behaviour tested using MariaDB 10.2.6 32-bit, PHP 5.6.31 32-bit and mysqlnd 5.0.11 running on windows 7.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120618""></a>
  <div class="note">
   <strong class="user">timer timer five at gmail dot com</strong>
   <a href="#120618" class="date">08-Feb-2017 05:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
About the connections created through classes<br />
<br />
eg: db::SQL()-&gt;query();<br />
then db::SQL()-&gt;lastInsertId();<br />
<br />
it will create a new connection and will not return the last ID inserted. it is better to include a PDO connection file (or directly the logins) and work with it to get the last ID properly.<br />
<br />
$db = new PDO(logins);<br />
$db-&gt;query();<br />
$db-&gt;lastInsertId();</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120354""></a>
  <div class="note">
   <strong class="user">enclaved</strong>
   <a href="#120354" class="date">20-Dec-2016 11:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
WARNING for PostgreSQL users! In response to the comment by ed at hicklinslade dot com, who wrote:<br />
<br />
...<br />
$last_insert_id = $objPDO-&gt;lastInsertId("$strTable_id_seq);<br />
<br />
This does appear to function as expected. What is a little unclear to me is whether this simply returns the current value of the sequence; if it does, this isn't a particularly reliable indicator as to the id of the record your code just inserted, especially if your site or application is especially high traffic.<br />
...<br />
<br />
NEVER ever use lastInsertId() with PostgreSQL sequences, ESPECIALLY when your application's insert/update load is high. PostgreSQL sequences are non-transactional (a natural design feature to avoid exclusive locking which otherwise produces unacceptable performance). This means that any concurrent transaction incrementing the same sequence will render the value returned by lastInsertId() invalid with respect to the last insert by your transaction. Example:<br />
<br />
Transaction 1 inserts with nextval('some_seq') yielding 100;<br />
Concurrent transaction 2 inserts with nextval('some_seq') yielding 101;<br />
Transaction 1 calls lastInsertId(), expecting 100, BUT GETS 101.<br />
<br />
This PDO method is braindead for PostgreSQL, always use INSERT ... RETURNING instead. Regards.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="119490""></a>
  <div class="note">
   <strong class="user">pippi langstrumpf</strong>
   <a href="#119490" class="date">20-Jun-2016 12:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
beware when mixing auto-incremented and explicit IDs!<br />
Given a fresh table "tbl", executing <br />
<br />
insert into tbl values (0, 'kaeptn blaubaer'); --auto increment (-&gt; 1)<br />
insert into tbl values (16, 'pipi langstrumpf'); --explicit id (-&gt; 16)<br />
select LAST_INSERT_ID();<br />
<br />
will return 1, which is not the value of the last insert. its the value from the last auto-increment insert!<br />
<br />
(using mysql)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118040""></a>
  <div class="note">
   <strong class="user">voilethht at gmail dot com</strong>
   <a href="#118040" class="date">23-Sep-2015 08:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In the Return Values part:<br />
<br />
If the PDO driver does not support this capability, PDO::lastInsertId() triggers an IM001 SQLSTATE.<br />
--------------------------------------------------------------------------------<br />
<br />
So what's the solution for this....?<br />
And I got this error:<br />
-------------------------------------------------------------------------------<br />
PHP Warning:&nbsp; PDO::lastInsertId(): SQLSTATE[IM001]: Driver does not support this function: driver does not support lastInsertId() in xxxx<br />
-------------------------------------------------------------------------------<br />
I'm using IBM db2 odbc driver...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="115739""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#115739" class="date">16-Sep-2014 07:19</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Sorry to contradict Jonathon Hibbard's comment (<a href="http://php.net/manual/en/pdo.lastinsertid.php#82838" rel="nofollow" target="_blank">http://php.net/manual/en/pdo.lastinsertid.php#82838</a>), but my experiencie with INSERT INTO ... ON DUPLICATE KEY UPDATE is totally different; maybe it's due to PHP version (I'm on Windows, 5.4.7; I realize his post is 6 years old) or to the database engine (MySQL in my case).<br />
<br />
Nevertheless, if I do an INSERT INTO ... ON DUPLICATE KEY UPDATE (something like id=id or equivalent, where the updated value is equal to the original one), this is what I'm getting:<br />
<br />
- If the key didn't exist, the value is inserted, and lastInsertId() returns the expected id for the new row.<br />
<br />
- If the row exists AND a value is updated, with lastInsertId() I get the ID of the updated row.<br />
<br />
- If the row exists but NO value is updated, lastInsertId() returns 0.<br />
<br />
That contradicts his example, where he assures that<br />
"INSERT INTO city (`city`) VALUES ('Paris') ON DUPLICATE KEY UPDATE `city` = 'Paris'"<br />
returns 2 (??) on lastInsertId() and that he expected to return 1 "since no records were inserted" (??).<br />
<br />
Hope this helps someone.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="113402""></a>
  <div class="note">
   <strong class="user">mattbridges at me dot com</strong>
   <a href="#113402" class="date">07-Oct-2013 08:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
@nour<br />
<br />
You need to call lastInsertId before you commit</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="110977""></a>
  <div class="note">
   <strong class="user">nick dot barton at libersys dot co dot uk</strong>
   <a href="#110977" class="date">02-Jan-2013 02:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Easiest solution I've found for MSSQL to obtain the last inserted ID is
<br />

<br />
<span class="default">&lt;?php
<br />
$STH </span><span class="keyword">= </span><span class="default">$DBH</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">"SELECT CAST(COALESCE(SCOPE_IDENTITY(), @@IDENTITY) AS int)"</span><span class="keyword">);
<br />
</span><span class="default">$STH</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();
<br />
</span><span class="default">$result </span><span class="keyword">= </span><span class="default">$STH</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">();
<br />
print </span><span class="default">$result</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="110037""></a>
  <div class="note">
   <strong class="user">noel dot mcavoy at gmail dot com</strong>
   <a href="#110037" class="date">13-Sep-2012 07:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This function is now compatible with the newer MS SQL driver. <a href="http://msdn.microsoft.com/en-us/library/ff628155(v=sql.105" rel="nofollow" target="_blank">http://msdn.microsoft.com/en-us/library/ff628155(v=sql.105</a>)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107622""></a>
  <div class="note">
   <strong class="user">spark at limao dot com dot br</strong>
   <a href="#107622" class="date">22-Feb-2012 01:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Remember, if you use a transaction you should use lastInsertId BEFORE you commit<br />
otherwise it will return 0</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105580""></a>
  <div class="note">
   <strong class="user">warezthebeef at gmail dot com</strong>
   <a href="#105580" class="date">29-Aug-2011 11:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you're accessing MSSQL/SQL Server 2008 R2 (or higher) from Linux via FreeTDS there's a slightly neater way of getting the last insert ID than the solution(s) outlined below.<br />
<br />
The specific SQL involved is outlined here:<br />
<br />
<a href="http://msdn.microsoft.com/en-us/library/ms177564.aspx" rel="nofollow" target="_blank">http://msdn.microsoft.com/en-us/library/ms177564.aspx</a><br />
<br />
So for example, with a table containing the two columns (product_id, product_name) where product_id is a uniqueidentifier or something similar you could do the following.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">// Assume $dbh connection handle is already established<br />
<br />
</span><span class="default">$sql </span><span class="keyword">= </span><span class="string">"INSERT INTO product (product_name) OUTPUT INSERTED.product_id VALUES (?)"</span><span class="keyword">;<br />
<br />
</span><span class="default">$sth </span><span class="keyword">= </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);<br />
<br />
</span><span class="default">$sth</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">(array(</span><span class="string">'widgets'</span><span class="keyword">));<br />
<br />
</span><span class="default">$temp </span><span class="keyword">= </span><span class="default">$sth</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">(</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">FETCH_ASSOC</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Then $temp will contain an array like:<br />
<br />
Array<br />
(<br />
&nbsp;&nbsp;&nbsp; [product_id] =&gt; E1DA1CB0-676A-4CD9-A22C-90C9D4E81914<br />
)<br />
<br />
Just be warned that there are some issues relating to how uniqueidentifier columns are handled by PDO_DBLIB/FreeTDS depending on the TDS version you choose that have only been fixed as of PHP 5.3.7.<br />
<br />
Information regarding this and the patch can be found here:<br />
<br />
https://bugs.php.net/bug.php?id=54167</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="102614""></a>
  <div class="note">
   <strong class="user">ruben02 at hotmail dot com</strong>
   <a href="#102614" class="date">24-Feb-2011 07:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I think I get a nice solution in Postgres to get the ID using the RETURNING that comes with Postgress since version 8.2. In the example below, I add to my insert clause the "returning" along with the primary key of my table, then after the execute, I do a fetch getting an array with the value of the last inserted id. 
<br />

<br />
<span class="default">&lt;?php
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">insert</span><span class="keyword">(</span><span class="default">$employee</span><span class="keyword">){
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sqlQuery </span><span class="keyword">= </span><span class="string">"INSERT INTO employee(user_id,name,address,city) VALUES(:user_id,:name,:address,:city) RETURNING employee_id"</span><span class="keyword">;
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$statement </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="default">$sqlQuery</span><span class="keyword">);
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$a </span><span class="keyword">=</span><span class="string">"2002-03-11 12:01AM" </span><span class="keyword">;
<br />

<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="string">":user_id"</span><span class="keyword">, </span><span class="default">$employee</span><span class="keyword">-&gt;</span><span class="default">getUserId</span><span class="keyword">(), </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_INT</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="string">":name"</span><span class="keyword">, </span><span class="default">$employee</span><span class="keyword">-&gt;</span><span class="default">getName</span><span class="keyword">(), </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_STR</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="string">":address"</span><span class="keyword">, </span><span class="default">$employee</span><span class="keyword">-&gt;</span><span class="default">getAddress</span><span class="keyword">(), </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_STR</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="string">":city"</span><span class="keyword">, </span><span class="default">$employee</span><span class="keyword">-&gt;</span><span class="default">getCity</span><span class="keyword">(), </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_STR</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">(</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">FETCH_ASSOC</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$result</span><span class="keyword">[</span><span class="string">"employee_id"</span><span class="keyword">];
<br />

<br />
&nbsp;&nbsp;&nbsp; }
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="87589""></a>
  <div class="note">
   <strong class="user">info at nospam dot timreeves dot de</strong>
   <a href="#87589" class="date">11-Dec-2008 12:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Workaround for the fact that MSSQL does not provide lastInsertId().&nbsp; This is locale-independent by design.
<br />

<br />
<span class="default">&lt;?php
<br />
$mixRc </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;
<br />
try {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Issue a compound command, 2nd part outputs the inserted Id
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$strQuery </span><span class="keyword">=
<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">'INSERT INTO t1 (f1,f2) VALUES(v1,v2); SELECT @@IDENTITY AS mixLastId'</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Yup, your eyes are ok, NOT exec but query!!!
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$objSth </span><span class="keyword">= </span><span class="default">$objDb</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="default">$strQuery</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mixRc </span><span class="keyword">= (</span><span class="default">is_object</span><span class="keyword">(</span><span class="default">$objSth</span><span class="keyword">) and </span><span class="default">$objSth</span><span class="keyword">-&gt;</span><span class="default">errorCode</span><span class="keyword">() == </span><span class="string">'00000'</span><span class="keyword">);
<br />
}
<br />
catch (</span><span class="default">PDOException $objException</span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pdoMsg </span><span class="keyword">= </span><span class="default">$objException</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">();
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pdoMsg </span><span class="keyword">= </span><span class="default">iconv</span><span class="keyword">(</span><span class="string">"ISO-8859-1"</span><span class="keyword">, </span><span class="string">"UTF-8"</span><span class="keyword">, </span><span class="default">$pdoMsg</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$strMessage </span><span class="keyword">= </span><span class="string">'insertRecord: Failed ' </span><span class="keyword">.
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$strQuery </span><span class="keyword">. </span><span class="string">', Error Message: ' </span><span class="keyword">. </span><span class="default">$pdoMsg</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">doLog</span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">, </span><span class="default">__LINE__</span><span class="keyword">, </span><span class="default">$strMessage</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; throw new </span><span class="default">core_exception_database</span><span class="keyword">(</span><span class="default">$strMessage</span><span class="keyword">);
<br />
}
<br />
if (</span><span class="default">$mixRc </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) return </span><span class="default">false</span><span class="keyword">;
<br />

<br />
</span><span class="comment">// The compound command delivers a multi-rowset statement handle
<br />
// Move past the first (invalid) rowset from the INSERT command
<br />
</span><span class="default">$objSth</span><span class="keyword">-&gt;</span><span class="default">nextRowset</span><span class="keyword">();
<br />
</span><span class="comment">// Pick up the first row of the rowset from "SELECT @@IDENTITY"
<br />
</span><span class="default">$rowTd </span><span class="keyword">= </span><span class="default">$objSth</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">(</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">FETCH_NUM</span><span class="keyword">);
<br />
if (!</span><span class="default">is_array</span><span class="keyword">(</span><span class="default">$rowTd</span><span class="keyword">)) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">doLog</span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">, </span><span class="default">__LINE__</span><span class="keyword">,
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'insertRecord: $objSth-&gt;fetch() returns %s'</span><span class="keyword">, </span><span class="default">gettype</span><span class="keyword">(</span><span class="default">$rowTd</span><span class="keyword">));
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;
<br />
}
<br />
</span><span class="default">$objSth</span><span class="keyword">-&gt;</span><span class="default">closeCursor</span><span class="keyword">();
<br />
</span><span class="default">$strLastRowId </span><span class="keyword">= </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$rowTd</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]); </span><span class="comment">// trim() for trailing Nullbyte
<br />
// Integers are returned stringified, format depends on locale
<br />
// Generally ends with ",00" or ".00" - trim that off
<br />
</span><span class="default">$strLastRowId </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">'/[,.]0+$/'</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">, </span><span class="default">$strLastRowId</span><span class="keyword">);
<br />
</span><span class="comment">// Remove any remaining "." or "," for thousands
<br />
</span><span class="default">$strLastRowId </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">'/[,.]/'</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">, </span><span class="default">$strLastRowId</span><span class="keyword">);
<br />
</span><span class="comment">// A GUID, which contains no "," or ".", will be left unchanged
<br />
</span><span class="keyword">return </span><span class="default">$strLastRowId</span><span class="keyword">;
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="86178""></a>
  <div class="note">
   <strong class="user">Alfred Reinold Baudisch</strong>
   <a href="#86178" class="date">06-Oct-2008 05:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For PostgreSQL you can still use the old solution to return the last Id of an INSERT, selecting the currval of a table's id_sequence.<br />
<br />
The code below shows a working function (which is easy adaptale into another class, etc).<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// -------------------------<br />
// Last Insert ID for PDO with PostgreSQL<br />
// -------------------------<br />
</span><span class="keyword">function </span><span class="default">pgsqlLastInsertId</span><span class="keyword">(</span><span class="default">$sqlQuery</span><span class="keyword">, </span><span class="default">$pdoObject</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Checks if query is an insert and gets table name<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">"/^INSERT[\t\n ]+INTO[\t\n ]+([a-z0-9\_\-]+)/is"</span><span class="keyword">, </span><span class="default">$sqlQuery</span><span class="keyword">, </span><span class="default">$tablename</span><span class="keyword">) )<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Gets this table's last sequence value<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$query </span><span class="keyword">= </span><span class="string">"SELECT currval('" </span><span class="keyword">. </span><span class="default">$tablename</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] . </span><span class="string">"_id_seq') AS last_value"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$temp_q_id </span><span class="keyword">= </span><span class="default">$pdoObject</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$temp_q_id</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$temp_q_id</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$temp_result </span><span class="keyword">= </span><span class="default">$temp_q_id</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">(</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">FETCH_ASSOC</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return ( </span><span class="default">$temp_result </span><span class="keyword">) ? </span><span class="default">$temp_result</span><span class="keyword">[</span><span class="string">'last_value'</span><span class="keyword">] : </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Example of use:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// ... connects to a PostgreSQL DB<br />
</span><span class="default">$pdoObject </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">'pgsql:host=localhost;dbname=mydb'</span><span class="keyword">, </span><span class="string">'user'</span><span class="keyword">, </span><span class="string">'pass'</span><span class="keyword">);<br />
<br />
</span><span class="default">$sql </span><span class="keyword">= </span><span class="string">'INSERT INTO table (column) VALUES (\'some_value\');'</span><span class="keyword">;<br />
</span><span class="default">$result </span><span class="keyword">= </span><span class="default">$pdoObject</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);<br />
</span><span class="default">$result</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
<br />
echo </span><span class="string">'Last Insert ID: ' </span><span class="keyword">. </span><span class="default">pgsqlLastInsertId</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">, </span><span class="default">$pdoObject</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85129""></a>
  <div class="note">
   <strong class="user">Nour</strong>
   <a href="#85129" class="date">15-Aug-2008 02:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Beware of lastInsertId() when working with transactions in mysql. The following code returns 0 instead of the insert id.
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">try {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dbh </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">'mysql:host=localhost;dbname=test'</span><span class="keyword">, </span><span class="string">'username'</span><span class="keyword">, </span><span class="string">'password'</span><span class="keyword">);
<br />

<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"INSERT INTO test (name, email) VALUES(?,?)"</span><span class="keyword">);
<br />

<br />
&nbsp;&nbsp;&nbsp; try {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">beginTransaction</span><span class="keyword">();
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">( array(</span><span class="string">'user'</span><span class="keyword">, </span><span class="string">'user@example.com'</span><span class="keyword">));
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">commit</span><span class="keyword">();
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">lastInsertId</span><span class="keyword">();
<br />
&nbsp;&nbsp;&nbsp; } catch(</span><span class="default">PDOExecption $e</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">rollback</span><span class="keyword">();
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print </span><span class="string">"Error!: " </span><span class="keyword">. </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">"&lt;/br&gt;"</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />
} catch( </span><span class="default">PDOExecption $e </span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; print </span><span class="string">"Error!: " </span><span class="keyword">. </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">"&lt;/br&gt;"</span><span class="keyword">;
<br />
}
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
When no exception is thrown, lastInsertId returns 0. However, if lastInsertId is called before calling commit, the right id is returned.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83440""></a>
  <div class="note">
   <strong class="user">ed at hicklinslade dot com</strong>
   <a href="#83440" class="date">26-May-2008 09:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In response to Yonatan Ben-Nes, it does appear that using the latest versions of PHP 5.x and PostgreSQL 8.x, the driver will return a "meaningful" ID (rather than an OID), provided you pass the name of the corresponding sequence.<br />
<br />
So, if you created a table as follows:<br />
<br />
CREATE TABLE "user" (<br />
"id" SERIAL PRIMARY KEY NOT NULL,<br />
"username" character varying(32)<br />
);<br />
<br />
PostgreSQL will (by default) create a sequence called 'user_id_seq'.<br />
<br />
You can then do something like:<br />
<br />
$strTable = "user":<br />
$last_insert_id = $objPDO-&gt;lastInsertId("$strTable_id_seq);<br />
<br />
This does appear to function as expected. What is a little unclear to me is whether this simply returns the current value of the sequence; if it does, this isn't a particularly reliable indicator as to the id of the record your code just inserted, especially if your site or application is especially high traffic.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83217""></a>
  <div class="note">
   <strong class="user">Xavier Arnaus</strong>
   <a href="#83217" class="date">15-May-2008 10:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As said by Dennis Du Kroger, in this situation the function will return 0. <br />
<br />
But you can retrieve the last inserted Id executing a query asking for the function LAST_INSERT_ID() (at least in MySQL)<br />
<br />
Try this:<br />
<br />
($o_db is the declared adapter)<br />
<br />
$last_id = $o_db-&gt;fetchAll('SELECT LAST_INSERT_ID() as last_id');<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
$last_id = intval($last_id[0]['last_id']);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83169""></a>
  <div class="note">
   <strong class="user">Steven L</strong>
   <a href="#83169" class="date">13-May-2008 12:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This function is not available for MSSQL either.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82838""></a>
  <div class="note">
   <strong class="user">Jonathon Hibbard</strong>
   <a href="#82838" class="date">28-Apr-2008 10:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It should be noted here at this function will not display the correct ID if issuing ON DUPLICATE KEY UPDATE.
<br />

<br />
Example on a new Row:
<br />
<span class="default">&lt;?php
<br />
$sql </span><span class="keyword">= </span><span class="string">"INSERT INTO city (`city`) VALUES ('Paris') ON DUPLICATE KEY UPDATE `city` = 'Paris"</span><span class="keyword">;
<br />
</span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);
<br />
echo </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">lastInsertId</span><span class="keyword">();
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Above displays: 1
<br />
Expected display: 1
<br />

<br />
Example on an existing row that gets updated:
<br />
<span class="default">&lt;?php
<br />
$sql </span><span class="keyword">= </span><span class="string">"INSERT INTO city (`city`) VALUES ('Paris') ON DUPLICATE KEY UPDATE `city` = 'Paris"</span><span class="keyword">;
<br />
</span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);
<br />
echo </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">lastInsertId</span><span class="keyword">();
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Above displays: 2
<br />
Expected display: 1 (since no new records were inserted)
<br />

<br />
You'll have to work around this.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75200""></a>
  <div class="note">
   <strong class="user">Yonatan Ben-Nes</strong>
   <a href="#75200" class="date">17-May-2007 09:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It should be mentioned that this function DOES NOT retrieve the ID (Primary key) of the row but it's OID instead.<br />
<br />
So if you use one of the latest PostgreSQL versions this function won't help you unless you add OID to the table specifically when you create it.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="72509""></a>
  <div class="note">
   <strong class="user">Dennis Du Kr?ger</strong>
   <a href="#72509" class="date">22-Jan-2007 02:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It should be noted that, at least for MySQL using InnoDB tables, with transactions PDO will report the last insert id as 0 after the commit, the real ids are only reported before committing.<br />
<br />
(As a side note, MySQL keeps the ID number incremented after a rollback).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68987""></a>
  <div class="note">
   <strong class="user">dave at dtracorp dot com</strong>
   <a href="#68987" class="date">18-Aug-2006 05:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
in case anyone was wondering<br />
something like<br />
<br />
$val = 5;<br />
$sql = "REPLACE table (column) VALUES (:val)";<br />
$stmt = $dbh-&gt;prepare($sql);<br />
$stmt-&gt;bindParam(':val', $val, PDO::PARAM_INT);<br />
$stmt-&gt;execute();<br />
$lastId = $dbh-&gt;lastInsertId();<br />
<br />
will return the last inserted id, whether the record was replaced or simply inserted<br />
<br />
the REPLACE syntax, simply inserts, or deletes &gt; inserts<br />
so lastInsertId() still works<br />
<br />
refer to <a href="http://mysql.com/doc/refman/5.0/en/replace.html" rel="nofollow" target="_blank">http://mysql.com/doc/refman/5.0/en/replace.html</a><br />
for REPLACE usage</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="59930""></a>
  <div class="note">
   <strong class="user">opik at opik dot ru</strong>
   <a href="#59930" class="date">20-Dec-2005 06:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Simple example:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">try {<br />
&nbsp;&nbsp; </span><span class="default">$dbh </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">'mysql:host=localhost;dbname=test'</span><span class="keyword">, </span><span class="string">'root'</span><span class="keyword">, </span><span class="string">'passowd'</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; </span><span class="default">$smf </span><span class="keyword">= </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"INSERT INTO test (`numer`) VALUES (?)"</span><span class="keyword">);<br />
&nbsp; <br />
&nbsp;&nbsp; </span><span class="default">$a </span><span class="keyword">= </span><span class="default">mt_rand</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">$smf</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">, </span><span class="default">$a</span><span class="keyword">, </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_INT</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">$smf</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
&nbsp;&nbsp; print </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">lastInsertId</span><span class="keyword">().</span><span class="string">'&lt;br /&gt;'</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; </span><span class="default">$a </span><span class="keyword">= </span><span class="default">mt_rand</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">$smf</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">, </span><span class="default">$a</span><span class="keyword">, </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_INT</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">$smf</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
&nbsp;&nbsp; print </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">lastInsertId</span><span class="keyword">();<br />
<br />
&nbsp;&nbsp; </span><span class="default">$dbh </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
} catch (</span><span class="default">PDOException $e</span><span class="keyword">) {<br />
&nbsp;&nbsp; print </span><span class="string">"Error!: " </span><span class="keyword">. </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">"&lt;br/&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp; die();<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
