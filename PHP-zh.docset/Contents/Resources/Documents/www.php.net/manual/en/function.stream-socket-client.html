<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>Open Internet or Unix domain socket connection</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.stream-socket-accept.html">? stream_socket_accept</a></li>
      <li style="float: right;"><a href="function.stream-socket-enable-crypto.html">stream_socket_enable_crypto ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.stream.html">Stream 函数</a></li>
    <li>Open Internet or Unix domain socket connection</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.stream-socket-client" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">stream_socket_client</h1>
  <p class="verinfo">(PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">stream_socket_client</span> &mdash; <span class="dc-title">Open Internet or Unix domain socket connection</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.stream-socket-client-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>stream_socket_client</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$address</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter reference">&$error_code</code><span class="initializer"> = <strong><code>null</code></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter reference">&$error_message</code><span class="initializer"> = <strong><code>null</code></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">float</span><span class="type"></span></span> <code class="parameter">$timeout</code><span class="initializer"> = <strong><code>null</code></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$flags</code><span class="initializer"> = <strong><code>STREAM_CLIENT_CONNECT</code></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">resource</span><span class="type"></span></span> <code class="parameter">$context</code><span class="initializer"> = <strong><code>null</code></strong></span></span><br>): <span class="type"><span class="type">resource</span>|<span class="type"><span class="type false">false</span></span></span></div>

  <p class="para rdfs-comment">
   Initiates a stream or datagram connection to the destination specified
   by <code class="parameter">address</code>.  The type of socket created
   is determined by the transport specified using standard URL formatting:
   <code class="literal">transport://target</code>.  For Internet Domain sockets
   (AF_INET) such as TCP and UDP, the <code class="literal">target</code> portion
   of the <code class="parameter">address</code> parameter should consist of
   a hostname or IP address followed by a colon and a port number.  For Unix
   domain sockets, the <code class="literal">target</code> portion should point
   to the socket file on the filesystem.
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    The stream will by default be opened in blocking mode.  You can
    switch it to non-blocking mode by using
    <span class="function"><a href="function.stream-set-blocking.html" class="function">stream_set_blocking()</a></span>.
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.stream-socket-client-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">address</code></dt>

     <dd>

      <p class="para">
       Address to the socket to connect to.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">error_code</code></dt>

     <dd>

      <p class="para">
       Will be set to the system level error number if connection fails.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">error_message</code></dt>

     <dd>

      <p class="para">
       Will be set to the system level error message if the connection fails.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">timeout</code></dt>

     <dd>

      <p class="para">
       Number of seconds until the <code class="literal">connect()</code> system call
       should timeout. By default, <a href="filesystem.configuration.html#ini.default-socket-timeout" class="link">default_socket_timeout</a>
       is used.
       <blockquote class="note"><p><strong class="note">Note</strong>: 
        <span class="simpara">
         This parameter only applies when not making asynchronous
         connection attempts.
        </span>
       </p></blockquote>
       <blockquote class="note"><p><strong class="note">Note</strong>: 
        <p class="para">
         To set a timeout for reading/writing data over the socket, use the
         <span class="function"><a href="function.stream-set-timeout.html" class="function">stream_set_timeout()</a></span>, as the
         <code class="parameter">timeout</code> only applies while making connecting
         the socket.
        </p>
       </p></blockquote>
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">flags</code></dt>

     <dd>

      <p class="para">
       Bitmask field which may be set to any combination of connection flags.
       Currently the select of connection flags is limited to
       <strong><code>STREAM_CLIENT_CONNECT</code></strong> (default),
       <strong><code>STREAM_CLIENT_ASYNC_CONNECT</code></strong> and
       <strong><code>STREAM_CLIENT_PERSISTENT</code></strong>.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">context</code></dt>

     <dd>

      <p class="para">
       A valid context resource created with <span class="function"><a href="function.stream-context-create.html" class="function">stream_context_create()</a></span>.
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.stream-socket-client-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   On success a stream resource is returned which may
   be used together with the other file functions (such as
   <span class="function"><a href="function.fgets.html" class="function">fgets()</a></span>, <span class="function"><a href="function.fgetss.html" class="function">fgetss()</a></span>,
   <span class="function"><a href="function.fwrite.html" class="function">fwrite()</a></span>, <span class="function"><a href="function.fclose.html" class="function">fclose()</a></span>, and
   <span class="function"><a href="function.feof.html" class="function">feof()</a></span>), <strong><code>false</code></strong> on failure.
  </p>
 </div>


 <div class="refsect1 errors" id="refsect1-function.stream-socket-client-errors">
  <h3 class="title">错误／异常</h3>
  <p class="para">
   On failure the <code class="parameter">error_code</code> and
   <code class="parameter">error_message</code> arguments will be populated with the actual
   system level error that occurred in the system-level
   <code class="literal">connect()</code> call. If the value returned in
   <code class="parameter">error_code</code> is <code class="literal">0</code> and the
   function returned <strong><code>false</code></strong>, it is an indication that the error
   occurred before the <code class="literal">connect()</code> call. This is
   most likely due to a problem initializing the socket. Note that
   the <code class="parameter">error_code</code> and
   <code class="parameter">error_message</code> arguments will always be passed by
   reference.
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.stream-socket-client-changelog">
  <h3 class="title">更新日志</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>版本</th>
      <th>说明</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
      <td>8.0.0</td>
      <td>
       <code class="parameter">timeout</code> and <code class="parameter">context</code> are now nullable.
      </td>
     </tr>

    </tbody>
   
  </table>

 </div>

 
 <div class="refsect1 examples" id="refsect1-function.stream-socket-client-examples">
  <h3 class="title">范例</h3>
  <p class="para">
   <div class="example" id="stream-socket-client.example.basic">
    <p><strong>Example #1 <span class="function"><strong>stream_socket_client()</strong></span> example</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">stream_socket_client</span><span style="color: #007700">(</span><span style="color: #DD0000">"tcp://www.example.com:80"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$errstr</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">30</span><span style="color: #007700">);<br />if&nbsp;(!</span><span style="color: #0000BB">$fp</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$errstr</span><span style="color: #DD0000">&nbsp;(</span><span style="color: #0000BB">$errno</span><span style="color: #DD0000">)&lt;br&nbsp;/&gt;\n"</span><span style="color: #007700">;<br />}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"GET&nbsp;/&nbsp;HTTP/1.0\r\nHost:&nbsp;www.example.com\r\nAccept:&nbsp;*/*\r\n\r\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(!</span><span style="color: #0000BB">feof</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #0000BB">fgets</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">1024</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
   <div class="example" id="stream-socket-client.example.daytime">
    <p><strong>Example #2 Using UDP connection</strong></p>
    <div class="example-contents"><p>
     Retrieving the day and time from the UDP service &quot;daytime&quot; (port 13)
     on localhost.
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">stream_socket_client</span><span style="color: #007700">(</span><span style="color: #DD0000">"udp://127.0.0.1:13"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$errstr</span><span style="color: #007700">);<br />if&nbsp;(!</span><span style="color: #0000BB">$fp</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"ERROR:&nbsp;</span><span style="color: #0000BB">$errno</span><span style="color: #DD0000">&nbsp;-&nbsp;</span><span style="color: #0000BB">$errstr</span><span style="color: #DD0000">&lt;br&nbsp;/&gt;\n"</span><span style="color: #007700">;<br />}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #0000BB">fread</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">26</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.stream-socket-client-notes">
  <h3 class="title">注释</h3>
  <div class="warning"><strong class="warning">Warning</strong>
   <p class="simpara">
     UDP sockets will sometimes appear to have opened without an error,
     even if the remote host is unreachable.  The error will only
     become apparent when you read or write data to/from the socket.
     The reason for this is because UDP is a &quot;connectionless&quot; protocol,
     which means that the operating system does not try to establish
     a link for the socket until it actually needs to send or receive data.
   </p>
  </div>
  <blockquote class="note"><p><strong class="note">Note</strong>: <span class="simpara">当指定数值型的 IPv6
地址（例如 <code class="literal">fe80::1</code>）时必须用方括号将 IP 围起来&mdash;&mdash;例如，
<code class="literal">tcp://[fe80::1]:80</code>。</span></p></blockquote>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    Depending on the environment, the Unix domain or the optional
    connect timeout may not be available.  A list of available
    transports can be retrieved using <span class="function"><a href="function.stream-get-transports.html" class="function">stream_get_transports()</a></span>.
    See <a href="transports.html" class="xref">所支持的套接字传输器（Socket Transports）列表</a> for a list of built in transports.
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.stream-socket-client-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.stream-socket-server.html" class="function" rel="rdfs-seeAlso">stream_socket_server()</a> - Create an Internet or Unix domain server socket</span></li>
    <li class="member"><span class="function"><a href="function.stream-set-blocking.html" class="function" rel="rdfs-seeAlso">stream_set_blocking()</a> - 为资源流设置阻塞或者阻塞模式</span></li>
    <li class="member"><span class="function"><a href="function.stream-set-timeout.html" class="function" rel="rdfs-seeAlso">stream_set_timeout()</a> - Set timeout period on a stream</span></li>
    <li class="member"><span class="function"><a href="function.stream-select.html" class="function" rel="rdfs-seeAlso">stream_select()</a> - Runs the equivalent of the select() system call on the given
   arrays of streams with a timeout specified by seconds and microseconds</span></li>
    <li class="member"><span class="function"><a href="function.fgets.html" class="function" rel="rdfs-seeAlso">fgets()</a> - 从文件指针中读取一行</span></li>
    <li class="member"><span class="function"><a href="function.fgetss.html" class="function" rel="rdfs-seeAlso">fgetss()</a> - 从文件指针中读取一行并过滤掉 HTML 标记</span></li>
    <li class="member"><span class="function"><a href="function.fwrite.html" class="function" rel="rdfs-seeAlso">fwrite()</a> - 写入文件（可安全用于二进制文件）</span></li>
    <li class="member"><span class="function"><a href="function.fclose.html" class="function" rel="rdfs-seeAlso">fclose()</a> - 关闭一个已打开的文件指针</span></li>
    <li class="member"><span class="function"><a href="function.feof.html" class="function" rel="rdfs-seeAlso">feof()</a> - 测试文件指针是否到了文件结束的位置</span></li>
    <li class="member"><a href="ref.curl.html" class="xref">cURL 函数</a></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="115723""></a>
  <div class="note">
   <strong class="user">Daniel</strong>
   <a href="#115723" class="date">12-Sep-2014 08:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you only need to check a stream for data, you can use stream_get_content and strtr function. stream_get_content&nbsp; <br />
reads the remainder of a stream into a string.&nbsp; <br />
<span class="default">&lt;?php<br />
<br />
$addr </span><span class="keyword">= </span><span class="default">gethostbyname</span><span class="keyword">(</span><span class="string">'www.example.com'</span><span class="keyword">);<br />
<br />
</span><span class="default">$client </span><span class="keyword">= </span><span class="default">stream_socket_client</span><span class="keyword">(</span><span class="string">"tcp://</span><span class="default">$addr</span><span class="string">:80"</span><span class="keyword">, </span><span class="default">$errno</span><span class="keyword">, </span><span class="default">$errorMessage</span><span class="keyword">);<br />
<br />
&nbsp;if(</span><span class="default">$client </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">UnexpectedValueException</span><span class="keyword">(</span><span class="string">"Failed to connect: </span><span class="default">$errorMessage</span><span class="string">"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$client</span><span class="keyword">, </span><span class="string">"GET / HTTP/1.0\r\nhost:&nbsp; &nbsp; 'www.example.com'\r\nAccept: */*\r\n\r\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; <br />
</span><span class="default">$variable </span><span class="keyword">= </span><span class="default">stream_get_content</span><span class="keyword">(</span><span class="default">$client</span><span class="keyword">);<br />
<br />
if(</span><span class="default">strstr</span><span class="keyword">(</span><span class="default">$variable</span><span class="keyword">,</span><span class="string">'data your looking for'</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; echo </span><span class="string">"The data you are looking for is here"</span><span class="keyword">;<br />
else<br />
&nbsp;&nbsp; &nbsp; &nbsp; echo </span><span class="string">"data not found"</span><span class="keyword">;<br />
<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$client</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105393""></a>
  <div class="note">
   <strong class="user">Vasil Rangelov a.k.a. boen_robot</strong>
   <a href="#105393" class="date">14-Aug-2011 01:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The remote_socket argument, in its end (well... after the port), can also contain a "/" followed by a unique identifier. This is especially useful if you want to create multiple persistent connections to the same transport://host:port combo.<br />
<br />
Example:<br />
<span class="default">&lt;?php<br />
$socket </span><span class="keyword">= </span><span class="default">stream_socket_client</span><span class="keyword">(</span><span class="string">'tcp://mysql.example.com:3306/root'</span><span class="keyword">, </span><span class="default">$errorno</span><span class="keyword">, </span><span class="default">$errorstr</span><span class="keyword">, </span><span class="default">$timeout</span><span class="keyword">, </span><span class="default">STREAM_CLIENT_CONNECT </span><span class="keyword">| </span><span class="default">STREAM_CLIENT_PERSISTENT</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Note that while (p)fsockopen() follows a similar scheme, it doesn't have this particular feature.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97036""></a>
  <div class="note">
   <strong class="user">bisho at onirica dot com</strong>
   <a href="#97036" class="date">29-Mar-2010 09:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
stream_socket_client is much easier and faster to use to direct sockets, because you can use directly fwrite / fget / fclose functions, but I find hard to find how to connect to a UNIX domain socket. The URL to use is "udg:///path/to/socket".<br />
<br />
For example, to log to the log socket (like syslog), you can use:<br />
<br />
<span class="default">&lt;?php<br />
$socket </span><span class="keyword">= </span><span class="default">stream_socket_client</span><span class="keyword">(</span><span class="string">'udg:///dev/log'</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$errorno</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$errorstr</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$timeout</span><span class="keyword">);<br />
</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, ...);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="86667""></a>
  <div class="note">
   <strong class="user">nicholas at nicholaswilliams dot net</strong>
   <a href="#86667" class="date">28-Oct-2008 05:08</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For those wanting to use stream_socket_client() to connect to a local UNIX socket who can't find documentation on how to do it, here's a (rough) example:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$sock </span><span class="keyword">= </span><span class="default">stream_socket_client</span><span class="keyword">(</span><span class="string">'unix:///full/path/to/my/socket.sock'</span><span class="keyword">, </span><span class="default">$errno</span><span class="keyword">, </span><span class="default">$errstr</span><span class="keyword">);<br />
<br />
</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="string">'SOME COMMAND'</span><span class="keyword">.</span><span class="string">"\r\n"</span><span class="keyword">);<br />
<br />
echo </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="default">4096</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">;<br />
<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85345""></a>
  <div class="note">
   <strong class="user">robin at gareus dot org</strong>
   <a href="#85345" class="date">26-Aug-2008 03:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I came here since fsockopen() does not support any SSL certificate checking in PHP5.<br />
<br />
while curl is nice, I use stream_socket_client() to make XML-RPC POST requests via HTTPS and since I have not found any PHP code around that does this, I'll attach an example that also includes HTTP-Digest Auth (eg. trac's WikiRPCInterface2):<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">#################################################<br />
# $host: hostname ; eg 'example.org' <br />
# $path: request' eg '/index.php?id=123'<br />
# $data_to_send : data to POST after the HTTP header.<br />
#<br />
# if $opts is an&nbsp; empty array() a standard&nbsp; HTTP to port 80 request is performed. <br />
# <br />
# set auth['type']='basic' to use plain-text auth, <br />
# digest-auth will be handled automatically if $auth['username'] is set and a 401<br />
# status is encountered. - use auth['type']='nodigest' to override.<br />
#<br />
##<br />
</span><span class="keyword">function </span><span class="default">httpPost</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$path</span><span class="keyword">, </span><span class="default">$data_to_send</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$opts</span><span class="keyword">=array(</span><span class="string">'cert'</span><span class="keyword">=&gt;</span><span class="string">""</span><span class="keyword">, </span><span class="string">'headers'</span><span class="keyword">=&gt;</span><span class="default">0</span><span class="keyword">, </span><span class="string">'transport' </span><span class="keyword">=&gt;</span><span class="string">'ssl'</span><span class="keyword">, </span><span class="string">'port'</span><span class="keyword">=&gt;</span><span class="default">443</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$auth</span><span class="keyword">=array(</span><span class="string">'username'</span><span class="keyword">=&gt;</span><span class="string">""</span><span class="keyword">, </span><span class="string">'password'</span><span class="keyword">=&gt;</span><span class="string">""</span><span class="keyword">, </span><span class="string">'type'</span><span class="keyword">=&gt;</span><span class="string">""</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ) {<br />
&nbsp; </span><span class="default">$transport</span><span class="keyword">=</span><span class="string">''</span><span class="keyword">; </span><span class="default">$port</span><span class="keyword">=</span><span class="default">80</span><span class="keyword">;<br />
&nbsp; if (!empty(</span><span class="default">$opts</span><span class="keyword">[</span><span class="string">'transport'</span><span class="keyword">])) </span><span class="default">$transport</span><span class="keyword">=</span><span class="default">$opts</span><span class="keyword">[</span><span class="string">'transport'</span><span class="keyword">];<br />
&nbsp; if (!empty(</span><span class="default">$opts</span><span class="keyword">[</span><span class="string">'port'</span><span class="keyword">])) </span><span class="default">$port</span><span class="keyword">=</span><span class="default">$opts</span><span class="keyword">[</span><span class="string">'port'</span><span class="keyword">];<br />
&nbsp; </span><span class="default">$remote</span><span class="keyword">=</span><span class="default">$transport</span><span class="keyword">.</span><span class="string">'://'</span><span class="keyword">.</span><span class="default">$host</span><span class="keyword">.</span><span class="string">':'</span><span class="keyword">.</span><span class="default">$port</span><span class="keyword">;<br />
<br />
&nbsp; </span><span class="default">$context </span><span class="keyword">= </span><span class="default">stream_context_create</span><span class="keyword">();<br />
&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">stream_context_set_option</span><span class="keyword">(</span><span class="default">$context</span><span class="keyword">, </span><span class="string">'ssl'</span><span class="keyword">, </span><span class="string">'verify_host'</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
&nbsp; if (!empty(</span><span class="default">$opts</span><span class="keyword">[</span><span class="string">'cert'</span><span class="keyword">])) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">stream_context_set_option</span><span class="keyword">(</span><span class="default">$context</span><span class="keyword">, </span><span class="string">'ssl'</span><span class="keyword">, </span><span class="string">'cafile'</span><span class="keyword">, </span><span class="default">$opts</span><span class="keyword">[</span><span class="string">'cert'</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">stream_context_set_option</span><span class="keyword">(</span><span class="default">$context</span><span class="keyword">, </span><span class="string">'ssl'</span><span class="keyword">, </span><span class="string">'verify_peer'</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
&nbsp; } else {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">stream_context_set_option</span><span class="keyword">(</span><span class="default">$context</span><span class="keyword">, </span><span class="string">'ssl'</span><span class="keyword">, </span><span class="string">'allow_self_signed'</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
&nbsp; }<br />
&nbsp; </span><span class="default">$fp </span><span class="keyword">= </span><span class="default">stream_socket_client</span><span class="keyword">(</span><span class="default">$remote</span><span class="keyword">, </span><span class="default">$err</span><span class="keyword">, </span><span class="default">$errstr</span><span class="keyword">, </span><span class="default">60</span><span class="keyword">, </span><span class="default">STREAM_CLIENT_CONNECT</span><span class="keyword">, </span><span class="default">$context</span><span class="keyword">);<br />
<br />
&nbsp; if (!</span><span class="default">$fp</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">'httpPost error: '</span><span class="keyword">.</span><span class="default">$errstr</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">NULL</span><span class="keyword">;<br />
&nbsp; }<br />
<br />
&nbsp; </span><span class="default">$req</span><span class="keyword">=</span><span class="string">''</span><span class="keyword">;<br />
&nbsp; </span><span class="default">$req</span><span class="keyword">.=</span><span class="string">"POST </span><span class="default">$path</span><span class="string"> HTTP/1.1\r\n"</span><span class="keyword">;<br />
&nbsp; </span><span class="default">$req</span><span class="keyword">.=</span><span class="string">"Host: </span><span class="default">$host</span><span class="string">\r\n"</span><span class="keyword">;<br />
&nbsp; if (</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'type'</span><span class="keyword">]==</span><span class="string">'basic' </span><span class="keyword">&amp;&amp; !empty(</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'username'</span><span class="keyword">])) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$req</span><span class="keyword">.=</span><span class="string">"Authorization: Basic "</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$req</span><span class="keyword">.=</span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'username'</span><span class="keyword">].</span><span class="string">':'</span><span class="keyword">.</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'password'</span><span class="keyword">]).</span><span class="string">"\r\n"</span><span class="keyword">;<br />
&nbsp; }<br />
&nbsp; elseif (</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'type'</span><span class="keyword">]==</span><span class="string">'digest' </span><span class="keyword">&amp;&amp; !empty(</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'username'</span><span class="keyword">])) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$req</span><span class="keyword">.=</span><span class="string">'Authorization: Digest '</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">$auth </span><span class="keyword">as </span><span class="default">$k </span><span class="keyword">=&gt; </span><span class="default">$v</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; if (empty(</span><span class="default">$k</span><span class="keyword">) || empty(</span><span class="default">$v</span><span class="keyword">)) continue;<br />
&nbsp;&nbsp; &nbsp;&nbsp; if (</span><span class="default">$k</span><span class="keyword">==</span><span class="string">'password'</span><span class="keyword">) continue;<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$req</span><span class="keyword">.=</span><span class="default">$k</span><span class="keyword">.</span><span class="string">'="'</span><span class="keyword">.</span><span class="default">$v</span><span class="keyword">.</span><span class="string">'", '</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$req</span><span class="keyword">.=</span><span class="string">"\r\n"</span><span class="keyword">;<br />
&nbsp; }<br />
&nbsp; </span><span class="default">$req</span><span class="keyword">.=</span><span class="string">"Content-type: text/xml\r\n"</span><span class="keyword">;<br />
&nbsp; </span><span class="default">$req</span><span class="keyword">.=</span><span class="string">'Content-length: '</span><span class="keyword">. </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data_to_send</span><span class="keyword">) .</span><span class="string">"\r\n"</span><span class="keyword">;<br />
&nbsp; </span><span class="default">$req</span><span class="keyword">.=</span><span class="string">"Connection: close\r\n\r\n"</span><span class="keyword">;<br />
<br />
&nbsp; </span><span class="default">fputs</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$req</span><span class="keyword">);<br />
&nbsp; </span><span class="default">fputs</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$data_to_send</span><span class="keyword">);<br />
<br />
&nbsp; while(!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">)) { </span><span class="default">$res </span><span class="keyword">.= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">128</span><span class="keyword">); }<br />
&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
<br />
&nbsp; if (</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'type'</span><span class="keyword">]!=</span><span class="string">'nodigest'<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">&amp;&amp; !empty(</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'username'</span><span class="keyword">])<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &amp;&amp; </span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'type'</span><span class="keyword">]!=</span><span class="string">'digest' </span><span class="comment"># prev. digest AUTH failed.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">&amp;&amp; </span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">"/^HTTP\/[0-9\.]* 401 /"</span><span class="keyword">, </span><span class="default">$res</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">1 </span><span class="keyword">== </span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">"/WWW-Authenticate: Digest ([^\n\r]*)\r\n/Us"</span><span class="keyword">, </span><span class="default">$res</span><span class="keyword">, </span><span class="default">$matches</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; foreach (</span><span class="default">split</span><span class="keyword">(</span><span class="string">","</span><span class="keyword">, </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]) as </span><span class="default">$i</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ii</span><span class="keyword">=</span><span class="default">split</span><span class="keyword">(</span><span class="string">"="</span><span class="keyword">,</span><span class="default">trim</span><span class="keyword">(</span><span class="default">$i</span><span class="keyword">),</span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!empty(</span><span class="default">$ii</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]) &amp;&amp; !empty(</span><span class="default">$ii</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$auth</span><span class="keyword">[</span><span class="default">$ii</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]]=</span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/^\"/"</span><span class="keyword">,</span><span class="string">''</span><span class="keyword">, </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/\"$/"</span><span class="keyword">,</span><span class="string">''</span><span class="keyword">, </span><span class="default">$ii</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'type'</span><span class="keyword">]=</span><span class="string">'digest'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'uri'</span><span class="keyword">]=</span><span class="string">'https://'</span><span class="keyword">.</span><span class="default">$host</span><span class="keyword">.</span><span class="default">$path</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'cnonce'</span><span class="keyword">]=</span><span class="default">randomNonce</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'nc'</span><span class="keyword">]=</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$a1</span><span class="keyword">=</span><span class="default">md5</span><span class="keyword">(</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'username'</span><span class="keyword">].</span><span class="string">':'</span><span class="keyword">.</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'realm'</span><span class="keyword">].</span><span class="string">':'</span><span class="keyword">.</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'password'</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$a2</span><span class="keyword">=</span><span class="default">md5</span><span class="keyword">(</span><span class="string">'POST'</span><span class="keyword">.</span><span class="string">':'</span><span class="keyword">.</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'uri'</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'response'</span><span class="keyword">]=</span><span class="default">md5</span><span class="keyword">(</span><span class="default">$a1</span><span class="keyword">.</span><span class="string">':'<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">.</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'nonce'</span><span class="keyword">].</span><span class="string">':'</span><span class="keyword">.</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'nc'</span><span class="keyword">].</span><span class="string">':'<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">.</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'cnonce'</span><span class="keyword">].</span><span class="string">':'</span><span class="keyword">.</span><span class="default">$auth</span><span class="keyword">[</span><span class="string">'qop'</span><span class="keyword">].</span><span class="string">':'</span><span class="keyword">.</span><span class="default">$a2</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; return </span><span class="default">httpPost</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$path</span><span class="keyword">, </span><span class="default">$data_to_send</span><span class="keyword">, </span><span class="default">$opts</span><span class="keyword">, </span><span class="default">$auth</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; }<br />
<br />
&nbsp; if (</span><span class="default">1 </span><span class="keyword">!= </span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">"/^HTTP\/[0-9\.]* ([0-9]{3}) ([^\r\n]*)/"</span><span class="keyword">, </span><span class="default">$res</span><span class="keyword">, </span><span class="default">$matches</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">'httpPost: invalid HTTP reply.'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">NULL</span><span class="keyword">;<br />
&nbsp; }<br />
<br />
&nbsp; if (</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] != </span><span class="string">'200'</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">'httpPost: HTTP error: '</span><span class="keyword">.</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">].</span><span class="string">' '</span><span class="keyword">.</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">NULL</span><span class="keyword">;<br />
&nbsp; }<br />
<br />
&nbsp; if (!</span><span class="default">$opts</span><span class="keyword">[</span><span class="string">'headers'</span><span class="keyword">]) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$res</span><span class="keyword">=</span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/^.*\r\n\r\n/Us"</span><span class="keyword">,</span><span class="string">''</span><span class="keyword">,</span><span class="default">$res</span><span class="keyword">);<br />
&nbsp; }<br />
&nbsp; return </span><span class="default">$res</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="77497""></a>
  <div class="note">
   <strong class="user">wbeaver at afilias dot info</strong>
   <a href="#77497" class="date">31-Aug-2007 02:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
# Some may find it useful to know that your caCert <br />
# must be in pem format, and that PHP seems to like <br />
# your key, cert, and cacert pem's to be concatenated<br />
# in a single file (I suffered various "unknown chain" <br />
# errors, otherwise)<br />
#<br />
# So, (linux users), concat your components as follows:<br />
# (where current working dir is dir where <br />
# cert components are stored)<br />
#<br />
# cat key.pem &gt;certchain.pem<br />
# cat cert.pem &gt;&gt;certchain.pem<br />
# cat cacert.pem &gt;&gt;certchain.pem<br />
#<br />
# Then, the php....<br />
##################################<br />
<br />
<span class="default">&lt;?php<br />
<br />
$host </span><span class="keyword">= </span><span class="string">'host.domain.tld'</span><span class="keyword">;<br />
</span><span class="default">$port </span><span class="keyword">= </span><span class="default">1234</span><span class="keyword">;<br />
</span><span class="default">$timeout </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">;<br />
<br />
</span><span class="default">$cert </span><span class="keyword">= </span><span class="string">'/path/to/your/certchain/certchain.pem'</span><span class="keyword">;<br />
</span><span class="default">$context </span><span class="keyword">= </span><span class="default">stream_context_create</span><span class="keyword">(array(</span><span class="string">'ssl'</span><span class="keyword">=&gt;array(</span><span class="string">'local_cert'</span><span class="keyword">=&gt; </span><span class="default">$cert</span><span class="keyword">,<br />
)));<br />
<br />
if (</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">stream_socket_client</span><span class="keyword">(</span><span class="string">'ssl://'</span><span class="keyword">.</span><span class="default">$host</span><span class="keyword">.</span><span class="string">':'</span><span class="keyword">.</span><span class="default">$port</span><span class="keyword">, </span><span class="default">$errno</span><span class="keyword">, </span><span class="default">$errstr</span><span class="keyword">, </span><span class="default">30</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">STREAM_CLIENT_CONNECT</span><span class="keyword">, </span><span class="default">$context</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"\n"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">8192</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
} else {<br />
&nbsp;&nbsp; echo </span><span class="string">"ERROR: </span><span class="default">$errno</span><span class="string"> - </span><span class="default">$errstr</span><span class="string">&lt;br /&gt;\n"</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
