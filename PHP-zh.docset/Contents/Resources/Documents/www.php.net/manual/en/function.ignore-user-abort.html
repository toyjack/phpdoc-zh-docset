<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>设置客户端断开连接时是否中断脚本的执行</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.hrtime.html">? hrtime</a></li>
      <li style="float: right;"><a href="function.pack.html">pack ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.misc.html">杂项 函数</a></li>
    <li>设置客户端断开连接时是否中断脚本的执行</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.ignore-user-abort" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">ignore_user_abort</h1>
  <p class="verinfo">(PHP 4, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">ignore_user_abort</span> &mdash; <span class="dc-title">设置客户端断开连接时是否中断脚本的执行</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.ignore-user-abort-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>ignore_user_abort</strong></span>(<span class="methodparam"><span class="type">bool</span> <code class="parameter">$value</code><span class="initializer"> = ?</span></span>): <span class="type">int</span></div>

  <p class="para rdfs-comment">
    设置客户端断开连接时是否中断脚本的执行
  </p>
  <p class="para">
   PHP 以命令行脚本执行时，当脚本终端结束，脚本不会被立即中止，除非设置 <code class="parameter">value</code> 为 <strong><code>true</code></strong>，否则脚本输出任意字符时会被中止。</p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.ignore-user-abort-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">value</code></dt>

     <dd>

      <p class="para">
       如果设置了该值，函数会把 <a href="misc.configuration.html#ini.ignore-user-abort" class="link">ignore_user_abort</a> ini 的值设置为 <code class="parameter">value</code>。
       如果未设置该值，函数不会改变设置，仅会返回之前的设置。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.ignore-user-abort-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   以整型返回之前的设置
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.ignore-user-abort-examples">
  <h3 class="title">范例</h3>
  <p class="para">
   <div class="example" id="example-3407">
    <p><strong>Example #1 <span class="function"><strong>ignore_user_abort()</strong></span>例子</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">//&nbsp;Ignore&nbsp;user&nbsp;aborts&nbsp;and&nbsp;allow&nbsp;the&nbsp;script<br />//&nbsp;to&nbsp;run&nbsp;forever<br /></span><span style="color: #0000BB">ignore_user_abort</span><span style="color: #007700">(</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">set_time_limit</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">);<br /><br />echo&nbsp;</span><span style="color: #DD0000">'Testing&nbsp;connection&nbsp;handling&nbsp;in&nbsp;PHP'</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;Run&nbsp;a&nbsp;pointless&nbsp;loop&nbsp;that&nbsp;sometime&nbsp;<br />//&nbsp;hopefully&nbsp;will&nbsp;make&nbsp;us&nbsp;click&nbsp;away&nbsp;from&nbsp;<br />//&nbsp;page&nbsp;or&nbsp;click&nbsp;the&nbsp;"Stop"&nbsp;button.<br /></span><span style="color: #007700">while(</span><span style="color: #0000BB">1</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Did&nbsp;the&nbsp;connection&nbsp;fail?<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if(</span><span style="color: #0000BB">connection_status</span><span style="color: #007700">()&nbsp;!=&nbsp;</span><span style="color: #0000BB">CONNECTION_NORMAL</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Sleep&nbsp;for&nbsp;10&nbsp;seconds<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">sleep</span><span style="color: #007700">(</span><span style="color: #0000BB">10</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">//&nbsp;If&nbsp;this&nbsp;is&nbsp;reached,&nbsp;then&nbsp;the&nbsp;'break'&nbsp;<br />//&nbsp;was&nbsp;triggered&nbsp;from&nbsp;inside&nbsp;the&nbsp;while&nbsp;loop<br /><br />//&nbsp;So&nbsp;here&nbsp;we&nbsp;can&nbsp;log,&nbsp;or&nbsp;perform&nbsp;any&nbsp;other&nbsp;tasks<br />//&nbsp;we&nbsp;need&nbsp;without&nbsp;actually&nbsp;being&nbsp;dependent&nbsp;on&nbsp;the&nbsp;<br />//&nbsp;browser.<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.ignore-user-abort-notes">
  <h3 class="title">注释</h3>
  <p class="para">
   在PHP尝试发送信息到客户端之前，不会检测到用户是否已中断连接。
   仅使用 echo 语句不能确保信息已发送，参见 <span class="function"><a href="function.flush.html" class="function">flush()</a></span> 函数。 
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.ignore-user-abort-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.connection-aborted.html" class="function" rel="rdfs-seeAlso">connection_aborted()</a> - 检查客户端是否已经断开</span></li>
    <li class="member"><span class="function"><a href="function.connection-status.html" class="function" rel="rdfs-seeAlso">connection_status()</a> - 返回连接的状态位</span></li>
    <li class="member">
     <a href="features.connection-handling.html" class="link">Connection Handling</a>
     关于PHP连接处理的完整描述。
    </li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="116487""></a>
  <div class="note">
   <strong class="user">Charlie Brown</strong>
   <a href="#116487" class="date">11-Jan-2015 09:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If running a long process and the browser often close the connection, then use this function.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116318""></a>
  <div class="note">
   <strong class="user">Micke</strong>
   <a href="#116318" class="date">11-Dec-2014 04:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It seems that this function does not work for IIS servers.<br />
<br />
A detailed description can be found on the PHP Bug Tracking System:<br />
https://bugs.php.net/bug.php?id=60586#1378935714</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93510""></a>
  <div class="note">
   <strong class="user">lukas dot starecek at centrum dot cz</strong>
   <a href="#93510" class="date">14-Sep-2009 12:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Comment from Anonymous is not 100% valid. Time from sleep function is not counted to execution time because sleep delays program execution (see <a href="http://www.php.net/manual/en/function.sleep.php and comments" rel="nofollow" target="_blank">http://www.php.net/manual/en/function.sleep.php and comments</a>). We tested it and it's true. Try this:<br />
<br />
<span class="default">&lt;?php<br />
<br />
set_time_limit</span><span class="keyword">(</span><span class="default">2</span><span class="keyword">);<br />
</span><span class="default">sleep</span><span class="keyword">(</span><span class="default">4</span><span class="keyword">);<br />
echo </span><span class="string">'hi!'</span><span class="keyword">;<br />
</span><span class="default">sleep</span><span class="keyword">(</span><span class="default">4</span><span class="keyword">);<br />
echo </span><span class="string">'bye bye!'</span><span class="keyword">;<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
It means, that if the loop most of the time will be at sleep (and in this case it probably be), then this script may be active for months or years even if you set time limit to one day.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="91972""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#91972" class="date">03-Jul-2009 01:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
use the spiritual-coder's code below with exreme caution and do not use it unless you are an advanced user.<br />
<br />
first of all, such a code with no bypass point can cause infinite loops and ghost threads in server. there must be a trick to break out the loop. <br />
<br />
i.e. you can use&nbsp; if (file_exists(dirname(__FILE__)."stop.txt")) break; in the loop so if you create "stop.txt", she script will stop execution.<br />
<br />
also if you use set_time_limit(86400); instead of set_time_limit(0); your script will stop after one day.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="91358""></a>
  <div class="note">
   <strong class="user">phpguy92135 at yahoo dot com</strong>
   <a href="#91358" class="date">08-Jun-2009 04:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Theres no point in sending anything to the browser if the user does abort.&nbsp; Since the user aborted, the browser wont listen even if PHP did send information to the browser.<br />
<br />
If you want to see if the user did abort, then use error_log() or some other form of logging to find out what happened, but dont rely on the output to the browser as the only method of checking ones data.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68114""></a>
  <div class="note">
   <strong class="user">spiritual-coder at spiritual-coder dot com</strong>
   <a href="#68114" class="date">13-Jul-2006 09:45</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want to simulate a crontask you must call this script once and it will keep running forever (during server uptime) in the background while "doing something" every specified seconds (= $interval):
<br />

<br />
<span class="default">&lt;?php
<br />
ignore_user_abort</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">); </span><span class="comment">// run script in background
<br />
</span><span class="default">set_time_limit</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">); </span><span class="comment">// run script forever
<br />
</span><span class="default">$interval</span><span class="keyword">=</span><span class="default">60</span><span class="keyword">*</span><span class="default">15</span><span class="keyword">; </span><span class="comment">// do every 15 minutes...
<br />
</span><span class="keyword">do{
<br />
&nbsp;&nbsp; </span><span class="comment">// add the script that has to be ran every 15 minutes here
<br />
&nbsp;&nbsp; // ...
<br />
&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">$interval</span><span class="keyword">); </span><span class="comment">// wait 15 minutes
<br />
</span><span class="keyword">}while(</span><span class="default">true</span><span class="keyword">);
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="12204""></a>
  <div class="note">
   <strong class="user">plamen at pulsator dot com</strong>
   <a href="#12204" class="date">29-Mar-2001 09:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The script should output something to the browser in order to abort. If there is no output the script keeps on running.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
