<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>将特殊字符转换为 HTML 实体</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.htmlspecialchars-decode.html">? htmlspecialchars_decode</a></li>
      <li style="float: right;"><a href="function.implode.html">implode ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.strings.html">字符串 函数</a></li>
    <li>将特殊字符转换为 HTML 实体</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.htmlspecialchars" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">htmlspecialchars</h1>
  <p class="verinfo">(PHP 4, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">htmlspecialchars</span> &mdash; <span class="dc-title">将特殊字符转换为 HTML 实体</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-function.htmlspecialchars-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>htmlspecialchars</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$string</code></span>
   , <span class="methodparam"><span class="type">int</span> <code class="parameter">$flags</code><span class="initializer"> = ENT_COMPAT | ENT_HTML401</span></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$encoding</code><span class="initializer"> = ini_get(&quot;default_charset&quot;)</span></span>
   , <span class="methodparam"><span class="type">bool</span> <code class="parameter">$double_encode</code><span class="initializer"> = <strong><code>true</code></strong></span></span>
   ) : <span class="type">string</span></div>

  <p class="para rdfs-comment">
   某类字符在 HTML 中有特殊用处，如需保持原意，需要用 HTML 实体来表达。
   本函数会返回字符转义后的表达。
   如需转换子字符串中所有关联的名称实体，使用 <span class="function"><a href="function.htmlentities.html" class="function">htmlentities()</a></span> 代替本函数。
  </p>
  <p class="para">
   如果传入字符的字符编码和最终的文档是一致的，则用函数处理的输入适合绝大多数 HTML 文档环境。
   然而，如果输入的字符编码和最终包含字符的文档是不一样的，
   想要保留字符（以数字或名称实体的形式），本函数以及 <span class="function"><a href="function.htmlentities.html" class="function">htmlentities()</a></span> 
   （仅编码名称实体对应的子字符串）可能不够用。
   这种情况可以使用 <span class="function"><a href="function.mb-encode-numericentity.html" class="function">mb_encode_numericentity()</a></span> 代替。
  </p>
  <p class="para">
   <table class="doctable table">
    <caption><strong>执行转换</strong></caption>
    
     <thead>
      <tr>
       <th>字符</th>
       <th>替换后</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td><code class="literal">&amp;</code> (&amp; 符号)</td>
       <td><code class="literal">&amp;amp;</code></td>
      </tr>

      <tr>
       <td><code class="literal">&quot;</code> (双引号)</td>
       <td><code class="literal">&amp;quot;</code>，除非设置了 <strong><code>ENT_NOQUOTES</code></strong></td>
      </tr>

      <tr>
       <td><code class="literal">&#039;</code> (单引号)</td>
       <td>
         设置了 <strong><code>ENT_QUOTES</code></strong> 后，
        <code class="literal">&amp;#039;</code>
        (如果是 <strong><code>ENT_HTML401</code></strong>) ，或者 <code class="literal">&amp;apos;</code> (如果是
        <strong><code>ENT_XML1</code></strong>、 <strong><code>ENT_XHTML</code></strong> 或
        <strong><code>ENT_HTML5</code></strong>)。
       </td>
      </tr>

      <tr>
       <td><code class="literal">&lt;</code> (小于)</td>
       <td><code class="literal">&amp;lt;</code></td>
      </tr>

      <tr>
       <td><code class="literal">&gt;</code> (大于)</td>
       <td><code class="literal">&amp;gt;</code></td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.htmlspecialchars-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">string</code></dt>

     <dd>

      <p class="para">
       待转换的 <span class="type">string</span>。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">flags</code></dt>

     <dd>

      <p class="para">
       位掩码，由以下某个或多个标记组成，设置转义处理细节、无效单元序列、文档类型。
       默认是
       <code class="literal">ENT_COMPAT | ENT_HTML401</code>。
       <table class="doctable table">
        <caption><strong>有效的 <code class="parameter">flags</code> 常量</strong></caption>
        
         <thead>
          <tr>
           <th>常量名称</th>
           <th>描述</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td><strong><code>ENT_COMPAT</code></strong></td>
           <td>会转换双引号，不转换单引号。</td>
          </tr>

          <tr>
           <td><strong><code>ENT_QUOTES</code></strong></td>
           <td>既转换双引号也转换单引号。</td>
          </tr>

          <tr>
           <td><strong><code>ENT_NOQUOTES</code></strong></td>
           <td>单/双引号都不转换</td>
          </tr>

          <tr>
           <td><strong><code>ENT_IGNORE</code></strong></td>
           <td>
            静默丢弃无效的代码单元序列，而不是返回空字符串。
            不建议使用此标记，
            因为它<a href="http://unicode.org/reports/tr36/#Deletion_of_Noncharacters" class="link external" title="Link : http://unicode.org/reports/tr36/#Deletion_of_Noncharacters">&raquo;&nbsp;可能有安全影响</a>。
           </td>
          </tr>

          <tr>
           <td><strong><code>ENT_SUBSTITUTE</code></strong></td>
           <td>
            替换无效的代码单元序列为 Unicode 代替符（Replacement Character），
            U+FFFD (UTF-8) 或者 &amp;#xFFFD; (其他)，而不是返回空字符串。
           </td>
          </tr>

          <tr>
           <td><strong><code>ENT_DISALLOWED</code></strong></td>
           <td>
            为文档的无效代码点替换为  Unicode 代替符（Replacement Character）：
            U+FFFD (UTF-8)，或 &amp;#xFFFD;（其他），而不是把它们留在原处。
            比如以下情况下就很有用：要保证 XML 文档嵌入额外内容时格式合法。
           </td>
          </tr>

          <tr>
           <td><strong><code>ENT_HTML401</code></strong></td>
           <td>
            以 HTML 4.01 处理代码。
           </td>
          </tr>

          <tr>
           <td><strong><code>ENT_XML1</code></strong></td>
           <td>
            以 XML 1 处理代码。
           </td>
          </tr>

          <tr>
           <td><strong><code>ENT_XHTML</code></strong></td>
           <td>
            以 XHTML 处理代码。
           </td>
          </tr>

          <tr>
           <td><strong><code>ENT_HTML5</code></strong></td>
           <td>
            以 HTML 5 处理代码。
           </td>
          </tr>

         </tbody>
        
       </table>

      </p>
     </dd>

    
    
     <dt>
<code class="parameter">encoding</code></dt>

     <dd>

      
 <p class="para">
  An optional argument defining the encoding used when converting characters.
 </p>

 <p class="para">
  If omitted, <code class="parameter">encoding</code> defaults to the value of the
  <a href="ini.core.html#ini.default-charset" class="link">default_charset</a> configuration
  option.
 </p>

 <p class="para">
  Although this argument is technically optional, you are highly encouraged to
  specify the correct value for your code
  if the <a href="ini.core.html#ini.default-charset" class="link">default_charset</a>
  configuration option may be set incorrectly for the given input.
 </p>

      <p class="para">
       本函数使用效果上，如果 <code class="parameter">string</code> 对以下字符编码是有效的，
       <code class="literal">ISO-8859-1</code>、 <code class="literal">ISO-8859-15</code>、
       <code class="literal">UTF-8</code>、 <code class="literal">cp866</code>、
       <code class="literal">cp1251</code>、 <code class="literal">cp1252</code>、
       <code class="literal">KOI8-R</code> 将具有相同的效果。
       也就是说，在这些编码里，
       受 <span class="function"><strong>htmlspecialchars()</strong></span> 影响的字符会占据相同的位置。
      </p>
      


<p class="para">
 支持以下字符集：
 <table class="doctable table">
  <caption><strong>支持的字符集列表</strong></caption>
  
   <thead>
    <tr>
     <th>字符集</th>
     <th>别名</th>
     <th>描述</th>
    </tr>

   </thead>

   <tbody class="tbody">
    <tr>
     <td>ISO-8859-1</td>
     <td>ISO8859-1</td>
     <td>
      西欧，Latin-1
     </td>
    </tr>

    <tr>
     <td>ISO-8859-5</td>
     <td>ISO8859-5</td>
     <td>
      Little used cyrillic charset (Latin/Cyrillic).
     </td>
    </tr>

    <tr>
     <td>ISO-8859-15</td>
     <td>ISO8859-15</td>
     <td>
      西欧，Latin-9。增加欧元符号，法语和芬兰语字母在 Latin-1(ISO-8859-1) 中缺失。
     </td>
    </tr>

    <tr>
     <td>UTF-8</td>
     <td class="empty">&nbsp;</td>
     <td>
      ASCII 兼容的多字节 8 位 Unicode。
     </td>
    </tr>

    <tr>
     <td>cp866</td>
     <td>ibm866, 866</td>
     <td>
      DOS 特有的西里尔编码。本字符集在 4.3.2 版本中得到支持。
     </td>
    </tr>

    <tr>
     <td>cp1251</td>
     <td>Windows-1251, win-1251, 1251</td>
     <td>
      Windows 特有的西里尔编码。本字符集在 4.3.2 版本中得到支持。
     </td>
    </tr>

    <tr>
     <td>cp1252</td>
     <td>Windows-1252, 1252</td>
     <td>
      Windows 特有的西欧编码。
     </td>
    </tr>

    <tr>
     <td>KOI8-R</td>
     <td>koi8-ru, koi8r</td>
     <td>
      俄语。本字符集在 4.3.2 版本中得到支持。
     </td>
    </tr>

    <tr>
     <td>BIG5</td>
     <td>950</td>
     <td>
      繁体中文，主要用于中国台湾省。
     </td>
    </tr>

    <tr>
     <td>GB2312</td>
     <td>936</td>
     <td>
      简体中文，中国国家标准字符集。
     </td>
    </tr>

    <tr>
     <td>BIG5-HKSCS</td>
     <td class="empty">&nbsp;</td>
     <td>
      繁体中文，附带香港扩展的 Big5 字符集。
     </td>
    </tr>

    <tr>
     <td>Shift_JIS</td>
     <td>SJIS, 932</td>
     <td>
      日语
     </td>
    </tr>

    <tr>
     <td>EUC-JP</td>
     <td>EUCJP</td>
     <td>
      日语
     </td>
    </tr>

    <tr>
     <td>MacRoman</td>
     <td class="empty">&nbsp;</td>
     <td>
      Mac OS 使用的字符串。
     </td>
    </tr>

    <tr>
     <td><code class="literal">&#039;&#039;</code></td>
     <td class="empty">&nbsp;</td>
     <td>
      An empty string activates detection from script encoding (Zend multibyte),
      <a href="ini.core.html#ini.default-charset" class="link">default_charset</a> and current
      locale (see <span class="function"><a href="function.nl-langinfo.html" class="function">nl_langinfo()</a></span> and
      <span class="function"><a href="function.setlocale.html" class="function">setlocale()</a></span>), in this order. Not recommended.
     </td>
    </tr>

   </tbody>
  
 </table>

 <blockquote class="note"><p><strong class="note">Note</strong>: 
  <span class="simpara">
   其他字符集没有认可。将会使用默认编码并抛出异常。
  </span>
 </p></blockquote>
</p>


     </dd>

    
    
     <dt>
<code class="parameter">double_encode</code></dt>

     <dd>

      <p class="para">
       关闭 <code class="parameter">double_encode</code> 时，PHP 不会转换现有的 HTML 实体，
       默认是全部转换。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.htmlspecialchars-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   转换后的 <span class="type">string</span>。
  </p>
  <p class="para">
   如果指定的编码 <code class="parameter">encoding</code> 里，
   <code class="parameter">string</code> 包含了无效的代码单元序列，
   没有设置 <strong><code>ENT_IGNORE</code></strong> 或者
   <strong><code>ENT_SUBSTITUTE</code></strong> 标记的情况下，会返回空字符串。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.htmlspecialchars-changelog">
  <h3 class="title">更新日志</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>版本</th>
       <th>说明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      
 <tr>
  <td>5.6.0</td>
  <td>
   The default value for the <code class="parameter">encoding</code> parameter was
   changed to be the value of the
   <a href="ini.core.html#ini.default-charset" class="link">default_charset</a> configuration
   option.
  </td>
 </tr>


      <tr>
       <td>5.4.0</td>
       <td>
        <code class="parameter">encoding</code> 参数的默认值改成 UTF-8。
       </td>
      </tr>

      <tr>
       <td>5.4.0</td>
       <td>
        增加常量 <strong><code>ENT_SUBSTITUTE</code></strong>、 <strong><code>ENT_DISALLOWED</code></strong>、
        <strong><code>ENT_HTML401</code></strong>、 <strong><code>ENT_XML1</code></strong>、
        <strong><code>ENT_XHTML</code></strong>、 <strong><code>ENT_HTML5</code></strong>。
       </td>
      </tr>

      <tr>
       <td>5.3.0</td>
       <td>
        增加常量 <strong><code>ENT_IGNORE</code></strong>。
       </td>
      </tr>

      <tr>
       <td>5.2.3</td>
       <td>
        增加参数 <code class="parameter">double_encode</code>。
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.htmlspecialchars-examples">
  <h3 class="title">范例</h3>
  <p class="para">
   <div class="example" id="example-5138">
    <p><strong>Example #1 <span class="function"><strong>htmlspecialchars()</strong></span> 例子</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$new&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">htmlspecialchars</span><span style="color: #007700">(</span><span style="color: #DD0000">"&lt;a&nbsp;href='test'&gt;Test&lt;/a&gt;"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">ENT_QUOTES</span><span style="color: #007700">);<br />echo&nbsp;</span><span style="color: #0000BB">$new</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//&nbsp;&amp;lt;a&nbsp;href=&amp;#039;test&amp;#039;&amp;gt;Test&amp;lt;/a&amp;gt;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.htmlspecialchars-notes">
  <h3 class="title">注释</h3>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    注意，本函数不会转换以上列表以外的实体。
    完整转换请参见 <span class="function"><a href="function.htmlentities.html" class="function">htmlentities()</a></span>。
   </p>
  </p></blockquote>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    如果 <code class="parameter">flags</code> 的设置模糊易混淆，将遵循以下规则：
   </p>
   <p class="para">
    <ul class="itemizedlist">
     <li class="listitem">
      <span class="simpara">
       当 <strong><code>ENT_COMPAT</code></strong>、<strong><code>ENT_QUOTES</code></strong>、<strong><code>ENT_NOQUOTES</code></strong> 都没设置，
       默认就是 <strong><code>ENT_NOQUOTES</code></strong>。
      </span>
     </li>
     <li class="listitem">
      <span class="simpara">
       如果设置不止一个 <strong><code>ENT_COMPAT</code></strong>、 <strong><code>ENT_QUOTES</code></strong>、
       <strong><code>ENT_NOQUOTES</code></strong> ，优先级最高的是 <strong><code>ENT_QUOTES</code></strong>，
       其次是 <strong><code>ENT_COMPAT</code></strong>。
      </span>
     </li>
     <li class="listitem">
      <span class="simpara">
       当 <strong><code>ENT_HTML401</code></strong>、 <strong><code>ENT_HTML5</code></strong>、
       <strong><code>ENT_XHTML</code></strong>、 <strong><code>ENT_XML1</code></strong> 都没设置，默认是
       <strong><code>ENT_HTML401</code></strong>。
      </span>
     </li>
     <li class="listitem">
      <span class="simpara">
       如果设置不止一个 <strong><code>ENT_HTML401</code></strong>、 <strong><code>ENT_HTML5</code></strong>、
       <strong><code>ENT_XHTML</code></strong>、 <strong><code>ENT_XML1</code></strong>，
       优先级最高的是
       <strong><code>ENT_HTML5</code></strong> 其次是 <strong><code>ENT_XHTML</code></strong>、<strong><code>ENT_XML1</code></strong> 和 <strong><code>ENT_HTML401</code></strong>。
      </span>
     </li>
     <li class="listitem">
      <span class="simpara">
       如果设置不止一个 <strong><code>ENT_DISALLOWED</code></strong>、 <strong><code>ENT_IGNORE</code></strong>、
       <strong><code>ENT_SUBSTITUTE</code></strong>，优先级最高的是 <strong><code>ENT_IGNORE</code></strong>，
       其次是 <strong><code>ENT_SUBSTITUTE</code></strong>。
      </span>
     </li>
    </ul>
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.htmlspecialchars-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.get-html-translation-table.html" class="function" rel="rdfs-seeAlso">get_html_translation_table()</a> - 返回使用 htmlspecialchars 和 htmlentities 后的转换表</span></li>
    <li class="member"><span class="function"><a href="function.htmlspecialchars-decode.html" class="function" rel="rdfs-seeAlso">htmlspecialchars_decode()</a> - 将特殊的 HTML 实体转换回普通字符</span></li>
    <li class="member"><span class="function"><a href="function.strip-tags.html" class="function" rel="rdfs-seeAlso">strip_tags()</a> - 从字符串中去除 HTML 和 PHP 标记</span></li>
    <li class="member"><span class="function"><a href="function.htmlentities.html" class="function" rel="rdfs-seeAlso">htmlentities()</a> - 将字符转换为 HTML 转义字符</span></li>
    <li class="member"><span class="function"><a href="function.nl2br.html" class="function" rel="rdfs-seeAlso">nl2br()</a> - 在字符串所有新行之前插入 HTML 换行标记</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="124059""></a>
  <div class="note">
   <strong class="user">qshing1437 at hotmail dot com</strong>
   <a href="#124059" class="date">22-Jul-2019 05:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you use htmlspecialchars() to escape any HTML attribute, make sure use double quote instead of single quote for the attribute.<br />
<br />
For Example, <br />
<br />
&gt; Wrap with Single Quote<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">echo </span><span class="string">"&lt;p title='"&nbsp; </span><span class="keyword">. </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="string">"Hello\"s\'world"</span><span class="keyword">) . </span><span class="string">"'"</span><span class="keyword">&gt; <br />
<br />
</span><span class="comment">// title will end up Hello"s\ and rest of the text after single quote will be cut off. <br />
</span><span class="default">?&gt;<br />
</span><br />
&gt; Wrap with Double quote :<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">echo </span><span class="string">'&lt;p title="'&nbsp; </span><span class="keyword">. </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="string">"Hello\"s\'world"</span><span class="keyword">) . </span><span class="string">'"'</span><span class="keyword">&gt; <br />
<br />
</span><span class="comment">// title will show up correctly as Hello"s'world<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117290""></a>
  <div class="note">
   <strong class="user">PoV</strong>
   <a href="#117290" class="date">17-May-2015 11:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be aware of the encoding of your source files!!! <br />
<br />
Some of the suggestions here make reference to workarounds where you hard-code an encoding.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="keyword">echo </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="string">'&lt;b&gt;W?rmann&lt;/b&gt;'</span><span class="keyword">);&nbsp; </span><span class="comment">// Why isn't this working?<br />
</span><span class="default">?&gt;<br />
</span><br />
As it turns out, it may actually be your text editor that is to blame.<br />
<br />
As of PHP 5.4, htmlspecialchars now defaults to the UTF-8 encoding. That said, many text editors default to non-UTF encodings like ISO-8859-1 (i.e. Latin-1) or WIN-1252. If you change the encoding of the file to UTF-8, the code above will now work (i.e. the ? is encoded differently in UTF-8 and ISO-8859-1, and you need the UTF-8 version).<br />
<br />
Make sure you are editing in UTF-8 Unicode mode! Check your UI or manual for how to convert files to Unicode. It's also a good idea to figure out where to look in your UI to see what the current file encoding is.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="114085""></a>
  <div class="note">
   <strong class="user">Felix D.</strong>
   <a href="#114085" class="date">09-Jan-2014 11:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Another thing important to mention is that<br />
htmlspecialchars(NULL)<br />
returnes an empty string and not NULL!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="113373""></a>
  <div class="note">
   <strong class="user">support at playnext dot ru</strong>
   <a href="#113373" class="date">03-Oct-2013 08:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For those having problems after the change of default value of $encoding argument to UTF-8 since PHP 5.4.<br />
<br />
If your old non-UTF8 projects ruined - pls consider:<br />
1. <a href="http://php.net/manual/en/function.override-function.php" rel="nofollow" target="_blank">http://php.net/manual/en/function.override-function.php</a><br />
2. <a href="http://php.net/manual/ru/function.runkit-function-redefine.php" rel="nofollow" target="_blank">http://php.net/manual/ru/function.runkit-function-redefine.php</a><br />
<br />
The idea - you override the built-in htmlspecialchars() function with your customized variant which is able to respect non UTF-8 default encoding. This small piece of code can be then easily inserted somewhere at the start of yout project. No need to rewrite all htmlspecialchars() entries globally.<br />
<br />
I've spent several hours with both approaches. Variant 1 looks good especaially in combination with <a href="http://www.php.net/manual/en/function.rename-function.php as it allows to call original htmlspecialchars(" rel="nofollow" target="_blank">http://www.php.net/manual/en/function.rename-function.php as it allows to call original htmlspecialchars(</a>) with just altered default args. The code could be as follows:<br />
<br />
<span class="default">&lt;?php<br />
rename_function</span><span class="keyword">(</span><span class="string">'htmlspecialchars'</span><span class="keyword">, </span><span class="string">'renamed_htmlspecialchars'</span><span class="keyword">);<br />
function </span><span class="default">overriden_htmlspecialchars</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$flags</span><span class="keyword">=</span><span class="default">NULL</span><span class="keyword">, </span><span class="default">$encoding</span><span class="keyword">=</span><span class="string">'cp1251'</span><span class="keyword">, </span><span class="default">$double_encode</span><span class="keyword">=</span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$flags </span><span class="keyword">= </span><span class="default">$flags </span><span class="keyword">? </span><span class="default">$flags </span><span class="keyword">: (</span><span class="default">ENT_COMPAT</span><span class="keyword">|</span><span class="default">ENT_HTML401</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">renamed_htmlspecialchars</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$flags</span><span class="keyword">, </span><span class="default">$encoding</span><span class="keyword">, </span><span class="default">$double_encode</span><span class="keyword">);<br />
}<br />
</span><span class="default">override_function</span><span class="keyword">(</span><span class="string">'htmlspecialchars'</span><span class="keyword">, </span><span class="string">'$string, $flags, $encoding, $double_encode'</span><span class="keyword">, </span><span class="string">'return overriden_htmlspecialchars($string, $flags, $encoding, $double_encode);'</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Unfortunatelly this didn't work for me properly - my site managed to call overriden function but not every time I reloaded the pages. Moreover other PHP sites crashed under my Apache server as they suddenly started blaming htmlspecialchars() was not defined. I suppose I had to spend more time to make it work thread/request/site/whatever-safe.<br />
<br />
So I switched to runkit (variant 2). It worked for me, although even after trying runkit_function_rename()+runkit_function_add() I didn't managed to recall original htmlspecialchars() function. So as a quick solution I decided to call htmlentities() instead:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">overriden_htmlspecialchars</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$flags</span><span class="keyword">=</span><span class="default">NULL</span><span class="keyword">, </span><span class="default">$encoding</span><span class="keyword">=</span><span class="string">'UTF-8'</span><span class="keyword">, </span><span class="default">$double_encode</span><span class="keyword">=</span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$flags </span><span class="keyword">= </span><span class="default">$flags </span><span class="keyword">? </span><span class="default">$flags </span><span class="keyword">: (</span><span class="default">ENT_COMPAT</span><span class="keyword">|</span><span class="default">ENT_HTML401</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$encoding </span><span class="keyword">= </span><span class="default">$encoding </span><span class="keyword">? </span><span class="default">$encoding </span><span class="keyword">: </span><span class="string">'cp1251'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">htmlentities</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$flags</span><span class="keyword">, </span><span class="default">$encoding</span><span class="keyword">, </span><span class="default">$double_encode</span><span class="keyword">);<br />
}<br />
</span><span class="default">runkit_function_redefine</span><span class="keyword">(</span><span class="string">'htmlspecialchars'</span><span class="keyword">, </span><span class="string">'$string, $flags, $encoding, $double_encode'</span><span class="keyword">, </span><span class="string">'return overriden_htmlspecialchars($string, $flags, $encoding, $double_encode);'</span><span class="keyword">); <br />
</span><span class="default">?&gt;<br />
</span><br />
You may be able to implement your more powerfull overriden function.<br />
Good luck!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="112476""></a>
  <div class="note">
   <strong class="user">Dave</strong>
   <a href="#112476" class="date">20-Jun-2013 11:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As of PHP 5.4 they changed default encoding from "ISO-8859-1" to "UTF-8". So if you get null from htmlspecialchars or htmlentities<br />
<br />
where you have only set <br />
<span class="default">&lt;?php<br />
</span><span class="keyword">echo </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">);<br />
echo </span><span class="default">htmlentities</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
you can fix it by<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">echo </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">ENT_COMPAT</span><span class="keyword">,</span><span class="string">'ISO-8859-1'</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
echo </span><span class="default">htmlentities</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">ENT_COMPAT</span><span class="keyword">,</span><span class="string">'ISO-8859-1'</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span> <br />
<br />
On linux you can find the scripts you need to fix by<br />
<br />
grep -Rl "htmlspecialchars\\|htmlentities" /path/to/php/scripts/</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="112228""></a>
  <div class="note">
   <strong class="user">minder at ufive dot unibe dot ch</strong>
   <a href="#112228" class="date">19-May-2013 01:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Problem<br />
<br />
In many PHP legacy products the function htmlspecialchars($string) is used to convert characters like &lt; and &gt; and quotes a.s.o to HTML-entities. That avoids the interpretation of HTML Tags and asymmetric quote situations.<br />
<br />
Since PHP 5.4 for $string in htmlspecialchars($string) utf8 characters are expected if no charset is defined explicitly as third parameter in the function. Legacy products are mostly in Latin1 (alias iso-8859-1) what makes the functions htmlspecialchars(), htmlentites() and html_entity_decode() to return empty strings if a special character, e. g. a German Umlaut, is present in $string:<br />
<br />
PHP&lt;5.4<br />
<br />
echo htmlspecialchars('&lt;b&gt;Woermann&lt;/b&gt;') //Output: &amp;lt;b&amp;gt;Woermann&amp;lt;b&amp;gt;<br />
echo htmlspecialchars('W?rmann') //Output: &amp;lt;b&amp;gt;W?rmann&amp;lt;b&amp;gt;<br />
<br />
PHP=5.4<br />
<br />
echo htmlspecialchars('&lt;b&gt;Woermann&lt;/b&gt;') //Output: &amp;lt;b&amp;gt;Woermann&amp;lt;b&amp;gt;<br />
echo htmlspecialchars('&lt;b&gt;W?rmann&lt;/b&gt;') //Output: empty<br />
<br />
Three alternative solutions<br />
<br />
a) Not runnig legacy products on PHP 5.4<br />
b) Change all find spots in your code from <br />
htmlspecialchars($string) and *** to <br />
htmlspecialchars($string, ENT_COMPAT | ENT_HTML401, 'ISO-8859-1')<br />
c) Replace all htmlspecialchars() and *** with a new self-made function<br />
<br />
*** The same is true for htmlentities() and html_entity_decode();<br />
<br />
Solution c<br />
<br />
1 Make Search and Replace in the concerned legacy project:<br />
Search for:&nbsp; &nbsp; &nbsp; &nbsp; htmlspecialchars<br />
Replace with:&nbsp;&nbsp; htmlXspecialchars<br />
Search for:&nbsp; &nbsp; &nbsp; &nbsp; htmlentities<br />
Replace with:&nbsp;&nbsp; htmlXentities<br />
Search for:&nbsp; &nbsp; &nbsp; &nbsp; html_entity_decode<br />
Replace with:&nbsp;&nbsp; htmlX_entity_decode<br />
2a Copy and paste the following three functions into an existing already everywhere included PHP-file in your legacy project. (of course that PHP-file must be included only once per request, otherwise you will get a Redeclare Function Fatal Error).<br />
<br />
function htmlXspecialchars($string, $ent=ENT_COMPAT, $charset='ISO-8859-1') {<br />
return htmlspecialchars($string, $ent, $charset);<br />
}<br />
<br />
function htmlXentities($string, $ent=ENT_COMPAT, $charset='ISO-8859-1') {<br />
return htmlentities($string, $ent, $charset);<br />
}<br />
<br />
function htmlX_entity_decode($string, $ent=ENT_COMPAT, $charset='ISO-8859-1') {<br />
return html_entity_decode($string, $ent, $charset);<br />
}<br />
<br />
or 2b crate a new PHP-file containing the three functions mentioned above, let's say, z. B. htmlXfunctions.inc.php and include it on the first line of every PHP-file in your legacy product like this: require_once('htmlXfunctions.inc.php').</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111666""></a>
  <div class="note">
   <strong class="user">Mike Robinson</strong>
   <a href="#111666" class="date">14-Mar-2013 12:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Unfortunately, as far as I can tell, the PHP devs did not provide ANY way to set the default encoding used by htmlspecialchars() or htmlentities(), even though they changed the default encoding in PHP 5.4 (*golf clap for PHP devs*). To save someone the time of trying it, this does not work:<br />
<br />
<span class="default">&lt;?php<br />
ini_set</span><span class="keyword">(</span><span class="string">'default_charset'</span><span class="keyword">, </span><span class="default">$charset</span><span class="keyword">); </span><span class="comment">// doesn't work.<br />
</span><span class="default">?&gt;<br />
</span><br />
Unfortunately, the only way to not have to explicitly provide the second and third parameter every single time this function is called (which gets extremely tedious) is to write your own function as a wrapper:<br />
<br />
<span class="default">&lt;?php<br />
define</span><span class="keyword">(</span><span class="string">'CHARSET'</span><span class="keyword">, </span><span class="string">'ISO-8859-1'</span><span class="keyword">);<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="string">'REPLACE_FLAGS'</span><span class="keyword">, </span><span class="default">ENT_COMPAT </span><span class="keyword">| </span><span class="default">ENT_XHTML</span><span class="keyword">);<br />
<br />
function </span><span class="default">html</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">REPLACE_FLAGS</span><span class="keyword">, </span><span class="default">CHARSET</span><span class="keyword">);<br />
}<br />
<br />
echo </span><span class="default">html</span><span class="keyword">(</span><span class="string">"?"</span><span class="keyword">); </span><span class="comment">// works<br />
</span><span class="default">?&gt;<br />
</span><br />
You can do the same for htmlentities()</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104433""></a>
  <div class="note">
   <strong class="user">ivan at lutrov dot com</strong>
   <a href="#104433" class="date">15-Jun-2011 01:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be careful, the "charset" argument IS case sensitive. This is counter-intuitive and serves no practical purpose because the HTML spec actually has the opposite.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101592""></a>
  <div class="note">
   <strong class="user">Thomasvdbulk at gmail dot com</strong>
   <a href="#101592" class="date">28-Dec-2010 10:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
i searched for a while for a script, that could see the difference between an html tag and just &lt; and &gt; placed in the text, <br />
the reason is that i recieve text from a database,<br />
wich is inserted by an html form, and contains text and html tags, <br />
the text can contain &lt; and &gt;, so does the tags,<br />
with htmlspecialchars you can validate your text to XHTML,<br />
but you'll also change the tags, like &lt;b&gt; to &amp;lt;b&amp;gt;,<br />
so i needed a script that could see the difference between those two...<br />
but i couldn't find one so i made my own one, <br />
i havent fully tested it, but the parts i tested worked perfect!<br />
just for people that were searching for something like this,<br />
it may looks big, could be done easier, but it works for me, so im happy.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">fixtags</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">){<br />
</span><span class="default">$text </span><span class="keyword">= </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">);<br />
</span><span class="default">$text </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/=/"</span><span class="keyword">, </span><span class="string">"=\"\""</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
</span><span class="default">$text </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/&amp;quot;/"</span><span class="keyword">, </span><span class="string">"&amp;quot;\""</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
</span><span class="default">$tags </span><span class="keyword">= </span><span class="string">"/&amp;lt;(\/|)(\w*)(\ |)(\w*)([\\\=]*)(?|(\")\"&amp;quot;\"|)(?|(.*)?&amp;quot;(\")|)([\ ]?)(\/|)&amp;gt;/i"</span><span class="keyword">;<br />
</span><span class="default">$replacement </span><span class="keyword">= </span><span class="string">"&lt;$1$2$3$4$5$6$7$8$9$10&gt;"</span><span class="keyword">;<br />
</span><span class="default">$text </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="default">$tags</span><span class="keyword">, </span><span class="default">$replacement</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
</span><span class="default">$text </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/=\"\"/"</span><span class="keyword">, </span><span class="string">"="</span><span class="keyword">, </span><span class="default">$text</span><span class="keyword">);<br />
return </span><span class="default">$text</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
an example:<br />
<br />
<span class="default">&lt;?php<br />
$string </span><span class="keyword">= </span><span class="string">"<br />
this is smaller &lt; than this&lt;br /&gt; <br />
this is greater &gt; than this&lt;br /&gt;<br />
this is the same = as this&lt;br /&gt;<br />
&lt;a href=\"<a href="http://www.example.com/example.php?test=test" rel="nofollow" target="_blank">http://www.example.com/example.php?test=test</a>\"&gt;This is a link&lt;/a&gt;&lt;br /&gt;<br />
&lt;b&gt;Bold&lt;/b&gt; &lt;i&gt;italic&lt;/i&gt; etc..."</span><span class="keyword">;<br />
echo </span><span class="default">fixtags</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
will echo:<br />
this is smaller &amp;lt; than this&lt;br /&gt; <br />
this is greater &amp;gt; than this&lt;br /&gt; <br />
this is the same = as this&lt;br /&gt; <br />
&lt;a href="<a href="http://www.example.com/example.php?test=test" rel="nofollow" target="_blank">http://www.example.com/example.php?test=test</a>"&gt;This is a link&lt;/a&gt;&lt;br /&gt; <br />
&lt;b&gt;Bold&lt;/b&gt; &lt;i&gt;italic&lt;/i&gt; etc...<br />
<br />
I hope its helpfull!!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98698""></a>
  <div class="note">
   <strong class="user">nachitox2000 [at] hotmail [dot] com</strong>
   <a href="#98698" class="date">01-Jul-2010 05:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I had problems with spanish special characters. So i think in using htmlspecialchars but my strings also contain HTML.
<br />
So I used this :) Hope it help
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">htmlspanishchars</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">) 
<br />
{
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">str_replace</span><span class="keyword">(array(</span><span class="string">"&amp;lt;"</span><span class="keyword">, </span><span class="string">"&amp;gt;"</span><span class="keyword">), array(</span><span class="string">"&lt;"</span><span class="keyword">, </span><span class="string">"&gt;"</span><span class="keyword">), </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">, </span><span class="default">ENT_NOQUOTES</span><span class="keyword">, </span><span class="string">"UTF-8"</span><span class="keyword">));
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93620""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#93620" class="date">18-Sep-2009 10:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This may seem obvious, but it caused me some frustration. If you try and use htmlspecialchars with the $charset argument set and the string you run it on is not actually the same charset you specify, you get any empty string returned without any notice/warning/error.<br />
<br />
<span class="default">&lt;?php<br />
<br />
$ok_utf8 </span><span class="keyword">= </span><span class="string">"A valid UTF-8 string"</span><span class="keyword">;<br />
</span><span class="default">$bad_utf8 </span><span class="keyword">= </span><span class="string">"An invalid UTF-8 string"</span><span class="keyword">;<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$bad_utf8</span><span class="keyword">, </span><span class="default">ENT_NOQUOTES</span><span class="keyword">, </span><span class="string">'UTF-8'</span><span class="keyword">));&nbsp; </span><span class="comment">// string(0) ""<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$ok_utf8</span><span class="keyword">, </span><span class="default">ENT_NOQUOTES</span><span class="keyword">, </span><span class="string">'UTF-8'</span><span class="keyword">));&nbsp; </span><span class="comment">// string(20) "A valid UTF-8 string"<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
So make sure your charsets are consistent<br />
<br />
<span class="default">&lt;?php<br />
<br />
$bad_utf8 </span><span class="keyword">= </span><span class="string">"An invalid UTF-8 string"</span><span class="keyword">;<br />
<br />
</span><span class="comment">// make sure it's really UTF-8<br />
</span><span class="default">$bad_utf8 </span><span class="keyword">= </span><span class="default">mb_convert_encoding</span><span class="keyword">(</span><span class="default">$bad_utf8</span><span class="keyword">, </span><span class="string">'UTF-8'</span><span class="keyword">, </span><span class="default">mb_detect_encoding</span><span class="keyword">(</span><span class="default">$bad_utf8</span><span class="keyword">));<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$bad_utf8</span><span class="keyword">, </span><span class="default">ENT_NOQUOTES</span><span class="keyword">, </span><span class="string">'UTF-8'</span><span class="keyword">));&nbsp; </span><span class="comment">// string(23) "An invalid UTF-8 string" <br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
I had this problem because a Mac user was submitting posts copy/pasted from a program and it contained weird chars in it.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93577""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#93577" class="date">16-Sep-2009 09:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a few notes on how one can use htmlspecialchars() and htmlentities() to filter user input on forms for later display and/or database storage... <br />
<br />
1. Use htmlspecialchars() to filter text input values for html input tags.&nbsp; i.e.,<br />
<br />
echo '&lt;input name=userdata type=text value="'.htmlspecialchars($data).'" /&gt;';<br />
<br />
&nbsp;<br />
2. Use htmlentities() to filter the same data values for most other kinds of html tags, i.e.,<br />
<br />
echo '&lt;p&gt;'.htmlentities($data).'&lt;/p&gt;';<br />
<br />
3. Use your database escape string function to filter the data for database updates &amp; insertions, for instance, using postgresql, <br />
<br />
pg_query($connection,"UPDATE datatable SET datavalue='".pg_escape_string($data)."'");<br />
&nbsp;<br />
<br />
This strategy seems to work well and consistently, without restricting anything the user might like to type and display, while still providing a good deal of protection against a wide variety of html and database escape sequence injections, which might otherwise be introduced through deliberate and/or accidental input of such character sequences by users submitting their input data via html forms.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="86240""></a>
  <div class="note">
   <strong class="user">Kenneth Kin Lum</strong>
   <a href="#86240" class="date">08-Oct-2008 06:45</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if your goal is just to protect your page from Cross Site Scripting (XSS) attack, or just to show HTML tags on a web page (showing &lt;body&gt; on the page, for example), then using htmlspecialchars() is good enough and better than using htmlentities().&nbsp; A minor point is htmlspecialchars() is faster than htmlentities().&nbsp; A more important point is, when we use&nbsp; htmlspecialchars($s) in our code, it is automatically compatible with UTF-8 string.&nbsp; Otherwise, if we use htmlentities($s), and there happens to be foreign characters in the string $s in UTF-8 encoding, then htmlentities() is going to mess it up, as it modifies the byte 0x80 to 0xFF in the string to entities like &amp;eacute;.&nbsp; (unless you specifically provide a second argument and a third argument to htmlentities(), with the third argument being "UTF-8").<br />
<br />
The reason htmlspecialchars($s) already works with UTF-8 string is that, it changes bytes that are in the range 0x00 to 0x7F to &amp;lt; etc, while leaving bytes in the range 0x80 to 0xFF unchanged.&nbsp; We may wonder whether htmlspecialchars() may accidentally change any byte in a 2 to 4 byte UTF-8 character to &amp;lt; etc.&nbsp; The answer is, it won't.&nbsp; When a UTF-8 character is 2 to 4 bytes long, all the bytes in this character is in the 0x80 to 0xFF range. None can be in the 0x00 to 0x7F range.&nbsp; When a UTF-8 character is 1 byte long, it is just the same as ASCII, which is 7 bit, from 0x00 to 0x7F.&nbsp; As a result, when a UTF-8 character is 1 byte long, htmlspecialchars($s) will do its job, and when the UTF-8 character is 2 to 4 bytes long, htmlspecialchars($s) will just pass those bytes unchanged.&nbsp; So htmlspecialchars($s) will do the same job no matter whether $s is in ASCII, ISO-8859-1 (Latin-1), or UTF-8.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82435""></a>
  <div class="note">
   <strong class="user">php dot net at orakio dot net</strong>
   <a href="#82435" class="date">10-Apr-2008 11:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was recently exploring some code when I saw this being used to make data safe for "SQL".<br />
<br />
This function should not be used to make data SQL safe (although to prevent phishing it is perfectly good).<br />
<br />
Here is an example of how NOT to use this function:<br />
<br />
<span class="default">&lt;?php<br />
$username </span><span class="keyword">= </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">trim</span><span class="keyword">(</span><span class="string">"</span><span class="default">$_POST</span><span class="keyword">[</span><span class="default">username</span><span class="keyword">]</span><span class="string">"</span><span class="keyword">));<br />
<br />
</span><span class="default">$uniqueuser </span><span class="keyword">= </span><span class="default">$realm_db</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">"SELECT `login` FROM `accounts` WHERE `login` = '</span><span class="default">$username</span><span class="string">'"</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
(Only other check on $_POST['username'] is to make sure it isn't empty which it is after trim on a white space only name)<br />
<br />
The problem here is that it is left to default which allows single quote marks which are used in the sql query. Turning on magic quotes might fix it but you should not rely on magic quotes, in fact you should never use it and fix the code instead. There are also problems with \ not being escaped. Even if magic quotes were used there would be the problem of allowing usernames longer than the limit and having some really weird usernames given they are to be used outside of html, this just provide a front end for registering to another system using mysql. Of course using it on the output wouldn;t cause that problem.<br />
<br />
Another way to make something of a fix would be to use ENT_QUOTE or do:<br />
<br />
<span class="default">&lt;?php<br />
$uniqueuser </span><span class="keyword">= </span><span class="default">$realm_db</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">'SELECT `login` FROM `accounts` WHERE `login` = "'</span><span class="keyword">.</span><span class="default">$username</span><span class="keyword">.</span><span class="string">'";'</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Eitherway none of these solutions are good practice and are not entirely unflawed. This function should simply never be used in such a fashion.<br />
<br />
I hope this will prevent newbies using this function incorrectly (as they apparently do).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75795""></a>
  <div class="note">
   <strong class="user">solar-energy</strong>
   <a href="#75795" class="date">16-Jun-2007 03:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
also see function "urlencode()", useful for passing text with ampersand and other special chars through url<br />
<br />
(i.e. the text is encoded as if sent from form using GET method)<br />
<br />
e.g.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">echo </span><span class="string">"&lt;a href='foo.php?text="</span><span class="keyword">.</span><span class="default">urlencode</span><span class="keyword">(</span><span class="string">"foo?&amp;bar!"</span><span class="keyword">).</span><span class="string">"'&gt;link&lt;/a&gt;"</span><span class="keyword">;<br />
</span><span class="default">?&gt;<br />
</span><br />
produces<br />
<br />
&lt;a href='foo.php?text=foo%3F%26bar%21'&gt;link&lt;/a&gt;<br />
<br />
and if the link is followed, the $_GET["text"] in foo.php will contain "foo?&amp;bar!"</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="50842""></a>
  <div class="note">
   
   <a href="#50842" class="date">11-Mar-2005 04:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
function htmlspecialchars_array($arr = array()) {<br />
&nbsp;&nbsp; $rs =&nbsp; array();<br />
&nbsp;&nbsp; while(list($key,$val) = each($arr)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; if(is_array($val)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $rs[$key] = htmlspecialchars_array($val);<br />
&nbsp;&nbsp; &nbsp; &nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $rs[$key] = htmlspecialchars($val, ENT_QUOTES);<br />
&nbsp;&nbsp; &nbsp; &nbsp; }&nbsp; &nbsp; <br />
&nbsp;&nbsp; }<br />
&nbsp;&nbsp; return $rs;<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="25217""></a>
  <div class="note">
   <strong class="user">_____ at luukku dot com</strong>
   <a href="#25217" class="date">14-Sep-2002 02:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
People, don't use ereg_replace for the most simple string replacing operations (replacing constant string with another).<br />
Use str_replace.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="13693""></a>
  <div class="note">
   <strong class="user">ryan at ryano dot net</strong>
   <a href="#13693" class="date">29-Jun-2001 03:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Actually, if you're using &gt;= 4.0.5, this should theoretically be quicker (less overhead anyway):
<br />

<br />
$text = str_replace(array("&amp;gt;", "&amp;lt;", "&amp;quot;", "&amp;amp;"), array("&gt;", "&lt;", "\"", "&amp;"), $text);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
